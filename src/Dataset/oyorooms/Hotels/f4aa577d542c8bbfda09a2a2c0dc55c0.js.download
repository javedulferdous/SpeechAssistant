(function(){(function(){if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,FNOP=function(){},fBound=function(){return fToBind.apply(this instanceof FNOP?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};FNOP.prototype=this.prototype;fBound.prototype=new FNOP();return fBound}}}());var PKG_ROOT={__anonymous__:true};var GLOBAL=null;try{GLOBAL=(false||eval)("this")||(function(){return this}())}catch(e){}PKG_ROOT=GLOBAL;var qubit=PKG_ROOT.qubit||{};if(!PKG_ROOT.qubit){PKG_ROOT.qubit=qubit}var qversion="3.1.0";if(qubit.VERSION&&qubit.VERSION!==qversion){try{console.warn("There is already 'qubit.VERSION' set to: "+qubit.VERSION)}catch(ex){}}qubit.VERSION=qversion;try{module.exports=PKG_ROOT}catch(e){}var EMPTY_FUN=function(){};var UNDEF;(function(){function Define(){}Define.global=function(){return GLOBAL};Define.STANDARD_CS_NS="qubit.cs";Define.clientSpaceClasspath=function(){if(window.qubit.CLIENT_CONFIG){return"qubit.cs.d"+window.qubit.CLIENT_CONFIG.id}return Define.STANDARD_CS_NS};Define.globalNamespace=function(path,instance,pckg,noOverride){return _namespace(path,instance,pckg,noOverride,true)};Define.namespace=function(path,instance,pckg,noOverride){return _namespace(path,instance,pckg,noOverride,false)};function _namespace(path,instance,pckg,noOverride,isGlobal){var files=path.split("."),current=Define.NAMESPACE_BASE||PKG_ROOT,last=null,lastName=null,i;if(isGlobal){current=GLOBAL}var root=current;current=pckg||current;for(i=0;i<files.length-1;i+=1){last=current;lastName=files[i];current[lastName]=current[lastName]||{};current=current[lastName]}last=current;lastName=files[files.length-1];if(GLOBAL.TAGSDK_NS_OVERRIDE){noOverride=false}if(GLOBAL.TAGSDK_NS_FORCED_OVERRIDE_OPTION!==undefined){noOverride=!GLOBAL.TAGSDK_NS_FORCED_OVERRIDE_OPTION}if(instance!==undefined){if(last[lastName]===undefined||!noOverride){last[lastName]=instance}}else{last[lastName]=last[lastName]||{}}if(instance){instance.CLASSPATH=files.join(".");files.splice(files.length-1,1);instance.PACKAGE_NAME=files.join(".")}return{root:root,object:last,instance:last[lastName]}}Define.clientNamespace=function(path,instance,pckg,noOverride){return Define.namespace(Define.clientSpaceClasspath()+"."+path,instance,pckg,noOverride)};Define.clazz=function(path,Class,SuperClass,pckg,config){Define.namespace(path,Class,pckg,true);if(typeof (SuperClass)==="function"){Class.SUPER=SuperClass;Class.superclass=SuperClass;Class.prototype=new SuperClass(config);Class.prototype.SUPER=SuperClass;Class.prototype.CLASS=Class}var names=path.split(".");if(Class.prototype){Class.prototype.CLASSPATH=names.join(".");Class.prototype.CLASS_NAME=names[names.length-1];names.splice(names.length-1,1);Class.prototype.PACKAGE_NAME=names.join(".")}else{Class.CLASSPATH=names.join(".");Class.STATIC_NAME=names[names.length-1];names.splice(names.length-1,1);Class.PACKAGE_NAME=names.join(".")}return Class};Define.clazz("qubit.Define",Define);Define.clientClazz=function(path,Class,SuperClass,pckg,config){return Define.clazz(Define.clientSpaceClasspath()+"."+path,Class,SuperClass,pckg,config)};Define.STANDARD_VS_NS="qubit.vs";Define.vendorsSpaceClasspath=function(path){var cp=qubit.VENDOR_SPACE_CP;var result=(cp===undefined||cp===null)?Define.STANDARD_VS_NS:cp;if(path){if(result){return result+"."+path}else{return path}}return result};var nsTmp=Define.vendorsSpaceClasspath();var _vspace;if(nsTmp){_vspace=Define.namespace(nsTmp,{},null,true).instance}else{_vspace=Define.global()}Define.getVendorSpace=function(){return _vspace};Define.vendorNamespace=function(path,instance,pckg,noOverride){path=Define.vendorsSpaceClasspath(path);return Define.namespace(path,instance,pckg,noOverride)};Define.vendorClazz=function(path,Class,SuperClass,pckg,config){path=Define.vendorsSpaceClasspath(path);return Define.clazz(path,Class,SuperClass,pckg,config)}}());(function(){var cookieAlphabet="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ*!-#$&+()@'%./:<>?[\"]^_`{|}~\\;=";var cookieAlphabetMap={};for(var i=0;i<cookieAlphabet.length;i++){cookieAlphabetMap[cookieAlphabet.charAt(i)]=i}function Cookie(config){}qubit.Define.clazz("qubit.Cookie",Cookie);Cookie.cookieAlphabet=cookieAlphabet;Cookie.cookieAlphabetMap=cookieAlphabetMap;Cookie.decode=function(string){return unescape(string)};Cookie.encode=function(string){return escape(string)};Cookie.set=function(name,value,days,domain,notEncoded){var expires;if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toGMTString()}else{expires=""}if(!notEncoded){name=Cookie.encode(name);value=Cookie.encode(value)}var cookie=name+"="+value+expires+"; path=/;";if(domain){cookie+=" domain="+domain}document.cookie=cookie};Cookie.get=function(name,notDecoded){var part=name+"=";var chunks=document.cookie.split(";");for(var i=0;i<chunks.length;i++){var chunk=chunks[i];while(chunk.charAt(0)===" "){chunk=chunk.substring(1,chunk.length)}if(chunk.indexOf(part)===0){var tmp=chunk.substring(part.length,chunk.length);if(!notDecoded){tmp=Cookie.decode(tmp)}return tmp}}return null};Cookie.getAllForName=function(name,decoded){if(!name){return[]}var part=name+"=";var chunks=document.cookie.split(";");var cookies=[];for(var i=0;i<chunks.length;i++){var chunk=chunks[i];while(chunk.charAt(0)===" "){chunk=chunk.substring(1,chunk.length)}if(chunk.indexOf(part)===0){var tmp=chunk.substring(part.length,chunk.length);if(decoded){tmp=Cookie.decode(tmp)}cookies.push(tmp)}}return cookies};Cookie.getAll=function(decoded){var chunks=document.cookie.split(";");var cookies=[];for(var i=0;i<chunks.length;i++){var chunk=chunks[i];while(chunk.charAt(0)===" "){chunk=chunk.substring(1,chunk.length)}var name=chunk.substring(0,chunk.indexOf("="));var tmp=chunk.substring(name.length+1,chunk.length);if(decoded){tmp=Cookie.decode(tmp)}cookies.push([name,tmp])}return cookies};Cookie.rm=function(name,domain){Cookie.set(name,"",-1,domain)}})();(function(){var Define=qubit.Define;var Cookie=qubit.Cookie;var Utils=function(){};var global=Define.global();Define.clazz("qubit.opentag.Utils",Utils);Utils.global=Define.global;Utils.namespace=Define.namespace;Utils.clazz=Define.clazz;Utils.getObjectUsingPath=function(path,base){base=base||global;var parts=path.split(".");for(var i=0;i<parts.length;i++){if(base&&parts[i]){base=base[parts[i]]}}return base};Utils.getParentObject=function(name){var idx=name.lastIndexOf(".");var path=name.substring(0,idx);return Utils.getObjectUsingPath(path)};Utils.variableExists=function(value){return(value!==undefined)&&(value!==null)};Utils.ANON_VARS=[];Utils.getAnonymousAcessor=function(obj){var index=Utils.indexInArray(obj,Utils.ANON_VARS);if(index===-1){index=addAnonymousAcessor(obj)}return"qubit.opentag.Utils.ANON_VARS["+index+"]"};function addAnonymousAcessor(obj){return Utils.addToArrayIfNotExist(Utils.ANON_VARS,obj)}function escapeRegExp(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}Utils.replaceAll=function(string,pattern,replace){return string.replace(new RegExp(escapeRegExp(pattern),"g"),replace)};Utils.secureText=function(string){if(typeof (string)!=="string"){string+=""}string=string.replace(/</g,"&lt;");string=string.replace(/>/g,"&gt;");return string};Utils.getUrl=function(){return document.location.href};Utils.getQueryParam=function(param){var i,ii,params,url,query,queries,splitQuery;url=Utils.getUrl();if(url.indexOf("?")>0){queries=url.substring(url.indexOf("?")+1).split("&");for(i=0,ii=queries.length;i<ii;i+=1){query=queries[i];if(query.indexOf("=")>0){splitQuery=query.split("=");if((splitQuery.length===2)&&(splitQuery[0]===param)){return splitQuery[1]}}}}return null};Utils.getElementValue=function(elementId){var el=document.getElementById(elementId);if(el){return el.textContent||el.innerText}return null};var travelArray=[];function existsInPath(object,copy){var len=travelArray.length;for(var i=0;i<len;i++){if(object===travelArray[i][0]){return travelArray[i][1]}}travelArray[travelArray.length]=[object,copy];return false}Utils.objectCopy=function(obj,cfg){cfg=cfg||{};var res=_objectCopy(obj,cfg,cfg.maxDeep);travelArray=[];return res};function _objectCopy(obj,cfg,maxDeep,start,parentObj){var nodes=false,noOwn=false,noFunctions=false,win=false,all=false,copyReference=false,emptyForMaxDeep=false;if(cfg){all=!!cfg.all;nodes=all||cfg.nodes;win=all||cfg.win;noOwn=all;emptyForMaxDeep=!!cfg.emptyForMaxDeep;noFunctions=cfg.noFunctions&&!all;if(cfg.noOwn!==undefined){noOwn=!!cfg.noOwn}if(cfg.noFunctions!==undefined){noFunctions=!!cfg.noFunctions}if(cfg.win!==undefined){win=!!cfg.win}if(cfg.nodes!==undefined){nodes=!!cfg.nodes}copyReference=!!cfg.copyReference}if(maxDeep!==undefined&&!maxDeep){if(emptyForMaxDeep){return }return obj}else{if(maxDeep!==undefined){maxDeep--}}if(!obj||!(obj instanceof Object)){return obj}if(!nodes){try{if(obj instanceof Node){return obj}}catch(ie){if(obj instanceof ActiveXObject&&obj.nodeType!==undefined){return obj}}if(obj===document){return obj}}if(!win){if(obj===global){return obj}}var copy=(obj instanceof Array)?[]:{};if(obj instanceof Date){copy=new Date(obj)}if(!noFunctions&&obj instanceof Function){var funStr=String(obj).replace(/\s+/g,"");if((funStr.indexOf("{[nativecode]}")+14)===funStr.length){copy=function(){return obj.apply(parentObj||this,arguments)}}else{copy=function(){return obj.apply(this,arguments)}}}if(start===undefined){travelArray=[];start=0}var existingCopy=existsInPath(obj,copy);if(existingCopy){return existingCopy}var i;if(copy instanceof Array){for(i=0;i<obj.length;i++){if(obj[i]===obj[i]){copy[copy.length]=_objectCopy(obj[i],cfg,maxDeep,start+1,obj)}else{copy[copy.length]=obj[i]}}}else{i=0;for(var prop in obj){if(noOwn||obj.hasOwnProperty(prop)){if(obj[prop]===obj[prop]){copy[prop]=_objectCopy(obj[prop],cfg,maxDeep,start+1,obj)}else{copy[prop]=obj[prop]}}i++}}if(cfg.proto){copy.prototype=_objectCopy(obj.prototype,cfg,maxDeep,start+1,obj)}if(copyReference){copy.___copy_ref=obj}return copy}var traverseArray=[];function existsInTraversePath(object,max){for(var i=0;i<max&&i<traverseArray.length;i++){if(object===traverseArray[i]){return true}}return false}Utils.traverse=function(obj,exe,cfg){var u;_traverse(obj,exe,cfg,u,u,u,u,cfg.maxDeep)};function _traverse(obj,exe,cfg,start,parent,prop,trackPath,maxDeep){cfg=cfg||{};if(cfg.hasOwn===undefined){cfg.hasOwn=true}if(cfg.objectsOnly&&!(obj instanceof Object)){return }if(maxDeep!==undefined&&!maxDeep){return }else{if(maxDeep!==undefined){maxDeep--}}if(!cfg||!cfg.nodes){try{if(obj instanceof Node){return }}catch(ie){if(obj instanceof ActiveXObject&&obj.nodeType!==undefined){return }}}if(obj===global){return }if(start===undefined){traverseArray=[];start=0}if(existsInTraversePath(obj,start)){return }traverseArray[start]=obj;parent=parent||obj;if(parent&&prop&&(parent[prop]!==parent[prop])){return }var stopHere=exe(obj,parent,prop,trackPath);if(stopHere){return }var i=0;var objPath="";for(var pprop in obj){if(!cfg.hasOwn||(obj.hasOwnProperty(pprop))){try{var object=obj[pprop];if(cfg.track){objPath=trackPath?(trackPath+"."+pprop):pprop}_traverse(object,exe,cfg,start+1,parent,pprop,objPath,maxDeep)}catch(e){}}i++}}Utils.prepareQuotedString=function(string){if(typeof (string)==="string"){return'"'+(string.replace(/\"/g,'\\"'))+'"'}else{return string}};Utils.expressionToFunction=function(expr,argzString){argzString=argzString||"";var funTemplate="function ("+argzString+") {"+expr+"}";return Utils.gevalAndReturn(funTemplate).result};Utils.defineWrappedClass=function(classPath,extClass,prototypeTemplate,pckg,constr){var clazz=function(){if(constr){return constr.apply(this,arguments)}else{return extClass.apply(this,arguments)}};Define.clazz(classPath,clazz,extClass,pckg);for(var prop in prototypeTemplate){if(prototypeTemplate.hasOwnProperty(prop)&&prop!=="CONSTRUCTOR"){clazz.prototype[prop]=prototypeTemplate[prop]}}return clazz};Utils.copyAandAddFromB=function(A,B,maxDeep){maxDeep=maxDeep||8;var copy=this.objectCopy(A,{maxDeep:maxDeep});for(var prop in B){if(B.hasOwnProperty(prop)){copy[prop]=B[prop]}}return copy};Utils.keys=function(obj){if(obj instanceof Object){if(Object.keys){return Object.keys(obj)}var keys=[];for(var prop in obj){if(obj.hasOwnProperty(prop)){keys[keys.length]=prop}}return keys}else{throw"keys() called on non-object!"}};Utils.getSrcElement=function(evt){var elem;evt=evt||window.event;if(evt.srcElement){elem=evt.srcElement}else{if(evt.target){elem=evt.target}}return elem};Utils.addToArrayIfNotExist=function(array,obj,equals){var i=0,exists=false;for(;i<array.length;i+=1){var tmp=equals&&equals(array[i],obj);if(tmp||array[i]===obj){exists=true;break}}if(!exists){array[array.length]=obj;i=-1}return i};Utils.indexInArray=function(array,obj){var i=0,exists=false;for(;i<array.length;i++){if(array[i]===obj){exists=true;break}}return exists?i:-1};Utils.removeFromArray=function(array,obj){var i=0,total=0;for(;i<array.length;){if(array[i]===obj){array.splice(i,1);total++}else{i++}}return total};Utils.addClass=function(node,name){var classes;try{node.classList.add(name)}catch(ex){if(node.className===null){node.className=name;return }classes=node.className.split(" ");Utils.addToArrayIfNotExist(classes,name);node.className=classes.join(" ")}};Utils.removeClass=function(node,name){var classes;try{node.classList.remove(name)}catch(ex){if(node.className===null){node.className="";return }classes=node.className.split(" ");Utils.removeFromArray(classes,name);node.className=classes.join(" ")}};var prefix="try{this.qubitopentagutilsgevalandreturn__var_test__=(";var suffix=");}catch(ex){this.qubitopentagutilsgevalandreturn__var_test__error = ex;}";Utils.gevalAndReturn=function(expression){var G=GLOBAL;G.qubitopentagutilsgevalandreturn__var_test__=undefined;G.qubitopentagutilsgevalandreturn__var_test__error=undefined;expression=prefix+expression+suffix;Utils.geval(expression);var res=G.qubitopentagutilsgevalandreturn__var_test__;var err=G.qubitopentagutilsgevalandreturn__var_test__error;try{G.qubitopentagutilsgevalandreturn__var_test__=UNDEF;G.qubitopentagutilsgevalandreturn__var_test__error=UNDEF;delete G.qubitopentagutilsgevalandreturn__var_test__;delete G.qubitopentagutilsgevalandreturn__var_test__error}catch(ex){}return{result:res,error:err}};Utils.trim=function(string){try{return String(string).trim()}catch(noTrim){return String(string).replace(/^\s+|\s+$/g,"")}};Utils.setIfUnset=function(obj,src){if(obj&&src){for(var prop in src){if(src.hasOwnProperty(prop)&&!obj.hasOwnProperty(prop)){obj[prop]=src[prop]}}}};Utils.overrideFromLeftToRight=function(A,B){if(A&&B){for(var prop in B){if(B.hasOwnProperty(prop)){A[prop]=B[prop]}}}return A};Utils.geval=function(expression){if(window&&window.execScript){return window.execScript(expression===""?" ":expression)}else{return(function(){return global["eval"].call(global,expression)}())}};var _availStack=[];Utils.bodyAvailable=function(callback){var avail=!!document.body;if(avail){if(_availStack){for(var i=0;i<_availStack.length;i++){try{_availStack[i]()}catch(ex){}}_availStack=false}callback()}else{_availStack.push(callback)}};Utils.rmCookiesMatching=function(string){var cookies=Cookie.getAll();for(var i=0;i<cookies.length;i++){var name=cookies[i][0];if(name.match(string)===0){Cookie.rm(name)}}};var _readyCalls=[];var _loaded=false;var _flushed=false;Utils.bodyReady=function(callback){if(_flushed){if(callback){callback()}return true}_loaded=_loaded||!!(document.body&&document.readyState==="complete");if(_loaded){_flushed=true;for(var i=0;i<_readyCalls.length;i++){try{_readyCalls[i]()}catch(ex){if(global.console&&global.console.trace){global.console.trace(ex)}}}if(callback){callback()}}else{if(callback){_readyCalls.push(callback)}}return _loaded};var oldOnload=global.onload;global.onload=function(e){try{Utils.bodyReady()}catch(ex){try{window.qubit.opentag.Utils.bodyReady()}catch(ex1){}}var oldRef=false;try{oldRef=oldOnload}catch(ex2){}if(oldRef){oldRef(e)}};(function(){var DOMContentLoaded,isReady=false,readyWait=1,readyList,readyComplete,bindReadyComplete,doScrollCheck;readyComplete=function(wait){var f;if(wait===true){readyWait-=1}if(!readyWait||(wait!==true&&!isReady)){if(!document.body){return setTimeout(readyComplete,1)}isReady=true;if(wait!==true){readyWait-=1;if(readyWait>0){return }}while(readyList.length>0){f=readyList.shift();f()}}};doScrollCheck=function(){if(isReady){return }try{document.documentElement.doScroll("left")}catch(e){setTimeout(doScrollCheck,1);return }readyComplete()};bindReadyComplete=function(){if(readyList){return }readyList=[];if(document.readyState==="complete"){return setTimeout(readyComplete,1)}if(document.addEventListener){document.addEventListener("DOMContentLoaded",DOMContentLoaded,false);window.addEventListener("load",readyComplete,false)}else{if(document.attachEvent){document.attachEvent("onreadystatechange",DOMContentLoaded);window.attachEvent("onload",readyComplete);var toplevel=false;try{toplevel=(window.frameElement===null)||(window.frameElement===undefined)}catch(e){}if(document.documentElement.doScroll&&toplevel){doScrollCheck()}}}};var ready=function(fn){bindReadyComplete();if(isReady){setTimeout(fn,1)}else{readyList.push(fn)}};if(document.addEventListener){DOMContentLoaded=function(){document.removeEventListener("DOMContentLoaded",DOMContentLoaded,false);readyComplete()}}else{if(document.attachEvent){DOMContentLoaded=function(){if(document.readyState==="complete"){document.detachEvent("onreadystatechange",DOMContentLoaded);readyComplete()}}}}ready(function(){_loaded=true;Utils.bodyReady()})}())}());(function(){var Define=qubit.Define;var _console=null;function Log(prefix,clazz,collectLocally){this.collectLogs=!!Log.isCollecting();this.collectLocally=collectLocally;this.collection=[];this.getPrefix=function(){var clz="";if(clazz){if(typeof (clazz)==="function"){clz=clazz(this.ref)}else{if(clazz.CLASS_NAME){clz=clazz.CLASS_NAME}else{if(clazz.constructor&&clazz.constructor.name){clz=clazz.constructor.name}}}if(clz){clz+=" -> "}}return(prefix||"")+clz}}Define.clazz("qubit.opentag.Log",Log);Log.LEVEL_FINEST=4;Log.LEVEL_FINE=3;Log.LEVEL_INFO=2;Log.LEVEL_WARN=1;Log.LEVEL_ERROR=0;Log.LEVEL_NONE=-1;Log.MAX_LOG_LEN=10000;Log.prototype.MAX_LOG_LEN=-1;var LEVEL=Log.LEVEL_NONE;LEVEL=Log.LEVEL_INFO;var COLLECT_LEVEL=Log.LEVEL_NONE;COLLECT_LEVEL=Log.LEVEL_FINE;var COLLECT=true;Log.setLevelFromCookie=function(){var cookieLevel=qubit.Cookie.get("qubit.opentag.Log.LEVEL");if(cookieLevel){cookieLevel=+cookieLevel;if(!isNaN(cookieLevel)){if(cookieLevel>0){var fine=Log.LEVEL_FINE;Log.setCollectLevel((cookieLevel>fine)?cookieLevel:fine);Log.setLevel(+cookieLevel)}}}};Log.setCollecting=function(isCollecting){COLLECT=!!isCollecting};Log.isCollecting=function(){return COLLECT||Log.COLLECT};Log.setLevel=function(level){LEVEL=+level};Log.getLevel=function(){return LEVEL};Log.setCollectLevel=function(level){COLLECT_LEVEL=+level};Log.getCollectLevel=function(){return COLLECT_LEVEL};var collection=[];Log.logsCollection=collection;Log.rePrintAll=function(level,delay,noClean,array){var oldLevel=LEVEL;if(level!==undefined){LEVEL=level}try{if(Log.isCollecting()){try{if(!noClean){_console.clear()}}catch(ex){}var collection=array||Log.logsCollection;var counter=0;for(var i=0;i<collection.length;i++){(function(j){var log=collection[j];var logLevel=log[3];if(logLevel!==undefined&&LEVEL>=logLevel){counter++;if(!delay){Log.print.apply(Log,log)}else{qubit.opentag.Timed.setTimeout(function(){if(level!==undefined){LEVEL=level}try{Log.print.apply(Log,log)}finally{LEVEL=oldLevel}},counter*delay)}}})(i)}}}catch(ex){}finally{LEVEL=oldLevel}};var tmp=Define.global();var isStylingSupported=!!(tmp.webkitMediaStream||tmp.webkitURL||tmp.mozContact);Log.isStyleSupported=function(){return isStylingSupported};var altConsole={};Log.setConsole=function(xconsole){_console=xconsole||altConsole;return _console};Log.delayPrint=-1;var _last_run=new Date().valueOf();Log.prototype.printMessage=function(message,style,type,level){if(Log.delayPrint>0){var delay=Log.delayPrint;var ago=_last_run-new Date().valueOf();if(ago>0){delay+=ago}try{qubit.opentag.Timed.setTimeout(function(){this.print(message,style,type,level)}.bind(this),delay)}catch(e){setTimeout(function(){this.print(message,style,type,level)}.bind(this),delay)}_last_run=new Date().valueOf()+delay}else{this.print(message,style,type,level)}};Log.prototype.print=function(message,style,type,level){Log.print(message,style,type,level)};Log.print=function(message,style,type,level){if(level!==undefined&&LEVEL<level){return }try{if(_console&&_console.log){if(style&&Log.isStyleSupported()){if(type&&_console[type]){_console[type]("%c"+message,style)}else{_console.log("%c"+message,style)}}else{if(type&&_console[type]){_console[type](message)}else{_console.log(message)}}}}catch(ex){}};Log.prototype.collect=function(toPrint,level){if(level===undefined){level=Log.getCollectLevel()}var collected=false;var collectingGlobally=(this.collectLogs&&Log.isCollecting()&&(Log.getCollectLevel()>=+level));if(collectingGlobally){collection.push(toPrint);collected=true}if(this.collectLocally&&collectingGlobally){this.collection.push(toPrint);collected=true}if(Log.MAX_LOG_LEN>0){if(collection.length>Log.MAX_LOG_LEN){collection.splice(0,collection.length-Log.MAX_LOG_LEN)}}if(Log.MAX_LOG_LEN>0||this.MAX_LOG_LEN>0){var len=Log.MAX_LOG_LEN;if(this.MAX_LOG_LEN>0){len=this.MAX_LOG_LEN}if(this.collection.length>len){this.collection.splice(0,this.collection.length-len)}}return collected?toPrint:null};Log.clearAllLogs=function(){try{_console.clear()}catch(e){}finally{collection.splice(0,collection.length)}};Log.getCollectedByLevel=function(level,altCollection){altCollection=altCollection||collection;var results=[];for(var i=0;i<altCollection.length;i++){var log=altCollection[i];var msg=log[0];var lvl=msg[4];if(lvl===level){results.push(log)}}return results};Log.prototype.rePrint=function(level,delay,clean){Log.rePrintAll(level,delay,!clean,this.collection)};function logger(log,prefix,type,message,plain,style,plainStyle,level){var toPrint;var pass=LEVEL>=level;if(Log.getCollectLevel()>=0||pass){if(plain){toPrint=[message,plainStyle,type]}else{toPrint=[prefix+log.getPrefix()+message,style,type]}toPrint[3]=level;log.collect(toPrint,level);if(pass){log.printMessage.apply(log,toPrint)}}}Log.prototype.FINEST=function(message,plain){logger(this,"FINEST: ",false,message,plain,"color:#CCCCCC;",false,Log.LEVEL_FINEST)};Log.prototype.FINE=function(message,plain){logger(this,"FINE: ",false,message,plain,"color:#999999;",false,Log.LEVEL_FINE)};Log.prototype.INFO=function(message,plain,style){logger(this,"INFO: ","info",message,plain,style,style,Log.LEVEL_INFO)};Log.prototype.WARN=function(message,plain){logger(this,"WARN: ","warn",message,plain,"color:#26A110;",false,Log.LEVEL_WARN)};Log.prototype.ERROR=function(message,plain){logger(this,"ERROR: ","error",message,plain,"color:red;",false,Log.LEVEL_ERROR)};Log.setConsole(Define.global().console);Log.setLevelFromCookie()}());(function(){var log=new qubit.opentag.Log("Timer -> ");function Timer(config){if(config){log.FINEST("Config:");log.FINEST(config,true);this._rate=config.rate||10;this._smallestRate=-1;if(config.start){this.startPooling()}this.config=config}this.inervals=[];this._lck_obj={};this._binded_pool=this._pool.bind(this)}qubit.Define.clazz("qubit.opentag.Timer",Timer);Timer.prototype.timers=[];Timer.prototype.startPooling=function(smallestRate){if(smallestRate&&this.config.dynamic){if(this._smallestRate<0||this._smallestRate>smallestRate){this._smallestRate=Math.min(Math.floor(smallestRate/2),1500)}}if(!this.started){this.started=true;setTimeout(this._binded_pool,0)}};Timer.prototype._pool=function(){this.maxFrequent(function(){var name="";if(this.config&&this.config.name){name="["+this.config.name+"]"}log.FINEST(name+"Pooling in progress...")},5000,this._lck_obj);this.callTimers();if(this.timers.length!==0){var rate=(this._smallestRate>this._rate)?this._smallestRate:this._rate;setTimeout(this._binded_pool,rate)}else{this.started=false;this._smallestRate=-1}};Timer.prototype.callTimers=function(){this.lastCalled=new Date().valueOf();for(var i=0;i<this.timers.length;i++){var timer=this.timers[i];var stamp=new Date().valueOf();if(stamp>=timer.time){try{timer.execute()}catch(e){log.ERROR("Error calling timer: "+e)}this.timers.splice(i,1);--i}}};Timer.prototype.cancellAll=function(){this.timers=[];log.WARN("Cancelling all stack.")};Timer.prototype.setRate=function(time){this._rate=time};Timer.prototype.maxFrequent=function(fun,time,lockObj){if(!lockObj){fun.__maxFrequent__timer_opentag_qubit_=fun.__maxFrequent__timer_opentag_qubit_||{};lockObj=fun.__maxFrequent__timer_opentag_qubit_}var last=lockObj.____last__timed__max__frequent____;if(!last||(new Date().valueOf()-last)>time){last=new Date().valueOf();lockObj.____last__timed__max__frequent____=last;fun()}};Timer.prototype.runIfNotScheduled=function(fun,time,lockObj){lockObj=lockObj||fun;if(lockObj.__lastRun__&&(new Date().valueOf()<(time+lockObj.__lastRun__))){return this.schedule(fun,time,lockObj)}else{lockObj.__lastRun__=new Date().valueOf();fun();return true}};Timer.prototype.schedule=function(fun,time,lockObj){if(lockObj.___scheduled___){return false}else{lockObj.___scheduled___=new Date().valueOf();this.setTimeout(function(){lockObj.___scheduled___=false;lockObj.__lastRun__=new Date().valueOf();fun()},time);return true}};var ids=1;Timer.prototype.setTimeout=function(call,time){var timer={id:ids++,time:new Date().valueOf()+(+time),execute:call};this.timers.push(timer);this.startPooling(time);return timer};Timer.prototype.setInterval=function(call,time){log.FINEST("Native wrapper");var interv=setInterval(call,time);this.inervals.push(interv);return interv}})();(function(){qubit.Define.namespace("qubit.opentag.Timed",new qubit.opentag.Timer({rate:37,dynamic:true}));var Timed=qubit.opentag.Timed;Timed.tillTrue=function(test,callback,often){var runner=function(){if(!test()){Timed.setTimeout(runner,often||33)}else{callback()}};runner()}})();var q={};q.html=q.html||{};q.html.fileLoader={};q.html.fileLoader.load=function(url,preLoadAction,postLoadHandler,parentNode,async,attributes){var scriptEl,preLoadResult,loadError,doPostLoad,loaded;loaded=false;doPostLoad=function(loadFailed){return function(){if(!loaded){loaded=true;if(loadFailed&&!loadError){loadError={url:document.location.href}}postLoadHandler(url,loadError,loadFailed)}}};try{if(preLoadAction){preLoadResult=preLoadAction(url)}}catch(e){preLoadResult=false;postLoadHandler(url,"Exception loading pre",true)}finally{if(preLoadResult!==false){scriptEl=q.html.fileLoader.createScriptEl(url,async,false,attributes);if(postLoadHandler){scriptEl.onload=doPostLoad(false);scriptEl.onerror=doPostLoad(true);scriptEl.onreadystatechange=function(){if((this.readyState==="complete")||(this.readyState==="loaded")){setTimeout(function(){doPostLoad(false)()},1)}}}if(!parentNode){parentNode=window.document.getElementsByTagName("head")[0]}parentNode.appendChild(scriptEl)}}};q.html.fileLoader.createScriptEl=function(path,async,forceReload,attr){var a,scriptEl=document.createElement("script");scriptEl.type="text/javascript";scriptEl.src=q.html.fileLoader.tidyUrl(path)+(forceReload?("?"+new Date().getTime()):"");if(async!==false){scriptEl.async="true";scriptEl.defer="true"}else{scriptEl.async="false";if(scriptEl.async!==false){scriptEl.async=false}scriptEl.defer="false";if(scriptEl.defer!==false){scriptEl.defer=false}}for(a in attr){if(attr.hasOwnProperty(a)){scriptEl.setAttribute(a,attr[a])}}return scriptEl};q.html.fileLoader.tidyUrl=function(path){if(path.substring(0,5)==="http:"){return path}if(path.substring(0,6)==="https:"){return path}return"//"+path};(function(){var Utils=qubit.opentag.Utils;var counter=0;var filters=[];function BaseFilter(config){this.log=new qubit.opentag.Log("",function(){return this.CLASS_NAME+"["+this.config.name+"]"}.bind(this),"collectLogs");this.config={order:0,include:true,name:"Filter-"+(counter++),script:undefined,session:undefined};this.session=null;if(config){for(var prop in config){if(config.hasOwnProperty(prop)){this.config[prop]=config[prop]}}if(config.session){this.setSession(config.session)}this.register(this)}}qubit.Define.clazz("qubit.opentag.filter.BaseFilter",BaseFilter);BaseFilter.state={DISABLED:-3,SESSION:-2,PASS:-1,FAIL:0};BaseFilter.prototype.reset=function(){this.enable()};BaseFilter.prototype.disable=function(){this.config.disabled=true};BaseFilter.prototype.enable=function(){this.config.disabled=false};BaseFilter.prototype.match=function(){return true};BaseFilter.prototype.setSession=function(session){this.session=session};BaseFilter.prototype.getSession=function(){return this.session};BaseFilter.prototype.getState=function(){var passed=BaseFilter.state.PASS;if(this.config.disabled){return BaseFilter.state.DISABLED}if(this.config.script){passed=this.config.script.call(this,passed)}if(isNaN(+passed)){this.log.WARN("filters should use a numerical state as a return for getState(): BaseFilter.state. Filter will fail. Returned: "+passed);passed=BaseFilter.state.FAIL}this.lastState=+passed;return passed};BaseFilter.getFilters=function(){return filters};BaseFilter.prototype.register=function(){BaseFilter.register(this)};BaseFilter.register=function(filter){Utils.addToArrayIfNotExist(filters,filter)}}());(function(){var Define=qubit.Define;var PatternType={CONTAINS:"CONTAINS",MATCHES_EXACTLY:"MATCHES_EXACTLY",STARTS_WITH:"STARTS_WITH",ENDS_WITH:"ENDS_WITH",REGULAR_EXPRESSION:"REGULAR_EXPRESSION",ALL_URLS:"ALL_URLS"};Define.namespace("qubit.opentag.filter.pattern.PatternType",PatternType)}());(function(){var Utils=qubit.opentag.Utils;var BaseFilter=qubit.opentag.filter.BaseFilter;var Timed=qubit.opentag.Timed;var PatternType=qubit.opentag.filter.pattern.PatternType;function URLFilter(config){this._lockObject={};var defaultConfig={patternType:PatternType.CONTAINS,pattern:""};if(config){for(var prop in config){if(config.hasOwnProperty(prop)){defaultConfig[prop]=config[prop]}}}URLFilter.SUPER.call(this,defaultConfig)}qubit.Define.clazz("qubit.opentag.filter.URLFilter",URLFilter,BaseFilter);URLFilter.prototype.PATTERNS=PatternType;URLFilter.prototype.getURL=function(url){return url||Utils.getUrl()};URLFilter.prototype.match=function(url){url=this.getURL(url);var match=true;var pattern=this.config.pattern;switch(this.config.patternType){case PatternType.CONTAINS:match=(url.toLowerCase().indexOf(pattern.toLowerCase())>=0);break;case PatternType.MATCHES_EXACTLY:match=(url.toLowerCase()===this.config.pattern.toLowerCase());break;case PatternType.STARTS_WITH:match=(url.toLowerCase().indexOf(pattern.toLowerCase())===0);break;case PatternType.ENDS_WITH:match=((url.lastIndexOf(pattern.toLowerCase())+pattern.length)===url.length);break;case PatternType.REGULAR_EXPRESSION:match=new RegExp(pattern).test(url);break;case PatternType.ALL_URLS:match=true;break}Timed.maxFrequent(function(){this.log.FINEST("[ Filter "+this.config.name+"] Checking if patternType '"+this.config.patternType+"' match '"+pattern+"' pattern: "+(match?("Yes -> "+match):"No")+", include: "+(this.config.include))}.bind(this),1000,this._lockObject);return match}}());(function(){var BaseFilter=qubit.opentag.filter.BaseFilter;var URLFilter=qubit.opentag.filter.URLFilter;var Utils=qubit.opentag.Utils;var sessionVariableFilterCount=0;function Filter(config){var defaultConfig={};if(config){for(var prop in config){if(config.hasOwnProperty(prop)){if(prop==="customStarter"&&config[prop]){this.customStarter=config[prop]}else{if(prop==="customScript"&&config[prop]){this.customScript=config[prop]}}defaultConfig[prop]=config[prop]}}this.uid="f"+(sessionVariableFilterCount++)}this.tagsToRun=[];Filter.SUPER.call(this,defaultConfig)}qubit.Define.clazz("qubit.opentag.filter.Filter",Filter,URLFilter);Filter.prototype.customStarter=function(session,ready,tag){ready(false)};Filter.prototype.isSession=function(){if(this.config.sessionDisabled){return false}if(this.customStarter===null&&this.customScript===null){return false}return true};Filter.prototype.customScript=function(session){return true};Filter.prototype.match=function(url){var match=true;try{if(this.customScript){if(this._matchState===undefined){this._matchState=!!this.customScript(this.getSession())}match=this._matchState}}catch(ex){this.log.FINE("Filter match throws exception:"+ex);match=false}return match&&Filter.SUPER.prototype.match.call(this,url)};Filter.prototype.runTag=function(tag){Utils.addToArrayIfNotExist(this.tagsToRun,tag);if(!this.starterExecuted){if(!this._starterWasRun){this._starterWasRun=true;var callback=function(rerun){this.reRun=rerun;this.starterExecuted=new Date().valueOf();this._processQueuedTagsToRun()}.bind(this);if(this.customStarter){this.customStarter(this.getSession(),callback,tag)}else{Filter.prototype.customStarter.call(this,this.getSession(),callback,tag)}}}else{if(this.reRun===true){tag.run()}else{tag.runOnce()}}};Filter.prototype._processQueuedTagsToRun=function(){for(var i=0;i<this.tagsToRun.length;i++){var tag=this.tagsToRun[i];if(this.reRun===true){tag.run()}else{tag.runOnce()}}};Filter.prototype.getState=function(session){if(session){this.setSession(session)}var pass=Filter.SUPER.prototype.getState.call(this);if(pass===BaseFilter.state.DISABLED){return BaseFilter.state.DISABLED}if(pass===BaseFilter.state.PASS){if(this.isSession()){pass=BaseFilter.state.SESSION}}if(this.config.script){pass=this.config.script.call(this,pass,this.getSession())}this.lastState=pass;return pass};Filter.prototype.reset=function(){this._matchState=undefined;Filter.SUPER.prototype.reset.call(this);this._starterWasRun=undefined;this.starterExecuted=undefined;this.tagsToRun=[];this.reRun=undefined}}());q.html.GlobalEval={};q.html.GlobalEval.globalEval=function(src){if(window.execScript){window.execScript(src===""?" ":src)}else{var fn=function(){window["eval"].call(window,src)};fn()}};q.html.HtmlInjector={};q.html.HtmlInjector.inject=function(el,injectStart,str,cb,parentNode){var i,ii,d,scriptsRaw,scripts,script,contents;if(str.toLowerCase().indexOf("<script")>=0){d=document.createElement("div");d.innerHTML="a"+str;scriptsRaw=d.getElementsByTagName("script");scripts=[];for(i=0,ii=scriptsRaw.length;i<ii;i+=1){scripts.push(scriptsRaw[i])}contents=[];for(i=0,ii=scripts.length;i<ii;i+=1){script=scripts[i];var s={attributes:q.html.HtmlInjector.getAttributes(script)};if(script.src){s.src=script.src}else{s.script=script.innerHTML}contents.push(s);script.parentNode.removeChild(script)}if(d.innerHTML){if(d.innerHTML.length>0){d.innerHTML=d.innerHTML.substring(1)}}q.html.HtmlInjector.doInject(el,injectStart,d);q.html.HtmlInjector.loadScripts(contents,0,cb,el)}else{d=document.createElement("div");d.innerHTML=str;q.html.HtmlInjector.doInject(el,injectStart,d);if(cb){cb()}}};q.html.HtmlInjector.doInject=function(el,injectStart,d){if(d.childNodes.length>0){var fragment=document.createDocumentFragment();while(d.childNodes.length>0){fragment.appendChild(d.removeChild(d.childNodes[0]))}if(injectStart){q.html.HtmlInjector.injectAtStart(el,fragment)}else{q.html.HtmlInjector.injectAtEnd(el,fragment)}}};q.html.HtmlInjector.injectAtStart=function(el,fragment){if(el.childNodes.length===0){el.appendChild(fragment)}else{el.insertBefore(fragment,el.childNodes[0])}};q.html.HtmlInjector.injectAtEnd=function(el,fragment,counter){if(!counter){counter=1}if((el===document.body)&&(document.readyState!=="complete")&&(counter<50)){setTimeout(function(){q.html.HtmlInjector.injectAtEnd(el,fragment,counter+1)},100)}else{el.appendChild(fragment)}};q.html.HtmlInjector.loadScripts=function(contents,i,cb,parentNode){var ii,c,foundSrc=false;for(ii=contents.length;i<ii;i+=1){c=contents[i];if(c.src){foundSrc=true;break}else{q.html.GlobalEval.globalEval(c.script)}}if(foundSrc){q.html.fileLoader.load(c.src,null,function(){q.html.HtmlInjector.loadScripts(contents,i+1,cb,parentNode)},parentNode,false,c.attributes)}if(cb&&(i===ii)){cb()}};q.html.HtmlInjector.getAttributes=function(node){var a,aLength,attributes,val,name,map={};if(node){attributes=node.attributes;aLength=attributes.length;for(a=0;a<aLength;a++){val=attributes[a].value;name=attributes[a].name.toLowerCase();if((val!=="")&&((name==="id")||(name==="class")||(name==="charset")||(name.substr(0,5)==="data-"))){map[name]=val}}return map}};(function(){var log=new qubit.opentag.Log("TagsUtils -> ");var BaseFilter=qubit.opentag.filter.BaseFilter;var Utils=qubit.opentag.Utils;var HtmlInjector=q.html.HtmlInjector;var FileLoader=q.html.fileLoader;var Filter=qubit.opentag.filter.Filter;var TagsUtils=function(){};qubit.Define.clazz("qubit.opentag.TagsUtils",TagsUtils);var _bodyLoaded=false;TagsUtils.bodyLoaded=function(){if(_bodyLoaded){return true}_bodyLoaded=!!(document.body&&document.readyState!=="loading");return _bodyLoaded};TagsUtils.bodyAvailable=function(callback){return !!document.body};var loadedURLs={};var STATE={SUCCESS:"success",FAIL:"failure",INIT:"not started"};TagsUtils.loadScript=function(config){var url=config.url;var loadingCheck=function(passedUrlFromLoader,loadError,loadFailed){loadedURLs[url].error=loadError;if(loadFailed){log.ERROR("Loading process error:");log.ERROR(loadError,true);loadedURLs[url].state=STATE.FAIL;config.onerror()}else{loadedURLs[url].state=STATE.SUCCESS;config.onsuccess()}};if(loadedURLs[url]){if(config.noMultipleLoad){log.FINE(url+" is already loaded, with state: "+loadedURLs[url].state);return loadingCheck(url,loadedURLs[url].error,loadedURLs[url].state===STATE.FAIL)}loadedURLs[url].count+=1}else{loadedURLs[url]={count:1,state:null}}var useWrite=!config.async;var loaded=TagsUtils.bodyLoaded();if(useWrite&&loaded){log.WARN("Script configured for synchronous injection while document seems to be already loaded. Secure option applies. Script will be appended in standard way.")}useWrite=useWrite&&!loaded;if(useWrite){log.WARN("Adding script element by using document.write. IE will error check fail broken url's.");TagsUtils.writeScriptURL(url,function(allOk,error){loadingCheck(url,error,!allOk)})}else{FileLoader.load(url,false,loadingCheck,config.node,config.async)}};var redirectedDocWriteMethods=null;function saveDocWriteMethods(){redirectedDocWriteMethods=redirectedDocWriteMethods||{write:document.write,writeln:document.writeln}}function unlockDocWriteMethods(){document.write=redirectedDocWriteMethods.write;document.writeln=redirectedDocWriteMethods.writeln;redirectedDocWriteMethods=null}TagsUtils.redirectDocumentWritesToArray=function(array,log){var text=array;if(log){log.FINE("redirecting document.write methods...")}saveDocWriteMethods();document.write=function(t){text.push(t);if(log){log.FINE("Received call from document.write with:"+t)}};document.writeln=function(t){text.push(t);if(log){log.FINE("Received call from document.writeln with:"+t)}}};TagsUtils.flushDocWritesArray=function(array,location,append,log,cb){var el=location;if(el&&array){var flushed=array.splice(0,array.length);try{TagsUtils.injectHTML(el,append,flushed.join("\n"),cb||EMPTY_FUN);return true}catch(ex){if(log){log.ERROR("Loading html caused exception:"+ex)}}}else{var message="Flushing location not found!";if(log){log.ERROR(message)}return false}if(cb){cb()}return true};TagsUtils.unlockDocumentWrites=function(){if(redirectedDocWriteMethods){if(log){log.FINEST("Bringing back document.write")}unlockDocWriteMethods()}};var accessorBasePath=TagsUtils.prototype.PACKAGE_NAME+".TagsUtils._writeScriptURL_callbacks";var accesorBase={};qubit.Define.namespace(accessorBasePath,accesorBase,GLOBAL,true);var wsCounter=0;var startFrom=new Date().valueOf();TagsUtils.writeScriptURL=function(url,callback){var callName="_"+startFrom+"_"+wsCounter++;var accessorName=accessorBasePath+"."+callName;var called=false;accesorBase[callName]=function(error){if(called){return }called=true;if(error){callback(false,"error while loading script "+url)}else{callback(true)}accesorBase[callName]=undefined;delete TagsUtils.writeScriptURL.callbacks[callName]};var jsIE='if(this.readyState === "loaded" || this.readyState === "complete"){ try {'+accessorName+"(true)} catch (ex) {}}";var jsNonIE="try{"+accessorName+"(false)}catch(ex){}";var jsNonIEerr="try{"+accessorName+"(true)}catch(ex){}";var scr="scr",value;url=FileLoader.tidyUrl(url);value="<"+scr+"ipt onload='"+jsNonIE+"'  onerror='"+jsNonIEerr+"' onreadystatechange='"+jsIE+"' type='text/javascript'  src='"+url+"'></"+scr+"ipt>";if(redirectedDocWriteMethods){unlockDocWriteMethods();document.write(value);saveDocWriteMethods()}else{document.write(value)}Utils.bodyReady(function(){if(!called){log.WARN("URL loaded but cannot tell if successful: "+url);called=true;callback(true)}})};TagsUtils.writeScriptURL.callbacks={};var SESSION=BaseFilter.state.SESSION;var PASS=BaseFilter.state.PASS;var FAIL=BaseFilter.state.FAIL;TagsUtils.filtersState=function(filters,session,tag,runLastSessionFilterIfPresent){filters=filters.sort(function(a,b){try{var bOrder=b.config.order;var aOrder=a.config.order;if(isNaN(-aOrder)){aOrder=0}if(isNaN(-bOrder)){bOrder=0}return bOrder-aOrder}catch(nex){return 0}});var decision=PASS;if(!filters||(filters.length===0)){return decision}var lastReadyToProcessFilter=null;var disabledFiltersPresent=false;var sessionFiltersPresent=false;var waitingResponse=0;var response;var lastSessionFilter;var sessionFiltersToRun=[];var filter;var lastUnmatched;for(var i=0;i<filters.length;i++){filter=filters[i];filter.setSession(session);if(filter.match()){response=filter.getState();if(response>0){if(waitingResponse===0||waitingResponse>response){waitingResponse=response}}else{if(response===BaseFilter.state.DISABLED){tag.log.WARN("filter with name "+filter.config.name+" is disabled");disabledFiltersPresent=true}else{if(response===SESSION){sessionFiltersPresent=true;lastReadyToProcessFilter=filter;lastSessionFilter=filter;sessionFiltersToRun.push(filter)}else{lastReadyToProcessFilter=filter}}}}else{lastUnmatched=filter}}var onlyAwaitingOrDisabledFiltersPresent=false;if(lastReadyToProcessFilter===null){onlyAwaitingOrDisabledFiltersPresent=true;if(!disabledFiltersPresent){decision=FAIL}else{decision=PASS}}else{if(lastReadyToProcessFilter.config.include){decision=response}else{decision=(response===PASS)?FAIL:PASS}}if(waitingResponse>0&&(decision===PASS||onlyAwaitingOrDisabledFiltersPresent)){decision=waitingResponse}if(decision===SESSION||((decision===PASS)&&sessionFiltersPresent)){if(!lastSessionFilter.config.include){return FAIL}decision=SESSION;if(lastSessionFilter instanceof Filter&&lastSessionFilter.isSession()){if(runLastSessionFilterIfPresent){for(var c=0;c<sessionFiltersToRun.length;c++){try{sessionFiltersToRun[c].runTag(tag)}catch(ex){sessionFiltersToRun[c].log.FINEST("trying custom starter failed:"+ex)}}}}}if(tag.config.dedupe&&decision===PASS){if(lastUnmatched&&lastUnmatched instanceof Filter&&lastUnmatched.isSession()){tag.sendDedupePing=true;decision=FAIL}}return decision};TagsUtils.injectHTML=function(location,append,html,callback){return HtmlInjector.inject(location,(!append)?1:0,html,callback||EMPTY_FUN)};TagsUtils.getHTMLLocationForTag=function(tag){var el;var name=tag.prepareLocationObject(tag.config.locationObject);switch(name){case"HEAD":el=document.getElementsByTagName("head")[0];break;case"BODY":el=document.body;break;default:if(name){el=document.getElementById(name)}else{el=document.body}}return el}})();(function(){var Utils=qubit.opentag.Utils;var Timed=qubit.opentag.Timed;var log=new qubit.opentag.Log("BaseVariable -> ");var BV_COUNTER=0;function BaseVariable(config){this.config={};this.handlers=[];this.log=new qubit.opentag.Log("",function(){return this.CLASS_NAME+"["+this.uniqueId+"]"}.bind(this),"collectLogs");this.parameters=null;this.callHandlersOnRead=false;if(config){this.uniqueId="BV"+BV_COUNTER++;BaseVariable.ALL_VARIABLES[this.uniqueId]=this;for(var prop in config){if(config.hasOwnProperty(prop)){this.config[prop]=config[prop];if(prop==="value"){this.value=config.value}}}var ret=BaseVariable.register(this);if(ret&&ret!==this){ret.log.FINEST("Variable config already registered.");ret.log.FINEST("Returning existing one.")}return ret}}qubit.Define.clazz("qubit.opentag.pagevariable.BaseVariable",BaseVariable);BaseVariable.ALL_VARIABLES={};var OBSERVED_VARIABLES=[];BaseVariable.OBSERVED_VARIABLES=OBSERVED_VARIABLES;BaseVariable.pageVariables=[];BaseVariable.register=function(variable){if(variable instanceof BaseVariable){for(var i=0;i<BaseVariable.pageVariables.length;i++){var regVar=BaseVariable.pageVariables[i];if(variable===regVar){return regVar}}BaseVariable.pageVariables.push(variable);return variable}return null};BaseVariable.prototype.getValue=function(){this._updateCurrentValue(this.value);return this.currentValue};BaseVariable.prototype._updateCurrentValue=function(newValue){if(!this.valuesAreEqual(newValue,this.currentValue)){this.oldValue=this.currentValue;this.currentValue=newValue;if(!observingStopped||this.callHandlersOnRead){this._handleValueChanged()}return true}return false};BaseVariable.prototype.getDefaultValue=function(){return this.defaultValue};BaseVariable.prototype.setDefaultValue=function(string){this.defaultValue=string};BaseVariable.prototype.exists=function(useDefaults){var exists=Utils.variableExists(this.getValue());if(useDefaults){exists=exists||Utils.variableExists(this.getDefaultValue())}return exists};BaseVariable.prototype.getRelativeValue=function(useDefaults,defaultValue){var pageValue=this.getValue();if(!Utils.variableExists(pageValue)){pageValue=defaultValue}var defLoc;if(useDefaults&&!Utils.variableExists(pageValue)){defLoc=this.getDefaultValue();if(Utils.variableExists(defLoc)){pageValue=defLoc}}return pageValue};BaseVariable.prototype.replaceToken=function(token,string,altValue,useExpressionAccessor){var exists=this.exists();var value=exists?this.getValue():altValue;token="\\$\\{"+token+"\\}";if((useExpressionAccessor||(value instanceof Array))){var acessorString;if(exists){acessorString=this.getValueAccessorString()}else{acessorString=Utils.getAnonymousAcessor(value)}return string.replace(new RegExp(token,"g"),acessorString)}else{return string.replace(new RegExp(token,"g"),value)}};BaseVariable.prototype.getAccessorString=function(){return"qubit.opentag.pagevariable.BaseVariable.ALL_VARIABLES."+this.uniqueId};BaseVariable.prototype.getValueAccessorString=function(){return this.getAccessorString()+".getValue()"};BaseVariable.prototype.onValueChanged=function(callback,startObserving){if(Utils.addToArrayIfNotExist(this.handlers,callback)===-1){this.log.FINE("Attached value changed handler: "+callback)}if(startObserving!==false){this.startObservingForChanges()}};BaseVariable.prototype.deatchOnValueChanged=function(callback){if(Utils.removeFromArray(this.handlers,callback)>0){this.log.FINE("Dettached value changed handler: "+callback)}};BaseVariable.prototype._handleValueChanged=function(){var event={oldValue:this.oldValue,newValue:this.currentValue,variable:this};for(var i=0;i<this.handlers.length;i++){try{this.handlers[i](event)}catch(e){this.log.ERROR("Error while calling qprotocol variable change handler: "+e)}}};var observingStopped=true;BaseVariable.CHECK_POLL_RATE=333;function checkIfChangedAndContinue(parameters){if(observingStopped){return false}for(var i=0;i<OBSERVED_VARIABLES.length;i++){try{var variable=OBSERVED_VARIABLES[i];variable.getValue()}catch(ex){log.ERROR("Value change update exception: "+ex)}}Timed.setTimeout(checkIfChangedAndContinue,BaseVariable.CHECK_POLL_RATE);return true}BaseVariable.prototype.startObservingForChanges=function(){this.addToObservedVariables();observingStopped=false;checkIfChangedAndContinue()};BaseVariable.prototype.stopObservingForChanges=function(){this.removeFromObservedVariables();if(OBSERVED_VARIABLES.length===0){observingStopped=true}};BaseVariable.prototype.addToObservedVariables=function(){Utils.addToArrayIfNotExist(OBSERVED_VARIABLES,this)};BaseVariable.prototype.removeFromObservedVariables=function(){Utils.removeFromArray(OBSERVED_VARIABLES,this)};BaseVariable.prototype.getObservedVariables=function(){return OBSERVED_VARIABLES};BaseVariable.prototype.valuesAreEqual=function(a,b){return a===b}}());(function(){var Utils=qubit.opentag.Utils;var Timed=qubit.opentag.Timed;function Expression(config){this._lockExprObject={};Expression.SUPER.apply(this,arguments)}qubit.Define.clazz("qubit.opentag.pagevariable.Expression",Expression,qubit.opentag.pagevariable.BaseVariable);Expression.prototype.getValue=function(){var ret;var error;var value=this.value;try{if(value&&value.indexOf("[#]")===-1){var tmp=Utils.gevalAndReturn(value);ret=tmp.result;this.failMessage=null;error=tmp.error}else{ret=Expression.parseUVArray(value)}}catch(e){error=e}if(error){var msg="could not read value of expression: \n"+value+"\nexact cause: "+error;if(this.failMessage!==msg){this.failMessage=msg}ret=null}var differs=this._updateCurrentValue(ret);if(differs){Timed.maxFrequent(function(){if(this.failMessage){this.log.FINEST(this.failMessage)}this.log.FINEST("getting value from expression: "+ret)}.bind(this),10000,this._lockExprObject)}return ret};Expression.parseUVArray=function(uv){var parts=uv.split("[#]");var array=Utils.gevalAndReturn(parts[0]).result;var collection=[];var pathOfElements=parts[1];if(pathOfElements.indexOf(".")===0){pathOfElements=pathOfElements.replace(".","")}for(var i=0;i<array.length;i++){var element=Utils.getObjectUsingPath(pathOfElements,array[i]);collection.push(element)}return collection};Expression.prototype.replaceToken=function(token,string,altValue,exp){if((this.getValue() instanceof Array)){exp=true}return Expression.SUPER.prototype.replaceToken.call(this,token,string,altValue,exp)}}());(function(){var Utils=qubit.opentag.Utils;function DOMText(config){DOMText.SUPER.apply(this,arguments)}qubit.Define.clazz("qubit.opentag.pagevariable.DOMText",DOMText,qubit.opentag.pagevariable.BaseVariable);DOMText.prototype.getValue=function(){this.log.FINEST("reading DOM element contents value");var val=Utils.getElementValue(this.value);this._updateCurrentValue(val);return val}}());(function(){var Timed=qubit.opentag.Timed;function Cookie(config){Cookie.SUPER.apply(this,arguments);this._lockObject={}}qubit.Define.clazz("qubit.opentag.pagevariable.Cookie",Cookie,qubit.opentag.pagevariable.BaseVariable);Cookie.prototype.getValue=function(){var val=qubit.Cookie.get(this.value);Timed.maxFrequent(function(){this.log.FINEST("reading cookie value: "+val)}.bind(this),2000,this._lockObject);this._updateCurrentValue(val);return val}}());(function(){var Utils=qubit.opentag.Utils;function URLQuery(config){URLQuery.SUPER.apply(this,arguments)}qubit.Define.clazz("qubit.opentag.pagevariable.URLQuery",URLQuery,qubit.opentag.pagevariable.BaseVariable);URLQuery.prototype.getValue=function(){var val=Utils.getQueryParam(this.value);this._updateCurrentValue(val);return val}}());(function(){var Utils=qubit.opentag.Utils;var TagsUtils=qubit.opentag.TagsUtils;var Timed=qubit.opentag.Timed;var BaseVariable=qubit.opentag.pagevariable.BaseVariable;var Expression=qubit.opentag.pagevariable.Expression;var UniversalVariable=qubit.opentag.pagevariable.UniversalVariable;var DOMText=qubit.opentag.pagevariable.DOMText;var Cookie=qubit.opentag.pagevariable.Cookie;var URLQuery=qubit.opentag.pagevariable.URLQuery;function TagHelper(){}qubit.Define.clazz("qubit.opentag.TagHelper",TagHelper);TagHelper.injectHTMLForLoader=function(tag,callback,tryWrite,altHtml){var html=(altHtml!==undefined)?altHtml:tag.getHtml();if(html){var append=(tag.config.locationPlaceHolder==="END");var location=TagsUtils.getHTMLLocationForTag(tag);tag.log.FINE("injecting html into page:");tag.log.FINE(html);tag.injectHTMLNotFinished=true;try{if(location){TagsUtils.injectHTML(location,append,html,function(){tag.log.FINE("finished html injection.");tag.injectHTMLNotFinished=false;if(callback){try{callback()}catch(e){tag.log.ERROR("error while trying to run callback after html injection: "+e)}}}.bind(tag))}else{if(tryWrite&&document.readyState==="loading"){document.write(html);tag.injectHTMLNotFinished=false}else{tag.injectHTMLFailed=new Date().valueOf();tag.log.ERROR("location was not found or/and html is told to not to write at runtime or document is already loaded. Please check tag's configuration. Injection cancelled.")}}}catch(ex){tag.injectHTMLNotFinished=false;tag.injectHTMLFailed=new Date().valueOf();tag.log.ERROR("error while trying to inject html: "+ex)}}};function findParamatersForVariable(tag,varRef){var ret=[];try{var params=tag.parameters;if(params){for(var i=0;i<params.length;i++){if(tag.getVariableForParameter(params[i])===varRef){ret.push(params[i])}}}}catch(ex){}return ret}TagHelper.getAllVariablesWithParameters=function(tag){var vars=tag.getPageVariables();var results=[];for(var i=0;i<vars.length;i++){var pageVar=vars[i];var parameters=findParamatersForVariable(tag,pageVar);for(var j=0;j<parameters.length;j++){results.push({parameter:parameters[j],variable:pageVar})}}return results};var _lock_obj={};TagHelper.allParameterVariablesReadyForTag=function(tag,tryDefaults){var useDefaults=tryDefaults;var log=tag.log;var allReady=true;var vars=tag.getPageVariables();for(var i=0;i<vars.length;i++){var pageVar=vars[i];try{var parameters=findParamatersForVariable(tag,pageVar);var exist=pageVar.exists();if(!exist&&useDefaults){if(parameters.length>0){exist=!!parameters[0].defaultValue}exist=exist||pageVar.exists(true)}var name=pageVar.config.name?pageVar.config.name:"[unnamed]";Timed.maxFrequent(function(){log.FINEST("Variable '"+name+"' exists? "+exist)},5000,_lock_obj);if(!exist){allReady=false;break}}catch(ex){Timed.maxFrequent(function(){log.ERROR("Error checking variable existence ");log.ERROR([pageVar,ex])},5000,_lock_obj);allReady=false;break}}if(allReady&&!_lock_obj.alreadyNotified){_lock_obj={};_lock_obj.alreadyNotified=true}Timed.maxFrequent(function(){log.FINEST("Checking page variables, variables are ready: "+allReady);if(!allReady){log.FINE("Variables not ready, waiting...")}else{_lock_obj.clear=true;log.FINE("Variables ready.")}},2000,_lock_obj);return allReady};var JS_VALUE="2";var QUERY_PARAM="3";var COOKIE_VALUE="4";var ELEMENT_VALUE="5";TagHelper.validateAndGetVariableForParameter=function(param){if(param.hasOwnProperty("variable")&&param.variable){param.variable=TagHelper.initPageVariable(param.variable)}return param.variable};TagHelper.initPageVariable=function(cfg){if(!cfg||cfg instanceof BaseVariable){return cfg}if(typeof (cfg)==="string"){var tmp=Utils.getObjectUsingPath(cfg);if(tmp&&tmp instanceof BaseVariable){return tmp}}switch(cfg.type){case JS_VALUE:return new Expression(cfg);case QUERY_PARAM:return new URLQuery(cfg);case COOKIE_VALUE:return new Cookie(cfg);case ELEMENT_VALUE:return new DOMText(cfg);case"EPRESSION":return new Expression(cfg);case"URL_PARAMETER":return new URLQuery(cfg);case"COOKIE_VALUE":return new Cookie(cfg);case"DOM_VALUE":return new DOMText(cfg);default:return new BaseVariable(cfg)}}}());(function(){var Define=qubit.Define;var Utils=qubit.opentag.Utils;function Events(config){this.log=new qubit.opentag.Log("Events -> ");this.calls={}}Events.prototype.on=function(name,call){if(!this.calls[name]){this.calls[name]=[]}return Utils.addToArrayIfNotExist(this.calls[name],call)};Events.prototype.call=function(name,event){var calls=this.calls[name];if(calls){for(var i=0;i<calls.length;i++){try{calls[i](event)}catch(ex){this.log.ERROR("Error while running event: "+ex)}}}};Events.prototype.remove=function(name,call){if(this.calls[name]){return Utils.removeFromArray(this.calls[name],call)}return null};Events.prototype.removeAll=function(call){var total=0;for(var prop in this.calls){if(this.calls.hasOwnProperty(prop)){total+=Utils.removeFromArray(this.calls[prop],call)}}return total};Events.prototype.clear=function(){this.calls={}};Define.clazz("qubit.Events",Events)})();(function(){var Utils=qubit.opentag.Utils;var TagsUtils=qubit.opentag.TagsUtils;var Timed=qubit.opentag.Timed;var TagHelper=qubit.opentag.TagHelper;var nameCounter=0;var Log=qubit.opentag.Log;var AFTER_EVENT="after";var BEFORE_EVENT="before";function GenericLoader(config){this.log=new Log("",function(){return this.CLASS_NAME+"["+this.config.name+"]"}.bind(this),"collectLogs");this.urlsLoaded=0;this.urlsFailed=0;this.runCounter=0;this.events=new qubit.Events({});this._depLoadedHandler=function(){if(this.dependenciesLoaded()&&this.awaitingDependencies){this.log.FINE("All dependencies has run successfuly. Triggering load.");this._triggerLoadingAndExecution()}}.bind(this);this.config={name:"Tag-"+nameCounter++,async:true,usesDocumentWrite:false,timeout:this.LOADING_TIMEOUT,dependencies:[],url:null,urlLocation:null,locationPlaceHolder:"END",locationObject:null,dontWaitForInjectionLocation:false,noMultipleLoad:false,loadDependenciesOnLoad:false};this.delayDocWrite=false;this.dependencies=[];this._lockObject={count:0};this._lockObjectDepsLoaded={};this.genericDependencies=[];if(config){this.log.FINE("instance...");if(!config.name){var n="Tag-"+nameCounter++;this.config.name=n;this.log.WARN("Name was not specified for tag. Assigning auto: "+n)}this.addState("INITIAL");for(var prop in config){this.config[prop]=config[prop]}if(config.genericDependencies){this.genericDependencies=this.genericDependencies.concat(config.genericDependencies)}if(config.dependencies){this.dependencies=config.dependencies.concat(this.dependencies)}if(config.PACKAGE){this._package=config.PACKAGE}this.onInit()}}qubit.Define.clazz("qubit.opentag.GenericLoader",GenericLoader);GenericLoader.prototype.onInit=EMPTY_FUN;GenericLoader.prototype.LOADING_TIMEOUT=5*1000;GenericLoader.prototype.getHtml=function(){if(this.config.html){return this.config.html}if(this.htmlContent){return Utils.trim(this.htmlContent)}return null};GenericLoader.prototype._executeScript=function(){var success=false;try{this.script();success=true}catch(ex){this.addState("EXECUTED_WITH_ERRORS");this.executedWithErrors=new Date().valueOf();this.log.ERROR("Error while executing: "+ex);this.log.ERROR("There was an error while executing instance of tag: "+this.CLASS_NAME+" from package: "+this.PACKAGE_NAME);this.log.ERROR(ex,true);this._onError(ex)}finally{this._onExecute(success)}};GenericLoader.prototype.getTimeout=function(){return this._getTimeout()};GenericLoader.prototype._getTimeout=function(chain){var tout=+this.config.timeout;var deps=this.dependencies;if(tout!==-1&&deps.length>0){var max=0;chain=chain||[];var present=(Utils.indexInArray(chain,this)!==-1);if(!present){chain[chain.length]=this;for(var i=0;i<deps.length;i++){var val=deps[i]._getTimeout(chain);if(val>max){max=val}}if(max>0){tout+=max}}else{return 0}}return tout};GenericLoader.prototype._onExecute=function(noErrors){this.onExecute(noErrors)};GenericLoader.prototype.onExecute=EMPTY_FUN;GenericLoader.prototype._flushDocWrites=function(cb){var ret=true;this._docWriteNotFlushed=false;try{var loc=TagsUtils.getHTMLLocationForTag(this);if(loc&&this._securedWrites&&this._securedWrites.length>0){this.log.FINE("flushing document.write proxy array");this.log.FINE("flushing: "+this._securedWrites.join("\n"));var append=(this.config.locationPlaceHolder==="END");ret=TagsUtils.flushDocWritesArray(this._securedWrites,loc,append,this.log,cb);if(ret){this._docWriteFlushed=new Date().valueOf()}else{this._docWriteNotFlushed=new Date().valueOf()}}}catch(ex){this.log.ERROR("Unexpected exception during flushing! "+ex);this._onError(ex)}if(cb){cb()}if(this._securedWrites&&this._securedWrites.length>0){ret=false;this._docWriteNotFlushed=new Date().valueOf()}return ret};GenericLoader.prototype.log=EMPTY_FUN;GenericLoader.prototype.finished=function(){return !!this.runIsFinished};GenericLoader.prototype.script=function(){};GenericLoader.prototype.before=function(){this.log.FINE("running before handler...");this.beforeRun=new Date().valueOf();try{this.events.call(BEFORE_EVENT,this)}catch(ex){this.log.ERROR("onBefore error: "+ex);this._onError(ex)}};GenericLoader.prototype.onBefore=function(callback){this.events.on(BEFORE_EVENT,callback)};GenericLoader.prototype.after=function(success){this.log.FINE("running after...");this.afterRun=new Date().valueOf();try{this.events.call(AFTER_EVENT,{success:success,tag:this})}catch(ex){this.log.ERROR("onAfter error: "+ex);this._onError(ex)}};GenericLoader.prototype.onAfter=function(callback){this.events.on(AFTER_EVENT,callback)};GenericLoader.prototype.runOnce=function(){if(!this._runOnceTriggered&&!this.scriptExecuted){this._runOnceTriggered=new Date().valueOf();this.run()}};GenericLoader.CANCEL_ALL=false;GenericLoader.prototype.run=function(){if(!isNaN(this.config.runningLimit)){if(this.config.runningLimit<=this.runCounter){this.log.FINE("running has been stopped as limit is reached.");return false}}if(this.cancelled||GenericLoader.CANCEL_ALL){this._handleCancel();return false}if(this.isRunning){this.log.FINE("loader is currently in progress, try again later.");return false}if(this.lastRun){this.log.FINE("Running again. Run count: "+(this.runCounter+1));this.reset()}this.lastRun=this.isRunning=new Date().valueOf();this.runCounter++;this._ignoreDeps=!!this.ignoreDependencies;if(!this._ignoreDeps&&!this.dependenciesLoaded()){this.log.FINE("Dependencies (other loaders) not ready. Attaching handlers.");this._attachDepsEventsToContinue();return false}return this._triggerLoadingAndExecution()};GenericLoader.prototype._triggerLoadingAndExecution=function(){this.awaitingDependencies=-new Date().valueOf();this.load();if(this._ignoreDeps){this.execute()}else{this.waitForDependenciesAndExecute()}return true};GenericLoader.prototype._attachDepsEventsToContinue=function(){this.log.FINE("Attaching success events to dependencies...");this.awaitingDependencies=new Date().valueOf();var deps=this.dependencies;for(var i=0;i<deps.length;i++){try{deps[i].events.on("success",this._depLoadedHandler)}catch(ex){this.log.WARN("Cannot set event for dependency -> ",deps[i]);this.log.WARN("Exception: ",ex)}}this.log.FINE("Attached "+deps.length+" handlers.")};GenericLoader.prototype.dependenciesLoaded=function(){var deps=this.dependencies;for(var i=0;i<deps.length;i++){if(deps[i]!==this){var executed=(+deps[i].scriptExecuted)>0;if(!executed){return false}}}return true};GenericLoader.prototype._setTimeout=function(fun,time){this._wasTimed=new Date().valueOf();return Timed.setTimeout(fun,time)};GenericLoader.prototype._handleCancel=function(){this.addState("CANCELLED");try{this.onCancel()}catch(ex){this.log.ERROR("Exception at onCancel"+ex);this._onError(ex)}};GenericLoader.prototype.waitForDependenciesAndExecute=function(){if(this.cancelled){this._handleCancel();return }if(this.loadedDependencies){this.execute()}else{if(this.loadingDependenciesFailed){this._markFailure();this._markFinished()}else{this._setTimeout(this.waitForDependenciesAndExecute.bind(this),30)}}};GenericLoader.prototype.execute=function(){this.log.FINE("entering execute...");this._triggerExecution()};GenericLoader.prototype._triggerExecution=function(){if(this.cancelled){this._handleCancel();return }if(this.scriptExecuted){return }var finished=true;if(this.shouldWaitForDocWriteProtection()){finished=false}else{if(!this._beforeEntered){this._beforeEntered=new Date().valueOf();var cancel=false;try{cancel=this.before()}catch(ex){this.log.ERROR("`before` thrown an exception");this.log.ERROR(ex,true);this._onError(ex)}if(cancel){this._markFailure();this._markFinished();return }}finished=this.loadExecutionURLsAndHTML(this._triggerExecution.bind(this))}if(this.scriptExecuted){return }if(this.unexpectedFail){finished=true}if(!finished){this._setTimeout(this._triggerExecution.bind(this),30)}else{this._flushDocWrites();if(this.scriptLoadingFailed||this.injectHTMLFailed||this.unexpectedFail){this._markFailure()}else{this.log.FINE("Executing...");this.scriptExecuted=new Date().valueOf();this.addState("EXECUTED");this._executeScript()}if(this.cancelled){this._handleCancel();return false}else{var successful=this.scriptExecuted>0;try{if(!this.afterRun){this.afterRun=new Date().valueOf();this.after(successful)}}catch(ex){this.executedWithErrors=new Date().valueOf()}if(!this.executedWithErrors){if(successful){this.events.call("success")}}}this._flushDocWrites();this._markFinished()}};GenericLoader.prototype._markFailure=function(){this.scriptExecuted=-(new Date().valueOf());this.addState("FAILED_TO_EXECUTE")};GenericLoader.prototype._markFinished=function(){this.runIsFinished=new Date().valueOf();this.isRunning=false;if(GenericLoader.LOCK_DOC_WRITE===this){this._flushDocWrites();TagsUtils.unlockDocumentWrites();GenericLoader.LOCK_DOC_WRITE=false}this.onFinished(true)};GenericLoader.prototype.onFinished=EMPTY_FUN;GenericLoader.prototype.onCancel=EMPTY_FUN;GenericLoader.prototype.onFinished=EMPTY_FUN;GenericLoader.prototype.shouldWaitForDocWriteProtection=function(){if(this.willSecureDocumentWrite()){if(!GenericLoader.LOCK_DOC_WRITE){GenericLoader.LOCK_DOC_WRITE=this;this._secureWriteAndCollectForExecution()}else{if(GenericLoader.LOCK_DOC_WRITE!==this){if(!this._lockedDocWriteInformed){this._lockedDocWriteInformed=new Date().valueOf();this.log.WARN("Tag will wait till document.write be available.");this.log.FINE(GenericLoader.LOCK_DOC_WRITE,true)}return true}}}return false};GenericLoader.prototype.runWithoutDependencies=function(){this.ignoreDependencies=true;this.run()};GenericLoader.prototype.loadExecutionURLsAndHTML=function(callback){if(this.cancelled){this._handleCancel();return true}if(!this._loadExecutionURLsAndHTMLInformed){this._loadExecutionURLsAndHTMLInformed=true}this._triggerURLsLoading(callback);if(!this.loadURLsNotFinished){this._flushDocWrites();this._triggerHTMLInjection();this._flushDocWrites();if(!this.injectHTMLNotFinished){this._flushDocWrites();if(!this._docWriteNotFlushed){if(this._docWriteFlushed){}return true}}}return false};GenericLoader.prototype._triggerURLsLoading=function(callback){if(!this._urlLoadTriggered&&this.config.url){this._urlLoadTriggered=true;this.loadURLs(false,callback)}};GenericLoader.prototype._triggerHTMLInjection=function(){if(!this._injectHTMLTriggered&&this.getHtml()){this._injectHTMLTriggered=true;this.log.FINE("tag has html option set to: "+this.getHtml());this.injectHTML()}};GenericLoader.prototype.STATE={INITIAL:0,STARTED:1,LOADING_DEPENDENCIES:2,LOADED_DEPENDENCIES:4,LOADING_URL:8,LOADED_URL:16,EXECUTED:32,EXECUTED_WITH_ERRORS:64,FAILED_TO_LOAD_DEPENDENCIES:128,FAILED_TO_LOAD_URL:256,FAILED_TO_EXECUTE:512,TIMED_OUT:1024,UNEXPECTED_FAIL:2048,CANCELLED:2048*2};GenericLoader.prototype.addState=function(stateName){if(this.STATE.hasOwnProperty(stateName)){this.state=(this.state|this.STATE[stateName]);try{this.onStateChange(stateName)}catch(ex){this.log.ERROR(ex);this._onError(ex)}}};GenericLoader.prototype.onStateChange=EMPTY_FUN;GenericLoader.prototype.cancel=function(){this.cancelled=new Date().valueOf()};GenericLoader.prototype.unCancel=function(){this.cancelled=undefined};GenericLoader.prototype.state=GenericLoader.prototype.STATE.INITIAL;GenericLoader.prototype._markLoadedSuccesfuly=function(){this.loadedDependencies=new Date().valueOf();this.onAllDependenciesLoaded()};GenericLoader.prototype._secureWriteAndCollectForExecution=function(){if(!this._securedWrites){this._securedWrites=[];TagsUtils.redirectDocumentWritesToArray(this._securedWrites,this.log)}};function _waitForDependencies(){if(this.cancelled){this._handleCancel();return }this.waitForDependenciesFinished=new Date().valueOf();var fullBodyNeededAndUnLoaded=this._fullBodyNeededAndUnLoaded();var interactiveBodyNeededButNotReady=this._bodyNeededButNotAvailable();if(fullBodyNeededAndUnLoaded||interactiveBodyNeededButNotReady){this.waitForDependenciesFinished=false}else{if(!this.timeoutCountdownStart){this.timeoutCountdownStart=new Date().valueOf()}if(this.allDependenciesLoaded()){this._markLoadedSuccesfuly()}else{if(this._loadingOutOfTimeFrames()){this.loadingTimedOut=new Date().valueOf();if(this.allDependenciesLoaded(true)){this._markLoadedSuccesfuly()}else{this.log.WARN("timed out while loading dependencies.");this.addState("TIMED_OUT");this._markLoadingDependenciesFailed();this._triggerOnLoadTimeout()}}else{this.waitForDependenciesFinished=false}}}if(!this.waitForDependenciesFinished){this._setTimeout(_waitForDependencies.bind(this),65);var diff=(new Date().valueOf()-this.loadStarted);var freq=3000;var curr=diff/this.getTimeout();var steps=Math.ceil(this.getTimeout()/freq);this._lockObject.curr=curr;Timed.maxFrequent(function(){if(fullBodyNeededAndUnLoaded){this.log.FINE("Full body needed. Waiting for full body.")}if(interactiveBodyNeededButNotReady){this.log.FINE("Interactive body needed. Waiting for body.")}this.log.FINE("Waiting for dependencies, counting... "+this._lockObject.count+++" ("+steps+")")}.bind(this),freq,this._lockObject)}else{this.addState("LOADED_DEPENDENCIES")}}GenericLoader.prototype._markLoadingDependenciesFailed=function(){this.addState("FAILED_TO_LOAD_DEPENDENCIES");this.loadingDependenciesFailed=new Date().valueOf()};GenericLoader.prototype.allDependenciesLoaded=function(tryDefaults,arrayToAdd){return this.getDependenciesToBeLoaded(tryDefaults,arrayToAdd).length===0};GenericLoader.prototype.getDependenciesToBeLoaded=function(tryDefaults,arrayToAdd){var failures=arrayToAdd||[];if(!this.injectionLocationReady()){failures.push("injection location")}var i;var deps=this.dependencies;for(i=0;i<deps.length;i++){if(deps[i]!==this){var executed=(+deps[i].scriptExecuted)>0;if(!executed){var name=deps[i].config?deps[i].config.name:"anonymous";failures.push("dependant Tag with name -> "+name)}}}for(i=0;i<this.genericDependencies.length;i++){var ready=this.genericDependencies[i](this);if(!ready){failures.push("this.genericDependencies["+i+"] (index: "+i+")")}}if(failures!==""){Timed.maxFrequent(function(){var awaitingList=failures.join(", ");if(awaitingList){this.log.FINE("Dependencies check: Waiting for: "+awaitingList)}else{this.log.FINE("Dependencies check: No basic dependencies.")}}.bind(this),5000,this._lockObjectDepsLoaded)}return failures};GenericLoader.prototype.docWriteAsksToWaitForBody=function(){return !!(this.delayDocWrite&&this.config.usesDocumentWrite)};GenericLoader.prototype._bodyNeededButNotAvailable=function(){if(this._dontWaitForInjections()){return false}return this._isBodyLocationNeeded()&&!TagsUtils.bodyAvailable()};GenericLoader.prototype._isBodyLocationNeeded=function(){if(!this.isLoadingAsynchronously()){return false}if(this._isBodyLocationSet()){return true}else{var atHead=(this.config.locationObject==="HEAD");return atHead&&(this.config.locationPlaceHolder==="END")}};GenericLoader.prototype._isBodyLocationSet=function(){var locObj=this.config.locationObject;return !locObj||(locObj==="BODY")};GenericLoader.prototype._fullBodyNeededAndUnLoaded=function(){if(this._dontWaitForInjections()){return false}var needed=false;if(this._isBodyLocationNeeded()){needed=(this.config.locationPlaceHolder==="END")}needed=needed||(this.fullbodyNeeded||this.docWriteAsksToWaitForBody());return needed&&!Utils.bodyReady()};GenericLoader.prototype._dontWaitForInjections=function(){return this.config.dontWaitForInjectionLocation||this.dontWaitForInjectionLocation||GenericLoader.dontWaitForInjectionLocation};GenericLoader.prototype.injectionLocationReady=function(){if(this._dontWaitForInjections()){return true}if(this._fullBodyNeededAndUnLoaded()){return false}if(!this.isLoadingAsynchronously()){return true}return !!TagsUtils.getHTMLLocationForTag(this)};GenericLoader.prototype._loadingOutOfTimeFrames=function(){if(this.getTimeout()<0){return false}return(new Date().valueOf()-this.timeoutCountdownStart)>this.getTimeout()};GenericLoader.prototype.loadDependencies=function(){this._loadDependencies()};GenericLoader.prototype.addClientDependenciesList=function(array,ns){return this.addDependenciesList(array,qubit.Define.clientSpaceClasspath())};GenericLoader.prototype.addDependenciesList=function(array,ns){if(!array||array.length===0){return }if(!this.failedDependenciesToParse){this.failedDependenciesToParse=[]}var dependencies=this.dependencies;for(var i=0;i<array.length;i++){var item=array[i];var bad=false;if(item instanceof GenericLoader){dependencies.push(item)}else{if(typeof (item)==="string"){var original=item;if(ns){item=ns+"."+item}var obj=Utils.getObjectUsingPath(item);if(obj){if(obj instanceof GenericLoader){dependencies.push(obj)}else{bad=true}}else{this.failedDependenciesToParse.push(original)}}else{bad=true}}if(bad){this.log.WARN("Bad object type passed to deps, ignoring.");this.badDepsObjects=this.badDepsObjects||[];Utils.addToArrayIfNotExist(this.badDepsObjects,item)}}};GenericLoader.prototype._loadDependencies=function(chain){chain=chain||[];var deps=this.dependencies;var present=Utils.indexInArray(chain,this)!==-1;if(!present){chain[chain.length]=this;for(var i=0;i<deps.length;i++){deps[i].load(chain)}}};GenericLoader.prototype.onError=EMPTY_FUN;GenericLoader.prototype._onError=function(msg){try{this.onError(msg)}catch(ex){}};GenericLoader.prototype._triggerOnLoadTimeout=function(){this.onLoadTimeout()};GenericLoader.prototype.onLoadTimeout=EMPTY_FUN;GenericLoader.prototype.onScriptsLoadSuccess=EMPTY_FUN;GenericLoader.prototype.onScriptLoadError=EMPTY_FUN;GenericLoader.prototype.onAllDependenciesLoaded=EMPTY_FUN;GenericLoader.prototype.onBeforeLoad=null;GenericLoader.prototype.load=function(){if(this.loadStarted){return }else{this.loadStarted=new Date().valueOf();try{if(this.onBeforeLoad){this.onBeforeLoad()}}catch(ex){this.log.ERROR("onBeforeLoad error: "+ex);this._onError(ex)}}this.addState("LOADING_DEPENDENCIES");try{if(!this._ignoreDeps&&this.config.loadDependenciesOnLoad){this.loadDependencies()}}catch(ex){this.log.ERROR("loadDependencies: unexpected exception occured: \n"+ex+"\ntrying to finish... ");throw ex}_waitForDependencies.call(this)};GenericLoader.prototype._singleUrlLoadHandler=function(success,urls,callback){++this.urlsLoaded;if(!success){++this.urlsFailed}if(this.urlsLoaded===urls.length){this.loadURLsNotFinished=false;if(success&&this.urlsFailed===0){this.addState("LOADED_URL");this.urlsLoaded=new Date().valueOf();try{if(callback){callback(true)}}catch(ex){this.log.ERROR("Callback error:"+ex);this._onError(ex)}finally{this.onScriptsLoadSuccess()}}else{var message="error loading urls. Failed "+this.urlsFailed;this.log.ERROR(message);this._onError(message);this.addState("FAILED_TO_LOAD_URL");this.urlsLoaded=-new Date().valueOf();try{this.scriptLoadingFailed=true;if(callback){callback(false)}}catch(ex){this.log.ERROR("Callback error:"+ex);this._onError(ex)}finally{this.onScriptLoadError(message)}}}};GenericLoader.prototype.loadURLs=function(urlz,callback){var urls=urlz||this.config.url;this.addState("LOADING_URL");this.log.FINE("loading URL(s) ...");try{if(urls&&!(urls instanceof Array)){urls=[urls]}for(var i=0;i<urls.length;i++){this.loadURLsNotFinished=true;var url=urls[i];url=this.prepareURL(url);this.log.FINE("loading URL: "+url+" ...");this.loadURL(url,function(success){this._singleUrlLoadHandler(success,urls,callback)}.bind(this))}}catch(ex){this.log.ERROR("loadURLs thrown unexpected exception! : "+ex);this.loadURLsNotFinished=false;this.addState("UNEXPECTED_FAIL");this.unexpectedFail=new Date().valueOf();this._onError(ex)}};GenericLoader.prototype.prepareLocationObject=function(loc){return loc};GenericLoader.prototype.prepareURL=function(url){return url};GenericLoader.prototype.prepareHTML=function(html){return html};GenericLoader.prototype.loadURL=function(url,callback,location){var passedUrl=url;this.addState("LOADING_URL");TagsUtils.loadScript({onsuccess:function(){this.log.FINE("succesfully loaded "+passedUrl);try{if(callback){callback(true)}}catch(ex){this.log.ERROR("error at callback for "+passedUrl+":"+ex)}}.bind(this),onerror:function(){this.log.ERROR("error loading "+passedUrl);try{if(callback){callback(false)}}catch(ex){this.log.ERROR("error at callback for error at "+passedUrl+":"+ex)}}.bind(this),url:passedUrl,node:location||this.config.urlLocation,async:this.isLoadingAsynchronously(),noMultipleLoad:this.config.noMultipleLoad})};GenericLoader.prototype.reset=function(){this.log.FINE("resetting.");var u;this._injectHTMLTriggered=u;this._loadExecutionURLsAndHTMLInformed=u;this._lockedDocWriteInformed=u;this._runOnceTriggered=u;this._urlLoadTriggered=u;this.afterRun=u;this.beforeRun=u;this.filtersRunTriggered=u;this.injectHTMLFailed=u;this.loadStarted=u;this.loadURLsNotFinished=u;this.loadedDependencies=u;this.loadingDependenciesFailed=u;this.loadingTimedOut=u;this.runIsFinished=u;this.scriptExecuted=u;this.scriptLoadingFailed=u;this.delayDocWrite=u;this._securedWrites=u;this.state=0;this.unexpectedFail=u;this.urlsFailed=0;this.urlsLoaded=0;this.waitForDependenciesFinished=u;this.isRunning=u;this._lastRun=u;this.cancelled=u;this._beforeEntered=u;this.awaitingDependencies=u;this.timeoutCountdownStart=u;this.addState("INITIAL")};GenericLoader.prototype.isLoadingAsynchronously=function(){if(this._wasTimed){return true}return !!(this.config.async||this.forceAsynchronous)};GenericLoader.prototype.willSecureDocumentWrite=function(){return(this.config.usesDocumentWrite&&this.isLoadingAsynchronously())};GenericLoader.prototype.injectHTML=function(callback){var tryWriteIfNoLocation=!this.docWriteAsksToWaitForBody();var html=this.prepareHTML(this.getHtml());if(html){TagHelper.injectHTMLForLoader(this,callback,tryWriteIfNoLocation,html)}};GenericLoader.prototype.clone=function(){var clone=new GenericLoader(this.config);return clone}}());(function(){var Utils=qubit.opentag.Utils;var TagsUtils=qubit.opentag.TagsUtils;var Timed=qubit.opentag.Timed;var BaseFilter=qubit.opentag.filter.BaseFilter;var GenericLoader=qubit.opentag.GenericLoader;var TagHelper=qubit.opentag.TagHelper;var BaseVariable=qubit.opentag.pagevariable.BaseVariable;var Cookie=qubit.Cookie;var Define=qubit.Define;var log=new qubit.opentag.Log("BaseTag -> ");function BaseTag(config){var defaults={filterTimeout:(config&&config.filterTimeout)||this.FILTER_WAIT_TIMEOUT,PACKAGE:(config&&config.PACKAGE),dedupe:false,needsConsent:false,inactive:false,variables:null,runner:null,disabled:false,locked:false,reRunOnVariableChange:false};Utils.setIfUnset(config,defaults);BaseTag.SUPER.apply(this,arguments);this.namedVariables={};this.parameters=[];this.filters=[];this.session=null;this.pingSent=false;this.reRunCounter=0;if(config){this.addState("INITIAL");try{BaseTag.register(this)}catch(ex){this.log.WARN("Problem with registering tag "+this.config.name);this.log.WARN(ex,true)}this.setupConfig(config);this.uniqueRefString=null;if(config.init){try{config.init.call(this,config)}catch(ex){this.log.ERROR("init call failed:"+ex)}}this.onTagInit();this.handleVariableChange=this._handleVariableChange.bind(this)}}Define.clazz("qubit.opentag.BaseTag",BaseTag,GenericLoader);BaseTag.prototype.setupConfig=function(config){if(!config){return }if(config.filters){this.addFilters(config.filters)}if(config.parameters){this.addParameters(config.parameters)}if(config.variables){for(var prop in config.variables){if(config.variables.hasOwnProperty(prop)){var param=this.getParameterByTokenName(prop);if(param){var variable=config.variables[prop];param.variable=variable;if(variable.defaultValue!==undefined){param.defaultValue=variable.defaultValue}if(variable.uv!==undefined){param.uv=variable.uv}}}}}if(config.locked){this.lock()}};BaseTag.prototype.valueForToken=function(token,defaults){var param=this.getParameterByTokenName(token);if(param){if(defaults===undefined){if(this.loadingTimedOut){defaults=true}}return this.getParameterValue(param,defaults)}var namedVariables=this.namedVariables;if(namedVariables&&namedVariables[token]){var variable=_getSetNamedVariable(this,token);if(variable){return variable.getRelativeValue(defaults)}}return undefined};BaseTag.prototype.addParameters=function(parameters){this.parameters=this.parameters.concat(parameters)};BaseTag.prototype.LOADING_TIMEOUT=5*1000;BaseTag.prototype.FILTER_WAIT_TIMEOUT=-1;BaseTag.prototype._isVariable=function(variable){return variable!==null&&variable!==undefined};BaseTag.prototype.run=function(){if(this.destroyed){throw"Tag is destroyed."}this.resolveAllDynamicData();var params=this.parameters;if(params){for(var i=0;i<params.length;i++){var variable=this.getVariableForParameter(params[i]);if(!this._isVariable(variable)){this.log.ERROR("Parameter is missing variable!");this.log.ERROR(params[i]);this._markLoadingDependenciesFailed();this._markFinished();return }}}if(this.config.runner){var ret=false;try{this.addState("AWAITING_CALLBACK");ret=this._runner=new Date().valueOf();this.config.runner.call(this)}catch(e){this.log.ERROR("Error while running custom runner: "+e)}return ret}else{this._runner=false;return this.start()}};BaseTag.prototype.lock=function(){this.locked=true;this._unlock=null};BaseTag.prototype.unlock=function(){this.locked=false;if(this._unlock){this._unlock();this._unlock=false}};BaseTag.prototype.start=function(){if(!this.locked){return BaseTag.SUPER.prototype.run.call(this)}else{this.log.WARN("Tag is locked. Running delegated.");this._unlock=function(){return BaseTag.SUPER.prototype.run.call(this)}.bind(this);return false}};BaseTag.prototype.startOnce=function(){if(!this.locked){return BaseTag.SUPER.prototype.runOnce.call(this)}else{this._unlock=function(){return BaseTag.SUPER.prototype.runOnce.call(this)}.bind(this);return false}};BaseTag.prototype.getFilters=function(){return this.filters};BaseTag.prototype.runOnceIfFiltersPass=function(){if(!this._runOnceIfFiltersPassTriggered&&!this.scriptExecuted){this._runOnceIfFiltersPassTriggered=new Date().valueOf();this.runIfFiltersPass()}};BaseTag.prototype.runIfFiltersPass=function(){if(this.destroyed){throw"Tag is destroyed."}this.resolveAllDynamicData();var state=this.filtersState(true);this.addState("FILTER_ACTIVE");if(!this.filtersRunTriggered){this.filtersRunTriggered=new Date().valueOf()}if(state===BaseFilter.state.SESSION){this.addState("AWAITING_CALLBACK");this.log.FINE("tag is in session and will be manually triggered by custom starter");this.awaitingCallback=new Date().valueOf()}else{if(state===BaseFilter.state.PASS){this.filtersPassed=new Date().valueOf();this.log.FINE("tag passed filters tests");try{this.onFiltersPassed()}catch(ex){this.log.ERROR("error running onFiltersDelayed:"+ex)}this.run()}else{if(state===BaseFilter.state.FAIL){this.log.FINE("tag failed to pass filters");this._markFiltersFailed();this._markFinished()}else{if(state>0){var tout=this.config.filterTimeout;if(tout<0||((new Date().valueOf()-this.filtersRunTriggered)>tout)){if(!this._awaitingForFilterInformed){this._awaitingForFilterInformed=new Date().valueOf();try{this.onFiltersDelayed()}catch(ex){this.log.ERROR("error running onFiltersDelayed:"+ex)}}this._setTimeout(this.runIfFiltersPass.bind(this),state)}else{this._markFiltersFailed();this._markFinished();this.filtersRunTimedOut=new Date().valueOf();this.log.WARN("awaiting for filters timed out.")}}}}}try{this.onFiltersCheck(state)}catch(e){this.log.ERROR(e)}return state};BaseTag.prototype._markFiltersFailed=function(){this.addState("FILTERS_FAILED");this.filtersPassed=-(new Date().valueOf())};BaseTag.prototype.STATE={INITIAL:0,FILTER_ACTIVE:1,AWAITING_CALLBACK:2,FILTERS_FAILED:4,STARTED:8,LOADING_DEPENDENCIES:16,LOADED_DEPENDENCIES:32,LOADING_URL:64,LOADED_URL:128,EXECUTED:256,EXECUTED_WITH_ERRORS:512,FAILED_TO_LOAD_DEPENDENCIES:1024,FAILED_TO_LOAD_URL:2048,FAILED_TO_EXECUTE:4096,TIMED_OUT:4096*2,UNEXPECTED_FAIL:4096*2*2,CANCELLED:4096*2*2*2};BaseTag.prototype.addState=function(stateName){BaseTag.SUPER.prototype.addState.call(this,stateName);try{BaseTag.onStateChange(this)}catch(ex){this.log.ERROR(ex)}this.stateStack=[];var s=this.STATE;var current=this.state;var stack=this.stateStack;if(current&s.INITIAL){stack.push("Initial state.")}if(current&s.FILTER_ACTIVE){stack.push("Tag running with filters pass triggered.")}if(current&s.FILTERS_FAILED){stack.push("Filters failed to pass.")}if(current&s.AWAITING_CALLBACK){stack.push("Awaiting callback to run this tag. Not pooling.")}if(current&s.STARTED){stack.push("Tag is initialized and loading has been started.")}if(current&s.LOADING_DEPENDENCIES){stack.push("Dependencies are being loaded.")}if(current&s.LOADED_DEPENDENCIES){stack.push("Dependencies loading process has been finished.")}if(current&s.LOADING_URL){stack.push("External URL is being loaded.")}if(current&s.LOADED_URL){stack.push("External URL has been loaded.")}if(current&s.EXECUTED){stack.push("Main script has been executed.")}if(current&s.EXECUTED_WITH_ERRORS){stack.push("Main script has been executed but errors occured.")}if(current&s.FAILED_TO_LOAD_DEPENDENCIES){stack.push("Dependencies has failed to load.")}if(current&s.FAILED_TO_LOAD_URL){stack.push("URL location failed to load.")}if(current&s.FAILED_TO_EXECUTE){stack.push("Script failed to execute.")}if(current&s.TIMED_OUT){stack.push("Script timed out awaiting for dependencies.")}if(current&s.UNEXPECTED_FAIL){stack.push("Script occured UNEXPECTED exception and is failed.")}if(current&s.CANCELLED){stack.push("Tag has been cancelled.")}};BaseTag.prototype.onTagInit=EMPTY_FUN;BaseTag.onStateChange=EMPTY_FUN;BaseTag.prototype.onFiltersDelayed=EMPTY_FUN;BaseTag.prototype.onFiltersPassed=EMPTY_FUN;BaseTag.prototype.onFiltersCheck=EMPTY_FUN;BaseTag.prototype.state=BaseTag.prototype.STATE.INITIAL;BaseTag.prototype.arePageVariablesLoaded=function(tryDefaults){return TagHelper.allParameterVariablesReadyForTag(this,tryDefaults)};BaseTag.prototype.getDependenciesToBeLoaded=function(tryDefaults,arrayToAdd){var failures=arrayToAdd||[];if(!this.arePageVariablesLoaded(tryDefaults)){failures.push("page variables")}return BaseTag.SUPER.prototype.getDependenciesToBeLoaded.call(this,tryDefaults,failures)};BaseTag.prototype.resolveAllDynamicData=function(){this.resolvePageVariables();this.resolveDependencies();this.resolveFilters()};BaseTag.prototype.resolveDependencies=function(){var map=this.failedDependenciesToParse;if(map){this.failedDependenciesToParse=null;this.addDependenciesList(map,Define.clientSpaceClasspath())}return this.dependencies};BaseTag.prototype.addClientVariablesMap=function(map){this.unresolvedClientVariablesMap=this._addVariablesMap(map,Define.clientSpaceClasspath());return this.unresolvedClientVariablesMap};BaseTag.prototype.resolvePageVariables=function(){var map=this.unresolvedClientVariablesMap;if(map){this.unresolvedClientVariablesMap=null;this.addClientVariablesMap(map)}map=this.unresolvedVariablesMap;if(map){this.unresolvedVariablesMap=null;this.addVariablesMap(map)}return this.getPageVariables()};BaseTag.prototype.addVariablesMap=function(map){this.unresolvedVariablesMap=this._addVariablesMap(map);return this.unresolvedVariablesMap};BaseTag.prototype._addVariablesMap=function(map,ns){if(!map){return }var unresolvedVariablesMap={};var namedVariables=this.namedVariables;for(var prop in map){if(map.hasOwnProperty(prop)){var item=map[prop];if(item instanceof BaseVariable){namedVariables[prop]=item}else{if(typeof (item)==="string"){var original=item;if(ns){item=ns+"."+item}var obj=Utils.getObjectUsingPath(item);if(obj){if(obj instanceof BaseVariable){namedVariables[prop]=obj}else{namedVariables[prop]=item}}else{unresolvedVariablesMap[prop]=original}}else{this.log.ERROR("Added variable is of wrong type!");this.log.ERROR(item)}}}}return unresolvedVariablesMap};BaseTag.prototype.prepareURL=function(url){return this.replaceTokensWithValues(url)};BaseTag.prototype.prepareLocationObject=function(loc){return this.replaceTokensWithValues(loc)};BaseTag.prototype.prepareHTML=function(html){if(html){html=this.replaceTokensWithValues(html)}return html};BaseTag.prototype._executeScript=function(){if(this.config&&this.config.script){if(typeof (this.config.script)==="function"){this.script=this.config.script}else{var expr=this.replaceTokensWithValues(String(this.config.script));this.script=Utils.expressionToFunction(expr).bind(this)}}BaseTag.SUPER.prototype._executeScript.call(this)};BaseTag.prototype.replaceTokensWithValues=function(string){if(!string||string.indexOf("${")===-1){return string}var params=this.parameters;if(params){for(var i=0;i<params.length;i++){var parameter=params[i];var variable=this.getVariableForParameter(parameter);if(variable){var token=params[i].token;var value=this.valueForToken(token);string=variable.replaceToken(token,string,value)}}}return string};BaseTag.prototype.getParameter=function(name){var params=this.parameters;var ret=null;if(params){for(var i=0;i<params.length;i++){if(params[i].name===name){ret=params[i]}}}return ret};BaseTag.prototype.setParameterValueByTokenName=function(tokenName,variable){var param=this.getParameterByTokenName(tokenName);if(param!==null){param.variable={value:variable};return true}return false};BaseTag.prototype.getParameterValue=function(parameterOrName,defaults){var param=(typeof (parameterOrName)==="string")?this.getParameter(parameterOrName):parameterOrName;if(param){var variable=this.getVariableForParameter(param);if(variable){try{var value;if(defaults&&param.defaultValue!==""){value=Utils.gevalAndReturn(param.defaultValue).result}value=variable.getRelativeValue(defaults,value);return value}catch(ex){this.log.ERROR("error while trying to resolve variable value:"+ex);this.log.ERROR("Variable defaults string is invalid: "+param.defaultValue);return undefined}}}return undefined};BaseTag.prototype.filtersState=function(runLastSessionFIlterIfPresent){var run=runLastSessionFIlterIfPresent;return TagsUtils.filtersState(this.filters,this.session,this,run)};BaseTag.prototype.addFilter=function(filter){Utils.addToArrayIfNotExist(this.filters,filter)};BaseTag.prototype.addFilters=function(filters){for(var i=0;i<filters.length;i++){this.addFilter(filters[i])}};BaseTag.prototype.addClientFiltersList=function(filters){this.unresolvedClientFilterClasspaths=this.addFiltersList(filters,Define.clientSpaceClasspath());return this.unresolvedClientFilterClasspaths};BaseTag.prototype.resolveFilters=function(){var list=this.unresolvedClientFilterClasspaths;if(list){this.unresolvedClientFilterClasspaths=null;this.addClientFiltersList(list)}return this.filters};BaseTag.prototype.addFiltersList=function(filters,ns){var unresolved=[];for(var i=0;i<filters.length;i++){try{var filter=filters[i];var tmp=filter;var cp=null;if(typeof (filter)==="string"){cp=filter;if(ns){filter=ns+"."+filter}filter=Utils.getObjectUsingPath(filter)}if(typeof (filter)==="function"){var FilterClass=filter;filter=new FilterClass()}if(!filter){this.log.FINE("Filter "+tmp+" does NOT exists.")}if(!filter instanceof BaseFilter){this.log.ERROR("Not a filter! ",filter);filter=null}if(filter){this.addFilter(filter)}else{if(cp){Utils.addToArrayIfNotExist(unresolved,cp)}}}catch(ex){this.log.FINE("Failed adding filter: "+filters[i]);this.failedFilters=this.failedFilters||[];this.failedFilters.push(filters[i])}}return unresolved};BaseTag.prototype.reset=function(){BaseTag.SUPER.prototype.reset.call(this);var u;this.filtersPassed=u;this.dedupePingSent=u;this.pingSent=false;this._runOnceIfFiltersPassTriggered=u;this.filtersRunTriggered=u;this._runner=u;this.reRunCounter=0;this.detachVariablesChangedListeners()};BaseTag.prototype.resetFilters=function(){for(var i=0;i<this.filters.length;i++){this.filters[i].reset()}};BaseTag.prototype.getParameterByTokenName=function(name){var ret=null;if(this.parameters){var params=this.parameters;for(var i=0;i<params.length;i++){if(params[i].token===name){ret=params[i]}}}return ret};BaseTag.prototype.removeFilter=function(filter){Utils.removeFromArray(this.filters,filter)};var _counter_tag_map=0;var tags=[];var tagAccessorsMap={};var UNIQUE_REF={};BaseTag.register=function(tag){log.FINEST('registering tag named "'+tag.config.name+'", instance of:');log.FINEST(tag,true);var index=Utils.addToArrayIfNotExist(tags,tag);if(index!==-1){log.FINE("tag already exists in tags registry.")}if(index===-1){tag._tagIndex=tags.length-1}else{tag._tagIndex=index}if(tag.config.id){var str="Q"+tag.config.id;UNIQUE_REF[str]=tag;tag.uniqueId=str}else{UNIQUE_REF[tag.CLASSPATH]=tag}};BaseTag.getById=function(id){return UNIQUE_REF[String(id)]};BaseTag.prototype.getById=BaseTag.getById;BaseTag.prototype.unregister=function(ref){BaseTag.unregister(ref||this)};BaseTag.prototype.destroy=function(){this.destroyed=true;this.cancel();BaseTag.unregister(this)};BaseTag.unregister=function(tag){log.FINEST('Un-registering tag named "'+tag.config.name+'", instance of:');log.FINEST(tag,true);var index=Utils.removeFromArray(tags,tag);if(!index||index.length===0){log.FINEST("tag "+tag.config.name+" is already unregistered.")}tag._tagIndex=-1};BaseTag.getTags=function(){return tags};BaseTag.getAccessorsMap=function(){return tagAccessorsMap};BaseTag.prototype.getTags=function(){return tags};BaseTag.prototype.getPageVariables=function(){var params=this.parameters;var vars=[];if(params){for(var i=0;i<params.length;i++){var v=this.getVariableForParameter(params[i]);if(this._isVariable(v)){Utils.addToArrayIfNotExist(vars,v)}}}if(this.namedVariables){for(var key in this.namedVariables){Utils.addToArrayIfNotExist(vars,_getSetNamedVariable(this,key))}}return vars};BaseTag.prototype.getAccessorString=function(){if(!this._accessorsMapKey){this._accessorsMapKey="_"+_counter_tag_map++;tagAccessorsMap[this._accessorsMapKey]=this}return"qubit.opentag.BaseTag.getAccessorsMap()."+this._accessorsMapKey};BaseTag.prototype.getVariableForParameter=function(param){var variable;var namedVariables=this.namedVariables;if((namedVariables&&namedVariables[param.token])){variable=_getSetNamedVariable(this,param.token)}if(!variable){variable=TagHelper.validateAndGetVariableForParameter(param)}return variable};BaseTag.prototype.printVariablesState=function(){var res=[];this.log.FINE("Tag has been timed out, showing variables:");var pairs=TagHelper.getAllVariablesWithParameters(this);for(var i=0;i<pairs.length;i++){var param=pairs[i].parameter;var variable=pairs[i].variable;var val;if(param&&param.token){val=this.valueForToken(param.token)}else{val=variable.getRelativeValue(true)}var tmp={name:variable.config.name,exists:variable.exists(),token:param?param.token:null,value:val,variable:variable};res.push(tmp);this.log.FINE(" Variable Name: "+tmp.name+", Exists: "+tmp.exists+", Token: "+(param?param.token:"<param is not assigned>")+", Value:"+val)}return res};BaseTag.prototype._triggerOnLoadTimeout=function(){this.printVariablesState();this.onLoadTimeout()};function _getSetNamedVariable(tag,token){var namedVariables=tag.namedVariables;var variable=TagHelper.initPageVariable(namedVariables[token]);namedVariables[token]=variable;return variable}BaseTag.prototype.getId=function(){return this._getUniqueId()};BaseTag.prototype._getUniqueId=function(){if(this.config.id){return this.config.id}if(String(this.CLASSPATH).indexOf(Define.STANDARD_CS_NS)===0){return this.CLASSPATH.substring(Define.STANDARD_CS_NS.length+1)}else{return this.CLASSPATH+"#"+this.config.name}};var forceCookiePrefix="qubit.tag.forceRunning_";var disableCookiePrefix="qubit.tag.disableRunning_";var cookieRunAll="qubit.tag.forceAllToRun";BaseTag.prototype.cookieSaysToRunEvenIfDisabled=function(){var id=this._getUniqueId();var ret=!!Cookie.get(cookieRunAll);if(!ret){ret=!!Cookie.get(forceCookiePrefix+id)}return ret};BaseTag.prototype.setCookieForcingTagToRun=function(){var id=this._getUniqueId();Cookie.set(forceCookiePrefix+id,"true")};BaseTag.setCookieForcingTagsToRun=function(){Cookie.set(cookieRunAll,"true")};BaseTag.prototype.setCookieToDisable=function(){var id=this._getUniqueId();Cookie.set(disableCookiePrefix+id,"true")};BaseTag.prototype.rmCookieToDisable=function(){var id=this._getUniqueId();Cookie.rm(disableCookiePrefix+id)};BaseTag.prototype.disabledByCookie=function(){var id=this._getUniqueId();return !!Cookie.get(disableCookiePrefix+id)};BaseTag.rmCookieForcingTagsToRun=function(){Cookie.rm(cookieRunAll)};BaseTag.prototype.rmCookieForcingTagToRun=function(){var id=this._getUniqueId();Cookie.rm(forceCookiePrefix+id)};BaseTag.rmAllDisablingCookies=function(){Utils.rmCookiesMatching(disableCookiePrefix)};BaseTag.rmAllCookiesForcingTagToRun=function(){Utils.rmCookiesMatching(forceCookiePrefix);BaseTag.rmCookieForcingTagsToRun()};BaseTag.prototype.onVariableChanged=function(callback){this.attachVariablesChangedListeners();this.events.on("variableChanged",callback)};BaseTag.prototype._handleVariableChange=function(ref){this.log.FINEST("Variable "+ref.variable.CLASSPATH+" changed from : "+ref.oldValue+"to:"+ref.newValue);this.events.call("variableChanged",ref);if(!this.isRunning&&this.config.reRunOnVariableChange){if(!isNaN(this.config.reRunLimit)){if(this.config.reRunLimit<=this.reRunCounter){return }}var counterVal=this.reRunCounter+1;this.reset();this.reRunCounter=counterVal;this.resetFilters();this.runIfFiltersPass()}};BaseTag.prototype.attachVariablesChangedListeners=function(force){var variables=this.getPageVariables();var startObserving=!!(this.config.reRunOnVariableChange||this.config.observeVariables||force);if(startObserving){for(var i=0;i<variables.length;i++){var variable=variables[i];variable.onValueChanged(this.handleVariableChange,startObserving)}}};BaseTag.prototype.detachVariablesChangedListeners=function(){var variables=this.getPageVariables();for(var i=0;i<variables.length;i++){var variable=variables[i];variable.deatchOnValueChanged(this.handleVariableChange)}};BaseTag.prototype._markFinished=function(){this.log.FINE("Marked finished.");BaseTag.SUPER.prototype._markFinished.call(this);this.attachVariablesChangedListeners()}}());(function(){var log=new qubit.opentag.Log("Tags -> ");var Utils=qubit.opentag.Utils;var BaseFilter=qubit.opentag.filter.BaseFilter;var Tags=function(){};qubit.Define.clazz("qubit.opentag.Tags",Tags);Tags.getById=function(id){return qubit.opentag.BaseTag.getById(String(id))};Tags.getAllTagsByState=function(){return qubit.opentag.Container.getAllTagsByState(Tags.getTags())};Tags.findTagByName=function(match){var tags=this.getTags();var results=[];for(var i=0;i<tags.length;i++){if(tags[i].config.name===match){results.push(tags[i])}}return results};Tags.findTagByMatch=function(match){var tags=this.getTags();var results=[];for(var i=0;i<tags.length;i++){if(tags[i].config.name.match(match)){results.push(tags[i])}}return results};Tags.findTagContainers=function(tag){var containers=Tags.getContainers();var containing=[];for(var i=0;i<containers.length;i++){var tagsMap=containers[i].tags;for(var prop in tagsMap){if(tagsMap[prop]===tag){containing.push(containers[i]);break}}}return containing};Tags.getTags=function(){log.FINEST("getTags");return qubit.opentag.BaseTag.getTags()};Tags.resetAllTags=function(skipFilters){log.WARN("reseting all tags!");var tags=Tags.getTags();for(var i=0;i<tags.length;i++){tags[i].reset();if(!skipFilters){tags[i].resetFilters()}}};Tags.getContainersPageVariables=function(){var containers=Tags.getContainers();var vars=[];for(var i=0;i<containers.length;i++){vars=vars.concat(containers.getPageVariables())}return vars};Tags.getAllPageVariables=function(){var tags=Tags.getTags();var vars=[];for(var i=0;i<tags.length;i++){vars=vars.concat(tags[i].getPageVariables())}return vars};Tags.cancelAll=function(){var tags=Tags.getTags();for(var i=0;i<tags.length;i++){tags[i].cancel()}};Tags.resetAll=function(skipFilters){var tags=Tags.getTags();for(var i=0;i<tags.length;i++){tags[i].reset();if(!skipFilters){tags[i].resetFilters()}}};Tags.getPageVariableByName=function(name){var vars=Tags.getAllPageVariables();var rets=[];for(var i=0;i<vars.length;i++){if(vars[i].config.name===name){rets.push(vars[i])}}return rets};Tags.getLoadTime=function(tag){var start=tag.beforeRun;var end=tag.runIsFinished;if(isNaN(end)){return{tag:tag,loadTime:null}}else{return{tag:tag,loadTime:(end-start)}}};Tags.getLoadTimes=function(tags){var ret=[];if(tags instanceof qubit.opentag.BaseTag){ret.push([Tags.getLoadTime(tags[prop])]);return ret}tags=tags||Tags.getTags();var array=tags instanceof Array;if(array){for(var i=0;i<tags.length;i++){if(tags[i] instanceof qubit.opentag.BaseTag){ret.push(Tags.getLoadTime(tags[i]))}}}else{for(var prop in tags){if(tags[prop] instanceof qubit.opentag.BaseTag){ret.push(Tags.getLoadTime(tags[prop]))}}}return ret};Tags.forceAllContainersAndTagsToRunIfDisabled=function(){qubit.opentag.Container.setCookieForDisabledContainersToRun();qubit.opentag.BaseTag.setCookieForcingTagsToRun()};Tags.rmAllContainersAndTagsForcingFlags=function(){qubit.opentag.Container.rmCookieForDisabledContainersToRun();qubit.opentag.BaseTag.rmAllCookiesForcingTagToRun()};Tags.getContainers=function(){return qubit.opentag.Container.getContainers()};Tags.findAllTagsByClassPath=function(startsWith){var start=new Date().valueOf();var ret=[];var excludes=[];try{excludes.push(qubit.opentag.CustomTag);excludes.push(qubit.opentag.LibraryTag)}catch(ex){log.FINEST("Warning:Missing known libraries: CustomTag, LibraryTag")}var tags=Tags.getTags();for(var i=0;i<tags.length;i++){var tag=tags[i];if(Utils.indexInArray(excludes,tag)<0&&tag.PACKAGE_NAME.indexOf(startsWith)===0){ret.push(tag);log.FINEST("findAllTagsByClassPath(): found: "+tag.PACKAGE_NAME+" -> "+tag.config.name)}}log.FINE("findAllTags(): selection found in "+(new Date().valueOf()-start));return ret};Tags.findAllTags=function(pckg,maxDeep){var BaseTag=qubit.opentag.BaseTag;var ret,excludes=[];var start=new Date().valueOf();try{excludes.push(qubit.opentag.CustomTag);excludes.push(qubit.opentag.LibraryTag)}catch(ex){log.FINEST("Warning:Missing known libraries: CustomTag, LibraryTag")}ret=Tags.findAllInstances(pckg,BaseTag,excludes,maxDeep);log.FINE("findAllTags(): found in "+(new Date().valueOf()-start));return ret};var findAllIn=function(pckg,check,excludes,maxDeep){var instances=[];if(typeof (pckg)==="string"){pckg=Utils.getObjectUsingPath(pckg)}if(pckg){var cfg={objectsOnly:true};if(maxDeep){cfg.maxDeep=true}cfg.track=true;var start=new Date().valueOf();var fun=function(obj,parent,propName,trackPath){if(check(obj)){for(var i=0;i<excludes.length;i++){if(excludes[i]===obj){return true}}log.FINE("found ["+trackPath+"]:"+(obj.config?obj.config.name:propName));Utils.addToArrayIfNotExist(instances,obj);return true}return false}.bind(this);Utils.traverse(pckg,fun,cfg);log.FINE("Found in "+(new Date().valueOf()-start))}return instances};Tags.findAllInstances=function(pckg,clazz,excludes,maxDeep){var check=function(obj){return obj instanceof clazz};return findAllIn(pckg,check,excludes,maxDeep)};Tags.findAllInheriting=function(pckg,clazz,excludes,maxDeep){var check=function(obj){return obj.prototype instanceof clazz};return findAllIn(pckg,check,excludes,maxDeep)};Tags.findAllFilters=function(pckg,maxDeep){var excludes=[];try{excludes.push(qubit.opentag.filter.Filter);excludes.push(qubit.opentag.filter.URLFilter)}catch(ex){log.FINE("Warning: Missing known libraries: CustomTag, LibraryTag")}return Tags.findAllInheriting(pckg,BaseFilter,excludes,maxDeep)}})();q.cookie={};q.cookie.PageView={};q.cookie.PageView.update=function(){var a,r;r=function _(){return(Math.floor(1+Math.random()*65536)).toString(36).substring(1)};if(!window.__pageViewId__){a=new Date().getTime().toString(36);window.__pageViewId__=a+r()+r()+r()}return window.__pageViewId__};q.html.PostData=function(url,data,type){var _post,agent,isIe,isIe9,isOldIe,fullUrl,loaded,retry,retryDelay,retryCount;retryCount=2;retryDelay=5000;loaded=false;retry=function(){if(retryCount>0){setTimeout(function(){if(!loaded){retryCount-=1;_post()}},retryDelay)}};agent=navigator.userAgent.toLowerCase();isIe=agent.indexOf("msie")!==-1;isIe9=agent.indexOf("msie 9")!==-1;isOldIe=((agent.indexOf("msie 7")!==-1)||(agent.indexOf("msie 6")!==-1));fullUrl=("https:"===document.location.protocol?"https:":"http:")+url;type=type||"POST";_post=function(){var xhr;try{xhr=null;try{xhr=new XMLHttpRequest()}catch(e1){}if(xhr&&!isIe){xhr.open(type,fullUrl,true)}else{if(typeof XDomainRequest!=="undefined"){xhr=new XDomainRequest();xhr.open(type,fullUrl)}else{xhr=null}}try{xhr.withCredentials=false}catch(e2){}if(xhr.setRequestHeader){xhr.setRequestHeader("Content-Type","text/plain;charset=UTF-8")}xhr.onload=function(){loaded=true};xhr.onreadystatechange=function(){};xhr.ontimeout=function(){};xhr.onerror=function(){};xhr.onprogress=function(){};xhr.send(data)}catch(err){try{try{q.html.fileLoader.load(fullUrl)}catch(err2){if(window.console&&window.console.log){window.console.log(err)}}}catch(e){}}retry()};if(isOldIe){q.html.fileLoader.load(fullUrl);return }else{_post()}};(function(){var log=new qubit.opentag.Log("Ping -> ");function Ping(){}qubit.Define.clazz("qubit.opentag.Ping",Ping);Ping.prototype.send=function(container,loadTimes){var config=container.config;var pingString="c="+config.clientId+"&p="+container.getContainerId()+"&l="+config.tellLoadTimesProbability+"&pv="+q.cookie.PageView.update()+"&d=";var pingStrings=[];for(var i=0;i<loadTimes.length;i++){var tag=loadTimes[i].tag;var loadTime=loadTimes[i].loadTime;if(loadTime===null||isNaN(loadTime)){continue}var loaderId=Ping.getPingID(tag);if(!tag.pingSent&&loaderId&&loadTime!==null){if(loaderId!==undefined){pingStrings.push('"'+loaderId+'":'+loadTime);tag.pingSent=true}else{log.WARN("send: tag `"+tag.config.name+"` has no ID assigned! Time load will not be sent.")}}else{if(tag.pingSent){log.FINEST("send: ping already sent for `"+tag.config.name+"`, ignoring.")}else{if(loadTime===null){log.FINEST("send: null load times for `"+tag.config.name+"`, ignoring (ping not sent).")}}}}if(config.pingServerUrl&&pingStrings.length>0){pingString+=encodeURIComponent("{"+pingStrings.join(",")+"}");var url="//"+config.pingServerUrl+"/tag2?"+pingString;log.FINE("send: sending pings "+url);q.html.PostData(url,null,"GET")}else{if(!pingStrings.length){log.FINE("send: no pings to sent")}if(!config.pingServerUrl){}}};Ping.prototype.sendErrors=function(container,errors){log.WARN("Errors sending is disabled.")};Ping.prototype.sendDedupe=function(container,tags){var config=container.config;var pingString="c="+config.clientId+"&p="+container.getContainerId()+"&l="+(config.tellLoadTimesProbability)+"&pv="+q.cookie.PageView.update()+"&dd=";var pingStrings=[];for(var i=0;i<tags.length;i++){var tag=tags[i];var loaderId=Ping.getPingID(tag);if(loaderId===undefined){log.WARN("sendDedupe: tag `"+tag.config.name+"` has no ID assigned! Deduplicaton time load will not be sent.")}else{if(!tag.dedupePingSent){pingStrings.push(loaderId);tag.dedupePingSent=true}}}if(pingStrings.length>0&&config.pingServerUrl){pingString+=encodeURIComponent("["+pingStrings.join(",")+"]");q.html.PostData("//"+config.pingServerUrl+"/tag2?"+pingString,null,"GET")}else{if(!pingStrings.length){log.FINE("sendDedupe: no dedupe pings to sent")}if(!config.pingServerUrl){log.WARN("sendDedupe: config.pingServerUrl is unset!")}}};Ping.getPingID=function(tag){if(tag.config.id){return tag.config.id}var idx=tag.PACKAGE_NAME.lastIndexOf(".");if(idx!==-1){return tag.PACKAGE_NAME.substring(idx+1)}else{return tag.PACKAGE_NAME}}}());q.cookie.SimpleSessionCounter={};q.cookie.SimpleSessionCounter._cookieName="_qst_s";q.cookie.SimpleSessionCounter._sessionCookie="_qsst_s";q.cookie.SimpleSessionCounter.update=function(domain){var c,s,ga,mins=30;c=qubit.Cookie.get(q.cookie.SimpleSessionCounter._cookieName);s=qubit.Cookie.get(q.cookie.SimpleSessionCounter._sessionCookie);if(!c){c=1}else{c=parseInt(c,10);if(!s||(parseInt(s,10)<(new Date().getTime()-mins*60*1000))){c+=1}}qubit.Cookie.set(q.cookie.SimpleSessionCounter._cookieName,c,365,domain);qubit.Cookie.set(q.cookie.SimpleSessionCounter._sessionCookie,new Date().getTime().toString(),null,domain);return c};var JSON={};(function(){function f(n){return n<10?"0"+n:n}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function stringifyDate(key){return isFinite(key.valueOf())?key.getUTCFullYear()+"-"+f(key.getUTCMonth()+1)+"-"+f(key.getUTCDate())+"T"+f(key.getUTCHours())+":"+f(key.getUTCMinutes())+":"+f(key.getUTCSeconds())+"Z":null}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value instanceof Date){value=stringifyDate(value)}else{if((value instanceof String)||(value instanceof Number)||(value instanceof Boolean)){value=value.valueOf()}}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){try{partial[i]=str(i,value)||"null"}catch(stackExceeded){partial[i]='{"stack_exceeded": null}'}}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];try{v=str(k,value)}catch(stackExceeded){v='{"stack_exceeded": null}'}if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){try{v=str(k,value)}catch(stackExceeded){v='{"stack_exceeded": null}'}if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());(function(){var defaultAlphabet=[];var len=Math.pow(2,8);for(var c=0;c<len;c++){defaultAlphabet.push(String.fromCharCode(c))}var xdict={};for(var i=0;i<defaultAlphabet.length;i++){xdict[defaultAlphabet[i]]=i}var Define=qubit.Define;function LZW(config){if(config){if(config.alphabet){this.alphabet=config.alphabet;this.dict={};for(var i=0;i<this.alphabet.length;i++){this.dict[this.alphabet[i]]=i}}else{this.alphabet=defaultAlphabet;this.dict=xdict}}}Define.clazz("qubit.compression.LZW",LZW);LZW.prototype.encode=function(string){var dictsize=this.alphabet.length;var extDict={};var results=[];var index=0;var curr=string.charAt(index++);var next;var dict=this.dict;while(!!(next=string.charAt(index++))){var newWord=curr+next;if(dict.hasOwnProperty(newWord)||extDict.hasOwnProperty(newWord)){curr=newWord}else{var val=dict.hasOwnProperty(curr)?dict[curr]:extDict[curr];if(val===undefined){throw"Dictionary base is to small for those contents: "+curr}results.push(val);extDict[newWord]=dictsize++;curr=next}}if(curr!==""){results.push(extDict.hasOwnProperty(curr)?extDict[curr]:dict[curr])}return results};LZW.prototype.decode=function(codes){var dict=this.dict;var dictSize=this.alphabet.length;var chunk;var locdict={};var prevChar=getFromDict(codes[0],dict);var prevChunk=prevChar;var results=[prevChar];for(var i=1;i<codes.length;i++){var currentCode=codes[i];chunk=getFromDict(currentCode,dict);if(chunk===null){if(locdict.hasOwnProperty(currentCode)){chunk=locdict[currentCode]}if(chunk===null){chunk=prevChunk+prevChar}}results.push(chunk);prevChar=chunk.charAt(0);locdict[dictSize++]=prevChunk+prevChar;prevChunk=chunk}return results.join("")};function getFromDict(code,dict){for(var p in dict){if(code===dict[p]){return p}}return null}}());(function(){var mex="abcdefghijklmnopqrstuvwxyz0123456789'%./:<>?[";var Umex='ABCDEFGHIJKLMNOPQRSTUVWXYZ*!-+()@{|}"]^_`~$&#';var mexMap={};for(var c=0;c<mex.length;c++){mexMap[mex.charAt(c)]=c}var UmexMap={};for(var ii=0;ii<mex.length;ii++){UmexMap[Umex.charAt(ii)]=ii}var UmexToMexMap={};for(var iii=0;iii<mex.length;iii++){UmexToMexMap[mex.charAt(iii)]=Umex.charAt(iii)}var mnums=mex.split("");var maxMnum=mnums.length;function converToMex(number){var rest=0;var minus=number<0;if(minus){number=-number}var newNum="";var first=true;do{rest=number%maxMnum;if(first){newNum=UmexToMexMap[mnums[rest]];first=false}else{newNum=mnums[rest]+newNum}number=(number-rest)/maxMnum}while(number>0);if(minus){return"-"+newNum}return newNum}function convertFromMex(mexNum){var newNum=0;var pow=0;var first=true;for(var i=0;i<mexNum.length;i++){var cur=mexNum.charAt(mexNum.length-1-i);if(first){first=false;cur=mex.charAt(UmexMap[cur])}newNum+=mexMap[cur]*Math.pow(maxMnum,pow++)}return newNum}var lzw=new qubit.compression.LZW({});var Define=qubit.Define;function Compressor(config){}Define.clazz("qubit.compression.Compressor",Compressor);Compressor.prototype.compress=function(string,lz){var array=(lz||lzw).encode(string);var result=[];for(var i=0;i<array.length;i++){result.push(String.fromCharCode(array[i]))}return result.join("")};Compressor.prototype.compressAnsi=function(string,lz){var array=(lz||lzw).encode(string);var result=[];for(var i=0;i<array.length;i++){var num=converToMex(array[i]);result.push(num)}return result.join("")};Compressor.prototype.decompressAnsi=function(code,lz){var array=[];var curr="";for(var i=0;i<code.length;i++){var ch=code.charAt(i);if(UmexMap.hasOwnProperty(ch)){var num=curr+ch;curr="";num=convertFromMex(num);array.push(num)}else{curr+=ch}}return(lz||lzw).decode(array)};Compressor.prototype.decompress=function(code,lz){var array=[];for(var i=0;i<code.length;i++){array.push(code.charCodeAt(i))}return(lz||lzw).decode(array)}}());(function(){var Define=qubit.Define;var Cookie=qubit.Cookie;var definitions=[['","referrer":[{"url":"http://',"1-"],['","referrer":[{"url":"https://',"2-"],[',"referrer":[{"url":"http://',"3-"],[',"referrer":[{"url":"https://',"4-"],[',"sessionStartTime":',"5-"],["www.google.co.uk","6-"],["www.google.","7-"],['"sessionStartTime":',"8-"],['"landing":"',"9-"],["http%3A%2F%2Fwww","10-"],['"landing":',"L"],['"time":',"A"],['"pageViews":',"P"],['"sessionCount":',"B"],['"referrer":',"R"],['"url":"http://www.',"J"],['"url":"https://www.',"M"],['"url":"',"I"],['"url":',"U"],["http://www.","W"],["https://www.","V"],["%2Fen%2Ftsuk%2F","K"],['"sessionLandingPage":',"F"],["http%3A%2F%2F","D"],["http://","H"],["https://","X"],['""',"O"],['",',"Y"],['":{}}',"z"],["<","S"],[">","G"],["[","Z"],["]","E"],["{","a"],["}","b"],["(","c"],[")","d"],["!","e"],["#","f"],["$","g"],["!","q"],["'","i"],[":","j"],["?","k"],["^","x"],["`","m"],["|","n"],["~","o"],["%","v"],[",","C"]];function prepareDefinitions(array){var definitions=[];for(var i=0;i<array.length;i++){var preparedString=escapeRegExp(array[i][0]);definitions.push([new RegExp(preparedString,"g"),"*"+array[i][1]])}return definitions}function getDefinitionByChar(ch,definitions){for(var i=0;i<definitions.length;i++){if(definitions[i][1]===ch){return definitions[i][0]}}return null}var regexDefinitions=prepareDefinitions(definitions);function Encoder(config){this._regexDefs=regexDefinitions;this._defs=definitions;if(config){if(config.definitions){this._regexDefs=prepareDefinitions(config.definitions);this._defs=config.definitions}}}Define.clazz("qubit.opentag.compression.Encoder",Encoder);Encoder.prototype.encode=function encode(string,limitUTFRange){var ret=string.replace(/\*/g,"**");var ininitalDdict=dynamicDictionary(ret);for(var i=0;i<this._regexDefs.length;i++){var pair=this._regexDefs[i];ret=ret.replace(pair[0],pair[1])}ret=ret.replace(/;/g,"*-");ret=ret.replace(/&/g,"*.");ret=ret.replace(/\\/g,"*/");ret=ret.replace(/=/g,"*+");ret=ret.replace(/\n/g,"*N");ret=ret.replace(/ /g,"*_");ret=ret.replace(/\t/g,"*T");ret=ret.replace(/"/g,"*Q");var ddict=dynamicDictionary(ret);ddict.concat(ininitalDdict);var result=replaceWithDynamicDictionary(ddict,ret);var actualDict=result[1];var replacementsOccured=actualDict.length>0;if(replacementsOccured){ret=result[0]}if(!limitUTFRange){ret=replaceWithUTFEncoding(ret)}else{ret=replaceWithUTFEncoding(ret,limitUTFRange)}if(replacementsOccured){return"Y"+actualDict.join("*")+"@"+ret}else{return"N"+ret}};function replaceWithUTFEncoding(string,range){var rewrite=[];for(var i=0;i<string.length;i++){var inRange=true;if(range){inRange=string.charCodeAt(i)<=range}var inCookieAlphabet=Cookie.cookieAlphabetMap.hasOwnProperty(string.charAt(i));if(inRange&&!inCookieAlphabet){rewrite.push("*"+string.charCodeAt(i)+".")}else{rewrite.push(string.charAt(i))}}return rewrite.join("")}function replaceWithDynamicDictionary(ddict,string){string=string.replace(/@/g,"@@");var dict=[];for(var i=0,j=0;i<ddict.length;i++){var pattern=ddict[i][0];var rx=new RegExp(escapeRegExp(pattern),"g");var out=string.replace(rx,"@"+j+"-");if(out!==string){dict.push(ddict[i][0]);j++;string=out}}return[string,dict]}function escapeRegExp(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}var dynamicDictChars="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ+_.";var dynamicDictCharsMap={};for(var i=0;i<dynamicDictChars.length;i++){dynamicDictCharsMap[dynamicDictChars.charAt(i)]=true}var MIN_WORD_LEN=4;var MIN_OCCURENCE_LEN=2;function dynamicDictionary(str){var parts={};var word="";for(var i=0;i<str.length;i++){var ch=str.charAt(i);if(!dynamicDictCharsMap[ch]){if(isNaN(parts[word])){parts[word]=str.split(word).length-1}word=""}else{word+=ch}}var dict=[];for(var prop in parts){if(parts.hasOwnProperty(prop)){var occurringNum=parts[prop];if(occurringNum>=MIN_OCCURENCE_LEN&&prop.length>=MIN_WORD_LEN){dict.push([prop,occurringNum])}}}dict=dict.sort(function(a,b){if(a[0].length===b[0].length){return 0}if(b[0].length>a[0].length){return 1}else{return -1}});return dict}Encoder.prototype.decode=function(string){var ddict=null;if(string.charAt(0)==="N"){string=string.substring(1)}else{if(string.charAt(0)==="Y"){var qMkIdx=string.indexOf("@");if(qMkIdx>=0){ddict=string.substring(1,qMkIdx);ddict=ddict.split("*");string=string.substring(qMkIdx+1);string=decodeDynamicDictionary(string,ddict)}}}var ret="";var codeWord=false;var collectingNum=false;var utfNum="";for(var i=0;i<string.length;i++){var ch=string.charAt(i);if(ch==="*"||codeWord||collectingNum){if(codeWord||collectingNum){codeWord=false;if(!isNaN(+("-"+ch))){utfNum=utfNum+ch;collectingNum=true}else{if(collectingNum){if(ch==="."){ret+=String.fromCharCode(+utfNum)}else{if(ch==="-"&&getDefinitionByChar(utfNum+"-",this._defs)){ret+=getDefinitionByChar(utfNum+"-",this._defs)}else{ret+="*"+utfNum+ch}}utfNum="";collectingNum=false}else{if(ch==="*"){ret+="*"}else{if(ch==="-"){ret+=";"}else{if(ch==="/"){ret+="\\"}else{if(ch==="."){ret+="&"}else{if(ch==="+"){ret+="="}else{if(ch==="N"){ret+="\n"}else{if(ch==="_"){ret+=" "}else{if(ch==="T"){ret+="\t"}else{if(ch==="Q"){ret+='"'}else{if(getDefinitionByChar(ch,this._defs)!==null){var def=getDefinitionByChar(ch,this._defs);ret+=def}else{ret+="*"+ch}}}}}}}}}}}}}else{codeWord=true}}else{ret+=ch}}if(utfNum){ret+="*"+utfNum}if(codeWord){ret+="*"}return ret};function decodeDynamicDictionary(string,ddict){if(!ddict||ddict.length===0||!string){return string}var ret="";var codeWord=false;var collectingNum=false;var codeNum="";for(var i=0;i<string.length;i++){var ch=string.charAt(i);if(ch==="@"||codeWord||collectingNum){if(codeWord||collectingNum){codeWord=false;if(ch==="@"){ret+="@"}else{if(!isNaN(+("-"+ch))){collectingNum=true;codeNum=codeNum+ch}else{if(collectingNum){if(ddict&&ch==="-"&&ddict[+codeNum]){ret+=ddict[+codeNum]}else{ret+="@"+codeNum+ch}codeNum="";collectingNum=false}else{ret+="@"+ch}}}}else{codeWord=true}}else{ret+=ch}}if(codeNum){ret+="@"+codeNum}if(codeWord){ret+="@"}return ret}})();(function(){var Define=qubit.Define;var Cookie=qubit.Cookie;var log=new qubit.opentag.Log("CookieCompressor -> ");var binSupported=false;function CookieCompressor(config){this.testBinary=false;this.binSupported=binSupported;if(config){log.FINEST("Created compressor instance.");this.compressor=new qubit.compression.Compressor();this.encoder=new qubit.opentag.compression.Encoder({})}}Define.clazz("qubit.opentag.compression.CookieCompressor",CookieCompressor);CookieCompressor.prototype.compress=function(string,forceCompression){if(typeof (string)!=="string"||string===""){return string}log.FINEST("Compressing...");var encoded=this.encoder.encode(string);var binOut;if(this.binSupported||this.testBinary){var bin=this.compressor.compress(encoded);binOut='"B'+this.encoder.encode(bin,128)+'"';Cookie.set("__qtag_test_bin__",binOut,undefined,undefined,true);var o=Cookie.get("__qtag_test_bin__",true);Cookie.rm("__qtag_test_bin__");if(o&&o!==binOut){binOut=null;log.FINEST("Binary cookie saving trial failed.")}}var ansiOut;var compressed=this.encoder.encode(this.compressor.compressAnsi(encoded));if((!forceCompression)&&encoded.length<=compressed.length){ansiOut="E"+encoded}else{ansiOut="C"+compressed}if(binOut&&binOut.length<ansiOut.length){log.FINEST("Binary compression ratio:"+(binOut.length/string.length));return binOut}else{log.FINEST("Compression ratio: "+(ansiOut.length/string.length));return ansiOut}};CookieCompressor.prototype.decompress=function(string){if(typeof (string)!=="string"||string===""){return string}if(string.charAt(0)==='"'){string=string.substring(1,string.length-1)}log.FINEST("Decompressing...");var code=string.charAt(0);string=string.substring(1);switch(code){case"E":return this.encoder.decode(string);case"C":var tmp=this.compressor.decompressAnsi(this.encoder.decode(string));return this.encoder.decode(tmp);case"B":var tmp1=this.compressor.decompress(this.encoder.decode(string));return this.encoder.decode(tmp1);default:throw"This code is not supported! Code: "+code}}})();(function(){var Cookie=qubit.Cookie;var Utils=qubit.opentag.Utils;var log=new qubit.opentag.Log("Session -> ");var Session=function(){};qubit.Define.clazz("qubit.opentag.Session",Session);var compressor=new qubit.opentag.compression.CookieCompressor({});Session.readCompressedCookie=function(name){var cookie=Cookie.get(name,true);return compressor.decompress(cookie)};Session.setupSession=function(container){var config=container.config;var session,i,cookie,cookieText,cookieName,now;session={};session.sessionCount=q.cookie.SimpleSessionCounter.update(config.cookieDomain);cookieName="qtag_"+container.getContainerId();var xCookieName="x_qtag_"+container.getContainerId();cookie=Cookie.get(cookieName);var nonCompressedCookie=!!cookie;if(cookie===null){cookie=Cookie.get(xCookieName,true);cookie=compressor.decompress(cookie)}if(cookie){try{cookie=JSON.parse(cookie)}catch(e){cookie={sc:0,sessionCount:0,pageViews:0,sessionStartTime:0,referrer:[],sessionLandingPage:"",__v:{}}}}else{cookie={sc:0,sessionCount:0,pageViews:0,sessionStartTime:0,referrer:[],sessionLandingPage:"",__v:{}}}now=new Date().getTime();if(session.sessionCount!==parseInt(cookie.sc,10)){cookie.sessionStartTime=now;cookie.sc=session.sessionCount;cookie.sessionCount+=1;cookie.referrer.push({url:Session.getReferrer(),landing:Utils.getUrl().substring(0,300),time:now});cookie.sessionLandingPage=Utils.getUrl().substring(0,300)}else{if(Session.isReferrerDifferent()){if(!Session.referrerIsSameAsPrevious(cookie.referrer,now,30*60*1000)){cookie.referrer.push({url:Session.getReferrer(),landing:Utils.getUrl().substring(0,300),time:now});cookie.sessionLandingPage=Utils.getUrl().substring(0,300);cookie.sessionStartTime=now;cookie.sessionCount+=1}}}session.sessionCount=cookie.sessionCount;session.sessionStartTime=cookie.sessionStartTime;session.pageStartTime=now;cookie.pageViews+=1;session.pageViews=cookie.pageViews;session.sessionLandingPage=cookie.sessionLandingPage;session.referrer=cookie.referrer;if(session.referrer.length>5){session.referrer.splice(2,session.referrer.length-5)}cookieText=JSON.stringify(cookie);i=0;while((compressor.compress(cookieText).length>config.maxCookieLength)&&(i<5)){if(cookie.referrer.length>=3){cookie.referrer.splice(2,1)}else{if(cookie.referrer.length===2){cookie.referrer=[cookie.referrer[0]]}else{if(cookie.referrer.length===1){cookie.referrer=[]}}}cookieText=JSON.stringify(cookie);i+=1}session.referrer=cookie.referrer;if(nonCompressedCookie){Cookie.rm(cookieName)}var xCookieText=compressor.compress(cookieText);Cookie.rm(xCookieName);if(config.maxCookieLength>0){Cookie.set(xCookieName,xCookieText,365,config.cookieDomain,true)}session.setVariable=function(key,value,time){var t=(!!time)?time:0;cookie.__v[key]=[value,t];var xCookieText=compressor.compress(JSON.stringify(cookie));if(config.maxCookieLength>0){Cookie.set(xCookieName,xCookieText,365,config.cookieDomain,true)}else{Cookie.rm(xCookieName)}};session.getCookie=function(name,compressed){var res=Cookie.get(name,true);if(res&&(compressed||name.indexOf("x_")===0)){log.FINE("getCookie() : Comressed cookie accessed:\n"+name+"="+res);try{res=compressor.decompress(res)}catch(ex){log.ERROR("Cookie failed to decompress: "+ex)}}else{if(res!==null){res=Cookie.decode(res)}}return res};session.getVariable=function(key){var v,t,now;v=cookie.__v[key];if(v){t=v[1];if((t===0)||(t>new Date().getTime())){return v[0]}}return null};session.on=function(event,el,fn){if(el.attachEvent){el.attachEvent("on"+event,fn)}else{if(el.addEventListener){el.addEventListener(event,fn,false)}}};session.getTagCookie=function(){return Session.readCompressedCookie(xCookieName)};Session.lastSession=session;return session};Session.referrerIsSameAsPrevious=function(referrers,now,overlapDuration){var url,landing,lastReferrer;if(referrers.length>0){url=Session.getReferrer();landing=Utils.getUrl().substring(0,300);lastReferrer=referrers[referrers.length-1];return(lastReferrer.url===url)&&(lastReferrer.landing===landing)&&((lastReferrer.time+overlapDuration)>now)}return false};Session.isReferrerDifferent=function(){var start,end,ref;ref=Session.getReferrer();start=ref.indexOf("://");if(start===-1){return true}start+=3;try{if(ref.substring(start).indexOf(Session.getDomain())!==0){return true}return false}catch(ex){return true}};Session.getReferrer=function(){if(document.referrer){return document.referrer.substring(0,300)}return"direct"};Session.getDomain=function(){return document.location.host}}());(function(){var Utils=qubit.opentag.Utils;var Define=qubit.Define;function LibraryTag(config){Utils.setIfUnset(config,LibraryTag.defaultConfig);if(this.singleton){var path=this.PACKAGE_NAME+"."+this.CLASS_NAME;var zuper=qubit.opentag.Utils.getObjectUsingPath(path,PKG_ROOT);if(zuper.__instance){zuper.__instance.log.FINEST("Returning singleton instance.");return zuper.__instance}zuper.__instance=this}LibraryTag.SUPER.call(this,config)}qubit.Define.clazz("qubit.opentag.LibraryTag",LibraryTag,qubit.opentag.BaseTag);LibraryTag.defaultConfig={vendor:null,imageUrl:null,description:"",async:false,isPrivate:false,upgradeable:true,html:"",parameters:[],prePostWindowScope:false};LibraryTag.prototype.pre=function(){this.log.FINEST("emtpy pre called")};LibraryTag.prototype.post=function(){this.log.FINEST("emtpy post called")};function extractAndEvalFunctionBody(fun,tag){var expr=fun.toString();expr=expr.replace(/\s*function\s*\([\w\s,_\d\$]*\)\s*\{/,"");expr=expr.substring(0,expr.lastIndexOf("}"));expr=expr.replace(/(["']\s*\+\s*)\s*_*\w+\s*\.\s*valueForToken\s*\(\s*'([^']*)'\s*\)/g,'$1"${$2}"');expr=expr.replace(/\s*_*\w+\s*\.\s*valueForToken\s*\(\s*'([^']*)'\s*\)(\s*\+\s*["'])/g,'"${$1}"$2');expr=expr.replace(/(["']\s*\+\s*)\s*_*\w+\s*\.\s*valueForToken\s*\(\s*"([^"]*)"\s*\)/g,'$1"${$2}"');expr=expr.replace(/\s*_*\w+\s*\.\s*valueForToken\s*\(\s*"([^"]*)"\s*\)(\s*\+\s*["'])/g,'"${$1}"$2');expr=expr.replace(/(\s*)_*\w+\s*\.\s*valueForToken\s*\(\s*'([^']*)'(\s*)\)/g,"$1${$2}$3");expr=expr.replace(/(\s*)_*\w+\s*\.\s*valueForToken\s*\(\s*"([^"]*)"(\s*)\)/g,"$1${$2}$3");expr=tag.replaceTokensWithValues(expr);Utils.geval(expr)}LibraryTag.prototype.before=function(){LibraryTag.SUPER.prototype.before.call(this);try{var cfg=this.config;if(cfg&&cfg.pre){if(typeof (cfg.pre)==="function"){this.pre=cfg.pre}else{var expr=this.replaceTokensWithValues(String(cfg.pre));this.pre=Utils.expressionToFunction(expr).bind(this)}}if(this.config.prePostWindowScope&&this.pre!==LibraryTag.prototype.pre&&this.pre.toString){extractAndEvalFunctionBody(this.pre,this)}else{this.pre()}}catch(ex){this.log.ERROR(this.config.name+" exception while running pre: "+ex);return true}return false};LibraryTag.prototype.after=function(success){LibraryTag.SUPER.prototype.after.call(this,success);try{var cfg=this.config;if(cfg&&cfg.post){if(typeof (cfg.post)==="function"){this.post=cfg.post}else{var expr=this.replaceTokensWithValues(String(cfg.post));this.post=Utils.expressionToFunction(expr).bind(this)}}if(this.config.prePostWindowScope&&this.post!==LibraryTag.prototype.post&&this.post.toString){extractAndEvalFunctionBody(this.post,this)}else{this.post(success)}}catch(ex){this.log.ERROR(this.config.name+" exception while running post: "+ex)}};LibraryTag.define=function(namespace,libConfig){namespace=namespace.replace(/^[\.]+/g,"").replace(/[\.]+$/g,"").replace(/\.+/g,".");namespace=qubit.Define.vendorsSpaceClasspath(namespace);var libraryDefaultConfig={};if(libConfig.getDefaultConfig){libraryDefaultConfig=libConfig.getDefaultConfig()}var constr=libConfig.CONSTRUCTOR;var prototypeTemplate={};for(var prop in libConfig){if(prop!=="config"){prototypeTemplate[prop]=libConfig[prop]}}var constructor=function(cfg){cfg=cfg||{};cfg=Utils.overrideFromLeftToRight(libraryDefaultConfig,cfg);var ret=qubit.opentag.LibraryTag.call(this,cfg);if(constr){constr.call(this,cfg)}if(ret){return ret}};var ret=qubit.opentag.Utils.defineWrappedClass(namespace,LibraryTag,prototypeTemplate,GLOBAL,constructor);var ns=Define.STANDARD_VS_NS+".";if(namespace.indexOf(ns)!==0){Utils.namespace(ns+namespace,ret)}return ret};LibraryTag.getLibraryByClasspath=function(namespace){return Utils.getObjectUsingPath(namespace,qubit.Define.getVendorSpace())}}());(function(){var LibraryTag=qubit.opentag.LibraryTag;var Define=qubit.Define;function Quick(){}Quick.library=function(){return LibraryTag.define.apply(LibraryTag,arguments)};Quick.libraryRef=function(){return LibraryTag.getLibraryByClasspath.apply(LibraryTag.getLibraryByClasspath,arguments)};Define.namespace("qubit.Quick",Quick)}());(function(){var Utils=qubit.opentag.Utils;var BaseFilter=qubit.opentag.filter.BaseFilter;var Filter=qubit.opentag.filter.Filter;var BaseTag=qubit.opentag.BaseTag;var Timed=qubit.opentag.Timed;var Tags=qubit.opentag.Tags;var Session=qubit.opentag.Session;var Cookie=qubit.Cookie;var log=new qubit.opentag.Log("Container -> ");var _counter=1;try{window.opentag_consentGiven=function(){Container.consentIsGiven=true;var all=Container.getContainers();for(var i=0;i<all.length;i++){try{all[i].run()}catch(ex){log.ERROR("error running consent dependant containers: "+ex)}}}.bind(this)}catch(ex){log.WARN("opentag_consentGiven could not be set!")}function Container(config){this.runQueue=[];this.log=new qubit.opentag.Log("",function(){return this.CLASS_NAME+"["+this.config.name+"]"}.bind(this),true);this.tags={};this.config={cookieDomain:"",maxCookieLength:1000,gzip:true,delayDocWrite:false,clientId:"",name:"",tellLoadTimesProbability:null,pingServerUrl:null,trackSession:null,disabled:false,containerId:"",scanTags:false,noPings:false};this.ignoreTagsState=false;if(config){this.setConfig(config);if(!config.name){this.config.name="Cont-"+_counter++}Container.register(this);this.log.FINE("container registered.");if(Container.NO_PINGS){this.config.noPings=true}this.ping=new qubit.opentag.Ping(this.config);this._sendPingsTrigger=this.sendPings.bind(this);if(config.init){try{config.init.call(this,config)}catch(ex){this.log.ERROR("init call failed:"+ex)}}var _this=this;this._tagLoadedHandler=function(event){if(_this._containerAlreadySentPings){_this.sendPingsNotTooOften();if(event.success){}}}}return this}qubit.Define.clazz("qubit.opentag.Container",Container);var containers=[];Container.register=function(ref){Utils.addToArrayIfNotExist(containers,ref)};Container.prototype.isTellingLoadTimes=function(){var value=this.config.tellLoadTimesProbability;if(value===null){value=0}return value>Math.random()};Container.prototype.destroy=function(withTags){this.destroyed=true;this.unregister();if(withTags){for(var prop in this.tags){var tag=this.tags[prop];if(tag instanceof BaseTag){tag.destroy();this.tags[prop]=null;delete this.tags[prop]}}}var name=this.PACKAGE_NAME.split(".");name=name[name.length-1];var pkg=Utils.getParentObject(this.PACKAGE_NAME);pkg[name]=null;delete pkg[name]};Container.findContainersByName=function(name){var items=this.getContainers();var results=[];for(var i=0;i<items.length;i++){if(items[i].config.name===name){results.push(items[i])}}return results};Container.getById=function(id){var items=this.getContainers();for(var i=0;i<items.length;i++){if(items[i].getContainerId()===id){return items[i]}}return null};Container.prototype.unregister=function(withTags){Container.unregister(this,withTags)};Container.unregister=function(ref,withTags){Utils.addToArrayIfNotExist(containers,ref);log.FINEST('Un-registering container named "'+ref.config.name+'", instance of:');log.FINEST(ref,true);var index=Utils.removeFromArray(containers,ref);if(withTags){for(var prop in this.tags){var tag=this.tags[prop];if(tag instanceof BaseTag){tag.unregister();this.tags[prop]=null;delete this.tags[prop]}}}if(!index||index.length===0){log.FINE("container is already unregisterd.")}};Container.prototype.hasConsent=function(){return Cookie.get("qubitconsent")==="Accepted"};Container.prototype.register=function(ref){Container.register(ref||this)};Container.getContainers=function(){return containers};Container.prototype.getContainers=function(){return Container.getContainers()};Container.prototype.onTagRegistered=function(tag){};Container.prototype.registerTag=function(tag){var name=tag.config.name;if(this.tags[name]){this.log.FINE("Tag with name `"+name+"` already is registered!")}else{this.tags[name]=tag;tag.onAfter(this._tagLoadedHandler);try{this.onTagRegistered(tag)}catch(ex){this.log.ERROR("onTagRegistered exception: "+ex)}}};Container.prototype.registerTags=function(tags){for(var i=0;i<tags.length;i++){this.registerTag(tags[i])}};Container.prototype.setConfig=function(config){this.log.FINEST("Setting configuration:");this.log.FINEST(config,true);for(var prop in config){this.config[prop]=config[prop]}};Container.prototype.run=function(){this.log.FINE("starting loading");this.runTags({command:"runOnceIfFiltersPass"})};Container.prototype.runWithoutFilters=function(){this.log.FINE("starting loading");this.runTags({command:"run"})};Container.prototype.getTagByname=function(name){return this.tags[name]};Container.prototype.containerScriptLoadedSynchronously=function(){var i,ii,script,scripts,src;scripts=document.getElementsByTagName("script");for(i=0,ii=scripts.length;i<ii;i+=1){script=scripts[i];src=script.getAttribute("src");if(!!src&&(src.indexOf(""+this.config.clientId+"-"+this.getContainerId()+".js")>0)){return(script.getAttribute("async")===null&&(script.getAttribute("defer")===false||script.getAttribute("defer")===""||script.getAttribute("defer")===null))}}return true};Container.prototype.prepareSessionIfNeeded=function(){var trackSession=this.config.trackSession;if(trackSession!==true&&trackSession!==false){var tags=this.tags;for(var name in tags){if(tags.hasOwnProperty(name)){var tmpTag=tags[name];tmpTag.resolveAllDynamicData();var filters=tmpTag.getFilters();for(var i=0;i<filters.length;i++){var filter=filters[i];if(filter instanceof Filter&&filter.isSession()){this.trackSession=true;break}}if(this.trackSession){break}}}}else{this.trackSession=trackSession}if(Container.TRACK_SESSION){this.trackSession=true}if(this.trackSession){this.session=Session.setupSession(this)}if(this.session){}};Container.prototype.runTags=function(config,force){if(this.destroyed){throw"Container has been destroyed."}if(!force){if(Container.LOCKED||Utils.global().QUBIT_CONTAINERS_LOCKED){this.log.WARN("Container locked - stopping here.");return }}if(this.onBeforeRun){try{this.onBeforeRun()}catch(ex){this.log.ERROR("Soft failure [Container.onBeforeRun()]: "+ex)}}var forceAsync=!this.containerScriptLoadedSynchronously();var command="runIfFiltersPass";if(config&&config.command){command=config.command}this.runningStarted=new Date().valueOf();this.log.FINE("triggering runningStarted at "+this.runningStarted);var firedTagsMap={};if(this.config.scanTags){if(!this._scanned){this.scanForTags();this._scanned=new Date().valueOf()}}this.prepareSessionIfNeeded();var orderedTags=this.getTagsInOrder();for(var z=0;z<orderedTags.length;z++){try{var tag=orderedTags[z];var name=tag.config.name;if(this.includedToRun(tag)){var deps=tag.resolveDependencies();if(deps.length>0){for(var i=0;i<deps.length;i++){var dependency=deps[i];var depName=dependency.config.name;if(!firedTagsMap[depName]&&this.tags[depName]){firedTagsMap[depName]=dependency;this._tagRunner(dependency,command,forceAsync)}}}if(!firedTagsMap[name]){firedTagsMap[name]=tag;this._tagRunner(tag,command,forceAsync)}}}catch(ex){this.log.ERROR("Error while preparing tag '"+name+"' to run.\n Error: "+ex)}}Timed.setTimeout(function(){this.sendPingsNotTooOften()}.bind(this),1100);this.waitForAllTagsToFinish()};Container.prototype.getTagsInOrder=function(){var tagsOrdered=[];for(var name in this.tags){var tmpTag=this.tags[name];var priority=tmpTag.config.priority;if((+priority)>0){var prIndex=0;for(var c=0;c<tagsOrdered.length;c++){var tmpTagOrdered=tagsOrdered[c];if(tmpTagOrdered){var priorityAlreadyIn=+tmpTagOrdered.config.priority;if(priorityAlreadyIn>0&&priorityAlreadyIn>priority){prIndex++}else{break}}}tagsOrdered.splice(prIndex,0,tmpTag)}else{tagsOrdered.push(tmpTag)}}return tagsOrdered};Container.prototype._tagRunner=function(tag,command,forceAsync){try{if(this.includedToRun(tag)){this.log.FINE("triggering tag named: "+tag.config.name);if(forceAsync){tag.forceAsynchronous=true}if(this.config.delayDocWrite){tag.delayDocWrite=true}tag.session=tag.session||this.session;tag[command]()}}catch(ex){this.log.ERROR(" -> tagRunner: Error running tag with name '"+tag.config.name+"'.\n Error: "+ex)}};Container.prototype.getContainerId=function(){if(this.config.containerId){return this.config.containerId}else{if(this._pkgName){return this._pkgName}var idx=this.PACKAGE_NAME.split(".");idx=idx[idx.length-1];this._pkgName=idx;return idx}};Container.prototype.includedToRun=function(tag){if(!tag){return false}var cfg=tag.config;if(cfg.inactive){return false}if(cfg.disabled){if(!tag.cookieSaysToRunEvenIfDisabled()){return false}}if(tag.disabledByCookie()){return false}var consentOk=Container.consentIsGiven||(!cfg.needsConsent)||this.hasConsent();var atInitialState=(tag.state===BaseTag.prototype.STATE.INITIAL);return this.ignoreTagsState||(consentOk&&atInitialState)};Container.prototype.scanForTags=function(clean,pkg){if(clean){this.tags={}}var tags;if(pkg&&typeof (pkg)==="object"){tags=this.findAllTags(pkg)}else{tags=this.findAllTagsByClassPath()}this.registerTags(tags);return tags};Container.prototype.findAllTags=function(pckg,maxDeep){pckg=pckg||this.tagsPackageName||this.PACKAGE_NAME;return Tags.findAllTags(pckg,maxDeep)};Container.prototype.findAllTagsByClassPath=function(startsWith){startsWith=startsWith||this.PACKAGE_NAME;return Tags.findAllTagsByClassPath(startsWith)};Container.prototype.findAllFilters=function(pckg,maxDeep){pckg=pckg||this.tagsPackageName||this.PACKAGE_NAME;return Tags.findAllFilters(pckg,maxDeep)};Container.prototype.waitForAllTagsToFinish=function(){if(this._waitForAllTagsToFinishWaiting){return }if(!this._lastWaited){this._lastWaited=new Date().valueOf()}var l=this.log;var timedOut=(new Date().valueOf()-this._lastWaited)>15*1000;var finished=this.allTagsFinished()||timedOut;if(!this._showFinishedOnce&&finished){this._lastWaited=null;if(timedOut){this.log.WARN("Waiting too long. Check tags dependencies.")}this._showFinishedOnce=true;this.runningFinished=new Date().valueOf();var results=this.getAllTagsByState();var awaitingLen=results.awaiting===null?0:Utils.keys(results.awaiting).length;var styling=" ;color: #0F7600;font-size: 12px;font-weight:bold; ";var len;if(results.run){len=Utils.keys(results.run).length}else{}if(results.failed){len=Utils.keys(results.failed).length;var addRed=results.failed===null?"":"color: #DF5500;"}else{}if(results.awaiting){len=Utils.keys(results.awaiting).length}else{}if(results.consent){len=Utils.keys(results.consent).length}else{}if(results.locked){len=Utils.keys(results.locked).length}else{}if(results.other){len=Utils.keys(results.other).length}else{}this._containerAlreadySentPings=new Date().valueOf();this.sendPingsNotTooOften();if(this.onTagsInitiallyRun){this.onTagsInitiallyRun()}}else{if(!finished){this._waitForAllTagsToFinishWaiting=true;this._showFinishedOnce=false;Timed.setTimeout(function(){this._waitForAllTagsToFinishWaiting=false;this.waitForAllTagsToFinish()}.bind(this),100)}else{}}};Container.prototype.onTagsInitiallyRun=EMPTY_FUN;Container.prototype.resetAllTags=function(skipFilters){this.log.WARN("reseting all tags!");for(var prop in this.tags){if(this.tags.hasOwnProperty(prop)){var tag=this.tags[prop];tag.reset();if(!skipFilters){tag.resetFilters()}}}};Container.prototype.reset=function(skipFilters){this.log.WARN("reseting container!");this.runningFinished=undefined;this._waitForAllTagsToFinishWaiting=undefined;this.runningStarted=undefined;this._showFinishedOnce=undefined;this.resetAllTags(skipFilters)};Container.prototype.sendPingsNotTooOften=function(){this._sndLck=this._sndLck||{};Timed.runIfNotScheduled(this._sendPingsTrigger,2000,this._sndLck)};Container.prototype.sendPings=function(){if(this.config.noPings){this.log.WARN("Pings are cancelled due to configuration.");return }var i;if(this.isTellingLoadTimes()){var results=this.getAllTagsByState();var _this=this;var loadTimes;if(results.run){loadTimes=Tags.getLoadTimes(results.run);this.lastPingsSentTime=new Date().valueOf();this.ping.send(this,loadTimes)}loadTimes=Tags.getLoadTimes();var deduplicatedTagsToBeSent=[];for(i=0;i<loadTimes.length;i++){var tag=loadTimes[i].tag;if(tag.config.dedupe&&tag.sendDedupePing){deduplicatedTagsToBeSent.push(tag)}}if(deduplicatedTagsToBeSent.length>0){this.lastDedupePingsSentTime=new Date().valueOf();this.ping.sendDedupe(this,deduplicatedTagsToBeSent)}if(results.other){loadTimes=Tags.getLoadTimes(results.other);var otherTagsToBeSent=[];for(i=0;i<loadTimes.length;i++){otherTagsToBeSent.push(loadTimes[i])}if(otherTagsToBeSent.length>0){this.ping.send(this,otherTagsToBeSent)}}if(results.awaiting){loadTimes=Tags.getLoadTimes(results.awaiting);var awaitingTagsToBeSent=[];for(i=0;i<loadTimes.length;i++){awaitingTagsToBeSent.push(loadTimes[i])}if(awaitingTagsToBeSent.length>0){this.ping.send(this,awaitingTagsToBeSent)}}}};Container.prototype.getAllTagsByState=function(){return Container.getAllTagsByState(this.tags)};Container.getAllTagsByState=function(tags){var runScripts=null,other=null,filterReady=null,failed=null,consent=null,locked=null;var LOWEST_FAIL_STATE=BaseTag.prototype.STATE.EXECUTED_WITH_ERRORS;for(var prop in tags){var tag=tags[prop];if(tag instanceof BaseTag){var name=tag.config.name;if(tag.scriptExecuted>0){runScripts=runScripts||{};attachRenamedIfExist(runScripts,tag,name)}else{if(tag.locked){locked=locked||{};attachRenamedIfExist(locked,tag,name)}else{if(tag.scriptExecuted<0||(tag.state>=LOWEST_FAIL_STATE)){failed=failed||{};attachRenamedIfExist(failed,tag,name)}else{if(tag.filtersState()===BaseFilter.state.SESSION||tag.filtersState()>0){filterReady=filterReady||{};attachRenamedIfExist(filterReady,tag,name)}else{if(tag.config.needsConsent){consent=consent||{};attachRenamedIfExist(consent,tag,name)}else{other=other||{};attachRenamedIfExist(other,tag,name)}}}}}}}return{run:runScripts,failed:failed,awaiting:filterReady,consent:consent,locked:locked,other:other}};var steps={};function attachRenamedIfExist(obj,src,name){if(obj[name]){steps[name]=steps[name]||1;name+="("+steps[name]+")";steps[name]++}obj[name]=src}Container.prototype.allTagsFinished=function(){for(var prop in this.tags){if(this.tags.hasOwnProperty(prop)){var tag=this.tags[prop];if(tag instanceof qubit.opentag.BaseTag){var state=tag.filtersState();if(!tag.config.disabled){var notFailedAndUnlocked=tag.filtersState()<0&&!tag.locked;var tagNotFinishedOrNotRunner=!(tag.finished()||(tag.config.runner&&!tag.isRunning));if(notFailedAndUnlocked&&tagNotFinishedOrNotRunner){var isNotSession=(state!==BaseFilter.state.SESSION);var doesWaitForDeps=+tag.awaitingDependencies>0;if(isNotSession&&!doesWaitForDeps){return false}}}}}}return true};Container.prototype.getPageVariables=function(){var vars=[];for(var prop in this.tags){if(this.tags.hasOwnProperty(prop)){var tVars=this.tags[prop].getPageVariables();for(var i=0;i<tVars.length;i++){Utils.addToArrayIfNotExist(vars,tVars[i])}}}return vars};Container.getPageVariableByName=function(name){var vars=this.getAllPageVariables();var rets=[];for(var i=0;i<vars.length;i++){if(vars[i].config.name===name){rets.push(vars[i])}}return rets};var disableCookiePrefix="qubit.opentag.disableContainerRunning_";var forceCookiePrefix="qubit.opentag.forceContainerRunning";Container.prototype._getCookieNameForDisabling=function(){return disableCookiePrefix+this.getContainerId()+this.config.name};Container.prototype.disabledByCookie=function(){return !!Cookie.get(this._getCookieNameForDisabling())};Container.prototype.setCookieToDisable=function(){Cookie.set(this._getCookieNameForDisabling(),"true")};Container.prototype.rmCookieToDisable=function(){Cookie.rm(this._getCookieNameForDisabling())};Container.rmAllDisablingCookies=function(){Utils.rmCookiesMatching(disableCookiePrefix)};Container.setCookieForDisabledContainersToRun=function(){Cookie.set(forceCookiePrefix,"true")};Container.rmCookieForDisabledContainersToRun=function(){Cookie.rm(forceCookiePrefix)}})();(function(){var Utils=qubit.opentag.Utils;function CustomTag(config){var defaults={url:null,html:"",locationPlaceHolder:"NOT_END",locationObject:"BODY",async:true};Utils.setIfUnset(config,defaults);CustomTag.SUPER.call(this,config)}qubit.Define.clazz("qubit.opentag.CustomTag",CustomTag,qubit.opentag.LibraryTag)}());(function(){function trim(text){return text.replace(/^\s+/,"").replace(/\s+$/,"")}var UVListener={callbacks:{},unfired_events:[],early_callbacks:null,currentUV:null},uv,uvLocation="universal_variable",starterId=0,POLL_DELAY_MS=500,timer;UVListener._isArray=function(input){return(Object.prototype.toString.call(input)==="[object Array]")};UVListener._targetChanged=function(keyString,old,newObject){var oldAsObject,oldTarget,newTarget;if(newObject===null){if(old==="null"){return false}else{return true}}else{if(newObject===undefined){if(old===newObject){return false}else{return true}}else{oldAsObject=JSON.parse(old);oldTarget=UVListener._getNested(oldAsObject,keyString);newTarget=UVListener._getNested(newObject,keyString);return !UVListener._jsonIsEqual(oldTarget,newTarget)}}};UVListener._processCallbacks=function(){var i;if(UVListener.early_callbacks&&UVListener.early_callbacks.length>0){for(i=0;i<UVListener.early_callbacks.length;i+=1){UVListener.push(UVListener.early_callbacks[i])}UVListener.early_callbacks=null}};UVListener._keyStringToArr=function(keyString){keyString=trim(keyString);if(keyString===""){return[]}else{keyString=keyString.replace(/\[(\w+)\]/g,".$1");keyString=keyString.replace(/^\./,"");return keyString.split(".")}};UVListener._getNested=function(object,keyString){var arr=UVListener._keyStringToArr(keyString),n;while(arr.length>0){n=arr.shift();if(object.hasOwnProperty(n)){object=object[n]}else{return }}return object};UVListener._jsonIsEqual=function(obj1,obj2){if(typeof obj1!=="string"){obj1=JSON.stringify(obj1,UVListener._stripEvents)}if(typeof obj2!=="string"){obj2=JSON.stringify(obj2,UVListener._stripEvents)}return obj1===obj2};UVListener._stripEvents=function(key,value){if(key!=="events"){return value}else{return undefined}};UVListener._on=function(type,func){var typeArray,key;typeArray=type.split(":");type=typeArray[0];key=typeArray[1];UVListener.callbacks[type]=UVListener.callbacks[type]||[];if(key){UVListener.callbacks[type].push({keyString:key,func:func})}else{UVListener.callbacks[type].push({func:func})}};UVListener._trigger=function(type,data){var i,keyString;if(UVListener.callbacks[type]){for(i=0;i<UVListener.callbacks[type].length;i+=1){if(typeof UVListener.callbacks[type][i].func==="function"){keyString=UVListener.callbacks[type][i].keyString;if(keyString){if(type==="change"&&UVListener._targetChanged(keyString,UVListener.currentUV,uv)){UVListener.callbacks[type][i].func(data)}}else{UVListener.callbacks[type][i].func(data)}}}}};UVListener._eventsPush=function(evt){var i,ii;uv.events[uv.events.length]=evt;evt.time=evt.time||(new Date()).getTime();if(UVListener.callbacks.event){i=0;ii=UVListener.callbacks.event.length;for(i;i<ii;i+=1){UVListener.callbacks.event[i].func(evt)}}evt.has_fired=true};UVListener._getUnfiredEvents=function(){var i=0;for(i=0;i<uv.events.length;i+=1){if(!uv.events[i].has_fired){UVListener.unfired_events.push(uv.events.splice(i,1)[0]);i-=1}}};UVListener._fireEvents=function(){while(UVListener.unfired_events.length>0){uv.events.push(UVListener.unfired_events.shift())}};UVListener._resetEventsPush=function(){uv.events=uv.events||[];if(uv.events.push.toString().indexOf("[native code]")!==-1){uv.events.push=UVListener._eventsPush;UVListener._getUnfiredEvents();UVListener._fireEvents()}};UVListener._checkForChanges=function(){if(UVListener.callbacks.change&&UVListener.callbacks.change.length>0){if(!UVListener._jsonIsEqual(UVListener.currentUV,uv)){UVListener._trigger("change",uv);UVListener.currentUV=JSON.stringify(uv,UVListener._stripEvents)}}};UVListener._setUVLocation=function(newLoc){uvLocation=newLoc;UVListener._initUV()};UVListener._initUV=function(){window[uvLocation]=window[uvLocation]||{events:[]};uv=window[uvLocation];if(!uv.events){uv.events=[]}};UVListener.push=function(data){if(!UVListener._isArray(data)){return }if(data[0]==="on"){UVListener._on(data[1],data[2])}else{if(data[0]==="trigger"&&data[1]){UVListener._trigger(data[1])}}};UVListener.init=function(testing,uvLoc){if(uvLoc){uvLocation=uvLoc}UVListener._initUV();if(!window.uv_listener||UVListener._isArray(window.uv_listener)){UVListener.early_callbacks=window.uv_listener||null;window.uv_listener=UVListener;if(!testing){UVListener.start()}}else{if(uvLoc){window.uv_listener._setUVLocation(uvLocation)}}};UVListener.start=function(){UVListener.currentUV=JSON.stringify(uv,UVListener._stripEvents);timer=setInterval(function(){UVListener._initUV();UVListener._resetEventsPush();UVListener._checkForChanges()},POLL_DELAY_MS);UVListener._processCallbacks()};q.html.UVListener=UVListener}());(function(){var log=new qubit.opentag.Log("Main -> ");var Cookie=qubit.Cookie;var Utils=qubit.opentag.Utils;function Main(){}function requestedDebugMode(){var isDebug=false;if(Cookie.get("opentag_debug")||document.location.href.indexOf("opentag_debug")>=0){isDebug=true}return isDebug}function requestedDebugTool(){var isDebug=false;if(Cookie.get("opentag_debug_tool")||document.location.href.indexOf("opentag_debug_tool")>=0){isDebug=true}return isDebug}function disabled(){try{var fun=GLOBAL.TAGSDK_MAIN_DISABLED_FUNCTION;if(fun&&fun()){return true}}catch(ex){log.ERROR("Buggy GLOBAL.TAGSDK_MAIN_DISABLED_FUNCTION ?\n "+ex)}if(document.location.href.indexOf("opentag_disabled=true")>=0){return true}return false}qubit.opentag.Log.setLevel(qubit.opentag.Log.LEVEL_NONE);qubit.opentag.Log.setCollectLevel(3);qubit.opentag.Log.setLevel(qubit.opentag.Log.LEVEL_INFO);qubit.opentag.Log.setCollectLevel(4);qubit.opentag.Log.setLevelFromCookie();Main.run=function(){var needDebugModeButNotInDebug=false;if(disabled()){return }var selfDebug=false;selfDebug=true;qubit.DEBUG_MODE=true;var debugToolRequested=requestedDebugTool();var debugRequested=debugToolRequested||requestedDebugMode();if(!selfDebug&&debugRequested){if(!qubit.DEBUG_MODE){GLOBAL.TAGSDK_NS_OVERRIDE=true}else{GLOBAL.TAGSDK_NS_OVERRIDE=false}needDebugModeButNotInDebug=true}if(qubit.DEBUG_MODE){GLOBAL.TAGSDK_NS_OVERRIDE=false}try{q.html.UVListener.init()}catch(uvInitFalure){}Main.runAllContainers(needDebugModeButNotInDebug);if(!needDebugModeButNotInDebug){if(selfDebug&&debugToolRequested&&!GLOBAL.TAGSDK_DEBUG_TOOL_LOADED){var debugTool=document.createElement("script");debugTool.src="https://s3-eu-west-1.amazonaws.com/opentag-dev/debug-tool/loader-v3.js";document.getElementsByTagName("head")[0].appendChild(debugTool);GLOBAL.TAGSDK_DEBUG_TOOL_LOADED=true}}};function setIfUnset(object,property,value){if(value&&(object[property]===undefined||object[property]===""||object[property]===null)){object[property]=value}}Main.runAllContainers=function(needDebugModeButNotInDebug){try{var containers=qubit.opentag.Container.getContainers();for(var i=0;i<containers.length;i++){var container=containers[i];var contCfg=container.config;if(!container.runningStarted&&!container.configuredInMain){contCfg.scanTags=true;var clientConfig=Utils.getParentObject(container.PACKAGE_NAME).ClientConfig;if(clientConfig){setIfUnset(container.config,"clientId",clientConfig.id)}var sysDefaults=Utils.getParentObject(container.PACKAGE_NAME).SystemDefaults;if(sysDefaults){setIfUnset(contCfg,"pingServerUrl",sysDefaults.pingServerUrl);setIfUnset(contCfg,"tellLoadTimesProbability",sysDefaults.tellLoadTimesProbability)}container.configuredInMain=true;if(needDebugModeButNotInDebug){container.destroy(true);Main.loadDebugVersion(container)}else{if(!GLOBAL.QUBIT_OPENTAG_STOP_MAIN_EXECUTION){container.run()}else{(function(){var runner=qubit.opentag.RUN_STOPPED_EXECUTON;qubit.opentag.RUN_STOPPED_EXECUTON=function(){try{if(runner){runner()}}finally{container.run()}}}(container))}}}}}catch(ex){}};function getClientId(container){var parent=qubit.opentag.Utils.getParentObject(container.PACKAGE_NAME);var cfg=parent.ClientConfig;if(cfg&&cfg.clientId){return cfg.clientId}else{var parts=container.PACKAGE_NAME.split(".");return parts[parts.length-2].substring(1)}}Main.loadDebugVersion=function(container){var debugScript=document.createElement("script");var url;var scriptURL=container.config.scriptURL;var clientId=getClientId(container);var containerId=container.getContainerId();if(scriptURL){url=scriptURL;var dLen="-debug.js".length;if(url.lastIndexOf("-debug.js")!==url.length-dLen){url=url.substring(0,url.length-".js".length);url+="-debug.js"}}var urlCDN="//d3c3cq33003psk.cloudfront.net/opentag-"+clientId+"-"+containerId+"-debug.js";if(url&&urlCDN!==url){debugScript.src=url}else{debugScript.src="//s3-eu-west-1.amazonaws.com/opentag/opentag-"+clientId+"-"+containerId+"-debug.js"}document.getElementsByTagName("head")[0].appendChild(debugScript)};qubit.Define.namespace("qubit.opentag.Main",Main)}());if(typeof module==="object"&&module.exports){module.exports=createUv}else{if(window){window.uv=createUv()}}function createUv(){var emittingEvents=[];var uv={emit:emit,on:on,once:once,events:[],listeners:[]};return uv;function emit(type,data){data=clone(data||{});data.meta=data.meta||{};data.meta.type=type;emittingEvents.push(data);if(emittingEvents.length===1){callHandlers(emittingEvents[0])}uv.listeners=filter(uv.listeners,function(l){return !l.disposed})}function callHandlers(event){uv.events.push(event);forEach(uv.listeners,function(listener){if(listener.disposed){return }if(!matches(listener.type,event.meta.type)){return }try{listener.callback.call(listener.context,event)}catch(e){if(console&&console.error){console.error("Error emitting UV event",e.stack)}}});emittingEvents.shift();if(emittingEvents.length>0){callHandlers(emittingEvents[0])}}function on(type,callback,context){var listener={type:type,callback:callback,disposed:false,context:context||window};uv.listeners.push(listener);var subscription={replay:replay,dispose:dispose};return subscription;function replay(){forEach(uv.events,function(event){if(listener.disposed){return }if(!matches(type,event.meta.type)){return }callback.call(context,event)});return subscription}function dispose(){listener.disposed=true;return subscription}}function once(type,callback,context){var subscription=uv.on(type,function(){callback.apply(context||window,arguments);subscription.dispose()});return subscription}function forEach(list,iterator){var length=list.length;for(var i=0;i<length;i++){iterator(list[i],i)}}function clone(input){var output={};for(var key in input){if(input.hasOwnProperty(key)){output[key]=input[key]}}return output}function matches(test,subject){return typeof test==="string"?test===subject:test.test(subject)}function filter(list,iterator){var l=list.length;var output=[];for(var i=0;i<l;i++){if(iterator(list[i])){output.push(list[i])}}return output}}var allEventsByType={};var unqueuedEvents=[];var inititated=false;var inititatedSuccessfully=false;var global=qubit.Define.global();function getUV(){return global.uv}function initiate(){var uv=getUV();if(!uv||!uv.emit){return false}if(!inititated){inititated=true;for(var i=0;i<unqueuedEvents.length;i++){var tmp=unqueuedEvents[i];if(tmp.on){uv.on.apply(uv,tmp.on)}else{if(tmp.emit){uv.emit.apply(uv,tmp.emit)}}}uv.on(/.*/,function(event){var type=event.meta.type;var obj=allEventsByType[type];if(!obj){allEventsByType[type]={current:event,history:[event]}}else{obj.current=event;obj.history.push(event)}}).replay();inititatedSuccessfully=true}return true}var PubSub={allEventsByType:allEventsByType,subscribe:function(eventName,callback){if(inititatedSuccessfully){var uv=getUV();uv.on(eventName,callback)}else{unqueuedEvents.push({on:[eventName,callback]})}},getEventHistory:function(name){return this.allEventsByType[name]},publish:function(eventName,event){if(inititatedSuccessfully){var uv=getUV();uv.emit(eventName,event)}else{unqueuedEvents.push({emit:[eventName,event]})}},connect:function(){initiate()}};PubSub.connect();qubit.Define.namespace("qubit.qprotocol.PubSub",PubSub);(function(){var PubSub=qubit.qprotocol.PubSub;var Utils=qubit.opentag.Utils;var DELIMITER=":";function QProtocolVariable(config){QProtocolVariable.SUPER.apply(this,arguments)}qubit.Define.clazz("qubit.opentag.pagevariable.QProtocolVariable",QProtocolVariable,qubit.opentag.pagevariable.BaseVariable);QProtocolVariable.prototype.init=function(){if(this.initialized){return false}else{this.initialized=new Date().valueOf()}this.callHandlersOnRead=true;if(!this.handlerAttached){var _this=this;var result=this.getValueAndPath(this.value);this.eventName=result[0];this.objectPath=result[1];this.updateValue();PubSub.subscribe(this.eventName,function(event){_this.updateValue(event)});this.handlerAttached=new Date().valueOf()}};QProtocolVariable.prototype.getValueAndPath=function(value){var eventName=value;var opath;if(eventName){var idx=value.indexOf(DELIMITER);if(idx!==-1){eventName=value.substring(0,idx);opath=value.substring(idx+1)}}return[eventName,opath]};QProtocolVariable.prototype.getValue=function(){this.init();return this.currentValue};QProtocolVariable.prototype.getEventsHistory=function(){return PubSub.getEventHistory(this.eventName)};QProtocolVariable.prototype.updateValue=function(event){if(!event){var history=this.getEventsHistory();if(history){event=history.current}}var newValue;var opath=this.objectPath;if(event&&opath){newValue=Utils.getObjectUsingPath(opath,event)}else{newValue=event}this._updateCurrentValue(newValue);return newValue};QProtocolVariable.prototype.startObservingForChanges=function(){};QProtocolVariable.prototype.stopObservingForChanges=function(){}}());(function(){function UniversalVariable(config){UniversalVariable.SUPER.apply(this,arguments)}qubit.Define.clazz("qubit.opentag.pagevariable.UniversalVariable",UniversalVariable,qubit.opentag.pagevariable.Expression)}())}());(function(){var L="";function E(){L="";if(!(typeof ae_parms_kv==="undefined")){for(key in ae_parms_kv){if(!(typeof key==="undefined")){if(!(typeof ae_skip_var==="undefined")&&Array.isArray(ae_skip_var)&&ae_skip_var.indexOf(key)>-1){continue}if(ae_parms_kv[key] instanceof Array){L=L+"&"+key+"="+encodeURIComponent(ae_parms_kv[key].join(","))}else{if(!(typeof ae_parms_kv[key]==="undefined")){L=L+"&"+key+"="+encodeURIComponent(ae_parms_kv[key])}}if(L.length>2000){break}}}}}E();var K=Math.floor(Math.random()*99999999999);var A=new qubit.opentag.filter.Filter({name:"depth6Filter"});A.customScript=function(){if(ae_parms_kv.depth==6){return true}else{return false}};var J=new qubit.opentag.filter.Filter({name:"depth7Filter"});J.customScript=function(){if(ae_parms_kv.depth==7){return true}else{return false}};var F=new qubit.opentag.Container({maxCookieLength:1000,delayDocWrite:true,name:"aeContainer",tellLoadTimesProbability:true,trackSession:false});var B=new qubit.opentag.CustomTag({name:"aeTag",description:"aeTag",async:true,locationObject:"HEAD",});B.htmlContent='<img height="1" width="1" style="display:none" src="https://sc.adelement.com/setRT_adelement_cookie.php?ae_rt=f4aa577d542c8bbfda09a2a2c0dc55c0'+L+'"/>';var G=new qubit.opentag.CustomTag({name:"tpTag680",description:"Third party tag piggyback",async:true,locationObject:"HEAD",html:'<img src="https://secure.adnxs.com/seg?add=22511191&t=2" style="border-style:none;display:none;" width="1" height="1" alt=""/>'});var D=new qubit.opentag.CustomTag({name:"tpTag681",description:"Third party tag piggyback",async:true,locationObject:"HEAD",html:'<script type="text/javascript"> var newdiv = document.createElement("div"); newdiv.setAttribute("style","display:inline;"); newdiv.innerHTML=\'<iframe src="https://d313lzv9559yp9.cloudfront.net/adx/2841.html" width="0" height="0" frameborder="0" style="display:none"></iframe>\'; document.getElementsByTagName("head")[0].appendChild(newdiv); <\/script>'});var H=new qubit.opentag.CustomTag({name:"tpTag726",description:"Third party tag piggyback",async:true,locationObject:"HEAD",html:'<img height="1" width="1" style="border-style:none;display:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/995239786/?value=0&amp;guid=ON&amp;script=0"/>'});var C=new qubit.opentag.CustomTag({name:"tpTag728",description:"Third party tag piggyback",async:true,locationObject:"HEAD",html:'<img height = "1" width = "1" style = "border-style:none;display:none;" alt = "" src="https://ads.adelement.com/www/delivery_dev/ti.php?trackerid=701&cb='+K+L+'"/>'});C.addClientFiltersList([J]);F.registerTags([B,G,D,H,C]);try{F.run()}catch(I){console.log("error exist in container")}})();