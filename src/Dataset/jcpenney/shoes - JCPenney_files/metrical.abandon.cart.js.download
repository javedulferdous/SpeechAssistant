_MetricalDeployment={version:"487780f48a7320b221131f52119dad90dd9ae2a5",lastUpdated:"2020-12-15 21:16:23 UTC"},_MetricalHosts={legacy:{apiendpointhost:"stage.getmetrical.com",staticendpointhost:"content-jcp.getmetrical.com",probabilityenginehost:"probability-stage.getmetrical.com",probabilityenginetesthost:!1},endpoints:{previousVisitor:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/visit/{surveyId}/{uuid}/{sessionId}/previousVisitor",previousCustomer:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/visit/{surveyId}/{uuid}/{sessionId}/previousCustomer",coupon:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/coupon",provision:"https://g4ipuvvgf7.execute-api.us-east-1.amazonaws.com/prod/site/provision",interaction:"https://api-v2.getmetrical.com/interaction",offerFlow:"https://api-v2.getmetrical.com/offerflow",singleUseCoupon:"https://api-v2.getmetrical.com/singleusecoupon",pe:"https://api-v2.getmetrical.com/pe",offerFlowStore:"https://api-v2.getmetrical.com/offerflowstore",callBridge:"https://phoneservices.getmetrical.com/bridgeCall",message:"https://phoneservices.getmetrical.com/message"}},_MetricalStorage={Storage:{storagePrefix:"_Metrical_",getItem:function(e){e=0===e.indexOf(this.storagePrefix)?e:this.storagePrefix+e;var t=localStorage.getItem(e);return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},setItem:function(e,t){"object"==typeof t&&(t=JSON.stringify(t)),localStorage.setItem(this.storagePrefix+e,t)},removeItem:function(e){return localStorage.removeItem(this.storagePrefix+e),!0},clear:function(){for(var e=this.keys(),t=0;t<e.length;t++){var i=e[t];0===i.indexOf(this.storagePrefix)&&this.removeItem(i.replace(this.storagePrefix,""))}},keys:function(){for(var e=[],t=0,i=localStorage.length;t<i;++t){var r=localStorage.key(t);0===r.indexOf(this.storagePrefix)&&e.push(r)}return e},metricalObject:function(){for(var e={},t=this.keys(),i=0;i<t.length;i++){var r=t[i],n=this.getItem(r);e[r]=n}return e}},SessionStorage:{storagePrefix:"_Metrical_",getItem:function(e){e=0===e.indexOf(this.storagePrefix)?e:this.storagePrefix+e;var t=sessionStorage.getItem(e);return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},setItem:function(e,t){"object"==typeof t&&(t=JSON.stringify(t)),sessionStorage.setItem(this.storagePrefix+e,t)},removeItem:function(e){return sessionStorage.removeItem(this.storagePrefix+e),!0},clear:function(){for(var e=this.keys(),t=0;t<e.length;t++){var i=e[t];0===i.indexOf(this.storagePrefix)&&this.removeItem(i.replace(this.storagePrefix,""))}},keys:function(){for(var e=[],t=0,i=sessionStorage.length;t<i;++t){var r=sessionStorage.key(t);0===r.indexOf(this.storagePrefix)&&e.push(r)}return e},metricalObject:function(){for(var e={},t=this.keys(),i=0;i<t.length;i++){var r=t[i],n=this.getItem(r);e[r]=n}return e}},Cookie:{path:"/",domain:document.domain,prefix:"_Metrical_",altPrefix:"_MetricalObject_",rootDomain:function(){var e=location.hostname.split(".").reverse();return e.length>1?"uk"==e[0]&&"co"==e[1]&&e.length>2?"."+e[2]+"."+e[1]+"."+e[0]:"."+e[1]+"."+e[0]:"."+e[0]},prefixKey:function(e){return e=0===e.indexOf(this.prefix)||0===e.indexOf(this.altPrefix)?e:this.prefix+e},getItem:function(e){e=this.prefixKey(e);var t=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},getItemWithoutPrefix:function(e){var t=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null;return _MetricalUtils.isJson(t)&&(t=JSON.parse(t)),t},sessionQuickSet:function(e,t){return this.quickSet(e,t,0)},quickSet:function(e,t,i){return void 0===i&&(i=1/0),this.setItem(e,t,i,this.path,this.rootDomain(),!1)},setItem:function(e,t,i,r,n,o,a){if(r||(r=this.path),n||(n=this.rootDomain()),!e||/^(?:expires|max\-age|path|domain|secure|SameSite)$/i.test(e))return!1;e=this.prefixKey(e);var s="";if(i)switch(i.constructor){case Number:s=i===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+i;break;case String:s="; expires="+i;break;case Date:s="; expires="+i.toUTCString()}"object"==typeof t&&(t=JSON.stringify(t));var c=location.protocol;return o||"https:"!=c||(o="secure"),a||(a="Lax"),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+s+(n?"; domain="+n:"")+(r?"; path="+r:"")+(o?"; secure":"")+"; SameSite="+a,!0},removeItem:function(e,t,i){return!(!e||!this.hasItem(e))&&(e=this.prefixKey(e),t=t||this.path,i=i||this.rootDomain(),document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(i?"; domain="+i:"")+(t?"; path="+t:""),!0)},hasItem:function(e){return e=this.prefixKey(e),new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),t=0;t<e.length;t++)e[t]=decodeURIComponent(e[t]);return e},getAllCookies:function(){return this.getCookies(!1)},getCookies:function(e){null==e&&(e=!0);for(var t=this.keys(),i=[],r=0;r<t.length;r++){var n=t[r],o=this.getItem(n);1==e&&-1==n.indexOf(this.metricalCookieNamePrefix)||i.push({"cookie-key":n,value:o})}return i},getAllCookieObject:function(){return this.getCookieObject(!1)},getCookieObject:function(e){for(var t=this.getCookies(e),i={},r=0;r<t.length;r++){var n=t[r],o=n["cookie-key"],a=n.value;i[o]=a}return i},makeExpires:function(e){var t=new Date;return t.setTime(t.getTime()+1e3*e),t},metricalObject:function(){for(var e={},t=this.keys(),i=0;i<t.length;i++){var r=t[i];if(0===r.indexOf(this.prefix)||0===r.indexOf(this.altPrefix)){var n=this.getItem(r);e[r]=n}}return e},addSameSiteSupport:function(){var e=this,t=["_Metrical_ACStatusOutputCounter","_Metrical_UserAbandonCount","_Metrical_ConditionsObserver_enabled","_Metrical_promoopened_general","_Metrical_PageViewCount","_Metrical_TimeOnSite","_Metrical_offers_disabled","_MetricalObject_QA","_MetricalObject_did","_MetricalObject_sample","_MetricalObject_tracking","_Metrical_clickregistered_","_MetricalAbandonCart_","_treatmenttag","_testgroup","_localtime_override"];if(!this.hasItem("CookiesUpdated")){var i=[];this.keys().forEach(function(e){-1!==e.indexOf("Metrical")&&t.forEach(function(t){-1!==e.indexOf(t)&&i.push(e)})}),i.forEach(function(t){var i=e.getItem(t);i&&e.setItem(t,i,1/0,"/",e.rootDomain())}),e.setItem("CookiesUpdated",!0,1/0,"/",e.rootDomain())}}},ServerStore:{store:{},objKey:null,init:function(e,t){if(this.objKey=t,console.log("Key: ",e),0!=!!e){var i=this,r=_MetricalHosts.endpoints.offerFlowStore+"/"+e;jQuery.ajax({type:"GET",url:r,dataType:"json",async:!1,success:function(e){i.store[i.objKey]=e,console.log("data"),console.log(e)},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})}},getItem:function(e){return this.store[e]?this.store[e]:null},setItem:function(e,t){this.store[e]=t},_post:function(e){var t=_MetricalHosts.endpoints.offerFlowStore;navigator.sendBeacon(t,JSON.stringify(e))}}},_MetricalLogger=function(e){this.properties=Object.assign({},{defaultLevel:"info",logLevel:"info",extraEntryData:{},write:function(){}},e),this.levels={trace:10,debug:20,info:30,warning:40,error:50,fatal:60},this.write=this.properties.write,this.logLevel=this.properties.logLevel||this.properties.defaultLevel},_MetricalLogger.prototype.child=function(e){var t=Object.assign({},this.properties,{extraEntryData:e||{}});return new _MetricalLogger(t)},_MetricalLogger.prototype.setLogLevel=function(e){if(!(e in this.levels))throw new Error("Passed value "+e+" is not a valid log level");this.properties.logLevel=e,this.logLevel=e},_MetricalLogger.prototype._formatEntry=function(e,t,i){var r=(new Date).toISOString();return Object.assign({level:e,value:this.levels[e],ts:r},t||{},i||{},this.properties.extraEntryData||{})},_MetricalLogger.prototype.log=function(){var e=this.properties.defaultLevel,t="",i={};if(1==arguments.length)t="object"==typeof arguments[0]?Object.assign(arguments[0]):{msg:String(arguments[0])};else if(2==arguments.length){var r=arguments[0];r in this.levels?(e=r,t="object"==typeof arguments[1]?Object.assign(arguments[1]):{msg:String(arguments[1])}):(t="object"==typeof arguments[0]?Object.assign(arguments[0]):{msg:String(arguments[0])},i="object"==typeof arguments[1]?Object.assign(arguments[1]):{})}else 3==arguments.length&&(e=arguments[0],t="object"==typeof arguments[1]?Object.assign(arguments[1]):{msg:String(arguments[1])},i="object"==typeof arguments[2]?Object.assign(arguments[2]):{});var n=this._formatEntry(e,t,i),o=this.levels[this.logLevel];this.levels[e]>=o&&this.write(n)},_MetricalLogger.prototype.traceStart=function(e){this.trace(">>> "+e)},_MetricalLogger.prototype.traceEnd=function(e){this.trace("<<< "+e)},_MetricalLogger.prototype.trace=function(e,t){this.log("trace",e,t)},_MetricalLogger.prototype.debug=function(e,t){this.log("debug",e,t)},_MetricalLogger.prototype.info=function(e,t){this.log("info",e,t)},_MetricalLogger.prototype.warning=function(e,t){this.log("warning",e,t)},_MetricalLogger.prototype.error=function(e,t){this.log("error",e,t)},_MetricalLogger.prototype.fatal=function(e,t){this.log("fatal",e,t)},_MetricalMonitor=function(e){var t={logger:new _MetricalLogger,show:!1,browser:{document:document}};this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.browser=this.properties.browser,this.containerEl=null,this.mainEl=null,this.entries=[],1==this.properties.show&&this.show()},_MetricalMonitor.prototype.stylesEl=function(){var e=this.browser.document.getElementById("Metrical_Monitor_css");if(null===e){var t=this.browser.document.createElement("style");return t.id="Metrical_Monitor_css",t.appendChild(this.browser.document.createTextNode([".MetricalMonitor { width: 400px; height: 200px; border: solid 1px black; position: fixed; bottom: 10px; right: 10px; padding: 3px;}",".MetricalMonitorMain { background-color: black; color: lime; height: 100%; width: 99%; padding-left: 1%; overflow-y: auto; font-size: .8em;}"].join("\n"))),this.browser.document.getElementsByTagName("head")[0].appendChild(t),t}return e},_MetricalMonitor.prototype.render=function(){this.logger.log("render called");var e=this.browser.document.createElement("div");e.classList.add("MetricalMonitor");var t=this.browser.document.createElement("div");t.classList.add("MetricalMonitorMain"),t.innerHTML="",this.mainEl=t,this.printEntries(t),e.append(t),this.stylesEl(),this.containerEl=e},_MetricalMonitor.prototype.printEntries=function(e){var t=this.entries.join("<br />");e.innerHTML=t,e.scrollTop=e.scrollHeight},_MetricalMonitor.prototype.addLogEntry=function(e){0==this.entries.includes(e.msg)&&this.addEntry(e.msg)},_MetricalMonitor.prototype.addEntry=function(e){var t="string"!=typeof e?JSON.stringify(e):String(e);this.entries.push(t),this.mainEl&&this.printEntries(this.mainEl)},_MetricalMonitor.prototype.show=function(){this.containerEl||this.render(),this.containerEl&&this.browser.document.querySelector("body").appendChild(this.containerEl)},_MetricalMonitor.prototype.hide=function(){this.containerEl&&this.containerEl.remove()},String.prototype.includes||(String.prototype.includes=function(){"use strict";return-1!==String.prototype.indexOf.apply(this,arguments)}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var i=Object(this),r=i.length>>>0;if(0===r)return!1;var n,o,a=0|t,s=Math.max(a>=0?a:r-Math.abs(a),0);for(;s<r;){if((n=i[s])===(o=e)||"number"==typeof n&&"number"==typeof o&&isNaN(n)&&isNaN(o))return!0;s++}return!1}}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),r=1;r<arguments.length;r++){var n=arguments[r];if(null!=n)for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(i[o]=n[o])}return i},writable:!0,configurable:!0}),function(){const e=function(e){return"string"==typeof e},t=function(e){return e instanceof Blob};(function(){if(function(){return"navigator"in this&&"sendBeacon"in this.navigator}.call(this))return;"navigator"in this||(this.navigator={});this.navigator.sendBeacon=function(i,r){var n=this.event&&this.event.type,o="unload"===n||"beforeunload"===n;const a="XMLHttpRequest"in this?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("POST",i,!o),a.withCredentials=!0,a.setRequestHeader("Accept","*/*"),e(r)?(a.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),a.responseType="text/plain"):t(r)&&r.type&&a.setRequestHeader("Content-Type",r.type);try{a.send(r)}catch(e){return!1}return!0}.bind(this)}).call("object"==typeof window?window:this)}(),function(){var e;e=function(){"use strict";function e(e){var t=this.constructor;return this.then(function(i){return t.resolve(e()).then(function(){return i})},function(i){return t.resolve(e()).then(function(){return t.reject(i)})})}function t(e){return!(!e||void 0===e.length)}function i(){}function r(e){if(!(this instanceof r))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],c(e,this)}function n(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,r._immediateFn(function(){var i=1===e._state?t.onFulfilled:t.onRejected;if(null!==i){var r;try{r=i(e._value)}catch(e){return void a(t.promise,e)}o(t.promise,r)}else(1===e._state?o:a)(t.promise,e._value)})):e._deferreds.push(t)}function o(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var i=t.then;if(t instanceof r)return e._state=3,e._value=t,void s(e);if("function"==typeof i)return void c(function(e,t){return function(){e.apply(t,arguments)}}(i,t),e)}e._state=1,e._value=t,s(e)}catch(t){a(e,t)}}function a(e,t){e._state=2,e._value=t,s(e)}function s(e){2===e._state&&0===e._deferreds.length&&r._immediateFn(function(){e._handled||r._unhandledRejectionFn(e._value)});for(var t=0,i=e._deferreds.length;i>t;t++)n(e,e._deferreds[t]);e._deferreds=null}function c(e,t){var i=!1;try{e(function(e){i||(i=!0,o(t,e))},function(e){i||(i=!0,a(t,e))})}catch(e){if(i)return;i=!0,a(t,e)}}var l=setTimeout;r.prototype.catch=function(e){return this.then(null,e)},r.prototype.then=function(e,t){var r=new this.constructor(i);return n(this,new function(e,t,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=i}(e,t,r)),r},r.prototype.finally=e,r.all=function(e){return new r(function(i,r){function n(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var s=t.then;if("function"==typeof s)return void s.call(t,function(t){n(e,t)},r)}o[e]=t,0==--a&&i(o)}catch(e){r(e)}}if(!t(e))return r(new TypeError("Promise.all accepts an array"));var o=Array.prototype.slice.call(e);if(0===o.length)return i([]);for(var a=o.length,s=0;o.length>s;s++)n(s,o[s])})},r.resolve=function(e){return e&&"object"==typeof e&&e.constructor===r?e:new r(function(t){t(e)})},r.reject=function(e){return new r(function(t,i){i(e)})},r.race=function(e){return new r(function(i,n){if(!t(e))return n(new TypeError("Promise.race accepts an array"));for(var o=0,a=e.length;a>o;o++)r.resolve(e[o]).then(i,n)})},r._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){l(e,0)},r._unhandledRejectionFn=function(e){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var u=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}();"Promise"in u?u.Promise.prototype.finally||(u.Promise.prototype.finally=e):u.Promise=r},"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(),function(){var e;function t(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}var i="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,i){return e==Array.prototype||e==Object.prototype?e:(e[t]=i.value,e)};var r,n=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var t=0;t<e.length;++t){var i=e[t];if(i&&i.Math==Math)return i}throw Error("Cannot find global object")}(this);function o(e,t){if(t){for(var r=n,o=e.split("."),a=0;a<o.length-1;a++){var s=o[a];s in r||(r[s]={}),r=r[s]}(s=t(a=r[o=o[o.length-1]]))!=a&&null!=s&&i(r,o,{configurable:!0,writable:!0,value:s})}}function a(e){return(e={next:e})[Symbol.iterator]=function(){return this},e}function s(e){var i="undefined"!=typeof Symbol&&Symbol.iterator&&e[Symbol.iterator];return i?i.call(e):{next:t(e)}}if(o("Symbol",function(e){function t(e,t){this.o=e,i(this,"description",{configurable:!0,writable:!0,value:t})}if(e)return e;t.prototype.toString=function(){return this.o};var r=0;return function e(i){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new t("jscomp_symbol_"+(i||"")+"_"+r++,i)}}),o("Symbol.iterator",function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var r="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),o=0;o<r.length;o++){var s=n[r[o]];"function"==typeof s&&"function"!=typeof s.prototype[e]&&i(s.prototype,e,{configurable:!0,writable:!0,value:function(){return a(t(this))}})}return e}),"function"==typeof Object.setPrototypeOf)r=Object.setPrototypeOf;else{var c;e:{var l={};try{l.__proto__={u:!0},c=l.u;break e}catch(e){}c=!1}r=c?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}var u=r;function d(){this.h=!1,this.f=null,this.m=void 0,this.b=1,this.l=this.v=0,this.g=null}function f(e){if(e.h)throw new TypeError("Generator is already running");e.h=!0}function p(e,t){return e.b=3,{value:t}}function h(e){this.a=new d,this.B=e}function m(e,t,i,r){try{var n=t.call(e.a.f,i);if(!(n instanceof Object))throw new TypeError("Iterator result "+n+" is not an object");if(!n.done)return e.a.h=!1,n;var o=n.value}catch(t){return e.a.f=null,e.a.j(t),g(e)}return e.a.f=null,r.call(e.a,o),g(e)}function g(e){for(;e.a.b;)try{var t=e.B(e.a);if(t)return e.a.h=!1,{value:t.value,done:!1}}catch(t){e.a.m=void 0,e.a.j(t)}if(e.a.h=!1,e.a.g){if(t=e.a.g,e.a.g=null,t.A)throw t.w;return{value:t.return,done:!0}}return{value:void 0,done:!0}}function v(e){this.next=function(t){return e.i(t)},this.throw=function(t){return e.j(t)},this.return=function(t){return function(e,t){f(e.a);var i=e.a.f;return i?m(e,"return"in i?i.return:function(e){return{value:e,done:!0}},t,e.a.return):(e.a.return(t),g(e))}(e,t)},this[Symbol.iterator]=function(){return this}}function b(e,t){var i=new v(new h(t));return u&&u(i,e.prototype),i}if(d.prototype.i=function(e){this.m=e},d.prototype.j=function(e){this.g={w:e,A:!0},this.b=this.v||this.l},d.prototype.return=function(e){this.g={return:e},this.b=this.l},h.prototype.i=function(e){return f(this.a),this.a.f?m(this,this.a.f.next,e,this.a.i):(this.a.i(e),g(this))},h.prototype.j=function(e){return f(this.a),this.a.f?m(this,this.a.f.throw,e,this.a.i):(this.a.j(e),g(this))},"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var _=function(e,t){for(var i=0;i<e.length;i++)t(e[i])},y=function(e,t,i){return t instanceof Blob?[String(e),t,void 0!==i?i+"":"string"==typeof t.name?t.name:"blob"]:[String(e),String(t)]},C=function(e,t){if(e.length<t)throw new TypeError(t+" argument required, but only "+e.length+" present.")},M=function(e){var t=s(e);e=t.next().value;var i=t.next().value;return t=t.next().value,i instanceof Blob&&(i=new File([i],t,{type:i.type,lastModified:i.lastModified})),[e,i]},w="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,I=w.FormData,S=w.XMLHttpRequest&&w.XMLHttpRequest.prototype.send,A=w.Request&&w.fetch,k=w.navigator&&w.navigator.sendBeacon,x=w.Element&&w.Element.prototype,O=w.Symbol&&Symbol.toStringTag;O&&(Blob.prototype[O]||(Blob.prototype[O]="Blob"),"File"in w&&!File.prototype[O]&&(File.prototype[O]="File"));try{new File([],"")}catch(e){w.File=function(e,t,i){return e=new Blob(e,i),i=i&&void 0!==i.lastModified?new Date(i.lastModified):new Date,Object.defineProperties(e,{name:{value:t},lastModifiedDate:{value:i},lastModified:{value:+i},toString:{value:function(){return"[object File]"}}}),O&&Object.defineProperty(e,O,{value:"File"}),e}}var E=function(e){this.c=[];var t=this;e&&_(e.elements,function(e){if(e.name&&!e.disabled&&"submit"!==e.type&&"button"!==e.type&&!e.matches("form fieldset[disabled] *"))if("file"===e.type){var i=e.files&&e.files.length?e.files:[new File([],"",{type:"application/octet-stream"})];_(i,function(i){t.append(e.name,i)})}else"select-multiple"===e.type||"select-one"===e.type?_(e.options,function(i){!i.disabled&&i.selected&&t.append(e.name,i.value)}):"checkbox"===e.type||"radio"===e.type?e.checked&&t.append(e.name,e.value):(i="textarea"===e.type?e.value.replace(/\r\n/g,"\n").replace(/\n/g,"\r\n"):e.value,t.append(e.name,i))})};if((e=E.prototype).append=function(e,t,i){C(arguments,2),this.c.push(y(e,t,i))},e.delete=function(e){C(arguments,1);var t=[];e=String(e),_(this.c,function(i){i[0]!==e&&t.push(i)}),this.c=t},e.entries=function e(){var t,i=this;return b(e,function(e){if(1==e.b&&(t=0),3!=e.b)return t<i.c.length?e=p(e,M(i.c[t])):(e.b=0,e=void 0),e;t++,e.b=2})},e.forEach=function(e,t){C(arguments,1);for(var i=s(this),r=i.next();!r.done;r=i.next()){var n=s(r.value);r=n.next().value,n=n.next().value,e.call(t,n,r,this)}},e.get=function(e){C(arguments,1);var t=this.c;e=String(e);for(var i=0;i<t.length;i++)if(t[i][0]===e)return M(t[i])[1];return null},e.getAll=function(e){C(arguments,1);var t=[];return e=String(e),_(this.c,function(i){i[0]===e&&t.push(M(i)[1])}),t},e.has=function(e){C(arguments,1),e=String(e);for(var t=0;t<this.c.length;t++)if(this.c[t][0]===e)return!0;return!1},e.keys=function e(){var t,i,r,n,o=this;return b(e,function(e){if(1==e.b&&(t=s(o),i=t.next()),3!=e.b)return i.done?void(e.b=0):(r=i.value,n=s(r),p(e,n.next().value));i=t.next(),e.b=2})},e.set=function(e,t,i){C(arguments,2),e=String(e);var r=[],n=y(e,t,i),o=!0;_(this.c,function(t){t[0]===e?o&&(o=!r.push(n)):r.push(t)}),o&&r.push(n),this.c=r},e.values=function e(){var t,i,r,n,o=this;return b(e,function(e){if(1==e.b&&(t=s(o),i=t.next()),3!=e.b)return i.done?void(e.b=0):(r=i.value,(n=s(r)).next(),p(e,n.next().value));i=t.next(),e.b=2})},E.prototype._asNative=function(){for(var e=new I,t=s(this),i=t.next();!i.done;i=t.next()){var r=s(i.value);i=r.next().value,r=r.next().value,e.append(i,r)}return e},E.prototype._blob=function(){for(var e="----formdata-polyfill-"+Math.random(),t=[],i=s(this),r=i.next();!r.done;r=i.next()){var n=s(r.value);r=n.next().value,n=n.next().value,t.push("--"+e+"\r\n"),n instanceof Blob?t.push('Content-Disposition: form-data; name="'+r+'"; filename="'+n.name+'"\r\nContent-Type: '+(n.type||"application/octet-stream")+"\r\n\r\n",n,"\r\n"):t.push('Content-Disposition: form-data; name="'+r+'"\r\n\r\n'+n+"\r\n")}return t.push("--"+e+"--"),new Blob(t,{type:"multipart/form-data; boundary="+e})},E.prototype[Symbol.iterator]=function(){return this.entries()},E.prototype.toString=function(){return"[object FormData]"},x&&!x.matches&&(x.matches=x.matchesSelector||x.mozMatchesSelector||x.msMatchesSelector||x.oMatchesSelector||x.webkitMatchesSelector||function(e){for(var t=(e=(this.document||this.ownerDocument).querySelectorAll(e)).length;0<=--t&&e.item(t)!==this;);return-1<t}),O&&(E.prototype[O]="FormData"),S){var j=w.XMLHttpRequest.prototype.setRequestHeader;w.XMLHttpRequest.prototype.setRequestHeader=function(e,t){j.call(this,e,t),"content-type"===e.toLowerCase()&&(this.s=!0)},w.XMLHttpRequest.prototype.send=function(e){e instanceof E?(e=e._blob(),this.s||this.setRequestHeader("Content-Type",e.type),S.call(this,e)):S.call(this,e)}}A&&(w.fetch=function(e,t){return t&&t.body&&t.body instanceof E&&(t.body=t.body._blob()),A.call(this,e,t)}),k&&(w.navigator.sendBeacon=function(e,t){return t instanceof E&&(t=t._asNative()),k.call(this,e,t)}),w.FormData=E}}();var _MetricalAbandonCart={timeOnPage:0,initTimestamp:null,passedInProperties:{},metricalInteractions:null,abandonprobable:{},useLegacyOfferDisplay:!0,appliedDiscountCode:null,observables:{postInit:[]},revisits:null,groups:null,ei:null,conditions:null,localInteractions:null,dataPoints:null,_notifyObservers:function(e){e in this.observables&&this.observables[e].map(function(e){e()})},observe:function(e,t){this.observables[e].push(t)},clearCookies:function(){var e=_MetricalAbandonCart.Cookie.keys(),t=_MetricalAbandonCart.Cookie.rootDomain();return jQuery.each(e,function(e,i){i.indexOf("_Metrical")>-1&&_MetricalAbandonCart.Cookie.removeItem(i,"/",t)}),"Cart Abandonment cookies are cleared."},getCookieObject:function(){var e=_MetricalAbandonCart.Cookie.keys(),t=["_Metrical_ConditionsObserver_enabled","_Metrical_UserAbandonCount","_Metrical_ACStatusOutputCounter"],i={};return jQuery.each(e,function(e,r){(jQuery.inArray(r,t)>-1||-1!==r.indexOf("_Metrical_promoopened_")||-1!==r.indexOf("_Metrical_clickregistered_"))&&(i[r]=_MetricalAbandonCart.Cookie.getItem(r))}),i},resetOfferFlowSession:function(){var e=_MetricalAbandonCart.Config.experiments[0].name;return _MetricalStorage.Cookie.removeItem(e+"_offerRecordGuid")},resetOfferFlow:function(){var e={};_MetricalTestMode.enable();var t=_MetricalAbandonCart.Config.experiments[0].name,i=t+"_offerRecordGuid";e.cookie_guid=_MetricalStorage.Cookie.removeItem(i);i=t+"_offerRecord";e.storage_record=_MetricalStorage.Storage.removeItem(i),e.cookie_record=_MetricalStorage.Cookie.removeItem(i);i=t+"_offerlimits";e.storage_limits=_MetricalStorage.Storage.removeItem(i),e.cookie_limits=_MetricalStorage.Cookie.removeItem(i);i="payload";e.cookie_payload=_MetricalStorage.Cookie.removeItem(i),_MetricalOfferFlow.reset();i=t+"_limboOfferIsSynced";e.limbo_offer_is_syncd=_MetricalStorage.Cookie.removeItem(i);i=t+"_limit";return e.limit_cookie=_MetricalStorage.Cookie.removeItem(i),_MetricalOfferFlow.reset(),e},enableOffers:function(){_MetricalStorage.Cookie.removeItem("offers_disabled")},disableOffers:function(){_MetricalStorage.Cookie.quickSet("offers_disabled",1)},offersActive:function(){return!_MetricalStorage.Cookie.hasItem("offers_disabled")||1!=_MetricalStorage.Cookie.getItem("offers_disabled")},makeActionable:function(){_MetricalStorage.Cookie.sessionQuickSet("overrideActionability",1)},addPeOverrides(e){_MetricalStorage.Cookie.quickSet("peoverrides",e)},removePeOverrides(){_MetricalStorage.Cookie.removeItem("peoverrides")},addRandomOverride(e){_MetricalStorage.Cookie.quickSet("randomoverride",e)},removeRandomOverride(){_MetricalStorage.Cookie.removeItem("randomoverride")},isInTestMode:function(){return _MetricalTestMode.isInTestMode()},code:function(){return _MetricalCouponDataAccess.getC()||null},codeAndClear:function(){var e=_MetricalCouponDataAccess.getC()||null;return _MetricalCouponDataAccess.removeC(),e},override:function(e){_MetricalStorage.Cookie.sessionQuickSet("oc",JSON.stringify(e))},clearOverrides:function(){_MetricalStorage.Cookie.removeItem("oc")},updateUserMeta:function(e){_MetricalAbandonCart.passedInProperties.usermeta=e,_MetricalCart.loaded&&_MetricalCart.syncWithUserMeta({usermeta:e})},initTimestamp:null,initUtcTimestamp:null,logger:new _MetricalLogger,monitor:null,init:function(e,t,i){var r=this;if(this.logger=new _MetricalLogger({write:function(e){e.terminal&&1==e.terminal&&r.monitor.addLogEntry(e),e.value>=50?console.error(e):console.log(e)}}),this.logger.setLogLevel(_MetricalStorage.Cookie.getItem("loglevel")||"error"),this.monitor=new _MetricalMonitor({logger:this.logger,show:_MetricalStorage.Cookie.getItem("showmonitor")||!1}),this.logger.trace(">>> starting init"),e!==window.jQuery)return this.logger.fatal("jQuery is not defined"),!1;if(jqAC=e,_MetricalStorage.Cookie.addSameSiteSupport(),this.logger.info("Initializing _MetricalAbandonCart"),_MetricalAbandonCart.initializeTimestamps(),_MetricalUserEvents.init(),this.logger.info("Initializing Identity"),_MetricalIdentity.init(_MetricalAbandonCart.Cookie,_MetricalAbandonCart.Storage,_MetricalUtils),_MetricalIdentity.getLastTimestamp()&&_MetricalAbandonCart.AbandonHandler.resetSessionIdAfterIdleMins(30,_MetricalIdentity.getLastTimestamp()),_MetricalBrowserHistory.init(),_MetricalTestMode.init(_MetricalAbandonCart.Cookie),_MetricalCouponDataAccess.init({jq:jqAC,endpoint:_MetricalHosts.endpoints.singleUseCoupon}),null!=t.abandoncartid){this.passedInProperties=t;r=this;null!=this.passedInProperties.assets&&this.passedInProperties.assets.length>0?(_MetricalAssetLoader.init(jqAC,{assets:this.passedInProperties.assets},function(){_MetricalAbandonCart.loadConfig(r.passedInProperties,i)}),_MetricalAssetLoader.exec()):_MetricalAbandonCart.loadConfig(this.passedInProperties),this.initTimestamp=Date.now()}else this.logger.error("The ID for the abandon cart config is not specified, the AbandonCart will not be loaded");this.logger.trace("<<< ending init")},loadConfig:function(properties,abandonCartAction){var that=this;that.logger.traceStart("loadConfig"),_MetricalAbandonCart.Config.loadConfigData(properties.abandoncartid,properties,function(){that.logger.traceStart("loadConfig callback"),_MetricalDebug.init({isActive:_MetricalAbandonCart.Config.debugisactive||!1,ac:_MetricalAbandonCart}),_MetricalAbandonCart.conditions=new _MetricalConditions({conditions:_MetricalAbandonCart.Config.conditions||null}),_MetricalCartDA.init({useCookieOverLocal:_MetricalAbandonCart.Config.usecookieoverlocal});var expandItemsFunc=null;_MetricalAbandonCart.Config.expanditemsfunc&&(eval(_MetricalAbandonCart.Config.expanditemsfunc),expandItemsFunc=expandItems||null),_MetricalCart.init({da:_MetricalCartDA,expandItemsFunc:expandItemsFunc}),_MetricalAbandonCart.Config.useprobabilityengine&&(_MetricalPE.init({jQuery:jqAC,ac:_MetricalAbandonCart,log:_MetricalAbandonCart.Log,identity:_MetricalIdentity,endpoint:_MetricalHosts.endpoints.pe,conditions:_MetricalAbandonCart.conditions}),_MetricalACInteractions.registerRecordInteractionObserver("pe",function(e){_MetricalPE.shouldRun().then(function(t){1==t&&_MetricalPE.sendInteractionData(e)}).catch(function(e){throw e})}),that.logger.info("Probability Engine enabled")),void 0!==_MetricalAbandonCart.Config.uselegacyofferdisplay&&(_MetricalAbandonCart.useLegacyOfferDisplay=_MetricalAbandonCart.Config.uselegacyofferdisplay),_MetricalACInteractions.registerRecordInteractionObserver("cartSync",function(e){_MetricalCart.syncWithUserMeta(e)}),_MetricalAbandonCart.dataPoints=new _MetricalDataPoints({storage:_MetricalStorage.SessionStorage,utils:_MetricalUtils,config:_MetricalAbandonCart.Config.datapoints||[]}),_MetricalAbandonCart.localInteractions=new _MetricalLocalInteractions({storage:_MetricalStorage.SessionStorage,utils:_MetricalUtils,uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId()}),1==_MetricalAbandonCart.Config.savelocalinteractions&&_MetricalACInteractions.registerRecordInteractionObserver("localinteractions",function(e){console.log("recording locally",e),_MetricalAbandonCart.localInteractions.record(e)}),null!=_MetricalAbandonCart.Config.custominteractions&&(_MetricalAbandonCart.setupInteractions(),_MetricalAbandonCart.metricalInteractions=jqAC.extend({},_MetricalACInteractions)),_MetricalAbandonCart.Config.interactionobservers.length>0?(that.logger.info("Registering interaction observers from the config"),_MetricalACInteractions.registerRecordInteractionObserver("observerConfig",function(e){_MetricalCallbacks.parseObserverConfig(_MetricalAbandonCart.Config.interactionobservers,e)})):that.logger.info("Skipping interaction observer registration"),_MetricalAbandonCart.Config.heartbeatisactive?(that.logger.info("Enabling heartbeat system"),_MetricalHeartBeat.init({interactions:_MetricalAbandonCart.metricalInteractions}),_MetricalUserEvents.subscribe("interval10",function(e){_MetricalHeartBeat.beat(e.hasInteracted)}),_MetricalUserEvents.addInterval(_MetricalAbandonCart.Config.heartbeatinterval,"interval10")):that.logger.info("Skipping heartbeat system"),_MetricalAbandonCart.Config.idleisactive?(that.logger.info("Enabling idle system"),_MetricalIdle.init({interactions:_MetricalAbandonCart.metricalInteractions}),_MetricalUserEvents.subscribe("interval30",function(e){_MetricalIdle.beat(e.hasInteracted)}),_MetricalUserEvents.addInterval(_MetricalAbandonCart.Config.idleinterval,"interval30")):that.logger.info("Skipping idle system"),1==_MetricalUserEvents.hasIntervals()&&_MetricalUserEvents.startIntervals(),_MetricalPreviousVisits.init(jqAC,_MetricalAbandonCart.Cookie,_MetricalAbandonCart.Log,_MetricalHosts.endpoints.previousVisitor,_MetricalHosts.endpoints.previousCustomer),null!=_MetricalAbandonCart.Config.previousvisitorisactive&&1==_MetricalAbandonCart.Config.previousvisitorisactive&&(that.logger.info("Previous Visit check is enabled"),_MetricalPreviousVisits.setPreviousVisit(properties.abandoncartid,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),_MetricalAbandonCart.Config.previousvisitorcookieprefix,_MetricalAbandonCart.Config.previousvisitorcookietimeout)),null!=_MetricalAbandonCart.Config.previouscustomerisactive&&1==_MetricalAbandonCart.Config.previouscustomerisactive&&(that.logger.info("Previous Customer check is enabled"),_MetricalPreviousVisits.setPreviousCustomer(properties.abandoncartid,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),_MetricalAbandonCart.Config.previouscustomercookieprefix,_MetricalAbandonCart.Config.previouscustomercookietimeout)),_MetricalAbandonCart.revisits=new _MetricalRevisits({storage:_MetricalStorage,namespace:_MetricalAbandonCart.Config.revisitsnamespace||"default",resetPoints:_MetricalAbandonCart.Config.revisitresetpoints?_MetricalAbandonCart.Config.revisitresetpoints:[]}),_MetricalAbandonCart.Config.revisitsisactive&&(that.logger.info("Configuring the revists system"),_MetricalAbandonCart.revisits.record(_MetricalIdentity.getSessionId()),_MetricalIdentity.pubsub.subscribe("reset-session-id",function(e){_MetricalAbandonCart.revisits.record(e.sessionId),_MetricalAbandonCart.groups&&"reset"in _MetricalAbandonCart.groups&&_MetricalAbandonCart.groups.reset()})),_MetricalAbandonCart.groups=new _MetricalGroups({storage:_MetricalStorage.SessionStorage,groups:_MetricalAbandonCart.Config.groups||{}}),1==!!_MetricalAbandonCart.Config.exitintentisactive&&1==_MetricalAbandonCart.Config.exitintentisactive&&(_MetricalAbandonCart.ei=new _MetricalExitIntent({dimensions:new _MetricalDimensions}),"desktop"==_MetricalUtils.determineDevice()?_MetricalUserEvents.subscribe("documentout",function(e){null!=e&&null!=e.clientX&&null!=e.clientY&&_MetricalAbandonCart.ei.checkForIntent(e.clientX,e.clientY)}):_MetricalUserEvents.subscribe("scrollup",function(e){_MetricalAbandonCart.ei.incrementExitIntents()})),that.logger.info("Initializing appliers"),_MetricalAppliers.init({jq:jqAC,logger:that.logger.child({module:"appliers"})}),_MetricalAbandonCart.AbandonHandler.bootstrap(abandonCartAction),that._notifyObservers("postInit"),that.logger.traceEnd("loadConfig callback")}),that.logger.traceEnd("loadConfig")},initializeTimestamps:function(){now=new Date;var e=_MetricalUtils.getFullDateUTC(now);_MetricalAbandonCart.initTimestamp=now,_MetricalAbandonCart.initUtcTimestamp=e,this.logger.info("Initialization Timestamp",_MetricalAbandonCart.initTimestamp),this.logger.info("Initialization UTC Timestamp",_MetricalAbandonCart.initUtcTimestamp)},getInteractionData:function(){_MetricalAbandonCart.initTimestamp?timeOnPage=Date.now()-_MetricalAbandonCart.initTimestamp:timeOnPage=0,interactionData={uuid:_MetricalIdentity.getDeviceId(),usermeta:_MetricalAbandonCart.passedInProperties.usermeta,survey_id:_MetricalAbandonCart.passedInProperties.abandoncartid,cookies:_MetricalAbandonCart.Cookie.getCookies(),url:window.location.href,device:_MetricalUtils.determineDevice(),instance_id:_MetricalIdentity.getInstanceId(),session_id:_MetricalIdentity.getSessionId(),timestamp:_MetricalUtils.getFullDateUTC(new Date),widget_init_timestamp:_MetricalAbandonCart.initUtcTimestamp,survey_revision:_MetricalAbandonCart.Config.revision,interaction_guid:_MetricalUtils.makeUUID(),timeonpage:timeOnPage},promoID=jqAC("#_Metrical_promoid_triggered"),null!=promoID&&promoID.length>0&&""!=promoID.val()&&(interactionData.promoid=promoID.val(),null!=_Metrical.app?interactionData.metricalinstanceid=_Metrical.app.instanceId:interactionData.metricalinstanceid="N/A");var e=null!=_MetricalAbandonCart.Config.eligibleexperiment?JSON.stringify(_MetricalAbandonCart.Config.eligibleexperiment):null;interactionData.experiment=e;var t=(new Date).getTimezoneOffset();interactionData.timezone_offset=t;var i=_MetricalUtils.getParameterByName("utm_source");null!=i&&""!=i&&(interactionData.usermeta.utmsource=i);var r=_MetricalUtils.getParameterByName("utm_medium");null!=r&&""!=r&&(interactionData.usermeta.utmmedium=r);var n=_MetricalUtils.getParameterByName("utm_campaign");null!=n&&""!=n&&(interactionData.usermeta.utmcampaign=n);var o=_MetricalUtils.getParameterByName("utm_term");null!=o&&""!=o&&(interactionData.usermeta.utmterm=o);var a=_MetricalUtils.getParameterByName("utm_content");null!=a&&""!=a&&(interactionData.usermeta.utmcontent=a);var s="referrer"in document?document.referrer:"";return interactionData.referrer=s,_MetricalDebug.isEnabled()&&(interactionData.debug=JSON.stringify(_MetricalDebug.debugInformation())),interactionData},setupInteractions:function(){captureinteractions=null==_MetricalAbandonCart.Config.captureinteractions||_MetricalAbandonCart.Config.captureinteractions,captureallinteractions=null!=_MetricalAbandonCart.Config.captureallinteractions&&_MetricalAbandonCart.Config.captureallinteractions,capturescrollinteractions=null!=_MetricalAbandonCart.Config.capturescrollinteractions&&_MetricalAbandonCart.Config.capturescrollinteractions,capturescrollinteractionsthreshold=null!=_MetricalAbandonCart.Config.capturescrollinteractionsthreshold?_MetricalAbandonCart.Config.capturescrollinteractionsthreshold:0,norecordonsubmitifempty=null!=_MetricalAbandonCart.Config.norecordonsubmitifempty&&_MetricalAbandonCart.Config.norecordonsubmitifempty;var e=null!=_MetricalAbandonCart.Config.interactionModificationCallback?_MetricalAbandonCart.Config.interactionModificationCallback:void 0;properties={apiendpoint:_MetricalHosts.endpoints.interaction,captureinteractions:captureinteractions,captureallinteractions:captureallinteractions,capturescrollinteractions:capturescrollinteractions,capturescrollinteractionsthreshold:capturescrollinteractionsthreshold,norecordonsubmitifempty:norecordonsubmitifempty,interactionModificationCallback:e,interactions:[],heartbeatisactive:void 0===_MetricalAbandonCart.Config.heartbeatisactive||_MetricalAbandonCart.Config.heartbeatisactive,heartbeatinterval:_MetricalAbandonCart.Config.heartbeatinterval||10},null!=_MetricalAbandonCart.Config.custominteractions&&(properties.interactions=properties.interactions.concat(_MetricalAbandonCart.Config.custominteractions)),_MetricalACInteractions.init(jqAC,properties,this.getInteractionData,this.setTransitionalCookie),this.interactionsReady=!0,this.runCachedInteractions()},resetTriggerConstraints:function(){_MetricalAbandonCart.AbandonHandler.alwaysEvaluateConditions=!0,_MetricalAbandonCart.AbandonHandler.triggeringPromo=!1,domain=_MetricalAbandonCart.Cookie.rootDomain(),path="/",_MetricalAbandonCart.Cookie.removeItem(_MetricalAbandonCart.Cookie.cookieNameTransitial,path,domain)},interactionsReady:!1,cachedInteractions:[],recordInteraction(e,t,i,r){0==this.interactionsReady?this.cachedInteractions.push(arguments):_MetricalACInteractions.recordInteraction.apply(_MetricalACInteractions,arguments)},runCachedInteractions:function(){if(1==this.interactionsReady&&this.cachedInteractions.length>0)for(;this.cachedInteractions.length>0;){var e=this.cachedInteractions.shift();_MetricalACInteractions.recordInteraction.apply(_MetricalACInteractions,e)}},recordInteractionState:function(e,t,i){if(null!=_MetricalAbandonCart.metricalInteractions){var r="";_MetricalTestMode.isInTestMode()&&(r="(testmode) ");var n=e+" "+t+" - "+r+i;_MetricalAbandonCart.metricalInteractions.recordInteraction(n,null,!0),this.logger.info(n)}else this.logger.warning("Interactions are disabled, can't record state "+e)},replaceEventHandlers:function(){this.logger.info("calling replaceEventHanlders"),_MetricalACInteractions.relinkBasicInteractions()},isMetricalActive:function(){return jqAC(".MetricalContainer").hasClass("is-popped")||"block"==jqAC(".Metrical_lightbox").css("display")},AbandonHandler:{handlerConfigObjects:[],evaluatingConditions:!1,triggeringPromo:!1,abandonCartAction:null,promoTimesOpenedCookieBaseName:"_Metrical_promoopened_",conditionsObserverEnabled:!1,alwaysEvaluateConditions:!1,processedMaxTimesReached:!1,eligibleExperiment:null,cxflow:null,evaluatingCxFlow:!1,bootstrap:function(e){this.handlerConfigObjects=[],this.evaluatingConditions=!1,this.triggeringPromo=!1,this.promoTimesOpenedCookieBaseName="_Metrical_promoopened_",this.conditionsObserverEnabled=!1,this.abandonCartAction=e,this.alwaysEvaluateConditions=!1;var t=this;_MetricalOfferFlowDataAccess.init({namespace:_MetricalAbandonCart.Config.experiments[0].name||"default",storageDriver:_MetricalAbandonCart.Config.storagedriver},jqAC,_MetricalAbandonCart,_MetricalIdentity,_MetricalHosts.endpoints.offerFlow),_MetricalUtils.getParameterByName("metrical_disable_offers")&&"1"==_MetricalUtils.getParameterByName("metrical_disable_offers")&&_MetricalAbandonCart.disableOffers(),_MetricalAbandonCart.offersActive()||(_MetricalAbandonCart.Config.offerflowisactive=!1);var i={conditions:_MetricalAbandonCart.conditions,engagements:_MetricalAbandonCart.Config.engagements||_MetricalAbandonCart.Config.offers||[],tags:_MetricalAbandonCart.Config.tags||{},globalofferlimit:_MetricalAbandonCart.Config.globalofferlimit||null,globalofferlimittimeout:_MetricalAbandonCart.Config.globalofferlimittimeout||null,offerflowtag:_MetricalAbandonCart.Config.offerflowtag||null,eligibilityrules:_MetricalAbandonCart.Config.eligibilityrules||"",offerflowisactive:_MetricalAbandonCart.Config.offerflowisactive||!0,da:_MetricalOfferFlowDataAccess,engagementFunction:function(e,t){var i=new _MetricalEngagementFactory({acConfig:_MetricalAbandonCart.Config,jQuery:jqAC,immediatelyPerformBenefit:1!=_MetricalOfferFlow.manuallyTriggerPostCoupon}).create(e);1==_MetricalOfferFlow.manuallyTriggerPostCoupon&&(_MetricalOfferFlow.manualPostFunction=i.performBenefit.bind(i)),i.execute().then(function(e){t()}).catch(function(e){throw e})},testMode:_MetricalTestMode,revision:_MetricalAbandonCart.Config.revision,abandonprobable:_MetricalAbandonCart.abandonprobable,logger:_MetricalAbandonCart.logger.child({module:"offerflow"})};_MetricalAbandonCart.Config.experiments&&(i.experiments=_MetricalAbandonCart.Config.experiments),_MetricalAbandonCart.Config.offerlimitchecks&&_MetricalAbandonCart.Config.offerlimitchecks.length>0&&(i.limitChecks=_MetricalAbandonCart.Config.offerlimitchecks),_MetricalOfferFlow.init(i),_MetricalAbandonCart.Config.useprobabilityengine&&_MetricalPE.subscribe("post/pe",function(e){_MetricalOfferFlow.properties.abandonprobable=e}),_MetricalIdentity.pubsub.subscribe("reset-session-id",function(e){_MetricalOfferFlow.reset()}),_MetricalAbandonCart.logger.info("Finalized the bootstrap of the AbandonHandler object",this),_MetricalIdentity.getLastTimestamp()&&t.resetSessionIdAfterIdleMins(30,_MetricalIdentity.getLastTimestamp()),1==!!_MetricalAbandonCart.Config.cxflows&&_MetricalAbandonCart.Config.cxflowsisactive&&1==_MetricalAbandonCart.Config.cxflowsisactive&&(t.cxflow=new _MetricalCxFlow({conditions:_MetricalAbandonCart.conditions,cxflows:_MetricalAbandonCart.Config.cxflows||[],utils:_MetricalUtils,jQuery:jqAC})),_MetricalUserEvents.subscribe("interact",function(e){t.resetSessionIdAfterIdleMins(30,_MetricalAbandonCart.initTimestamp,function(){}),_MetricalAbandonCart.dataPoints.evaluate(),_MetricalAbandonCart.AbandonHandler.evaluate(e)}),window.onbeforeunload=function(e){_MetricalIdentity.setLastTimestamp()},_MetricalAbandonCart.dataPoints.evaluate(),_MetricalAbandonCart.AbandonHandler.evaluate(new Event("abandonHandlerBootstrap"))},resetSessionIdAfterIdleMins:function(e,t,i){_MetricalAbandonCart.timeOnPage=Date.now()-t;var r=Math.abs(_MetricalAbandonCart.timeOnPage);Math.round(r/1e3/60)>=e&&(_MetricalAbandonCart.initTimestamp=Date.now(),_MetricalIdentity.resetSessionId(),_MetricalAbandonCart.logger.info("Reset session ID due to idle timeout"),"function"==typeof i&&i())},evaluate:function(e){var t=_MetricalOfferFlow.isVisible,i=this;this.evaluatingConditions||t||(this.evaluatingConditions=!0,_MetricalOfferFlow.executeEngagementLoop().then(function(e){i.evaluatingConditions=!1}).catch(function(e){throw e})),null===i.cxflow||i.evaluatingCxFlow||(i.evaluatingCxFlow=!0,i.cxflow.executeEngagementLoop().then(function(e){i.evaluatingCxFlow=!1}).catch(function(e){throw e}))}},Config:{abandoncartid:null,proto:"https:"==window.location.protocol?"https://":"http://",apiendpointhost:_MetricalHosts.legacy.apiendpointhost,staticendpointhost:_MetricalHosts.legacy.staticendpointhost,probabilityenginehost:_MetricalHosts.legacy.probabilityenginehost,probabilityenginetesthost:_MetricalHosts.legacy.probabilityenginetesthost,configlocation:"survey_files",triggersinglepromofor:"user",useprobabilityengine:!1,onlyshowsingleoffer:!1,usecookieoverlocal:!1,debugisactive:!1,heartbeatisactive:!0,heartbeatinterval:10,idleisactive:!0,idleinterval:30,experimental:!1,offerflowisactive:!0,interactionModificationCallback:void 0,revisitsisactive:!1,revisitsnamespace:"default",endpointoverrides:null,interactionobservers:[],savelocalinteractions:!1,datapointsisactive:!1,datapoints:[],loadConfigData:function(e,t,i){var r=this;if(void 0!==t.proto&&(this.proto=t.proto),void 0!==t.staticendpointhost&&(this.staticendpointhost=t.staticendpointhost),void 0!==t.apiendpointhost&&(this.apiendpointhost=t.apiendpointhost),void 0!==t.probabilityenginehost&&(this.probabilityenginehost=t.probabilityenginehost),void 0!==t.probabilityenginetesthost&&(this.probabilityenginetesthost=t.probabilityenginetesthost),void 0!==t.configlocation&&(this.configlocation=t.configlocation),void 0!==t.interactionModificationCallback&&(this.interactionModificationCallback=t.interactionModificationCallback),void 0!==e){this.abandoncartid=e;var n=this.proto+this.staticendpointhost+"/";n=""!=this.configlocation?n+this.configlocation+"/"+e+".json":n+e+".json",jqAC.ajax({crossDomain:!0,type:"GET",dataType:"json",traditional:!1,url:n,data:null,success:function(e){if(jqAC.each(e,function(e,t){r.addProperty(e,t)}),_MetricalAbandonCart.logger.info("Configuration loaded",r),r.importProperties(),null==r.isactive||0!=r.isactive){if(null!==r.endpointoverrides)for(var t in r.endpointoverrides)t in _MetricalHosts.endpoints&&(_MetricalAbandonCart.logger.info("Replacing endpoint "+t+" value "+_MetricalHosts.endpoints[t]+" with "+r.endpointoverrides[t]),_MetricalHosts.endpoints[t]=r.endpointoverrides[t]);assetsToLoad=[],null!=e.assets&&jqAC.each(e.assets,function(e,t){assetsToLoad.push(t)}),_MetricalSamplingDataAccess.init({namespace:"default",useCookieOverLocal:_MetricalAbandonCart.Config.usecookieoverlocal},jqAC,_MetricalAbandonCart),_MetricalSampling.init(_MetricalAbandonCart.Config,_MetricalSamplingDataAccess),_MetricalTrafficControl.init(_MetricalAbandonCart.Config,_MetricalSampling,_MetricalAbandonCart.Log),_MetricalAbandonCart.logger.info("Checking traffic control"),_MetricalTrafficControl.isExecutionGranted()?(_MetricalAbandonCart.logger.info("The traffic control policies allowed the execution, keep loading..."),jqAC.each(_MetricalAbandonCart.Config,function(e,t){"cx"==e&&(asset={type:"json",url:_MetricalAbandonCart.Config.proto+_MetricalAbandonCart.Config.staticendpointhost+"/"+_MetricalAbandonCart.Config.configlocation+"/"+t.surveyid+".json"},assetsToLoad.push(asset)),"promos"==e&&jqAC.each(t,function(e,t){void 0!==t.isactive&&1!=t.isactive||(asset={type:"json",url:_MetricalAbandonCart.Config.proto+_MetricalAbandonCart.Config.staticendpointhost+"/"+_MetricalAbandonCart.Config.configlocation+"/"+t.survey+".json"},assetsToLoad.push(asset))})}),_MetricalAssetLoader.init(jqAC,{assets:assetsToLoad},function(){assetsFromJSON=[],jqAC.each(_MetricalAssetLoader.assetsJSON,function(e,t){jsonData=_MetricalAbandonCart.Config.getAssetsDataFromJSON(t),assetsFromJSON.push.apply(assetsFromJSON,jsonData)}),_MetricalAssetLoader.init(jqAC,{assets:assetsFromJSON},function(){i&&i()}),_MetricalAssetLoader.exec()}),_MetricalAssetLoader.exec()):(msg="The AC library will not be loaded due to traffic control policies",_MetricalAbandonCart.logger.warning(msg))}},error:function(e,t,i){_MetricalAbandonCart.logger.error(i,{xhr:e,status:t})}})}else _MetricalAbandonCart.logger.error("There are missing required parameters in the loadConfigData call")},addProperty:function(e,t){this[e]=t},importProperties:function(){jqAC.each(_MetricalAbandonCart.passedInProperties,function(e,t){void 0!==_MetricalAbandonCart.Config[e]&&"cx"!=e&&"usermeta"!=e&&(_MetricalAbandonCart.Config[e]=t),"cx"==e&&(null!=_MetricalAbandonCart.Config.cx?jqAC.each(t,function(e,t){_MetricalAbandonCart.Config.cx[e]=t}):_MetricalAbandonCart.Config.cx=t)})},getAssetsDataFromJSON:function(e){var t=[];return null!=e.defaultstylesheet&&(url=_MetricalAbandonCart.Config.proto+_MetricalAbandonCart.Config.staticendpointhost+e.defaultstylesheet,t.push({type:"css",url:url})),null!=e.css&&jqAC.each(e.css,function(e,i){t.push({type:"css",url:i})}),null!=e.js&&jqAC.each(e.js,function(e,i){t.push({type:"js",url:i})}),t}},Storage:{storagePrefix:"_Metrical_",getItem:function(e){return localStorage.getItem(this.storagePrefix+e)},setItem:function(e,t){localStorage.setItem(this.storagePrefix+e,t)},removeItem:function(e){localStorage.removeItem(this.storagePrefix+e)}},Cookie:{path:"/",domain:document.domain,metricalCookieNamePrefix:"_MetricalObject",cookieNameDid:"_MetricalObject_did",cookieNameSession:"_MetricalObject_sessionid",cookieNameTransitial:"_MetricalObject_transitial",cookieNamePageViewCount:"_MetricalObject_PageViewCount",cookieNameSample:"_MetricalObject_sample",cookieNameTracking:"_MetricalObject_tracking",cookieNameQuestionAnswer:"_MetricalObject_QA",cookieNameExperiment:"_Metrical_experiment",rootDomain:function(){if(this.isDomainAnIp())return this.domain;var e=location.hostname.split(".").reverse();return e.length>1?"uk"==e[0]&&"co"==e[1]&&e.length>2?"."+e[2]+"."+e[1]+"."+e[0]:"."+e[1]+"."+e[0]:"."+e[0]},isDomainAnIp:function(){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(this.domain)},getItem:function(e){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(e,t,i,r,n,o,a){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var s="";if(i)switch(i.constructor){case Number:s=i===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+i;break;case String:s="; expires="+i;break;case Date:s="; expires="+i.toUTCString()}var c=location.protocol;return o||"https:"!=c||(o="secure"),a||(a="Lax"),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+s+(n?"; domain="+n:"")+(r?"; path="+r:"")+(o?"; secure":"")+"; SameSite="+a,!0},removeItem:function(e,t,i){return!(!e||!this.hasItem(e))&&(document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(i?"; domain="+i:"")+(t?"; path="+t:""),!0)},hasItem:function(e){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),t=0;t<e.length;t++)e[t]=decodeURIComponent(e[t]);return e},getAllCookies:function(){return this.getCookies(!1)},getCookies:function(e){null==e&&(e=!0);for(var t=this.keys(),i=[],r=0;r<t.length;r++){var n=t[r],o=this.getItem(n);1==e&&-1==n.indexOf(this.metricalCookieNamePrefix)||i.push({"cookie-key":n,value:o})}return i},getAllCookieObject:function(){return this.getCookieObject(!1)},getCookieObject:function(e){for(var t=this.getCookies(e),i={},r=0;r<t.length;r++){var n=t[r],o=n["cookie-key"],a=n.value;i[o]=a}return i},makeExpires:function(e){var t=new Date;return t.setTime(t.getTime()+1e3*e),t}},Log:{logs:new Array,buffer:!0,promoAlreadyOpenedPrinted:!1,promoTimesOpenedPrinted:!1,info:function(){var e=Array.prototype.slice.call(arguments);jqAC.each(e,function(e,t){});var t={type:"info",timestamp:this.timeStamp(),echoed:!1,data:e};this.logs.push(t),this.buffer||this.echo()},error:function(){var e=Array.prototype.slice.call(arguments);jqAC.each(e,function(e,t){});var t={type:"error",timestamp:this.timeStamp(),echoed:!1,data:e};this.logs.push(t),this.buffer||this.echo()},echo:function(){var e=this;return window.console&&jqAC.each(this.logs,function(t,i){i.echoed||(e.printOutData(i),i.echoed=!0)}),"End of logs"},echoAll:function(){var e=this;return window.console&&jqAC.each(this.logs,function(t,i){e.printOutData(i)}),"End of logs"},printOutData:function(e){"info"==e.type?console.info(e.timestamp+": ",e.data):"error"==e.type&&jqAC.each(e.data,function(t,i){i instanceof Error?console.error(e.timestamp+" - "+i.name+" - "+i.message+": ",i.stack):console.error(e.timestamp+": ",i)})},timeStamp:function(){var e=new Date,t=[e.getMonth()+1,e.getDate(),e.getFullYear()],i=[e.getHours(),e.getMinutes(),e.getSeconds()],r=i[0]<12?"AM":"PM";i[0]=i[0]<12?i[0]:i[0]-12,i[0]=i[0]||12;for(var n=1;n<3;n++)i[n]<10&&(i[n]="0"+i[n]);return t.join("/")+" "+i.join(":")+" "+r}}},jqAC=null;_MetricalUserEvents={events:{},interacted:{},handles:{},init:function(e){var t={interactIntervals:[],document:document,window:window,throttle:_MetricalUtils.throttle,debounce:_MetricalUtils.debounce};if(this.properties=Object.assign({},t,e||{}),this.events={},this.interacted={},this.handles={},this.lastPageYOffset=0,this.lastPercentChange=0,this.interactTimer=null,this.properties.interactIntervals.length>0){var i=this;this.properties.interactIntervals.forEach(function(e){i.interacted[e.interval]=!1})}this._initializeEvents()},hasIntervals:function(){return this.properties.interactIntervals.length>0},addInterval:function(e,t){0==this.properties.interactIntervals.map(function(e){return e.topic}).includes(t)&&(this.properties.interactIntervals.push({interval:e,topic:t}),this.interacted[e]=!1)},_setInteracted:function(){if(this.properties.interactIntervals.length>0){var e=this;this.properties.interactIntervals.forEach(function(t){e.interacted[t.interval]=!0})}},startIntervals:function(){var e=this;this.properties.interactIntervals.length>0&&this.properties.interactIntervals.forEach(function(t){var i=t.interval,r=t.topic,n=1e3*i;e.handles[i]=setInterval(function(){e.publish(r,{hasInteracted:e.interacted[i]}),e.interacted[i]=!1},n)})},scrollPercent:function(){var e=document.documentElement,t=document.body,i="scrollTop",r="scrollHeight";return(e[i]||t[i])/((e[r]||t[r])-e.clientHeight)*100},_initializeEvents:function(){var e=this,t=e.properties.throttle(function(t){e.publish("interact",t)},750);e.properties.window.addEventListener("mousemove",e.properties.debounce(function(i){e._setInteracted(),e.publish("mousemove",i),t(i)},250)),e.properties.window.addEventListener("scroll",e.properties.debounce(function(i){e._setInteracted(),e.publish("scroll",i),t(i);var r=Math.max(e.properties.window.pageYOffset||0,e.properties.window.scrollY||0),n=e.scrollPercent();if(r>e.lastPageYOffset){var o=n-e.lastPercentChange;e.publish("scrolldown",i,{percent:n,percentDelta:o})}if(r<e.lastPageYOffset){o=e.lastPercentChange-n;e.publish("scrollup",i,{percent:n,percentDelta:o})}e.lastPageYOffset=r,e.lastPercentChange=n},250)),e.properties.window.addEventListener("keydown",function(i){e._setInteracted(),e.publish("keydown",i),t(i)}),e.properties.window.addEventListener("click",function(i){e._setInteracted(),e.publish("click",i),t(i)}),e.properties.window.addEventListener("touchstart",function(i){e._setInteracted(),t(i)}),e.properties.window.addEventListener("touchmove",e.properties.debounce(function(i){e._setInteracted(),t(i)},250)),e.properties.document.addEventListener("mouseout",function(t){var i=void 0;"toElement"in t&&(i=t.toElement),"relatedTarget"in t&&(i=t.relatedTarget),null===i&&e.publish("documentout",t)}),e.properties.window.addEventListener("resize",e.properties.debounce(function(t){e.publish("resize",t)},250)),this.interactTimer=setInterval(t,2e3)},subscribe:function(e,t){var i=this.events[e];!1==!!i&&(i=this.events[e]=[]),"function"==typeof t&&i.push(t)},unsubscribe:function(e,t){var i=this.events[e];if(!1!=!!i){var r=i.indexOf(t);i.splice(r)}},publish:function(e,t,i){var r=this.events[e];!1!=!!r&&r.forEach(function(e){"function"==typeof e&&e.call(this,t,i)})}},_MetricalUtils={evaluateRule:function(rule,conditions,tags){var keys=Object.keys(conditions);keys.sort(function(e,t){return t.length-e.length});var tagKeys=Object.keys(tags||[]);tagKeys.sort(function(e,t){return t.length-e.length});for(var i=0;i<tagKeys.length;i++){var tagKey=tagKeys[i],searchKey="#"+tagKey,tagValue="object"==typeof tags[tagKey]&&null!==tags[tagKey]&&void 0!==tags[tagKey]&&"result"in tags[tagKey]?tags[tagKey].result:tags[tagKey];rule=rule.replace(searchKey,String(tagValue))}for(var i=0;i<keys.length;i++){var conditionKey=keys[i],conditionValue="object"==typeof conditions[conditionKey]&&"result"in conditions[conditionKey]?conditions[conditionKey].result:conditions[conditionKey];rule=rule.replace(conditionKey,String(conditionValue))}var result=!1;try{result=eval(rule)}catch(e){console.log("Rule parsing failed: %s",rule),console.error(e)}return result},ruleCriteriaString:function(e,t,i){i=i||{};var r=Object.keys(t);r.sort(function(e,t){return t.length-e.length});var n=Object.keys(i||[]);n.sort(function(e,t){return t.length-e.length});for(var o=0;o<n.length;o++){var a=n[o],s=i[a],c="#"+a,l=c+" ("+String(s)+") ",u=new RegExp(c+"\\s{1}|"+c+"$","g");e=e.replace(u,l).trim()}for(o=0;o<r.length;o++){var d=r[o],f="object"==typeof t[d]&&"result"in t[d]?t[d].result:t[d];l=d+" ("+String(f)+")";e=e.replace(d,l)}return e},chooseRandomItem:function(e){for(var t,i,r=e.reduce(function(e,t){return e+t.weight},0),n=(t=0,i=r,Math.random()*(i-t)+t),o=0,a=0;a<e.length;a++)if(n<=(o=+(o+=e[a].weight).toFixed(4)))return e[a].item},testRegex:function(e,t){return new RegExp(e).test(t)},determineDevice:function(){var e="desktop";/Touch|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(e=window.matchMedia("(max-width: 730px)").matches?"mobile":window.matchMedia("screen and (orientation: portrait)").matches?screen.width<=480?"mobile":"tabletvertical":screen.height<=480?"mobile":"tablethorizontal");return e},isPlusDelimitedFormat:function(e){return/^\[(.*?\+)+[^\+]+?\]$/.test(e)},plusDelimitedParts:function(e){return 1==this.isPlusDelimitedFormat(e)?e.slice(1).slice(0,-1).split("+"):(newInput=e.replace("[","").replace("]",""),newInput.length>0?[newInput]:[])},round:function(e,t){var i=Math.pow(10,t),r=e*i;return Math.round(r)/i},cleanMoney:function(e){var t=0;if("number"==typeof e&&(t=e),"string"==typeof e){var i=e.replace("$","").replace(",","").match(/[\d]+(\.\d+)?/g);null!==i&&(t=parseFloat(i[0]))}return t},getIEVersion:function(){var e=navigator.userAgent.match(/(?:MSIE |Trident\/.*; rv:)(\d+)/);return e?parseInt(e[1]):void 0},makeUUID:function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:7&i|8).toString(16)})},getFullDateUTC:function(e){return year=""+e.getUTCFullYear(),month=""+(e.getUTCMonth()+1),1==month.length&&(month="0"+month),day=""+e.getUTCDate(),1==day.length&&(day="0"+day),hour=""+e.getUTCHours(),1==hour.length&&(hour="0"+hour),minute=""+e.getUTCMinutes(),1==minute.length&&(minute="0"+minute),second=""+e.getUTCSeconds(),1==second.length&&(second="0"+second),date=year+"-"+month+"-"+day+" "+hour+":"+minute+":"+second,date},identifierIsIOS:function(){return!!/iPhone|iPad|iPod/i.test(navigator.userAgent)},PubSub:function(){var e={subscriptions:{},subscriptionKeys:{},topicPublishCount:{},subscribers:function(e){var t=this;return(e in this.subscriptions?Object.keys(this.subscriptions[e]):[]).map(function(i){return e in t.subscriptions?t.subscriptions[e][i]:function(){}})},subscribe:function(e,t){e in this.subscriptions||(this.subscriptions[e]={},this.subscriptionKeys[e]=0);var i=e+"-"+this.subscriptionKeys[e];return this.subscriptions[e][i]=t,this.subscriptionKeys[e]++,i},unsubscribe:function(e,t){var i=e in this.subscriptions?this.subscriptions[e]:{};t in i&&delete i[t]},publish:function(e,t,i){var r=e in this.subscriptions?this.subscriptions[e]:{};if(this.topicPublishCount[e]=e in this.topicPublishCount?this.topicPublishCount[e]+1:1,void 0===i||this.topicPublishCount[e]<=i)for(var n in r){(0,r[n])(t)}}};return e},jsonPath:function(obj,expr,arg){var P={resultType:arg&&arg.resultType||"VALUE",result:[],normalize:function(e){var t=[];return e.replace(/[\['](\??\(.*?\))[\]']/g,function(e,i){return"[#"+(t.push(i)-1)+"]"}).replace(/'?\.'?|\['?/g,";").replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,"").replace(/#([0-9]+)/g,function(e,i){return t[i]})},asPath:function(e){for(var t=e.split(";"),i="$",r=1,n=t.length;r<n;r++)i+=/^[0-9*]+$/.test(t[r])?"["+t[r]+"]":"['"+t[r]+"']";return i},store:function(e,t){return e&&(P.result[P.result.length]="PATH"==P.resultType?P.asPath(e):t),!!e},trace:function(e,t,i){if(e){var r=e.split(";"),n=r.shift();if(r=r.join(";"),t&&t.hasOwnProperty(n))P.trace(r,t[n],i+";"+n);else if("*"===n)P.walk(n,r,t,i,function(e,t,i,r,n){P.trace(e+";"+i,r,n)});else if(".."===n)P.trace(r,t,i),P.walk(n,r,t,i,function(e,t,i,r,n){"object"==typeof r[e]&&P.trace("..;"+i,r[e],n+";"+e)});else if(/,/.test(n))for(var o=n.split(/'?,'?/),a=0,s=o.length;a<s;a++)P.trace(o[a]+";"+r,t,i);else/^\(.*?\)$/.test(n)?P.trace(P.eval(n,t,i.substr(i.lastIndexOf(";")+1))+";"+r,t,i):/^\?\(.*?\)$/.test(n)?P.walk(n,r,t,i,function(e,t,i,r,n){P.eval(t.replace(/^\?\((.*?)\)$/,"$1"),r[e],e)&&P.trace(e+";"+i,r,n)}):/^(-?[0-9]*):(-?[0-9]*):?([0-9]*)$/.test(n)&&P.slice(n,r,t,i)}else P.store(i,t)},walk:function(e,t,i,r,n){if(i instanceof Array)for(var o=0,a=i.length;o<a;o++)o in i&&n(o,e,t,i,r);else if("object"==typeof i)for(var s in i)i.hasOwnProperty(s)&&n(s,e,t,i,r)},slice:function(e,t,i,r){if(i instanceof Array){var n=i.length,o=0,a=n,s=1;e.replace(/^(-?[0-9]*):(-?[0-9]*):?(-?[0-9]*)$/g,function(e,t,i,r){o=parseInt(t||o),a=parseInt(i||a),s=parseInt(r||s)}),o=o<0?Math.max(0,o+n):Math.min(n,o),a=a<0?Math.max(0,a+n):Math.min(n,a);for(var c=o;c<a;c+=s)P.trace(c+";"+t,i,r)}},eval:function(x,_v,_vname){try{return $&&_v&&eval(x.replace(/@/g,"_v"))}catch(e){throw new SyntaxError("jsonPath: "+e.message+": "+x.replace(/@/g,"_v").replace(/\^/g,"_a"))}}},$=obj;if(expr&&obj&&("VALUE"==P.resultType||"PATH"==P.resultType))return P.trace(P.normalize(expr).replace(/^\$;/,""),obj,"$"),!!P.result.length&&P.result},get:function(e,t,i){i=void 0!==i?i:null,t=0!==t.indexOf("$.")?"$."+t:t;var r=this.jsonPath(e,t);return Array.isArray(r)&&r.length>0?r[0]:i},isJson:function(e){try{JSON.parse(e);return!0}catch(e){return!1}},getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null},waitForIdToAppear:function(e,t){if(document.getElementById(e))t();else{var i=new MutationObserver(function(r){document.getElementById(e)&&(i.disconnect(),t())});i.observe(document,{attributes:!1,childList:!0,characterData:!1,subtree:!0})}},parseUserMetaArray:function(e){if(/^\[(.*?)\]$/.test(e)){return e.slice(1).slice(0,-1).split("+")}return[e]},querySelector:function(e){return document.querySelector(e)},querySelectorAll:function(e){return document.querySelectorAll(e)},isEqual:function(){var e=200,t="__lodash_hash_undefined__",i=1,r=2,n=9007199254740991,o="[object Arguments]",a="[object Array]",s="[object Boolean]",c="[object Date]",l="[object Error]",u="[object Function]",d="[object GeneratorFunction]",f="[object Map]",p="[object Number]",h="[object Object]",m="[object RegExp]",g="[object Set]",v="[object String]",b="[object Symbol]",_="[object ArrayBuffer]",y="[object DataView]",C=/^\[object .+?Constructor\]$/,M=/^(?:0|[1-9]\d*)$/,w={};w["[object Float32Array]"]=w["[object Float64Array]"]=w["[object Int8Array]"]=w["[object Int16Array]"]=w["[object Int32Array]"]=w["[object Uint8Array]"]=w["[object Uint8ClampedArray]"]=w["[object Uint16Array]"]=w["[object Uint32Array]"]=!0,w[o]=w[a]=w[_]=w[s]=w[y]=w[c]=w[l]=w[u]=w[f]=w[p]=w[h]=w[m]=w[g]=w[v]=w["[object WeakMap]"]=!1;var I="object"==typeof global&&global&&global.Object===Object&&global,S="object"==typeof self&&self&&self.Object===Object&&self,A=I||S||Function("return this")(),k="object"==typeof exports&&exports&&!exports.nodeType&&exports,x=k&&"object"==typeof module&&module&&!module.nodeType&&module,O=x&&x.exports===k&&I.process,E=function(){try{return O&&O.binding("util")}catch(e){}}(),j=E&&E.isTypedArray;function T(e,t){for(var i=-1,r=e?e.length:0;++i<r;)if(t(e[i],i,e))return!0;return!1}function R(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function P(e){var t=-1,i=Array(e.size);return e.forEach(function(e,r){i[++t]=[r,e]}),i}function D(e){var t=-1,i=Array(e.size);return e.forEach(function(e){i[++t]=e}),i}var L,q,U,N=Array.prototype,F=Function.prototype,H=Object.prototype,V=A["__core-js_shared__"],B=(L=/[^.]+$/.exec(V&&V.keys&&V.keys.IE_PROTO||""))?"Symbol(src)_1."+L:"",K=F.toString,J=H.hasOwnProperty,$=H.toString,G=RegExp("^"+K.call(J).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Q=A.Symbol,z=A.Uint8Array,W=H.propertyIsEnumerable,Y=N.splice,X=(q=Object.keys,U=Object,function(e){return q(U(e))}),Z=Ie(A,"DataView"),ee=Ie(A,"Map"),te=Ie(A,"Promise"),ie=Ie(A,"Set"),re=Ie(A,"WeakMap"),ne=Ie(Object,"create"),oe=ke(Z),ae=ke(ee),se=ke(te),ce=ke(ie),le=ke(re),ue=Q?Q.prototype:void 0,de=ue?ue.valueOf:void 0;function fe(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function pe(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function he(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function me(e){var t=-1,i=e?e.length:0;for(this.__data__=new he;++t<i;)this.add(e[t])}function ge(e){this.__data__=new pe(e)}function ve(e,t){var i=Oe(e)||function(e){return function(e){return Pe(e)&&Ee(e)}(e)&&J.call(e,"callee")&&(!W.call(e,"callee")||$.call(e)==o)}(e)?function(e,t){for(var i=-1,r=Array(e);++i<e;)r[i]=t(i);return r}(e.length,String):[],r=i.length,n=!!r;for(var a in e)!t&&!J.call(e,a)||n&&("length"==a||Ae(a,r))||i.push(a);return i}function be(e,t){for(var i=e.length;i--;)if(xe(e[i][0],t))return i;return-1}function _e(e,t,n,u,d){return e===t||(null==e||null==t||!Re(e)&&!Pe(t)?e!=e&&t!=t:function(e,t,n,u,d,C){var M=Oe(e),w=Oe(t),I=a,S=a;M||(I=(I=Se(e))==o?h:I);w||(S=(S=Se(t))==o?h:S);var A=I==h&&!R(e),k=S==h&&!R(t),x=I==S;if(x&&!A)return C||(C=new ge),M||De(e)?Me(e,t,n,u,d,C):function(e,t,n,o,a,u,d){switch(n){case y:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case _:return!(e.byteLength!=t.byteLength||!o(new z(e),new z(t)));case s:case c:case p:return xe(+e,+t);case l:return e.name==t.name&&e.message==t.message;case m:case v:return e==t+"";case f:var h=P;case g:var C=u&r;if(h||(h=D),e.size!=t.size&&!C)return!1;var M=d.get(e);if(M)return M==t;u|=i,d.set(e,t);var w=Me(h(e),h(t),o,a,u,d);return d.delete(e),w;case b:if(de)return de.call(e)==de.call(t)}return!1}(e,t,I,n,u,d,C);if(!(d&r)){var O=A&&J.call(e,"__wrapped__"),E=k&&J.call(t,"__wrapped__");if(O||E){var j=O?e.value():e,T=E?t.value():t;return C||(C=new ge),n(j,T,u,d,C)}}if(!x)return!1;return C||(C=new ge),function(e,t,i,n,o,a){var s=o&r,c=Le(e),l=c.length,u=Le(t).length;if(l!=u&&!s)return!1;for(var d=l;d--;){var f=c[d];if(!(s?f in t:J.call(t,f)))return!1}var p=a.get(e);if(p&&a.get(t))return p==t;var h=!0;a.set(e,t),a.set(t,e);for(var m=s;++d<l;){f=c[d];var g=e[f],v=t[f];if(n)var b=s?n(v,g,f,t,e,a):n(g,v,f,e,t,a);if(!(void 0===b?g===v||i(g,v,n,o,a):b)){h=!1;break}m||(m="constructor"==f)}if(h&&!m){var _=e.constructor,y=t.constructor;_!=y&&"constructor"in e&&"constructor"in t&&!("function"==typeof _&&_ instanceof _&&"function"==typeof y&&y instanceof y)&&(h=!1)}return a.delete(e),a.delete(t),h}(e,t,n,u,d,C)}(e,t,_e,n,u,d))}function ye(e){return!(!Re(e)||(t=e,B&&B in t))&&(je(e)||R(e)?G:C).test(ke(e));var t}function Ce(e){if(i=(t=e)&&t.constructor,r="function"==typeof i&&i.prototype||H,t!==r)return X(e);var t,i,r,n=[];for(var o in Object(e))J.call(e,o)&&"constructor"!=o&&n.push(o);return n}function Me(e,t,n,o,a,s){var c=a&r,l=e.length,u=t.length;if(l!=u&&!(c&&u>l))return!1;var d=s.get(e);if(d&&s.get(t))return d==t;var f=-1,p=!0,h=a&i?new me:void 0;for(s.set(e,t),s.set(t,e);++f<l;){var m=e[f],g=t[f];if(o)var v=c?o(g,m,f,t,e,s):o(m,g,f,e,t,s);if(void 0!==v){if(v)continue;p=!1;break}if(h){if(!T(t,function(e,t){if(!h.has(t)&&(m===e||n(m,e,o,a,s)))return h.add(t)})){p=!1;break}}else if(m!==g&&!n(m,g,o,a,s)){p=!1;break}}return s.delete(e),s.delete(t),p}function we(e,t){var i,r,n=e.__data__;return("string"==(r=typeof(i=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==i:null===i)?n["string"==typeof t?"string":"hash"]:n.map}function Ie(e,t){var i=function(e,t){return null==e?void 0:e[t]}(e,t);return ye(i)?i:void 0}fe.prototype.clear=function(){this.__data__=ne?ne(null):{}},fe.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},fe.prototype.get=function(e){var i=this.__data__;if(ne){var r=i[e];return r===t?void 0:r}return J.call(i,e)?i[e]:void 0},fe.prototype.has=function(e){var t=this.__data__;return ne?void 0!==t[e]:J.call(t,e)},fe.prototype.set=function(e,i){return this.__data__[e]=ne&&void 0===i?t:i,this},pe.prototype.clear=function(){this.__data__=[]},pe.prototype.delete=function(e){var t=this.__data__,i=be(t,e);return!(i<0||(i==t.length-1?t.pop():Y.call(t,i,1),0))},pe.prototype.get=function(e){var t=this.__data__,i=be(t,e);return i<0?void 0:t[i][1]},pe.prototype.has=function(e){return be(this.__data__,e)>-1},pe.prototype.set=function(e,t){var i=this.__data__,r=be(i,e);return r<0?i.push([e,t]):i[r][1]=t,this},he.prototype.clear=function(){this.__data__={hash:new fe,map:new(ee||pe),string:new fe}},he.prototype.delete=function(e){return we(this,e).delete(e)},he.prototype.get=function(e){return we(this,e).get(e)},he.prototype.has=function(e){return we(this,e).has(e)},he.prototype.set=function(e,t){return we(this,e).set(e,t),this},me.prototype.add=me.prototype.push=function(e){return this.__data__.set(e,t),this},me.prototype.has=function(e){return this.__data__.has(e)},ge.prototype.clear=function(){this.__data__=new pe},ge.prototype.delete=function(e){return this.__data__.delete(e)},ge.prototype.get=function(e){return this.__data__.get(e)},ge.prototype.has=function(e){return this.__data__.has(e)},ge.prototype.set=function(t,i){var r=this.__data__;if(r instanceof pe){var n=r.__data__;if(!ee||n.length<e-1)return n.push([t,i]),this;r=this.__data__=new he(n)}return r.set(t,i),this};var Se=function(e){return $.call(e)};function Ae(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||M.test(e))&&e>-1&&e%1==0&&e<t}function ke(e){if(null!=e){try{return K.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function xe(e,t){return e===t||e!=e&&t!=t}(Z&&Se(new Z(new ArrayBuffer(1)))!=y||ee&&Se(new ee)!=f||te&&"[object Promise]"!=Se(te.resolve())||ie&&Se(new ie)!=g||re&&"[object WeakMap]"!=Se(new re))&&(Se=function(e){var t=$.call(e),i=t==h?e.constructor:void 0,r=i?ke(i):void 0;if(r)switch(r){case oe:return y;case ae:return f;case se:return"[object Promise]";case ce:return g;case le:return"[object WeakMap]"}return t});var Oe=Array.isArray;function Ee(e){return null!=e&&Te(e.length)&&!je(e)}function je(e){var t=Re(e)?$.call(e):"";return t==u||t==d}function Te(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}function Re(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Pe(e){return!!e&&"object"==typeof e}var De=j?function(e){return function(t){return e(t)}}(j):function(e){return Pe(e)&&Te(e.length)&&!!w[$.call(e)]};function Le(e){return Ee(e)?ve(e):Ce(e)}return function(e,t){return _e(e,t)}}(),throttle:function(e,t){let i,r;return function(){const n=this,o=arguments;r?(clearTimeout(i),i=setTimeout(function(){Date.now()-r>=t&&(e.apply(n,o),r=Date.now())},t-(Date.now()-r))):(e.apply(n,o),r=Date.now())}},debounce:function(e,t){let i;return function(){const r=this,n=arguments;clearTimeout(i),i=setTimeout(()=>e.apply(r,n),t)}},intersection:function(e,t){var i;return t.length>e.length&&(i=t,t=e,e=i),e.filter(function(e){return t.indexOf(e)>-1}).filter(function(e,t,i){return i.indexOf(e)===t})}},_MetricalDateUtils={getLocalUtcTimestamp:function(){return(new Date).getTime()},isValidTimestamp:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},getTimestamp:function(e){if(null!=e)return this.isValidTimestamp(e)?e:Date.parse(e)},isTimestampBetweenDates:function(e,t,i){return(void 0===t||!isNaN(t))&&((void 0===i||!isNaN(i))&&(t&&i?t<=e&&e<=i:t&&!i?t<=e:!(t||!i)&&e<=i))},dbFormat:function(e){var t=e||(new Date).getTime();return new Date(t).toISOString()}},_MetricalFetch={post:function(e,t,i){return new Promise(function(r,n){var o=Object.assign({method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer"},i||{});o.body=JSON.stringify(t),fetch(e,o).then(function(e){if(!e.ok)throw new Error(e.status+" - "+e.statusText);return e.json()}).then(function(e){r(e)}).catch(function(e){n(e)})})}},_MetricalLocalTime=function(e){this.defaultParams={storage:_MetricalStorage||null},this.params=Object.assign({},this.defaultParams,e||{}),this.overrideKeyName="ltor"},_MetricalLocalTime.prototype.localTime=function(){var e=this.getOverrideValue();return e||(new Date).getTime()},_MetricalLocalTime.prototype.getOverrideValue=function(){return this.params.storage.Cookie.getItem(this.overrideKeyName)},_MetricalLocalTime.prototype.setOverrideValue=function(e){var t=new Date(e).getTime();return this.params.storage.Cookie.quickSet(this.overrideKeyName,t)},_MetricalLocalTime.prototype.removeOverrideValue=function(){return this.params.storage.Cookie.removeItem(this.overrideKeyName)},_MetricalRevisits=function(e){if(this.defaultParams={storage:null,namespace:null,resetPoints:[]},this.params=Object.assign({},this.defaultParams,e||{}),this.overrideKeyName="ltor",0==!!this.params.storage)throw new Error("A valid storage engine needs to be passed to revisits.");if(0==!!this.params.namespace)throw new Error("A valid namespace needs to be passed to revisits.");this.key="revisits_"+this.params.namespace,this.storage=this.params.storage,this.resetPoints=this.params.resetPoints},_MetricalRevisits.prototype.resetPoint=function(){var e=new _MetricalLocalTime({storage:this.storage}).localTime(),t=this.resetPoints.map(function(e){return new Date(e).getTime()});return t.sort(function(e,t){return t-e}),t.reduce(function(t,i){return null===t&&i<=e&&(t=i),t},null)},_MetricalRevisits.prototype.record=function(e){var t=this.storage.Storage.getItem(this.key)||{},i=this.resetPoint();if(null!==i&&(t=Object.keys(t).reduce(function(e,r){var n=t[r];return n>i&&(e[r]=n),e},{}),this.storage.Storage.setItem(this.key,t)),!(e in t)){var r=new _MetricalLocalTime({storage:this.storage}).localTime();t[e]=r,this.storage.Storage.setItem(this.key,t)}},_MetricalRevisits.prototype.recordCount=function(){var e=this.storage.Storage.getItem(this.key)||{};return Object.keys(e).length||0},_MetricalGroups=function(e){if(this.params=Object.assign({},{storageKey:"groups"},e),0==!!this.params.storage)throw new Error("A storage object needs to be supplied to the _MetricalGroups class");if(0==!!this.params.groups)throw new Error("A groups object needs to be supplied to the _MetricalGroups class")},_MetricalGroups.prototype.reset=function(){this.params.storage.removeItem(this.params.storageKey)},_MetricalGroups.prototype.randomNumber=function(e){return Math.floor(Math.random()*e+1)},_MetricalGroups.prototype.groupItem=function(e){var t=this.params.storage.getItem(this.params.storageKey),i={};if(null!==t&&"ttl"in t){var r=t.ttl;(new Date).getTime()>r&&(t=null)}return t?i=t.obj||{}:(i=this.assignGroupItems(),t={ttl:(new Date).getTime()+18e5,obj:i},this.params.storage.setItem(this.params.storageKey,t)),e in i?i[e]:null},_MetricalGroups.prototype.assignGroupItems=function(){var e=this;return Object.keys(this.params.groups).reduce(function(t,i){var r=e.params.groups[i],n=r.upper,o=e.randomNumber(n);return t[i]=e.findItem(r.items,o),t},{})},_MetricalGroups.prototype.findItem=function(e,t){return Object.keys(e).reduce(function(i,r){return(Array.isArray(e[r])?e[r]:[e[r]]).includes(t)&&(i=r),i},null)},_MetricalLocalInteractions=function(e){this.defaultProperties={storage:_MetricalStorage.SessionStorage||null,utils:_MetricalUtils||null,uuid:null,sessionId:null,keyName:"lint"},this.properties=Object.assign({},this.defaultProperties,e||{}),this.storage=this.properties.storage,this.utils=this.properties.utils},_MetricalLocalInteractions.prototype.record=function(e){var t=this,i=this.all().filter(function(e){return t.properties.sessionId==e.session_id&&t.properties.uuid==e.uuid});return i.push(e),this.storage.setItem(this.properties.keyName,i)},_MetricalLocalInteractions.prototype.all=function(){return this.storage.getItem(this.properties.keyName)||[]},_MetricalLocalInteractions.prototype.values=function(e){if("string"!=typeof e)throw new Error("LocalInteractions.value() expects to receive a string denoting an object path");e=void 0===e?"":e;var t=this;return t.all().map(function(i){return t.utils.get(i,e)})},_MetricalDataPoints=function(e){this.defaultProperties={storage:_MetricalStorage.SessionStorage||null,utils:_MetricalUtils||null,keyName:"dp",config:[]},this.properties=Object.assign({},this.defaultProperties,e||{}),this.storage=this.properties.storage,this.utils=this.properties.utils},_MetricalDataPoints.prototype.evaluate=function(){var that=this,data=that.all();this.properties.config.forEach(function(config){var value=eval(config.eval);config.key in data&&data[config.key]==config.target||(data[config.key]=value)}),that.record(data)},_MetricalDataPoints.prototype.record=function(e){var t=this.all();return this.storage.setItem(this.properties.keyName,Object.assign({},t,e))},_MetricalDataPoints.prototype.all=function(){return this.storage.getItem(this.properties.keyName)||{}},_MetricalDataPoints.prototype.get=function(e){var t=this.all();return e in t?t[e]:null},_MetricalConditions=function(e){this.params=Object.assign({},{conditions:{}},e),this.conditionsList=[],this.prepareConditions()},_MetricalConditions.prototype.prepareConditions=function(){var e=this;this.conditionsList=Object.keys(this.params.conditions).map(function(t){var i=e.params.conditions[t],r="object"==typeof i&&"conditiontype"in i?i.conditiontype:"default";return new(e.conditionClass(r))(t,i)})},_MetricalConditions.prototype.conditionClass=function(e){var t={urlcondition:function(){return _MetricalUrlCondition},devicetypecondition:function(){return _MetricalDeviceTypeCondition},randomsamplecondition:function(){return _MetricalRandomSampleCondition},cartcontainscondition:function(){return _MetricalCartContainsCondition},basiccondition:function(){return _MetricalBasicCondition},default:function(){return _MetricalDefaultCondition}};return(t[e]||t.default)()},_MetricalConditions.prototype.overrides=function(){var e={};return _MetricalStorage.Cookie.hasItem("oc")&&(e=_MetricalStorage.Cookie.getItem("oc")),e},_MetricalConditions.prototype.evaluateConditions=function(e){var t=this;return new Promise(function(i,r){try{var n={},o=t.overrides()||{};void 0===e&&(e=[]),e=Array.isArray(e)?e:[e];var a=t.conditionsList.reduce(function(t,i){return(0==e.length||e.includes(i.id))&&t.push(i.evaluate(n)),t},[]);Promise.all(a).then(function(e){const t=e.reduce(function(e,t){return e[t.id]=t.val,e},{});i(Object.assign({},t,o))}).catch(function(e){r(e)})}catch(e){r(e)}})},_MetricalDefaultCondition=function(e,t){this.id=e,this.params=t},_MetricalDefaultCondition.prototype.evaluate=function(){var evalString=this.params;try{return{id:this.id,val:eval(evalString)}}catch(e){var newMessage=e.toString()+": "+evalString;throw new Error(newMessage)}},_MetricalBasicCondition=function(e,t){this.id=e,this.params=t,this.firstOperand=t.properties.firstoperand,this.operator=t.properties.operator,this.secondOperand=t.properties.secondoperand},_MetricalBasicCondition.prototype.getValueFromOperand=function(operand){var value=null;if("html"==operand.type){var el=_MetricalUtils.querySelector(operand.selector);value=el?this.getDataFromElement(el,operand.selectortype):null}else"constant"==operand.type?value=operand.value:"eval"==operand.type&&(value=eval(operand.value));return 1==operand.numeric&&null!=value&&null!=value&&"string"==typeof value&&(value=value.replace(/[^\d.-]/g,"")),value},_MetricalBasicCondition.prototype.getDataFromElement=function(e,t){var i=null;return e.length>0&&(e=e[0]),null!=e&&("image"==t?i=e.src:"tag"==t?i=e.textContent:"input"==t?i=e.value:"input-id"==t?i.push(e.id):"a"==t?i.push(e.href):"select"==t&&(i=e.options[e.selectedIndex].value)),i},_MetricalBasicCondition.prototype.evaluate=function(){var that=this,firstValue=this.getValueFromOperand(this.firstOperand),secondValue=this.getValueFromOperand(this.secondOperand);if(firstValue instanceof Array){var evalParts=[];firstValue.forEach(function(val,key){"string"==typeof val&&0==val.length||"string"==typeof secondValue&&0==secondValue.length?res=val==secondValue:res=eval(val+" "+that.operator+" "+secondValue),evalString+=res+" || ",evalParts.push(res)});var evalString=evalParts.join(" || ");result=eval(evalString)}else if(secondValue instanceof Array){var evalParts=[];secondValue.forEach(function(val,key){"string"==typeof val&&0==val.length||"string"==typeof firstValue&&0==firstValue.length?res=val==firstValue:res=eval(firstValue+" "+that.operator+" "+val),evalParts.push(res)});var evalString=evalParts.join(" || ");result=eval(evalString)}else result=null!=firstValue&&null!=secondValue?eval(firstValue+" "+this.operator+" "+secondValue):void 0;return{id:that.id,val:result}},_MetricalRandomSampleCondition=function(e,t){if(this.id=e,this.params=t,this.upper="upper"in t.properties&&t.properties.upper>1?t.properties.upper:2,this.groupid="groupid"in t.properties?t.properties.groupid:"default",!("equal"in t.properties))throw new Error("Condition ramdomsamplecondition requires an equal property to be set");this.equal=Array.isArray(t.properties.equal)?t.properties.equal:[t.properties.equal]},_MetricalRandomSampleCondition.prototype.randomNumber=function(){return Math.floor(Math.random()*this.upper+1)},_MetricalRandomSampleCondition.prototype.evaluate=function(e){if("rand"in e||(e.rand={}),!(this.groupid in e.rand)){var t=this.randomNumber();e.rand[this.groupid]=t}var i=e.rand[this.groupid];return{id:this.id,val:this.equal.includes(i)}},_MetricalUrlCondition=function(e,t){if(this.id=e,this.params=t,!("urlvalue"in this.params.properties))throw new Error("Condition urlcondition requires a urlvalue property to be set");this.urlPatterns=Array.isArray(this.params.properties.urlvalue)?this.params.properties.urlvalue:[this.params.properties.urlvalue],this.href="href"in this.params.properties?this.params.properties.href:window.location.href},_MetricalUrlCondition.prototype.evaluate=function(e){var t=this,i=1==this.urlPatterns.map(function(e){return new RegExp(e).test(t.href)}).includes(!0);return{id:this.id,val:i}},_MetricalDeviceTypeCondition=function(e,t){if(this.id=e,this.params=t,!("devicesallowed"in this.params.properties))throw new Error("Condition devicetype requires a devicesallowed property to be set");this.devicesAllowed=Array.isArray(this.params.properties.devicesallowed)?this.params.properties.devicesallowed:[this.params.properties.devicesallowed]},_MetricalDeviceTypeCondition.prototype.evaluate=function(e){var t=_MetricalUtils.determineDevice(),i=1==this.devicesAllowed.includes(t);return{id:this.id,val:i}},_MetricalPECondition=function(e,t){if(this.id=e,this.params=t,!("model"in this.params.properties))throw new Error("Condition PE requires a model property to be set");this.model=this.params.properties.model,this.field=this.params.properties.field?this.params.properties.field:"abandonmentProbable",this.source=_MetricalAbandonCart},_MetricalPECondition.prototype.evaluate=function(e){var t="abandonProbable."+this.model+"."+this.field,i=!!_MetricalUtils.get(this.source,t,!1);return{id:this.id,val:i}},_MetricalCartContainsCondition=function(e,t){if(this.id=e,this.params=t,!("comparisons"in this.params.properties))throw new Error("CartContains requires a comparisons property to be set");this.comparisons=this.params.properties.comparisons,this.logicalOperator=this.params.properties.logicaloperator?this.params.properties.logicaloperator:"AND";var i=_MetricalUtils.get(_MetricalAbandonCart,"passedInProperties.usermeta.cartidlist","");this.source=i?String(i):"",this.items=_MetricalCart.items||{}},_MetricalCartContainsCondition.prototype._checkComparisons=function(e){var t=this.comparisons.map(function(t){var i=t.key,r=t.value,n=e[i]||"";return Array.isArray(r)?r.includes(n):n==r});return"OR"==this.logicalOperator?!!t.includes(!0):!t.includes(!1)},_MetricalCartContainsCondition.prototype.evaluate=function(e){var t=this,i=!!_MetricalUtils.plusDelimitedParts(t.source).reduce(function(e,i){var r=t.items[i]||{};return t._checkComparisons(r)&&(e=!0),e},!1);return{id:this.id,val:i}},_MetricalEngagementLimits=function(e,t){if("object"!=typeof e)throw new Error("EngagementLimits expects an engagement object");if(0==Array.isArray(t))throw new Error("EngagementLimits expects an engagementsShown array");this.engagement=e,this.engagementsShown=t.slice(),this.engagementsShown.sort(function(e,t){return e.ts-t.ts})},_MetricalEngagementLimits.prototype.campaignLimit=function(e,t){var i=this;if(t&&Object.keys(t).map(function(e){var r=t[e];return e in i.engagement&&i.engagement[e]==r}).includes(!1))return!1;var r=i.engagement.campaign||void 0;return this.engagementsShown.filter(function(e){return e.campaign==r}).length>=e},_MetricalEngagementLimits.prototype.servedInLast24Hours=function(e,t){var i=this;if(t&&Object.keys(t).map(function(e){var r=t[e];return e in i.engagement&&i.engagement[e]==r}).includes(!1))return!1;var r=(new Date).getTime()-864e5;return this.engagementsShown.filter(function(e){return e.ts>=r}).length>=e},_MetricalDimensions=function(e){const t={document:document||null,window:window||null};this.properties=Object.assign({},t,e||{})},_MetricalDimensions.prototype.documentWidth=function(){return Math.max(this.properties.document.body.clientWidth||0,this.properties.document.documentElement.clientWidth||0,this.properties.window.innerWidth||0)},_MetricalDimensions.prototype.documentHeight=function(){return Math.max(this.properties.document.body.clientHeight||0,this.properties.document.documentElement.clientHeight||0,this.properties.window.innerHeight||0)},_MetricalDimensions.prototype.viewPortWidth=function(){return Math.max(this.properties.document.documentElement.clientWidth||0,this.properties.window.innerWidth||0)},_MetricalDimensions.prototype.viewPortHeight=function(){return Math.max(this.properties.document.documentElement.clientHeight||0,this.properties.window.innerHeight||0)},_MetricalDimensions.prototype.browserWidth=function(){return this.properties.window.outerWidth||0},_MetricalDimensions.prototype.browserHeight=function(){return this.properties.window.outerHeight||0},_MetricalDimensions.prototype.screenWidth=function(){return this.properties.window.screen.width||0},_MetricalDimensions.prototype.screenHeight=function(){return this.properties.window.screen.height||0},_MetricalExitIntent=function(e){if(this.properties=Object.assign({},{yStart:0,yThickness:10,leftZoneSize:200,rightZoneSize:200,dimensions:null},e||{}),!1==!!this.properties.dimensions)throw new Error("Exit intent requires the dimensions module be passed");this.x=null,this.y=null,this.zones=[],this.exitIntents=0,this.lastExitIntentTimestamp=null},_MetricalExitIntent.prototype.hasExitIntent=function(){return this.exitIntents>0},_MetricalExitIntent.prototype.checkForIntent=function(e,t){return this.x=e,this.y=t,1==this.isInZone(this.x,this.y)&&(this.incrementExitIntents(),!0)},_MetricalExitIntent.prototype.incrementExitIntents=function(){this.exitIntents++,this.lastExitIntentTimestamp=(new Date).getTime()},_MetricalExitIntent.prototype.isInZone=function(e,t){return t<=this.properties.yStart+this.properties.yThickness},_MetricalCxLauncher=function(e){var t={jQuery:void 0,config:void 0,acconfig:"object"==typeof _MetricalAbandonCart&&_MetricalAbandonCart.Config||void 0,metricalObj:"object"==typeof _Metrical?_Metrical:void 0,document:"object"==typeof document?document:void 0};if(this.properties=Object.assign({},t,e||{}),this.metricalObj=this.properties.metricalObj,this.document=this.properties.document,0==!!this.properties.jQuery)throw new Error("_MetricalCxLauncher requires the jQuery parameter");if(0==!!this.properties.config)throw new Error("_MetricalCxLauncher requires a config parameter");if(0==!!this.properties.acconfig)throw new Error("_MetricalCxLauncher requires an acconfig parameter");if(0==!!this.properties.metricalObj)throw new Error("_MetricalCxLauncher requires a metricalObj parameter");if(0==!!this.properties.document)throw new Error("_MetricalCxLauncher requires a document parameter")},_MetricalCxLauncher.prototype.bootstrap=function(e){var t=this;this.metricalObj&&this.metricalObj.app&&this.metricalObj.app.tabCloserTimer&&clearInterval(this.metricalObj.app.tabCloserTimer);var i=this.document.querySelector(".Metrical_lightbox");i&&i.remove();var r=this.document.querySelector(".MetricalContainer");r&&r.remove();var n=Object.assign({},this.properties.config);null==n.apiendpointhost&&(n.apiendpointhost=this.properties.acconfig.apiendpointhost),null==n.staticendpointhost&&(n.staticendpointhost=this.properties.acconfig.staticendpointhost),n.postWidgetRender=function(){t.metricalObj.makeVisible(),e(!0)},this.metricalObj.init(this.properties.jQuery,n)},_MetricalCxLauncher.prototype.execute=function(){var e=this;return new Promise(function(t,i){try{e.bootstrap(t)}catch(e){i(e)}})},_MetricalCxFlow=function(e){var t={conditions:void 0,cxflows:[],utils:_MetricalUtils,jQuery:null};if(this.properties=Object.assign({},t,e||{}),0==!!this.properties.conditions)throw new Error("_MetricalCxFlow requires a conditions parameter");if(0==!!this.properties.jQuery)throw new Error("_MetricalCxFlow requires a jQuery parameter");this.conditions=this.properties.conditions,this.cxflows=this.properties.cxflows,this.selectionLog=[],this.isPresenting=!1,this.isClosed=!1},_MetricalCxFlow.prototype.executeEngagementLoop=function(){var e=this;return new Promise(function(t,i){try{e.isClosed&&t(!1),e.conditions.evaluateConditions().then(function(r){var{selectedFlow:n,selectionLog:o}=e.selectCxSurvey(r);e.selectionLog=o,null!==n&&0==e.isPresenting?(e.isPresenting=!0,e.launchFlow(n).then(function(i){e.closeFlow(),t(!0)}).catch(function(t){e.closeFlow(),i(t)})):t(!0)}).catch(function(e){i(e)})}catch(e){console.error(e),i(e)}})},_MetricalCxFlow.prototype.closeFlow=function(){this.isClosed=!0},_MetricalCxFlow.prototype.selectCxSurvey=function(e){var t=this,i=[],r=[];return this.cxflows.forEach(function(n){var o=n.rule||void 0;if(o){var a=t.properties.utils.evaluateRule(o,e,{}),s=t.properties.utils.ruleCriteriaString(o,e,{});i.push("CxFlow: "+n.id+" - "+s),a&&r.push(n)}}),i.push("Considered CxFlows length after remaining is "+r.length),r.length>0?{selectedFlow:r[0],selectionLog:i}:{selectedFlow:null,selectionLog:i}},_MetricalCxFlow.prototype.launchFlow=function(e){var t=this;return new Promise(function(i,r){try{new _MetricalCxLauncher({jQuery:t.properties.jQuery,config:e.cxconfig}).execute().then(function(e){i(!0)}).catch(function(e){r(e)})}catch(e){r(e)}})},_MetricalEngagementFactory=function(e){if(this.params=Object.assign({},{acConfig:null,jQuery:null},e),0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to offer v2");if(0==!!this.params.jQuery)throw new Error("A valid instance of jQuery needs to be passed to offer v2")},_MetricalEngagementFactory.prototype.create=function(e){var t=this,i={callbridge:function(e){return new _MetricalCallBridge(Object.assign({},t.params,{engagement:e}))},offerv2:function(e){return new _MetricalOfferV2(Object.assign({},t.params,{engagement:e}))},offerv1:function(e){return new _MetricalOfferV1(Object.assign({},t.params,{engagement:e}))},default:function(e){throw new Error("A default engagement creation behanvior is not defined")}};return i[this.determineType(e)](e)||i.default(e)},_MetricalEngagementFactory.prototype.determineType=function(e){if("engagementtype"in e&&"callbridge"==e.engagementtype)return"callbridge";if("couponconfig"in e)return"offerv2";if("survey"in e&&1==!!e.survey&&"none"!=e.survey)return"offerv1";throw new Error("Not able to determine the engagement type")},_MetricalCallBridge=function(e){if(this.params=Object.assign({},{acConfig:null,jQuery:null,engagement:null,immediatelyPerformBenefit:!0},e),this.performBenefitFunction=function(){},console.log(typeof this.performBenefitFunction),0==!!this.params.engagement)throw new Error("A valid engagement configuration object needs to be passed to offer v2");if(0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to offer v2");if(0==!!this.params.jQuery)throw new Error("A valid instance of jQuery needs to be passed to offer v2")},_MetricalCallBridge.prototype.performBenefit=function(){console.log("running performBenefit"),console.log(typeof this.performBenefitFunction),this.performBenefitFunction()},_MetricalCallBridge.prototype.execute=function(){var e=this;return console.log(e.params),new Promise(function(t,i){try{var r=e.params.engagement,n="closestatus"in r?r.closestatus:"dismissed",o="submitstatus"in r?r.submitstatus:"submitted",a=new _MetricalOfferViewV3({view:r.viewconfig,config:e.params.acConfig}),s=Object.assign({},r.couponconfig,{callbackEndpoint:_MetricalHosts.endpoints.callBridge}),c=new _MetricalCouponDriverCallBridge(s);e.performBenefitFunction=function(){console.log("running coupon.postCoupon()");var e=a.formData.Metrical_phonenumber||null;console.log("performBenefitFunction phone",e),c.execute(e).then(function(e){console.log(e)}).catch(function(e){console.error(e)})},a.subscribe("render/post",function(){}),a.subscribe("submit/post",function(){console.log("in submit"),console.log(e),1==e.params.immediatelyPerformBenefit&&(console.log("handler performing benefit"),e.performBenefit()),_MetricalOfferFlow.response(o),a.navigate("thankyou")}),a.subscribe("close/post",function(){_MetricalOfferFlow.response(n)}),a.render("index"),t(!0)}catch(e){i(e)}})},_MetricalOfferV2=function(e){if(this.params=Object.assign({},{acConfig:null,jQuery:null,engagement:null,immediatelyPerformBenefit:!0},e),this.performBenefitFunction=function(){},0==!!this.params.engagement)throw new Error("A valid engagement configuration object needs to be passed to offer v2");if(0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to offer v2");if(0==!!this.params.jQuery)throw new Error("A valid instance of jQuery needs to be passed to offer v2")},_MetricalOfferV2.prototype.performBenefit=function(){this.performBenefitFunction()},_MetricalOfferV2.prototype.execute=function(){var e=this;return new Promise(function(t,i){try{var r=e.params.engagement;_MetricalCoupon.init(e.params.jQuery,{},r.couponconfig,function(){}),e.performBenefitFunction=function(){_MetricalCoupon.postCoupon()};var n="closestatus"in r?r.closestatus:"dismissed",o="submitstatus"in r?r.submitstatus:"submitted",a=new _MetricalOfferViewV2({view:r,config:e.params.acConfig});a.subscribe("render/post",function(){}),a.subscribe("submit/post",function(){1==e.params.immediatelyPerformBenefit&&e.performBenefit(),_MetricalOfferFlow.response(o)}),a.subscribe("close/post",function(){_MetricalOfferFlow.response(n)}),a.render(),t(!0)}catch(e){i(e)}})},_MetricalOfferV1=function(e){if(this.params=Object.assign({},{acConfig:null,jQuery:null,engagement:null,immediatelyPerformBenefit:!0},e),this.performBenefitFunction=function(){},0==!!this.params.engagement)throw new Error("A valid engagement configuration object needs to be passed to offer v2");if(0==!!this.params.acConfig)throw new Error("A valid AC config object needs to be passed to offer v2");if(0==!!this.params.jQuery)throw new Error("A valid instance of jQuery needs to be passed to offer v2")},_MetricalOfferV1.prototype.performBenefit=function(){this.performBenefitFunction()},_MetricalOfferV1.prototype.execute=function(){var e=this;return new Promise(function(t,i){try{({abandonCartAction:null,bootstrap:function(e,t,i){this.abandonCartAction=t;var r=this;this.clearMetrical(),this.initMetrical(e,function(){if(r.configureOfferEventHandlers(e),"function"==typeof i){var t={couponConfig:_MetricalCoupon.couponConfig()};i(t)}})},initMetrical:function(e,t){var i=Object.assign({},e);null==i.apiendpointhost&&(i.apiendpointhost=_MetricalAbandonCart.Config.apiendpointhost),null==i.staticendpointhost&&(i.staticendpointhost=_MetricalAbandonCart.Config.staticendpointhost),i.postWidgetRender=t,_Metrical.init(jqAC,i),_MetricalAbandonCart.Log.info("Finalized the bootstrap of Metrical",this)},displayMetrical:function(){},clearMetrical:function(){_Metrical&&_Metrical.app&&_Metrical.app.tabCloserTimer&&clearInterval(_Metrical.app.tabCloserTimer),jqAC(".Metrical_lightbox").remove(),jqAC(".MetricalContainer").remove()},configureOfferEventHandlers:function(t){e.performBenefitFunction=function(){_MetricalCoupon.postCoupon()};var i="closestatus"in t?t.closestatus:"dismissed",r="submitstatus"in t?t.submitstatus:"submitted",n="autocloseafterxseconds"in t?t.autocloseafterxseconds:void 0,o="autosubmitafterxseconds"in t?t.autosubmitafterxseconds:void 0;setTimeout(function(){var t=void 0,a=void 0;n&&(t=setTimeout(function(){jqAC(".MetricalContainer #close-widget").click()},1e3*n));o&&(a=setTimeout(function(){jqAC(".MetricalContainer #submit-widget").click()},1e3*o));jqAC(".MetricalTab a.mobile-link").click(function(e){_MetricalOfferFlow.response(i),void 0!==t&&clearTimeout(t)});for(var s=document.querySelectorAll(".MetricalTab.elTab-left, .MetricalTab.elTab-right, .MetricalTab.elTab-top"),c=0;c<s.length;c++)s[c].addEventListener("click",function(e){jqAC(this).parent().hasClass("is-popped")&&void 0!==e.originalEvent&&(_MetricalOfferFlow.response(i),void 0!==t&&clearTimeout(t))});jqAC(".MetricalContainer #close-widget").click(function(e){_MetricalOfferFlow.response(i),void 0!==t&&clearTimeout(t)}),jqAC(".MetricalContainer #submit-widget").click(function(t){1==e.params.immediatelyPerformBenefit&&e.performBenefit(),_MetricalOfferFlow.response(r),void 0!==a&&clearTimeout(a),jqAC("body").css("overflow-y",""),t.stopPropagation()})},500)}}).bootstrap(e.params.engagement,null,t)}catch(e){i(e)}})},_MetricalCouponDriverCallBridge=function(e){this.properties=Object.assign({},{},e||{})},_MetricalCouponDriverCallBridge.prototype.execute=function(e){var t=this;return new Promise(function(i,r){console.log(t.properties),console.log(e);var n={method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify({phone:e})};console.log(n),fetch(t.properties.callbackEndpoint,n).then(function(e){return e}).then(function(e){console.log("success"),console.log(e),i(e)}).catch(function(e){console.log("error"),console.error(e),r(e)})})},_MetricalOfferRecord={keyMap:{offer_flow_guid:"ofg",is_invalid:"ii",is_closed:"ic",experiment_name:"en",experiment_settings:"es",eligibility:"el",eligibility_timestamp:"elt",eligibility_criteria:"elc",testgroup:"tg",testgroup_timestamp:"tgt",engagement_selected:"ens",engagement_selected_timestamp:"enst",engagement_rule_name_matched:"enrn",engagement_rule_matched:"enrm",engagement_rule_metadata:"enrmd",engagement_selection_log:"ensl",engagement_selected_couponcode:"ensc",presentation:"prs",presentation_timestamp:"prst",offer_is_visible:"oisv",response:"rsp",response_timestamp:"rspt",feature_id:"fid",campaign:"cam",acconfig_settings:"acs",tags:"tags",session_id:"sid"},new:function(){return{offer_flow_guid:null,is_invalid:!1,is_closed:!1,experiment_name:null,experiment_settings:{},eligibility:null,eligibility_timestamp:null,eligibility_criteria:null,testgroup:null,testgroup_timestamp:null,engagement_selected:null,engagement_selected_timestamp:null,engagement_rule_name_matched:null,engagement_rule_matched:null,engagement_rule_metadata:null,engagement_selection_log:null,engagement_selected_couponcode:null,presentation:null,presentation_timestamp:null,offer_is_visible:!1,response:null,response_timestamp:null,feature_id:null,campaign:null,acconfig_settings:null,tags:{},session_id:null}},dehydrate:function(e){var t={};for(var i in e){var r=e[i],n=i in _MetricalOfferRecord.keyMap?_MetricalOfferRecord.keyMap[i]:i;"experiment_settings"==i&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),r={}),"engagement_selected"==i&&null!==r&&(delete(r=JSON.parse(JSON.stringify(r))).isactive,delete r.name,delete r.offerrules,delete r.survey),"engagement_selection_log"==i&&null!==r&&(r=JSON.parse(JSON.stringify(r)),r=[]),t[n]=r}return t},hydrate:function(e){var t={},i={};for(var r in _MetricalOfferRecord.keyMap)i[_MetricalOfferRecord.keyMap[r]]=r;for(var r in e){var n=e[r];t[r in i?i[r]:r]=n}return t}},_MetricalDebug={init:function(e){this.defaultConfig={isActive:!1,ac:{Log:{logs:[]}}},this.config=Object.assign({},this.defaultConfig,e||{})},isEnabled:function(){return!!this.config.isActive},debugInformation:function(){var e={};return e.localStorage=_MetricalStorage.Storage.metricalObject(),e.cookie=_MetricalStorage.Cookie.metricalObject(),e.log=this._createLogRows(),e.offerflowda=_MetricalStorage.SessionStorage.metricalObject(),e},_createLogRows:function(){for(var e=this.config.ac.Log.logs,t=[],i=0;i<e.length;i++){var r=e[i];r.data.forEach(function(e){var i=r.type+" - "+r.timestamp+":";e instanceof Error?(i=i+" "+e.name+" - "+e.message+": ",e.stack):i="object"==typeof e?i+" "+JSON.stringify(e):i+" "+e,t.push(i)})}return t}},_MetricalPhase=function(e){this.defaultParams={config:_MetricalAbandonCart.Config||null},this.params=Object.assign({},this.defaultParams,e||{}),this.phases=this.params.config.phases||[]},_MetricalPhase.prototype.currentPhase=function(){var e=(new _MetricalLocalTime).localTime();return this.selectPhase(e)||null},_MetricalPhase.prototype.selectPhase=function(e){var t=this.phases.filter(function(t){var i=new Date(t.start).getTime(),r=new Date(t.end).getTime();return e>=i&&e<r});return 1==t.length?t[0]:null},_MetricalPhase.prototype.constrainOfferToPhaseTimeframe=function(e,t){if(void 0===t&&(t=this.currentPhase()),null===t)return e;var i=e.startdate?new Date(e.startdate).getTime():null,r=e.enddate?new Date(e.enddate).getTime():null,n=new Date(t.start).getTime(),o=new Date(t.end).getTime();return"phase"in e&&e.phase==t.id&&((null===i||i<n||i>o)&&(e.startdate=t.start),(null===r||r>o||r<n)&&(e.enddate=t.end)),e},_MetricalOfferFlowDataAccess={init:function(e,t,i,r,n){switch(this.defaultConfig={namespace:"default",storageDriver:"localStorage"},this.config=Object.assign({},this.defaultConfig,e||{}),this.namespace=this.config.namespace||"default",this.jqDA=t,this.ac=i,this.identity=r,this.postEndpoint=n,this.offerRecordKey="offerRecord",this.offerRecordGuidKey="offerRecordGuid",this.testGroupKey="testgroup",this.treatmentTagKey="treatmenttag",this.controlExpired="controlexpired",this.offerLimitsKey="offerlimits",this.limitKey="limit",this.timestampKey="localtime_override",this.getOfferRecordMutator=void 0,this.saveOfferRecordMutator=void 0,this.cookieObject=_MetricalStorage.Cookie,this.storageObject=_MetricalStorage.Storage,this.recordStore=null,this.limitStore=null,this.post=function(e){},this.config.storageDriver){case"serverstore":this.recordStore=_MetricalStorage.ServerStore,this.limitStore=_MetricalStorage.Cookie,this.post=_MetricalStorage.ServerStore._post;var o=this.namespace+"_"+this.offerRecordGuidKey,a=this.cookieObject.getItem(o),s=this.namespace+"_"+this.offerRecordKey;this.recordStore.init(a,s);break;case"cookie":this.recordStore=_MetricalStorage.Cookie,this.limitStore=_MetricalStorage.Cookie,this.getOfferRecordMutator=_MetricalOfferRecord.hydrate,this.saveOfferRecordMutator=_MetricalOfferRecord.dehydrate;break;case"localStorage":default:this.recordStore=_MetricalStorage.Storage,this.limitStore=_MetricalStorage.Storage}this.debug=[]},setNamespace:function(e){this.namespace=e},getOfferRecord:function(){var e=this.namespace+"_"+this.offerRecordKey,t=this.namespace+"_"+this.offerRecordGuidKey,i=this.recordStore.getItem(e);"function"==typeof this.getOfferRecordMutator&&(i=this.getOfferRecordMutator(i));var r=this.cookieObject.getItem(t);if(null===i||null===r||i.offer_flow_guid!=r||i.session_id!=this.identity.getSessionId()){var n=_MetricalOfferRecord.new();return n.offer_flow_guid=_MetricalUtils.makeUUID(),n.session_id=this.identity.getSessionId(),this.saveOfferRecord(n),this._resetLimitKey(),n}return i},updateSessionId:function(e){0==e.is_closed&&e.session_id!=this.identity.getSessionId()&&(e.session_id=this.identity.getSessionId(),this.saveOfferRecord(e),this._resetLimitKey())},saveOfferRecord:function(e){var t,i=this.namespace+"_"+this.offerRecordKey,r=this.namespace+"_"+this.offerRecordGuidKey;t="function"==typeof this.saveOfferRecordMutator?this.saveOfferRecordMutator(e):e;this.recordStore.setItem(i,t);return this.cookieObject.sessionQuickSet(r,e.offer_flow_guid),!0},postOfferRecord:function(e,t){var i=this;try{if(null!=t){if(i._limitKeyUsed(t))return;i._addLimitKey(t)}i.post(e);var r={surveyId:i.ac.Config.surveyid,uuid:i.identity.getDeviceId(),sessionId:i.identity.getSessionId(),offerflow:e};i.debug.push(r),_MetricalStorage.SessionStorage.setItem("offerflowda_debug",i.debug),i.jqDA.ajax({type:"POST",dataType:"json",data:JSON.stringify(r),contentType:"text/plain",async:!1,url:i.postEndpoint,success:function(e){i.debug.push({callback:"success",response:e}),_MetricalStorage.SessionStorage.setItem("offerflowda_debug",i.debug)},error:function(e,t,r){console.log(e),console.log(t),console.log(r),i.debug.push({callback:"error",xhr:e,status:t,err:r}),_MetricalStorage.SessionStorage.setItem("offerflowda_debug",i.debug)}})}catch(e){console.error(e),i.debug.push({err:e}),_MetricalStorage.SessionStorage.setItem("offerflowda_debug",i.debug)}},getTestGroup:function(){var e=this.namespace+"_"+this.testGroupKey,t=null;switch(this.cookieObject.hasItem(e)?(t=this.cookieObject.getItem(e),this.storageObject.getItem(e)||this.storageObject.setItem(e,t)):(t=this.storageObject.getItem(e),this.cookieObject.quickSet(e,t)),t){case"treatment":return"treatment";case"control":return"control";default:return null}},saveTestGroup:function(e,t){var i=this.namespace+"_"+this.testGroupKey;t>0&&(t=new Date(t));this.cookieObject.quickSet(i,e,t);return this.storageObject.setItem(i,e),!0},getTreatmentTag:function(){var e=this.namespace+"_"+this.treatmentTagKey;return this.cookieObject.getItem(e)},saveTreatmentTag:function(e){var t=this.namespace+"_"+this.treatmentTagKey;this.cookieObject.quickSet(t,e);return!0},getIsControlExpired:function(){var e=this.namespace+"_"+this.controlExpired;return!!this.cookieObject.hasItem(e)&&"1"==this.cookieObject.getItem(e)},setIsControlExpired:function(e,t){var i=this.namespace+"_"+this.controlExpired;e=e?"1":"0";return t>0&&(t=new Date(t)),this.cookieObject.quickSet(i,e,t)},getOfferLimits:function(){var e=this.namespace+"_"+this.offerLimitsKey;return this.limitStore.getItem(e)},saveOfferLimits:function(e){var t=this.namespace+"_"+this.offerLimitsKey;this.limitStore.setItem(t,e,1/0);return!0},_getLimitKey:function(){var e=this.namespace+"_"+this.limitKey,t=this.cookieObject.getItem(e);return t||[]},_saveLimitKey:function(e){var t=this.namespace+"_"+this.limitKey;this.cookieObject.sessionQuickSet(t,e)},_limitKeyUsed:function(e){return this._getLimitKey().includes(e)},_addLimitKey:function(e){var t=this._getLimitKey();t.push(e),this._saveLimitKey(t)},_resetLimitKey:function(){this._saveLimitKey([])},getCurrentTimestamp:function(){var e=this.namespace+"_"+this.timestampKey;return this.cookieObject.getItem(e)},setCurrentTimestamp:function(e){var t=this.namespace+"_"+this.timestampKey;this.cookieObject.quickSet(t,e);return!0},savePresentedOffer:function(e){if(0==!!e.engagement_selected)return!1;var t=e.engagement_selected,i={};i.id=t.id,i.campaign=t.campaign||null,i.ts=(new Date).getTime();var r=this.storageObject.getItem("offers_selected");(r=Array.isArray(r)?r:[]).push(i);var n=(new Date).getTime()-5184e6,o=r.filter(function(e){return e.ts>=n});return this.storageObject.setItem("offers_selected",o),!0},getPresentedOffers:function(){var e=this.storageObject.getItem("offers_selected");return Array.isArray(e)?e:[]}},_MetricalOfferFlow={pubsub:new _MetricalUtils.PubSub,pubsubTopics:{tg:"eligible-test-group-defined",na:"not-actionable","OFFER-SELECTED":"offer-selected","OFFER-PRESENTED":"offer-presented","OFFER-NOT-PRESENTED":"offer-not-presented",np:"waiting-to-match-business-rules","CUSTOMER-RESPONDED":"customer-responded",CLOSE:"close"},manuallyTriggerPostCoupon:!1,manualPostFunction:null,manualPostCoupon:function(){1==this.manuallyTriggerPostCoupon&&"function"==typeof this.manualPostFunction&&this.manualPostFunction()},queuedTags:{},init:function(e){var t={conditions:null,engagements:[],tags:{},globalofferlimit:null,globalofferlimittimeout:null,offerflowtag:null,experiments:[{name:"default",treatmentweight:1,controlweight:0}],eligibilityrules:"",offerflowisactive:!0,da:null,engagementFunction:function(){},testMode:null,isInvalid:!1,revision:null,abandonprobable:{},limitChecks:[],logger:new _MetricalLogger({extraEntryData:{module:"offerflow"}})};if(this.properties=Object.assign({},t,e||{}),this.logger=this.properties.logger,this.logger.traceStart("init"),0==!!this.properties.conditions)throw new Error("A conditions object needs to be set and passed as an input to offer flows");if(0==!!this.properties.da)throw new Error("A data access object needs to be set and passed as an input to offer flows");this.engagementFunction=this.properties.engagementFunction,this.testMode=this.properties.testMode,this.activeExperiment=this.properties.experiments[0],this.conditions=this.properties.conditions,this.da=this.properties.da,this.da.setNamespace(this.activeExperiment.name),this.eligibilityRules=this.properties.eligibilityrules,this.engagements=this.properties.engagements,this.isVisible=!1,this.offerRecord={},this._loadOfferRecord(),this.validResponses=["submitted","dismissed","offer expired","timer expired","acknowledged","continued","checked out"],this.delayStarted=!1,this.isPresenting=!1,this.previousTags=null,this.definedTags={},this.logger.traceEnd("init")},reset:function(){this.isVisible=!1,this.offerRecord={},this._loadOfferRecord()},_loadOfferRecord:function(){if(this.offerRecord=this.da.getOfferRecord(),this.offerRecord.experiment_name=this.activeExperiment.name,this.offerRecord.experiment_settings=this.activeExperiment,this.offerRecord.is_invalid=this._isInTestMode()||this.properties.isInvalid,this.offerRecord.acconfig_settings={traffic_control_number:_MetricalSampling.getTrafficControlNumber()||null,offerflowtag:this.properties.offerflowtag,revision:this.properties.revision},Object.keys(this.queuedTags).length>0){var e=Object.assign({},this.offerRecord.tags,this.queuedTags);this.offerRecord.tags=e,this.queuedTags={},this.saveStateAndSync()}},_isInTestMode:function(){return null!==this.testMode&&this.testMode.isInTestMode()},executeEngagementLoop:function(){var e=this;return e.logger.traceStart("executeEngagementLoop"),new Promise(function(t,i){e.da.updateSessionId(e.offerRecord),e.isClosed()||0==e.properties.offerflowisactive&&0==e._isInTestMode()?(e.inLoopExecution=!1,e.logger.traceEnd("executeEngagementLoop"),t(!0)):e.conditions.evaluateConditions().then(function(i){if(e.logger.debug("Computed conditions",i),e.evaluateEligibility(i)){e.logger.info("Session has become eligible",{terminal:!0});var r=e.evaluateTestGroup();e.saveStateAndSync("tg"),e.logger.info("Determined test group "+r+" for the session",{terminal:!0,testGroup:r});var n=e.evaluateTags(i);e.logger.info("Evaluating tags for the session",{terminal:!0});var{selectedEngagement:o,selectedRule:a,selectionLog:s}=e.selectEngagement(i,n);o?0==e.isPresenting&&(e.logger.info("The engagement "+o.name+" was selected for the session",{terminal:!0,selectedEngagement:o}),e.isPresenting=!0,e.updateRecordSelectionLogAndTags(s,n),e.updateRecordWithEngagement(o,a),e.logger.debug("Offer Record",{offerRecord:e.offerRecord}),e.recordPresentedOffer(),"treatment"==r?(e.logger.info("Presenting the engagement to the session",{terminal:!0,selectedEngagement:o}),e.presentEngagement()):(e.logger.info("Not presenting the engagement to the session due to being control",{terminal:!0,selectedEngagement:o}),e.doNotPresentEngagement(),e.publish("OFFER-NOT-PRESENTED"),e.closeOffer())):(e.updateRecordSelectionLogAndTags(s,n),e.didTagsChange(n)?(e.previousTags=Object.assign({},n),e.saveStateAndSync("sl")):e.saveState())}else e.saveState();e.logger.traceEnd("executeEngagementLoop"),t(!0)}).catch(function(t){e.logger.traceEnd("executeEngagementLoop"),i(t)})})},recordPresentedOffer:function(){this.da.savePresentedOffer(this.offerRecord)},isClosed:function(){return this.offerRecord.is_closed},publish:function(e){if(e in this.pubsubTopics){var t={offer_presented:this.offerRecord.engagement_selected||{couponcode:null}};this.pubsub.publish(this.pubsubTopics[e],Object.assign({},this.offerRecord,t),1)}},closeOffer:function(){this.offerRecord.is_closed=!0,this.saveStateAndSync(),this.logger.info("Closing offer flow",{terminal:!0}),this.publish("CLOSE")},saveState:function(){this.da.saveOfferRecord(this.offerRecord)},saveStateAndSync:function(e){this.da.saveOfferRecord(this.offerRecord),0==this.da._limitKeyUsed(e)&&this.publish(e),this.da.postOfferRecord(this.offerRecord,e)},evaluateEligibility:function(e){var t=!1;if("eligible"==this.offerRecord.eligibility)t=!0;else{t=_MetricalUtils.evaluateRule(this.eligibilityRules,e);var i=_MetricalUtils.ruleCriteriaString(this.eligibilityRules,e);i!=this.offerRecord.eligibility_criteria&&(this.offerRecord.eligibility_criteria=i),this.offerRecord.eligibility_timestamp=(new Date).toISOString(),this.offerRecord.eligibility=1==t?"eligible":"not eligible"}return t},evaluateTestGroup:function(e){var t=this.da.getTestGroup(),i=this.da.getIsControlExpired(),r=this._determineControlExpiration();if(null===t){var n="posttreatmentweight"in this.activeExperiment&&"isatthreshold"in this.activeExperiment&&1==this.activeExperiment.isatthreshold?this.activeExperiment.posttreatmentweight:this.activeExperiment.treatmentweight,o="postcontrolweight"in this.activeExperiment&&"isatthreshold"in this.activeExperiment&&1==this.activeExperiment.isatthreshold?this.activeExperiment.postcontrolweight:this.activeExperiment.controlweight;if("string"==typeof n&&"string"==typeof o){var a=this._testGroupRule(n);this._testGroupRule(o)&&(t="control"),a&&(t="treatment")}else{var s=[{item:"treatment",weight:n},{item:"control",weight:o}];t=_MetricalUtils.chooseRandomItem(s)}"control"==t&&!1!==r?(this.da.saveTestGroup(t,r),this.da.setIsControlExpired(!0,r),i=!0):this.da.saveTestGroup(t)}return null==this.offerRecord.testgroup_timestamp&&(this.offerRecord.testgroup_timestamp=(new Date).toISOString()),this.offerRecord.testgroup=t,"control"===t&&0==i&&!1!==r&&(this.da.saveTestGroup(t,r),this.da.setIsControlExpired(!0,r)),t},_testGroupRule(rule){var result=!1;try{var evalResult=eval(rule);result=!!evalResult}catch(e){console.error(e)}return result},_determineControlExpiration:function(){if("object"==typeof this.activeExperiment&&"controlreleasedays"in this.activeExperiment){var e=this.activeExperiment.controlreleasedays,t=(new Date).getTime();return t+=86400*e*1e3}return!1},evaluateTags:function(e){var t=this,i=Object.keys(this.properties.tags||{}).reduce(function(i,r){i[r]=null;var n=t.properties.tags[r],o=_MetricalUtils.evaluateRule(n,e,i);return i[r]=o,i},{});return Object.assign({},i,this.definedTags||{})},didTagsChange:function(e){return 0==_MetricalUtils.isEqual(e,this.previousTags)},updateRecordSelectionLogAndTags:function(e,t){this.offerRecord.engagement_selection_log=e,this.offerRecord.tags=t},updateRecordWithEngagement:function(e,t){this.offerRecord.engagement_selected=e,this.offerRecord.engagement_selected_timestamp=(new Date).toISOString(),null!==t&&(this.offerRecord.engagement_rule_name_matched=t.name||"Not Found",this.offerRecord.engagement_rule_metadata=t.metadata||{},this.offerRecord.engagement_rule_matched=t),this.offerRecord.engagement_selected_couponcode=e.couponcode||null,this.offerRecord.campaign=e.campaign||null,"object"==typeof this.properties.abandonprobable&&"fid"in this.properties.abandonprobable&&(this.offerRecord.feature_id=this.properties.abandonprobable.fid||null)},currentOfferLimits:function(){var e=this.da.getOfferLimits();if(e){var t=(new Date).getTime();if("resetOn"in e&&(e.resetOn>0&&t>e.resetOn||null===e.resetOn)&&(e.total=0,e.resetOn=null),"offers"in e)for(var i in e.offers){let r=e.offers[i];"resetOn"in r&&(r.resetOn>0&&t>r.resetOn||null===r.resetOn)&&(r.total=0,r.resetOn=null)}}return e||{total:0,resetOn:null,offers:{}}},selectEngagement:function(e,t){var i=this,r=[],n=[],o=function(e){return!!i._engagementRules(e)},a=function(e){return e.map(function(e){return e.id}).join(", ")};n.push("Initial engagement count is "+this.engagements.length);var s=this.engagements.reduce(function(e,t){return"isactive"in t&&1==t.isactive?e.push(t):n.push("Eliminated "+t.id+" for not being active"),e},[]).reduce(function(e,t){if("startdate"in t||"enddate"in t){var r=_MetricalDateUtils.getLocalUtcTimestamp(),o=_MetricalDateUtils.getTimestamp(i.da.getCurrentTimestamp());o&&(r=o);var a=_MetricalDateUtils.getTimestamp(t.startdate),s=_MetricalDateUtils.getTimestamp(t.enddate);_MetricalDateUtils.isTimestampBetweenDates(r,a,s)?e.push(t):n.push("Eliminated "+t.id+" for not not being in the timestamp range")}else e.push(t);return e},[]).reduce(function(e,t){if(i.properties.limitChecks.length>0){var r=[],o=new _MetricalEngagementLimits(t,i.da.getPresentedOffers());i.properties.limitChecks.forEach(function(e){if(!(e.function in o))throw new Error(e.function+" is not a valid limit check function reference");r.push(o[e.function](e.value,e.offerselectionfilter||void 0))}),0==r.includes(!0)?e.push(t):n.push("Eliminated "+t.id+" for having a match against a limit check")}else e.push(t);return e},[]),c=i.currentOfferLimits(),l=s.reduce(function(e,t){var r=i._offerIsUnderLimit(t,c);return i._isUnderGlobalLimit(c)?r?e.push(t):n.push("Eliminated "+t.id+" because of engagement limit reached"):n.push("Eliminated "+t.id+" because of global limit reached"),e},[]);n.push("Avaialble engagements for consideration are: "+a(l));var u=l.filter(function(e){return 1==o(e)}),d=l.filter(function(e){return 0==o(e)});return u.forEach(function(o){var a=i._engagementCheckRules(o,e,t,n);a&&r.push({engagement:o,rule:a})}),d.forEach(function(e){n.push("Engagement: "+e.id+" - always available"),r.push({engagement:e,rule:null})}),n.push("Considered engagements length after remaining is "+r.length),r.length>0?(n.push("Considered engagements are: "+a(r.map(function(e){return e.engagement}))),{selectedEngagement:r[0].engagement,selectedRule:r[0].rule,selectionLog:n}):{selectedEngagement:null,selectedRule:null,selectionLog:n}},_engagementRules:function(e){return"offerrule"in e&&("string"==typeof e.offerrule&&e.offerrule.length>0||Array.isArray(e.offerrule))?e.offerrule:"engagementrule"in e&&("string"==typeof e.engagementrule&&e.engagementrule.length>0||Array.isArray(e.engagementrule))?e.engagementrule:null},_engagementCheckRules:function(e,t,i,r){var n=this._engagementRules(e);return(n=Array.isArray(n)?n:[{name:e.id+"-rule1",metadata:{},rule:n}]).reduce(function(n,o){var a=_MetricalUtils.evaluateRule(o.rule,t,i);return r.push("Engagement: "+e.id+" - "+_MetricalUtils.ruleCriteriaString(o.rule,t,i)),null===n&&1==a&&(n=o),n},null)},_isUnderGlobalLimit:function(e){var t=this.properties.globalofferlimit;return!("total"in e&&null!==t&&e.total>=t)},_offerIsUnderLimit:function(e,t){var i=!0;"offers"in t&&e.id in t.offers&&"offerlimit"in e&&((t.offers[e.id].total||0)>=e.offerlimit&&(i=!1));return i},doNotPresentEngagement:function(){this.offerRecord.presentation="not presented",this.offerRecord.presentation_timestamp=(new Date).toISOString()},presentEngagement:function(){var e=this,t=e._engagementDelay(),i=function(){var t=e._updateOfferLimits(e.currentOfferLimits());e.da.saveOfferLimits(t),e.isVisible=!0,e.offerRecord.offer_is_visible=!0,e.offerRecord.presentation="presented",e.offerRecord.presentation_timestamp=(new Date).toISOString(),e.offerRecord.offer_is_visible=!0,e.saveStateAndSync("po"),e.publish("OFFER-PRESENTED")};return setTimeout(function(){if("function"!=typeof e.engagementFunction)throw new Error("The engagementFunction was not set to be a valid function");e.engagementFunction(e.offerRecord.engagement_selected,i)},1e3*t),!0},_engagementDelay:function(){var e=0;return this.offerRecord.engagement_selected&&"delay"in this.offerRecord.engagement_selected&&(e=this.offerRecord.engagement_selected.delay||0),e},_updateOfferLimits:function(e){if(e.total++,this.properties.globalofferlimittimeout>0&&null===e.resetOn){var t=(new Date).getTime();t+=1e3*this.properties.globalofferlimittimeout,e.resetOn=t}if(null!==this.offerRecord.engagement_selected){var i=this.offerRecord.engagement_selected.id,r="offerlimittimeout"in this.offerRecord.engagement_selected?this.offerRecord.engagement_selected.offerlimittimeout:null;if(i in e.offers||(e.offers[i]={total:0,resetOn:null}),e.offers[i].total++,r>0&&null===e.offers[i].resetOn){t=(new Date).getTime();t+=1e3*r,e.offers[i].resetOn=t}}return e},dismissed:function(e){this.response("dismissed")},submitted:function(e){this.response("submitted")},expired:function(){this.response("timer expired")},response:function(e){return this.logger.traceStart("response"),this.logger.debug({status:e}),-1===this.validResponses.indexOf(e)?(this.logger.warning(e+" is an invalid offer flow status",{status:e}),!1):null===this.offerRecord.response||"dismissed"==this.offerRecord.response&&"dismissed"!==e||"timer expired"==this.offerRecord.response&&"submitted"===e?(this.logger.info("Session responded with status "+e,{terminal:!0,status:e}),this.offerRecord.response_timestamp=(new Date).toISOString(),this.offerRecord.response=e,this.publish("CUSTOMER-RESPONDED"),this.closeOffer(),!0):(this.logger.warning("Skipping for status "+e,{status:e}),void this.logger.traceEnd("response"))},addTag:function(e){if("offerRecord"in this){this.definedTags=Object.assign({},this.definedTags,e||{});var t=this.offerRecord.tags,i=Object.assign({},t,this.definedTags);this.offerRecord.tags=i,this.saveStateAndSync()}else this.queuedTags=Object.assign({},this.queuedTags,e||{})}};var _MetricalACInteractions={apiendpoint:_MetricalHosts.endpoints.interaction,interactionsSourceID:"InteractionsModule",captureinteractions:!1,captureallinteractions:!1,capturescrollinteractions:!1,norecordonsubmitifempty:!1,capturescrollinteractionsthreshold:0,interactions:[],interactionsHandlers:[],interactionsObserver:null,interactionsIframeHandlers:[],interactionsIframeObservers:{},postRecordAction:null,scrollThresholdReachedTimes:0,scrollInteractionsRecordingLimit:2,originalDocumentHeight:0,intProcessedTimestamps:{},limitInteractionsProcessingRate:!0,recordInteractionCallback:null,recordInteractionObservers:[],observersCalled:[],interactionModificationCallback:void 0,customEventsList:["element closed","element opened","text changed","attribute changed","elements added","elements removed"],getBasicInteractionData:function(){return uuid=this.Util.makeUUID(),{uuid:uuid,survey_id:this.interactionsSourceID}},getInteractionData:function(){return{}},init:function(e,t,i,r,n){if(jqInt=e,_MetricalACInteractions.Log.info("Initializing the _MetricalACInteractions module"),null!=t.apiendpoint&&(this.apiendpoint=t.apiendpoint),null!=t.captureinteractions&&(this.captureinteractions=t.captureinteractions),null!=t.captureallinteractions&&(this.captureallinteractions=t.captureallinteractions),null!=t.capturescrollinteractions&&(this.capturescrollinteractions=t.capturescrollinteractions),null!=t.limitinteractionsprocessingrate&&(this.limitInteractionsProcessingRate=t.limitinteractionsprocessingrate),null!=t.norecordonsubmitifempty&&(this.norecordonsubmitifempty=t.norecordonsubmitifempty),null!=t.interactionModificationCallback&&(this.interactionModificationCallback=t.interactionModificationCallback),null!=t.capturescrollinteractionsthreshold&&(this.capturescrollinteractionsthreshold=t.capturescrollinteractionsthreshold,Array.isArray(this.capturescrollinteractionsthreshold))){this.scrollThresholdReachedTimes={};for(var o=0;o<this.capturescrollinteractionsthreshold.length;o++)this.scrollThresholdReachedTimes[100*this.capturescrollinteractionsthreshold[o]+"%"]=0}if(null!=t.interactions&&(this.interactions=this.interactions.concat(t.interactions)),i&&"function"==typeof i&&(this.getInteractionData=i),r&&"function"==typeof r&&(this.postRecordAction=r),1==_MetricalACInteractions.captureinteractions&&1==_MetricalACInteractions.captureallinteractions){null!=n&&"function"==typeof n&&(this.recordInteractionCallback=n);try{this.setupInteractions(),this.setupIframeInteractions(),this.setupLoadUnloadInteractions(),this.setupScrollInteractions(),this.processURLInteractions()}catch(e){console.log("Skipping custom interactions, due to error %s",e)}}else _MetricalACInteractions.Log.info("Did not set up the interactions capture, since captureinteractions or captureallinteractions is/are set to false");_MetricalACInteractions.Log.info("Finished the initialization of the _MetricalACInteractions module",this)},setupLoadUnloadInteractions:function(){this.recordInteraction("",null,!0,!1)},relinkBasicInteractions:function(){jqInt.each(_MetricalACInteractions.interactions,function(e,t){if(jqInt(t.selector).length>0&&!_MetricalACInteractions.isCustomEvent(t.event)){var i=t.event+".Metrical";jqInt(t.selector).off(i),customHandler=jqInt(t.selector).on(i,null,null,function(e){void 0!==e.originalEvent&&_MetricalACInteractions.processInteraction(t,e)})}})},setupInteractions:function(){jqInt.each(_MetricalACInteractions.interactions,function(key,interaction){if(!_MetricalACInteractions.isInteractionAlreadyRegistered(interaction)){var interactionEventHandler=function(e){void 0!==e.originalEvent&&_MetricalACInteractions.processInteraction(interaction,e)},customEventInteractionEventHandler=function(event){switch(interaction.event){case"element closed":recordInteraction=_MetricalACInteractions.isElementClosedInteraction(event),fieldKey=interaction.fieldkey,fieldVal=eval(interaction.fieldeval);break;case"element opened":recordInteraction=_MetricalACInteractions.isElementOpenedInteraction(event),fieldKey=interaction.fieldkey,fieldVal=eval(interaction.fieldeval);break;case"text changed":recordInteraction=!0,fieldKey=interaction.fieldkey?interaction.fieldkey:"text_changed",fieldValString=interaction.fieldeval?interaction.fieldeval:"event[0].target.textContent",fieldVal=eval(fieldValString);break;case"attribute changed":recordInteraction=_MetricalACInteractions.isAttributeChangedInteraction(event,interaction.observedattributes),fieldKey=interaction.fieldkey?interaction.fieldkey:"attribute_changed",fieldValString=interaction.fieldeval?interaction.fieldeval:"event[0].attributeName",fieldVal=eval(fieldValString);break;case"elements added":recordInteraction=_MetricalACInteractions.isElementsAddedInteraction(event),fieldKey=interaction.fieldkey?interaction.fieldkey:"elements_added",fieldValString=interaction.fieldeval?interaction.fieldeval:"JSON.stringify(event[0].addedNodes)",fieldVal=eval(fieldValString);break;case"elements removed":recordInteraction=_MetricalACInteractions.isElementsRemovedInteraction(event),fieldKey=interaction.fieldkey?interaction.fieldkey:"elements_removed",fieldValString=interaction.fieldeval?interaction.fieldeval:"JSON.stringify(event[0].removedNodes)",fieldVal=eval(fieldValString);break;default:recordInteraction=!1,fieldKey=interaction.fieldkey,fieldVal=eval(interaction.fieldeval)}recordInteraction&&_MetricalACInteractions.processInteraction(interaction,event,fieldKey,fieldVal)};if(jqInt(interaction.selector).length>0)if(_MetricalACInteractions.Log.info("Registering the event handler for the custom interaction",interaction),_MetricalACInteractions.isCustomEvent(interaction.event))jqInt.each(jqInt(interaction.selector),function(e,t){_MetricalACInteractions.Log.info("Registering an observer for '"+interaction.event+"' interactions on the element",t),elementObserver=new MutationObserver(customEventInteractionEventHandler),elementObserver.observe(t,_MetricalACInteractions.getObserverConfigForCustomEvent(interaction.event))}),_MetricalACInteractions.interactionsHandlers.push({selector:interaction.selector,event:interaction.event,handlerFunction:customEventInteractionEventHandler});else{var eventNamespace=interaction.event+".Metrical";jqInt(interaction.selector).off(eventNamespace,null,null,interactionEventHandler),customHandler=jqInt(interaction.selector).on(eventNamespace,null,null,interactionEventHandler),_MetricalACInteractions.interactionsHandlers.push({selector:interaction.selector,event:interaction.event,handlerFunction:interactionEventHandler})}}}),null==_MetricalACInteractions.interactionsObserver&&(_MetricalACInteractions.Log.info("Setting up an observer for the elements with interactions"),_MetricalACInteractions.interactionsObserver=new MutationObserver(_MetricalACInteractions.setupInteractions),_MetricalACInteractions.interactionsObserver.observe(document.documentElement,{childList:!0,subtree:!0}))},checkInteractionProcessingLimit:function(e){var t=!1;if(this.limitInteractionsProcessingRate){var i=e.selector.replace(/ /g,"_")+"_"+e.event.replace(/ /g,"_"),r=+new Date;null==_MetricalACInteractions.intProcessedTimestamps[i]&&(_MetricalACInteractions.intProcessedTimestamps[i]=r);var n=r-_MetricalACInteractions.intProcessedTimestamps[i],o=!0;if("element opened"==e.event||"element closed"==e.event){var a="element opened"==e.event?"element_closed":"element_opened",s=e.selector.replace(/ /g,"_")+"_"+a;if(null!=_MetricalACInteractions.intProcessedTimestamps[s])r-_MetricalACInteractions.intProcessedTimestamps[s]<1e3&&(o=!1);else _MetricalACInteractions.intProcessedTimestamps[s]=r;_MetricalACInteractions.intProcessedTimestamps[i]>_MetricalACInteractions.intProcessedTimestamps[s]&&(o=!1)}(0==n||n>=1e3)&&o&&(_MetricalACInteractions.intProcessedTimestamps[i]=+new Date,t=!0)}else t=!0;return t},processInteraction:function(interaction,event,fieldKey,fieldVal){if(_MetricalACInteractions.checkInteractionProcessingLimit(interaction)){targetToRecord=null,null!=interaction.recordtarget&&1==interaction.recordtarget&&(null==fieldKey&&(fieldKey=interaction.fieldkey),null==fieldVal&&(fieldVal=eval(interaction.fieldeval)),targetToRecord={field_key:fieldKey,target:fieldVal}),null!=interaction.chainedinteraction&&"before"==interaction.chainedinteraction.chainorder&&_MetricalACInteractions.processInteraction(_MetricalACInteractions.interactions[interaction.chainedinteraction.interactionindex],event);var isAsync="isasync"in interaction?interaction.isasync:void 0;_MetricalACInteractions.recordInteraction(interaction.action,targetToRecord,isAsync),null!=interaction.chainedinteraction&&"after"==interaction.chainedinteraction.chainorder&&_MetricalACInteractions.processInteraction(_MetricalACInteractions.interactions[interaction.chainedinteraction.interactionindex],event)}},indicatorNotPresent:function(e){return 1!=jqInt(e).data("_MetricalInteractionIsSet")},isCustomEvent:function(e){return this.customEventsList.indexOf(e)>-1},getObserverConfigForCustomEvent:function(e){switch(e){case"element closed":case"element opened":config={attributes:!0,subtree:!1,childList:!1,characterData:!1};break;case"text changed":config={attributes:!1,subtree:!0,childList:!1,characterData:!0};break;case"attribute changed":config={attributes:!0,subtree:!1,childList:!1,characterData:!1};break;case"elements added":case"elements removed":config={attributes:!1,subtree:!1,childList:!0,characterData:!1};break;default:config={subtree:!0,childList:!0}}return config},isElementClosedInteraction:function(e){return elementClosedInteractionPerformed=!1,element=e[0].target,"none"!=element.style.display&&"0px"!=element.style.width&&"hidden"!=element.style.visibility||(elementClosedInteractionPerformed=!0),elementClosedInteractionPerformed},isElementOpenedInteraction:function(e){return elementOpenedInteractionPerformed=!1,element=e[0].target,"none"!=element.style.display&&"0px"!=element.style.width&&"hidden"!=element.style.visibility&&(elementOpenedInteractionPerformed=!0),elementOpenedInteractionPerformed},isAttributeChangedInteraction:function(e,t){return attributeChangedInteractionPerformed=!1,t.indexOf(e[0].attributeName)>-1&&(attributeChangedInteractionPerformed=!0),attributeChangedInteractionPerformed},isElementsAddedInteraction:function(e){elementsAddedInteractionPerformed=!1;for(var t=0;t<e.length;t++)if(e[t].addedNodes.length>0){elementsAddedInteractionPerformed=!0;break}return elementsAddedInteractionPerformed},isElementsRemovedInteraction:function(e){elementsRemovedInteractionPerformed=!1;for(var t=0;t<e.length;t++)if(e[t].removedNodes.length>0){elementsRemovedInteractionPerformed=!0;break}return elementsRemovedInteractionPerformed},processURLInteractions:function(){jqInt.each(_MetricalACInteractions.interactions,function(e,t){"url"==t.event&&(patt=new RegExp(t.urlmatch),urlMatches=patt.test(window.location.href),urlMatches&&_MetricalACInteractions.processInteraction(t,null,null!=t.fieldkey?t.fieldkey:"",_MetricalACInteractions.Util.getURLParameterByName(t.urlparameter,window.location.href)))})},isInteractionAlreadyRegistered:function(e){for(var t=0;t<_MetricalACInteractions.interactionsHandlers.length;t++)if(rInteraction=_MetricalACInteractions.interactionsHandlers[t],e.selector==rInteraction.selector&&e.event==rInteraction.event)return!0;return!1},setupIframeInteractions:function(){null!=jqInt("iframe")&&jqInt("iframe").on("load",null,null,function(){_MetricalACInteractions.Log.info("Iframe loaded. Configuring the custom interactions...",this);var e=this.src;if(_MetricalACInteractions.isSameOrigin(e)){var t=this.contentWindow.document,i=this.contentWindow;null!=_MetricalACInteractions.interactionsIframeObservers[e]&&_MetricalACInteractions.interactionsIframeObservers[e].disconnect(),observer=new MutationObserver(function(){jqInt.each(_MetricalACInteractions.interactions,function(r,n){var o=function(e){void 0!==e.originalEvent&&_MetricalACInteractions.processInteraction(n,e,n.fieldkey,i.eval(n.fieldeval))},a=function(e){switch(n.event){case"element closed":recordInteraction=_MetricalACInteractions.isElementClosedInteraction(e),fieldKey=n.fieldkey,fieldVal=i.eval(n.fieldeval);break;case"element opened":recordInteraction=_MetricalACInteractions.isElementOpenedInteraction(e),fieldKey=n.fieldkey,fieldVal=i.eval(n.fieldeval);break;case"text changed":recordInteraction=!0,fieldKey=n.fieldkey?n.fieldkey:"text_changed",fieldValString=n.fieldeval?n.fieldeval:"event[0].target.textContent",fieldVal=i.eval(fieldValString);break;case"attribute changed":recordInteraction=_MetricalACInteractions.isAttributeChangedInteraction(e,n.observedattributes),fieldKey=n.fieldkey?n.fieldkey:"attribute_changed",fieldValString=n.fieldeval?n.fieldeval:"event[0].attributeName",fieldVal=i.eval(fieldValString);break;case"elements added":recordInteraction=_MetricalACInteractions.isElementsAddedInteraction(e),fieldKey=n.fieldkey?n.fieldkey:"elements_added",fieldValString=n.fieldeval?n.fieldeval:"JSON.stringify(event[0].addedNodes)",fieldVal=i.eval(fieldValString);break;case"elements removed":recordInteraction=_MetricalACInteractions.isElementsRemovedInteraction(e),fieldKey=n.fieldkey?n.fieldkey:"elements_removed",fieldValString=n.fieldeval?n.fieldeval:"JSON.stringify(event[0].removedNodes)",fieldVal=i.eval(fieldValString);break;default:recordInteraction=!1,fieldKeyValue=n.fieldkey,fieldVal=i.eval(n.fieldeval)}recordInteraction&&_MetricalACInteractions.processInteraction(n,e,fieldKey,fieldVal)};_MetricalACInteractions.isCustomInteractionIframeAlreadyRegistered(e,n)&&jqInt(n.selector,t).unbind(n.event),jqInt(n.selector,t).length>0&&(_MetricalACInteractions.Log.info("Registering the event handler for the custom interaction on the iframe",n),_MetricalACInteractions.isCustomEvent(n.event)?(jqInt.each(jqInt(n.selector),function(e,t){_MetricalACInteractions.Log.info("Registering an observer for '"+n.event+"' interactions on the iframe on the element",t),elementObserver=new MutationObserver(a),elementObserver.observe(t,_MetricalACInteractions.getObserverConfigForCustomEvent(n.event))}),_MetricalACInteractions.interactionsIframeHandlers.push({ifrSrc:e,selector:n.selector,event:n.event,handlerFunction:a})):(jqInt(n.selector,t).off(n.event,null,null,o),customHandler=jqInt(n.selector,t).on(n.event,null,null,o),_MetricalACInteractions.interactionsIframeHandlers.push({ifrSrc:e,selector:n.selector,event:n.event,handlerFunction:o})))}),_MetricalACInteractions.Log.info("Ending custom interactions iframe setup")}),observer.observe(t.documentElement,{childList:!0,subtree:!0}),_MetricalACInteractions.interactionsIframeObservers[e]=observer}})},isCustomInteractionIframeAlreadyRegistered:function(e,t){for(var i=0;i<_MetricalACInteractions.interactionsIframeHandlers.length;i++)if(rInteraction=_MetricalACInteractions.interactionsIframeHandlers[i],t.selector==rInteraction.selector&&t.event==rInteraction.event&&e==rInteraction.ifrSrc)return!0;return!1},setupScrollInteractions:function(){this.originalDocumentHeight=jqInt(document).height();var e,t=jqInt(window),i=(t.scrollTop(),this);1==this.capturescrollinteractions?(scrollHandler=function(){i.originalDocumentHeight==t.height()&&(i.originalDocumentHeight=jqInt(document).height());var r=100*t.scrollTop()/(i.originalDocumentHeight-t.height());if(!isNaN(r)&&isFinite(r)&&(scrollThresholdData=i.getScrollThresholdReached(r),(null==scrollThresholdData.thresholdReached||scrollThresholdData.thresholdReached)&&scrollThresholdData.recordInteraction)){r=r.toFixed()+"%";var n=t.scrollTop();e&&clearTimeout(e),e=setTimeout(function(){i.shouldScrollInteractionBeRecorded(scrollThresholdData)&&(percent=null!=scrollThresholdData.thresholdReached?scrollThresholdData.thresholdReached:r,_MetricalACInteractions.recordInteraction("scroll to "+percent,null,!0))},1e3),n}},t.off("scroll",scrollHandler),t.on("scroll",scrollHandler)):_MetricalACInteractions.Log.info("Did not set up the scroll interactions capture, since capturescrollinteractions is set to false")},getScrollThresholdReached:function(e){if(thresholdData={recordInteraction:!1,thresholdReached:null},Array.isArray(this.capturescrollinteractionsthreshold))for(var t=0;t<this.capturescrollinteractionsthreshold.length;t++){if(null!=this.capturescrollinteractionsthreshold[t+1]&&e>100*this.capturescrollinteractionsthreshold[t]&&e<=100*this.capturescrollinteractionsthreshold[t+1]){thresholdData.thresholdReached=100*this.capturescrollinteractionsthreshold[t]+"%",thresholdData.recordInteraction=!0;break}if(null==this.capturescrollinteractionsthreshold[t+1]&&e>100*this.capturescrollinteractionsthreshold[t]){thresholdData.thresholdReached=100*this.capturescrollinteractionsthreshold[t]+"%",thresholdData.recordInteraction=!0;break}}else 0==this.capturescrollinteractionsthreshold?thresholdData.recordInteraction=!0:e>=100*this.capturescrollinteractionsthreshold&&(thresholdData.thresholdReached=100*this.capturescrollinteractionsthreshold+"%",thresholdData.recordInteraction=!0);return thresholdData},shouldScrollInteractionBeRecorded:function(e){return shouldBeRecorded=!1,e.recordInteraction&&(thresholdReached=e.thresholdReached,null==thresholdReached&&(shouldBeRecorded=!0),null!=thresholdReached&&Number.isInteger(this.scrollThresholdReachedTimes)&&this.scrollThresholdReachedTimes<this.scrollInteractionsRecordingLimit&&(shouldBeRecorded=!0,this.scrollThresholdReachedTimes++),null!=thresholdReached&&"object"==typeof this.scrollThresholdReachedTimes&&this.scrollThresholdReachedTimes[thresholdReached]<this.scrollInteractionsRecordingLimit&&(shouldBeRecorded=!0,this.scrollThresholdReachedTimes[thresholdReached]++)),shouldBeRecorded},isIframeOnSameDomain:function(e){return ifrDomain=this.extractHostname(e),currentDomain=this.extractHostname(window.location.href),ifrDomain==currentDomain},isSameOrigin:function(e){var t=window.location.protocol+"//"+window.location.hostname;return 0==e.split("?")[0].indexOf(t)},extractHostname:function(e){return(e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]).split(":")[0].split("?")[0]},extractRootDomain:function(e){var t=this.extractHostname(e),i=t.split("."),r=i.length;return r>2&&(t=i[r-2]+"."+i[r-1],2==i[r-1].length&&2==i[r-1].length&&(t=i[r-3]+"."+t)),t},registerRecordInteractionObserver:function(e,t){0==this.recordInteractionObservers.map(function(e){return e.key}).includes(e)&&this.recordInteractionObservers.push({key:e,callback:t})},recordInteraction:function(e,t,i,r){if(this.captureinteractions){var n=this;n.observersCalled=[],i=void 0===i||i,r=void 0===r||r;var o=function(t){for(var o in t.usermeta)void 0===t.usermeta[o]&&(t.usermeta[o]=null);if("heartbeat"==t.action){var a=_MetricalStorage.SessionStorage.getItem("lastUserMeta");if(_MetricalUtils.isEqual(t.usermeta,a))return}_MetricalStorage.SessionStorage.setItem("lastUserMeta",t.usermeta),jqInt.ajax({type:"POST",dataType:"json",data:t,traditional:!1,async:i,url:n.apiendpoint,success:function(t){jqInt("body")&&(jqInt("#metrical_interaction").remove(),jqInt("body").append("<input type='hidden' id='metrical_interaction' name='metrical_interaction_"+e.split(" ").join("_")+"' value='succeed'>"))},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}});for(var s=0;s<n.recordInteractionObservers.length;s++){var c=n.recordInteractionObservers[s];"function"==typeof c.callback&&c.callback(t)}null!=n.postRecordAction&&r&&n.postRecordAction(e),"function"==typeof n.recordInteractionCallback&&n.recordInteractionCallback(t)};if("assign"in Object==0?interactionData=jqInt.extend(this.getBasicInteractionData(),this.getInteractionData()):interactionData=Object.assign(this.getBasicInteractionData(),this.getInteractionData()),interactionData.action=e,null!=t&&(interactionData[t.field_key]=t.target),"function"==typeof this.interactionModificationCallback)this.interactionModificationCallback(jqInt,interactionData,o,i);else o(interactionData)}else _MetricalACInteractions.Log.info("Interactions capture disabled")},Log:{logs:new Array,buffer:!0,info:function(){var e=Array.prototype.slice.call(arguments);jqInt.each(e,function(e,t){});var t={type:"info",timestamp:this.timeStamp(),echoed:!1,data:e};this.logs.push(t),this.buffer||this.echo()},error:function(){var e=Array.prototype.slice.call(arguments);jqInt.each(e,function(e,t){});var t={type:"error",timestamp:this.timeStamp(),echoed:!1,data:e};this.logs.push(t),this.buffer||this.echo()},echo:function(){var e=this;return window.console&&jqInt.each(this.logs,function(t,i){i.echoed||(e.printOutData(i),i.echoed=!0)}),"End of logs"},echoAll:function(){var e=this;return window.console&&jqInt.each(this.logs,function(t,i){e.printOutData(i)}),"End of logs"},printOutData:function(e){"info"==e.type?console.info(e.timestamp+": ",e.data):"error"==e.type&&jqInt.each(e.data,function(t,i){i instanceof Error?console.error(e.timestamp+" - "+i.name+" - "+i.message+": ",i.stack):console.error(e.timestamp+": ",i)})},timeStamp:function(){var e=new Date,t=[e.getMonth()+1,e.getDate(),e.getFullYear()],i=[e.getHours(),e.getMinutes(),e.getSeconds()],r=i[0]<12?"AM":"PM";i[0]=i[0]<12?i[0]:i[0]-12,i[0]=i[0]||12;for(var n=1;n<3;n++)i[n]<10&&(i[n]="0"+i[n]);return t.join("/")+" "+i.join(":")+" "+r}},Util:{makeUUID:function(){var e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:7&i|8).toString(16)})},identifierIsIOS:function(){return!!/iPhone|iPad|iPod/i.test(navigator.userAgent)},getURLParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}}},jqInt=null;_MetricalHeartBeat={init:function(e){if(this.properties=Object.assign({},{actionLabel:"heartbeat",interactions:null},e||{}),this.interactions=this.properties.interactions,null===this.interactions)throw new Error("interactions needs to be defined for heartbeat")},beat:function(e){e&&this.interactions.recordInteraction(this.properties.actionLabel)}},_MetricalIdle={init:function(e){if(this.properties=Object.assign({},{actionLabel:"idle",interactions:null},e||{}),this.interactions=this.properties.interactions,null===this.interactions)throw new Error("interactions needs to be defined for heartbeat");this.noInteractionFirstCheck=!1,this.noInteractionSecondCheck=!1},beat:function(e){e?(this.noInteractionFirstCheck=!1,this.noInteractionSecondCheck=!1):0==this.noInteractionFirstCheck&&0==this.noInteractionSecondCheck?this.noInteractionFirstCheck=!0:1==this.noInteractionFirstCheck&&0==this.noInteractionSecondCheck&&(this.noInteractionSecondCheck=!0,this.interactions.recordInteraction(this.properties.actionLabel))},isIdle:function(){return this.noInteractionFirstCheck&&this.noInteractionSecondCheck}};var _MetricalIdentity={pubsub:new _MetricalUtils.PubSub,pubsubTopics:{"reset-session-id":"reset-session-id"},Cookie:null,Storage:null,Util:null,instanceId:null,init:function(e,t,i){this.Cookie=e,this.Storage=t,this.Util=i,this.initializeInstanceId(),this.initializeDeviceId(),this.initializeSessionId()},initializeInstanceId:function(){this.instanceId=this.Util.makeUUID()},initializeDeviceId:function(){if(this.Cookie.hasItem(this.Cookie.cookieNameDid))null==this.Storage.getItem(this.Cookie.cookieNameDid)&&this.Storage.setItem(this.Cookie.cookieNameDid,this.Cookie.getItem(this.Cookie.cookieNameDid));else{var e=new Date;if(e.setTime(e.getTime()+15768e7),null!=this.Storage.getItem(this.Cookie.cookieNameDid))this.Cookie.setItem(this.Cookie.cookieNameDid,this.Storage.getItem(this.Cookie.cookieNameDid),e,this.Cookie.path,this.Cookie.rootDomain());else{var t=this.Util.makeUUID();this.Cookie.setItem(this.Cookie.cookieNameDid,t,e,this.Cookie.path,this.Cookie.rootDomain()),this.Storage.setItem(this.Cookie.cookieNameDid,t)}}},initializeSessionId:function(){this.Cookie.hasItem(this.Cookie.cookieNameSession)||this.resetSessionId()},resetSessionId:function(){var e=this.Util.makeUUID();this.Cookie.setItem(this.Cookie.cookieNameSession,e,"",this.Cookie.path,this.Cookie.rootDomain()),this.pubsub.publish(this.pubsubTopics["reset-session-id"],{sessionId:e})},getSessionId:function(){return this.Cookie.getItem(this.Cookie.cookieNameSession)},getDeviceId:function(){return this.Cookie.getItem(this.Cookie.cookieNameDid)},getInstanceId:function(){return this.instanceId},getLastTimestamp:function(){return this.Cookie.getItem("_Metrical_lastTimestamp")},setLastTimestamp:function(){this.Cookie.setItem("_Metrical_lastTimestamp",Date.now(),"",this.Cookie.path,this.Cookie.rootDomain())}},_MetricalAssetLoader={assets:[],assetItems:[],assetsJSON:[],assetsFailed:[],loadSuccessCallback:function(){console.log("Default success callback")},loadFailedCallback:function(){console.log("The loading of one or more assets failed",_MetricalAssetLoader.assetsFailed)},init:function(jQuery,properties,successCallback,failCallback){jqAL=jQuery,assetItems=[],assetJSON=[],assetFailed=[],null!=successCallback&&(this.loadSuccessCallback=successCallback),null!=failCallback&&(this.loadFailedCallback=failCallback),jqAL.each(properties.assets,function(key,asset){addAsset=!0,null!=asset.filter&&""!=asset.filter&&(res=eval(asset.filter),res||(addAsset=!1)),addAsset&&_MetricalAssetLoader.addAssetItem(asset)})},addAssetItem:function(e){var t=this;if("undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]"))var i=function(e){var i=e;return new Promise(function(e,r){t.loadAsset(i,null,e,r)})};else i=function(e){var i=e;return jqAL.Deferred(function(e){t.loadAsset(i,e,null,null)})};this.assetItems.push(i(e))},exec:function(){if("undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]"))Promise.all(this.assetItems).then(this.loadSuccessCallback,this.loadFailedCallback);else{var e=this;jqAL.when(this.assetItems).done(function(){e.loadSuccessCallback()}).fail(function(){e.loadFailedCallback()})}},loadAsset:function(e,t,i,r){if(_MetricalAbandonCart.Log.info("Loading asset ",e),"json"==e.type)jqAL.ajax({crossDomain:!0,type:"GET",dataType:"json",traditional:!1,url:e.url,data:null,success:function(r){_MetricalAssetLoader.assetsJSON.push(r);var n=document.createElement("script");n.type="application/json";try{n.appendChild(document.createTextNode(JSON.stringify(r))),document.body&&document.body.appendChild(n)}catch(e){n.text=JSON.stringify(r),document.body&&document.body.appendChild(n)}null!=t?t.resolve(e.url):i(e.url)},error:function(i,n,o){_MetricalAssetLoader.assetsFailed.push({url:e.url,status:n}),null!=t?t.reject(e.url):r(e.url)}});else{switch(e.type){case"js":tag="script";break;case"css":tag="link";break;case"img":tag="img";break;case"font":tag="link";break;default:tag="link"}var n=document.createElement(tag),o="body",a="src";switch(n.onload=function(){try{(e.type=document[o])&&document[o].removeChild(n),null!=t?t.resolve(e.url):i(e.url)}catch(e){console.error(e)}},n.onerror=function(){_MetricalAssetLoader.assetsFailed.push({url:e.url,status:status}),null!=t?t.reject(e.url):r(e.url)},e.type){case"js":n.async=!0;break;case"css":n.type="text/css",n.rel="stylesheet",a="href",o="head";break;case"font":n.type="font/otf",n.rel="prefetch",n.as="font",a="href",o="head",crossorigin="anonymous";break;case"img":n.alt=e.alt?e.alt:"",n.style=e.style?e.style:""}n[a]=e.url,document[o]&&document[o].appendChild(n)}},assetExists:function(e){var t=new XMLHttpRequest;return t.open("HEAD",e,!1),t.setRequestHeader("Access-Control-Allow-Origin","*"),t.withCredentials=!1,t.send(),404!=t.status}},jqAL=null,_MetricalBrowserHistory={key:"urlHistory",history:[],init:function(){var e=window.location.href;this.history=this.getHistoryFromStorage(),this.history.unshift(e),this.saveHistoryToStorage()},storageHasKey:function(){for(var e=!1,t=this.key,i=0;i<window.sessionStorage.length;i++)window.sessionStorage.key(i)==t&&(e=!0);return e},getHistoryFromStorage:function(){var e=[];return this.storageHasKey()&&(e=JSON.parse(window.sessionStorage.getItem(this.key))),e},saveHistoryToStorage:function(){window.sessionStorage.setItem(this.key,JSON.stringify(this.history))},getCurrentUrl:function(){return this.history.length>0?this.history[0]:null},getLastUrl:function(){return this.history.length>1?this.history[1]:null}};_MetricalPE={jQueryPE:null,ac:null,log:null,identity:null,endpoint:null,socket:null,testSocket:null,registrations:0,overrides:{},init:function(e){try{for(var t in this.jQueryPE=e.jQuery,this.ac=e.ac,this.log=e.log,this.identity=e.identity,this.endpoint=e.endpoint,this.conditions=e.conditions,this.utils=_MetricalUtils,this.pubsub=new _MetricalUtils.PubSub,this.pubsub)this[t]=this.pubsub[t]}catch(e){this.log.error(e)}},shouldRun:function(){var e=this;return new Promise(function(t,i){try{var r=e._getStartRule(),n=e._getEndRule();r&&n?Promise.all([e._evalRule(r),e._evalRule(n)]).then(function(e){1==e[0]&&0==e[1]?t(!0):t(!1)}).catch(function(e){throw e}):r&&!n?e._evalRule(r).then(function(e){t(1==e)}).catch(function(e){throw e}):!r&&n?e._evalRule(n).then(function(e){t(0==e)}).catch(function(e){throw e}):t(!0)}catch(e){i(e)}})},_getStartRule:function(){return"Config"in this.ac&&"probabilityengine"in this.ac.Config&&"startrule"in this.ac.Config.probabilityengine?this.ac.Config.probabilityengine.startrule:null},_getEndRule:function(){return"Config"in this.ac&&"probabilityengine"in this.ac.Config&&"endrule"in this.ac.Config.probabilityengine?this.ac.Config.probabilityengine.endrule:null},_evalRule:function(ruleObj){var that=this;return new Promise(function(resolve,reject){try{var type=ruleObj.type||"eval",rule=ruleObj.rule||"";if(""==rule&&resolve(!1),"condition"==type)that.conditions.evaluateConditions().then(function(e){var t=that.utils.evaluateRule(rule,e,{});resolve(t)}).catch(function(e){throw e});else{var value=eval(rule);resolve(value)}}catch(e){reject(e)}})},sendInteractionData:function(e){var t=this,i="peoverrides";this.overrides=_MetricalStorage.Cookie.hasItem(i)&&"object"==typeof _MetricalStorage.Cookie.getItem(i)?_MetricalStorage.Cookie.getItem(i):{},this.publish("pre/pe",e);try{t.jQueryPE.ajax({type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"text/plain",async:!0,url:t.endpoint,success:function(e){t.ac.abandonprobable=Object.assign({},e,t.overrides),t.publish("post/pe",t.ac.abandonprobable)},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})}catch(e){t.log.error(e)}}};var _MetricalTestMode={Cookie:null,init:function(e){this.Cookie=e},enable:function(){return this.Cookie.setItem("_Metrical_TestMode",1,"",this.Cookie.path,this.Cookie.rootDomain()),"Test Mode is enabled"},disable:function(){return this.Cookie.setItem("_Metrical_TestMode",0,"",this.Cookie.path,this.Cookie.rootDomain()),"Test Mode is disabled"},isInTestMode:function(){return"1"==this.Cookie.getItem("_Metrical_TestMode")}},_MetricalPreviousVisits={jq:null,Cookie:null,Log:null,previousVisitorEndpoint:"",previousCustomerEndpoint:"",init:function(e,t,i,r,n){this.jq=e,this.Cookie=t,this.Log=i,this.previousVisitorEndpoint=r,this.previousCustomerEndpoint=n,this.previousVisitorCookieName=null,this.previousCustomerCookieName=null},setPreviousVisit:function(e,t,i,r,n){null!=r&&null!=r||(r="v1"),null!=n&&null!=r||(n=2592e3);var o="_Metrical_"+r+"_previousVisit";if(this.previousVisitorCookieName=o,!this.Cookie.hasItem(o)){var a=this,s=this.previousVisitorEndpoint.replace("{surveyId}",e).replace("{uuid}",t).replace("{sessionId}",i);this.jq.getJSON(s,function(e){var t=e.isPreviousVisitor?1:0;a.Cookie.setItem(o,t,a.Cookie.makeExpires(n),a.Cookie.path,a.Cookie.rootDomain()),a.Log.info("Previous visit cookie set with value "+t)})}},isPreviousVisitor:function(){var e=null;null!==this.previousVisitorCookieName&&(e=1==this.Cookie.getItem(this.previousVisitorCookieName));return e},setPreviousCustomer:function(e,t,i,r,n){null!=r&&null!=r||(r="v1"),null!=n&&null!=r||(n=2592e3);var o="_Metrical_"+r+"_previousCustomer";if(this.previousCustomerCookieName=o,!this.Cookie.hasItem(o)){var a=this,s=this.previousCustomerEndpoint.replace("{surveyId}",e).replace("{uuid}",t).replace("{sessionId}",i);this.jq.getJSON(s,function(e){var t=e.isPreviousCustomer?1:0;a.Cookie.setItem(o,t,a.Cookie.makeExpires(n),a.Cookie.path,a.Cookie.rootDomain()),a.Log.info("Previous customer cookie set with value "+t)})}},isPreviousCustomer:function(){var e=null;null!==this.previousCustomerCookieName&&(e=1==this.Cookie.getItem(this.previousCustomerCookieName));return e}};_MetricalTrafficControl={init:function(e,t,i){null!=i&&(this.logger=i),this.properties=Object.assign({},{trafficcontrolrule:null,trafficcontrolpercent:null,trafficcontrolisactive:!1,trafficcontrolprefix:"v1"},e||{}),this.sampling=t,this.trafficcontrolpercent=this.properties.trafficcontrolpercent,this.trafficcontrolrule=this.properties.trafficcontrolrule,this.trafficcontrolisactive=this.properties.trafficcontrolisactive,this.trafficcontrolprefix=this.properties.trafficcontrolprefix},testType(){return this.trafficcontrolpercent?"percent":this.trafficcontrolrule?"rule":null},percentPasses(){var e=!1;if(null!==this.trafficcontrolpercent){var t=this.sampling.getTrafficControlNumber();this.logger&&this.logger.info("Traffic Control Number set on: "+t),t<=this.trafficcontrolpercent&&(e=!0)}return e},rulePasses(){var result=!1;if(null!==this.trafficcontrolrule)try{var evalResult=eval(this.trafficcontrolrule);result=!!evalResult}catch(e){console.error(e)}return result},isExecutionGranted:function(){var e=!0,t=this;this.trafficcontrolisactive&&(e=function(e){var i={percent:function(){return t.percentPasses()},rule:function(){return t.rulePasses()},default:function(){return!0}};return(i[e]||i.default)()}(this.testType()));return e}},_MetricalSampling={init:function(e,t){this.properties=Object.assign({},{groupnumberprefix:"default"},e||{}),this.da=t,this.groupnumberprefix=this.properties.groupnumberprefix,this.da.setNamespace(this.groupnumberprefix),this._getSampleRecord(),null===this.sampleRecord.group_number&&this.setGroupNumber(),null===this.sampleRecord.traffic_control_number&&this.setTrafficControlNumber()},_getSampleRecord:function(){this.sampleRecord=this.da.getSampleRecord()},_setSampleRecord:function(){return this.da.saveSampleRecord(this.sampleRecord)},_makeRandomNumber:function(){return Math.floor(100*Math.random()+1)},setGroupNumber:function(e){return this.sampleRecord.group_number=void 0!==e?e:this._makeRandomNumber(),this._setSampleRecord()},getGroupNumber:function(){return this.sampleRecord.group_number},getTrafficControlNumber:function(){return this.sampleRecord.traffic_control_number},setTrafficControlNumber:function(e){return this.sampleRecord.traffic_control_number=void 0!==e?e:this._makeRandomNumber(),this._setSampleRecord()},randomSessionNumber:function(){var e=this.da.getRandomSample();return null===e&&(e=this._makeRandomNumber(),this.da.setRandomSample(e)),e}},_MetricalSamplingDataAccess={init:function(e,t,i){this.defaultConfig={namespace:"default",useCookieOverLocal:!1},this.config=Object.assign({},this.defaultConfig,e||{}),this.namespace=this.config.namespace||"default",this.jqDA=t,this.ac=i,this.groupNumberKey="sampleRecord",this.randomSampleKey="randomSample",this.config.useCookieOverLocal?this.storageObject=_MetricalStorage.Cookie:this.storageObject=_MetricalStorage.Storage},setNamespace:function(e){this.namespace=e},getSampleRecord:function(){var e=this.namespace+"_"+this.groupNumberKey,t=this.storageObject.getItem(e);if(null===t){var i={group_number:null,traffic_control_number:null};return this.saveSampleRecord(i),i}return t},saveSampleRecord:function(e){var t=this.namespace+"_"+this.groupNumberKey;this.storageObject.setItem(t,e);return!0},getRandomSample:function(){var e=this.namespace+"_"+this.randomSampleKey;return _MetricalStorage.SessionStorage.getItem(e)},setRandomSample:function(e){var t=this.namespace+"_"+this.randomSampleKey;return _MetricalStorage.SessionStorage.setItem(t,e),!0}},_MetricalCoupon={jqCoupon:null,couponDriver:null,logger:null,init:function(e,t,i,r){t&&"function"==typeof t.logError&&(this.logger=t);try{this.jqCoupon=e}catch(e){this.logger?this.logger.logError(e):console.log(e)}r&&(this.prePostCouponHandler=r);this.properties=Object.assign({},{},i||{});try{couponDriverName="RedirectCouponDriver",this.properties.coupondriver?(couponDriverName=this.properties.coupondriver,"JavascriptDoEventCouponDriver"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties.couponeventstatement):"FetchDriver"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties):"CallBridge"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties):"iFrameCouponDriver"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties.iframeSrc,this.properties.couponFieldSelector,this.properties.submitButtonSelector,this.properties.couponCode,this.properties.postbackURL):"RedirectRunApplierCouponDriver"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties.couponurlpost,this.properties.couponcode,this.properties.applier,this.properties.urlfilter,this.properties.params||void 0):"JcpCouponDriver"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties):"AjaxGETDriverOptionalRedirect"==couponDriverName?this.couponDriver=new this[couponDriverName](this.properties):this.couponDriver=new this[couponDriverName](this.properties.couponurlpost,this.properties.couponcode,this.properties.postbackurl)):this.couponDriver=new this[couponDriverName](this.properties.couponurlpost,this.properties.couponcode,this.properties.postbackurl),this.logger&&this.logger.logInfo("setting up the coupon driver "+couponDriverName,this.couponDriver)}catch(e){this.logger&&this.logger.logError("an error occurred setting up the coupon driver "+couponDriverName+" : "+e.message,e)}},couponConfig:function(){return this.properties||{}},postCoupon:function(){var e=this.properties;this.couponDriver?e.singleusecoupon?(surveyid=_MetricalAbandonCart.Config.surveyid?_MetricalAbandonCart.Config.surveyid:_Metrical.app.properties.survey,uuid=_MetricalStorage.Cookie.hasItem("_MetricalObject_did")?_MetricalStorage.Cookie.getItem("_MetricalObject_did"):"",sessionid=_MetricalStorage.Cookie.hasItem("_MetricalObject_sessionid")?_MetricalStorage.Cookie.getItem("_MetricalObject_sessionid"):"",this.fetchSingleUseCouponCode(surveyid,e.couponcode,uuid,sessionid,function(e){e.success&&(_MetricalCoupon.couponDriver.couponCode=e.coupon,_MetricalCoupon.prePostCouponHandler&&_MetricalCoupon.prePostCouponHandler(),_MetricalCoupon.couponDriver.postCoupon())})):(this.prePostCouponHandler&&this.prePostCouponHandler(),this.couponDriver.postCoupon()):this.logger&&this.logger.logInfo("There is no coupon driver set to post the coupon")},fetchSingleUseCouponCode:function(e,t,i,r,n,o){var a={surveyId:e,couponId:t,uuid:i,sessionId:r};this.jqCoupon.ajax({type:"POST",dataType:"json",data:JSON.stringify(a),contentType:"text/plain",traditional:!1,async:!1,url:_MetricalHosts.endpoints.singleUseCoupon,success:function(e){n(e)},error:function(e,t,i){console.log(e),console.log(t),console.log(i),o&&o()}})},couponRedirect:function(){"redirect"in this.couponDriver&&this.couponDriver.redirect()},FetchDriver:function(e){if(this.localProperties=e,0==!!this.localProperties.couponoperations)throw new Error("FetchDriver expects a couponoperations parameter");if(0==Array.isArray(this.localProperties.couponoperations))throw new Error("FetchDriver expects couponoperations to be an array");this.redirect=function(e){window.location.href=e},this.postCoupon=function(){var e=this;return new Promise(function(t,i){var r=Promise.resolve(null);e.localProperties.couponoperations.reduce(function(e,t){var i=t.url,r=t.params||{method:"get"},n=t.data||null;return n&&(r.body=JSON.stringify(n)),e.then(function(){return fetch(i,r)})},r).then(function(){e.localProperties.redirecturl?(e.redirect(e.localProperties.redirecturl),t(!0)):t(!0)}).catch(function(e){console.error(e),i(e)})})}},CallBridge:function(e){this.localProperties=e,this.postCoupon=function(){var e=this;return new Promise(function(t,i){console.log(e.localProperties);var r={method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify({phone:e.localProperties.phoneNumber})};console.log(r),fetch(e.localProperties.callbackEndpoint,r).then(function(e){return e}).then(function(e){console.log("success"),console.log(e),t(e)}).catch(function(e){console.log("error"),console.error(e),i(e)})})}},RedirectCouponDriver:function(e){if(void 0===e)throw{name:"RequiredParameterMissing",message:"the couponurlpost attribute needs to be defined for this coupon driver"};this.postURL=e,this.postCoupon=function(){window.location.href=this.postURL}},EvalRedirectCouponDriver:function(postURL){this.postURL=postURL,this.postCoupon=function(){var tempUrl=eval(this.postURL);window.location.href=tempUrl}},JavascriptDoEventCouponDriver:function(couponEventStatement){if(void 0===couponEventStatement)throw{name:"RequiredParameterMissing",message:"the couponeventstatement attribute needs to be defined for this coupon driver"};this.couponEventStatement=couponEventStatement,this.postCoupon=function(){eval(this.couponEventStatement)}},MagentoCouponDriver:function(e,t,i){if(void 0===t)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};this.couponCode=t,this.postCoupon=function(){_MetricalCoupon.jqCoupon("#coupon_code").val(this.couponCode),discountForm.submit(!1)}},MagentoCouponDriverAlternative:function(e,t,i){if(void 0===e)throw{name:"RequiredParameterMissing",message:"the couponurlpost attribute needs to be defined for this coupon driver"};if(this.postURL=e,void 0===t)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};if(this.couponCode=t,void 0===i)throw{name:"RequiredParameterMissing",message:"the postbackurl attribute needs to be defined for this coupon driver"};this.postbackURL=i,this.postCoupon=function(){var e=this;_MetricalCoupon.jqCoupon.post(this.postURL,{coupon_code:this.couponCode},function(t){window.location.href=e.postbackURL})}},MonsterProductsCouponDriver:function(e,t,i){if(void 0===e)throw{name:"RequiredParameterMissing",message:"the couponurlpost attribute needs to be defined for this coupon driver"};if(this.postURL=e,void 0===t)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};if(this.couponCode=t,void 0===i)throw{name:"RequiredParameterMissing",message:"the postbackurl attribute needs to be defined for this coupon driver"};this.postbackURL=i,this.postCoupon=function(){var e=this;expSKU=_MetricalCoupon.jqCoupon("input[name='ExpSKU']").val(),postData={scriptManager:"ctl13$orderSummary$updatePanel|ctl13$orderSummary$coupon$applyCoupon2",__EVENTTARGET:"ctl13$orderSummary$coupon$applyCoupon2",__EVENTARGUMENT:"",w:"",ExpSKU:expSKU,ctl13$orderSummary$coupon$couponCode:this.couponCode,ctl13$HF_AccessToken:"",__VIEWSTATEGENERATOR:_MetricalCoupon.jqCoupon("#__VIEWSTATEGENERATOR").val(),__VIEWSTATE:_MetricalCoupon.jqCoupon("#__VIEWSTATE").val(),__ASYNCPOST:!0},postData[expSKU]=_MetricalCoupon.jqCoupon("input[name='"+expSKU+"']").val(),this.jqCoupon.post(this.postURL,postData,function(t){window.location.href=e.postbackURL})}},AjaxGETDriver:function(e,t,i){if(void 0===e)throw{name:"RequiredParameterMissing",message:"the couponurlpost attribute needs to be defined for this coupon driver"};if(this.postURL=e,void 0===t)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};if(this.couponCode=t,void 0===i)throw{name:"RequiredParameterMissing",message:"the postbackurl attribute needs to be defined for this coupon driver"};this.postbackURL=i,this.postCoupon=function(){var e=this;this.postURL=this.postURL.replace("{{couponCode}}",this.couponCode),_MetricalCoupon.jqCoupon.get(this.postURL,{},function(t){_MetricalCouponDataAccess.setC(e.couponCode),window.location.href=e.postbackURL})}},AjaxGETDriverOptionalRedirect:function(e){if(this.params=e,!("couponurlpost"in e)||"string"!=typeof e.couponurlpost)throw{name:"RequiredParameterMissing",message:"the couponurlpost attribute needs to be defined for this coupon driver"};if(!("couponcode"in e)||"string"!=typeof e.couponcode)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};if(!("postbackurl"in e)||"string"!=typeof e.postbackurl)throw{name:"RequiredParameterMissing",message:"the postbackurl attribute needs to be defined for this coupon driver"};this.forceRedirect=1==!!e.forceredirect,this.postCoupon=function(){var e=this,t=e.params.couponurlpost.replace("{{couponCode}}",e.params.couponcode);_MetricalCoupon.jqCoupon.get(t,{},function(t){_MetricalCouponDataAccess.setC(e.params.couponcode),(e.params.postbackurl!=window.location.href||e.forceRedirect)&&(window.location.href=e.params.postbackurl)})}},iFrameCouponDriver:function(e,t,i,r,n){if(void 0===e)throw{name:"RequiredParameterMissing",message:"the iframeSrc attribute needs to be defined for this coupon driver"};if(this.iframeSrc=e,void 0===t)throw{name:"RequiredParameterMissing",message:"the couponFieldSelector attribute needs to be defined for this coupon driver"};if(this.couponFieldSelector=t,void 0===i)throw{name:"RequiredParameterMissing",message:"the submitButtonSelector attribute needs to be defined for this coupon driver"};if(this.submitButtonSelector=i,void 0===r)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};if(this.couponCode=r,void 0===n)throw{name:"RequiredParameterMissing",message:"the postbackurl attribute needs to be defined for this coupon driver"};this.postbackURL=n,this.postCoupon=function(){var e=this,t=document.createElement("iframe");t.id="metrical_coupon_frame",t.onload=function(){var t=window.parent._MetricalCoupon.jqCoupon("#metrical_coupon_frame")[0].contentDocument;_MetricalCoupon.jqCoupon(e.couponFieldSelector,t).val(e.couponCode),_MetricalCoupon.jqCoupon(e.submitButtonSelector,t).click(),window.location.replace(e.postbackURL)},t.src=this.iframeSrc,t.style="display: none;",document.body.append(t)}},iFrameAjaxGetDriver:function(e,t,i){if(void 0===e)throw{name:"RequiredParameterMissing",message:"the iframeSrc attribute needs to be defined for this coupon driver"};if(this.iframeSrc=e,void 0===t)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};this.couponCode=t,this.postbackURL=i||!1,this.postCoupon=function(){this.iframeSrc=this.iframeSrc.replace("{{couponCode}}",this.couponCode);var e=document.createElement("iframe");e.id="metrical_coupon_frame",e.onload=function(){},e.src=this.iframeSrc,e.style="display: none;",document.body.append(e)},this.redirect=function(){this.postbackURL&&window.location.replace(this.postbackURL)}},RedirectRunApplierCouponDriver:function(e,t,i,r,n){if(console.log(e),console.log(t),console.log(i),console.log(r),console.log(n),this.postURL=e,void 0===t)throw{name:"RequiredParameterMissing",message:"the couponcode attribute needs to be defined for this coupon driver"};if(this.couponCode=t,void 0===i)throw{name:"RequiredParameterMissing",message:"the applier attribute needs to be defined for this coupon driver"};if(this.applier=i,void 0===r)throw{name:"RequiredParameterMissing",message:"the urlFilter attribute needs to be defined for this coupon driver"};this.urlFilter=r,this.additionalParams=void 0!==n?n:{},this.postCoupon=function(){console.log("in postCoupon");var e=Object.assign({},{applier:this.applier,code:this.couponCode,filter:this.urlFilter},this.additionalParams);console.log(e);var t=encodeURIComponent(btoa(JSON.stringify(e)));console.log(t),_MetricalStorage.Cookie.sessionQuickSet("payload",t),this.postURL&&(window.location.href==this.postURL?_MetricalAppliers.init({jq:jQuery,logger:_MetricalAbandonCart.logger.child({module:"appliers"})}):window.location.replace(this.postURL))}},JcpCouponDriver:function(e){if(0==!!e.postbackurl)throw new Error("the postbackurl attribute needs to be defined for this coupon driver");if(0==!!e.couponcode)throw new Error("the couponcode attribute needs to be defined for this coupon driver");this.forceRedirect=1==!!e.forceredirect,this.properties=e,this.singleUse=!(!e.singleuse||!e.singleuse),this.postCoupon=function(){var e=this,t=function(e,t){window.handleVendorAction("apply_coupon",e,function(e){t("error"!=e&&0!=e)})},i=function(t,i,r){1==t.includes(!1)?e.renderOfferError({couponcode:i.join(", "),killcode:r.join(", ")}):e.doRedirect()};try{var r=Array.isArray(e.properties.couponcode)?e.properties.couponcode:[e.properties.couponcode],n=e.singleUse?n=e.singleUseCode:e.normalCode;n(r,function(e){var n=Array.isArray(e.coupon)?e.coupon:[e.coupon],o=[],a=r[0],s=n[0]||null;t({couponCode:a,serialCode:s},function(e){if(o.push(e),r.length>1){var a=r[1],s=n[1]||null;t({couponCode:a,serialCode:s},function(e){o.push(e),i(o,r,n)})}else i(o,r,n)})})}catch(e){throw console.error(e),e}},this.normalCode=function(e,t){t({success:!0,coupon:null})},this.singleUseCode=function(e,t){_MetricalCouponDataAccess.fetchSingleUseCouponCode(_MetricalAbandonCart.Config.surveyid,e,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),function(e){t(e)},function(){throw new Error("singleUseCoupon failed")})},this.doRedirect=function(){(this.properties.postbackurl!=window.location.href||this.forceRedirect)&&(window.location.href=this.properties.postbackurl),this.properties.postbackurl==window.location.href&&window.location.reload()},this.renderOfferError=function(e){var t=_MetricalAbandonCart.Config.views.couponerror;t.viewconfig.textblocks[0].tagreplacements.COUPON=e.couponcode,t.viewconfig.textblocks[0].tagreplacements.SERIAL=e.killcode,new _MetricalOfferViewV2({view:t,config:_MetricalAbandonCart.Config}).render(),_MetricalACInteractions.recordInteraction("couponerror")}}},_MetricalCouponDataAccess={init:function(e){var t={jq:jqAC,endpoint:_MetricalHosts.endpoints.singleUseCoupon};this.properties=Object.assign({},t,e),this.jq=this.properties.jq,this.cKey="c"},getC:function(){var e=_MetricalStorage.Cookie.getItem(this.cKey);return e?atob(decodeURIComponent(e)):null},setC:function(e){var t=encodeURIComponent(btoa(e));_MetricalStorage.Cookie.sessionQuickSet(this.cKey,t)},removeC:function(){_MetricalStorage.Cookie.removeItem(this.cKey)},fetchSingleUseCouponCode:function(e,t,i,r,n,o){var a={surveyId:e,couponId:t,uuid:i,sessionId:r};this.jq.ajax({type:"POST",dataType:"json",data:JSON.stringify(a),traditional:!1,contentType:"text/plain",async:!1,url:this.properties.endpoint,success:function(e){n(e)},error:function(e,t,i){console.log(e),console.log(t),console.log(i),o&&o()}})}},_MetricalAppliers={init:function(e){const t={logger:new _MetricalLogger({extraEntryData:{module:"appliers"}}),skipFilterCheck:!1};if(this.properties=Object.assign({},t,e),this.jq=this.properties.jq,this.logger=this.properties.logger,0==!!this.jq)throw new Error("jQuery needs to be defined for appliers");var i=_MetricalStorage.Cookie.getItem("payload");if(i){var r=JSON.parse(atob(decodeURIComponent(i)));console.log(r),r.applier in this?(this[r.applier](r),console.log("after bind call")):console.error("can't find applier function")}},test:function(e){"filter"in e&&-1!==window.location.href.indexOf(e.filter)&&console.log("filter matched, doing work")},hp:function(e){"filter"in e&&-1!==window.location.href.indexOf(e.filter)&&_MetricalUtils.waitForIdToAppear("promoGift",function(){let t=document.getElementById("promoGift"),i=t.value;t.value=e.code;let r=new Event("input",{bubbles:!0}),n=t._valueTracker;n&&n.setValue(i),t.dispatchEvent(r),$('input[name="eventName.updateGiftCertDataEvent"]').click()})},bbbv3:function(e){var t=this;if(t.logger.traceStart("bbbv3"),t.logger.debug("input params",e),!("confirmation_id"in e))return t.logger.error("confirmation_id needs to be provided in the applier payload",e),null;if(1==t.properties.skipFilterCheck||"filter"in e&&-1!==window.location.href.indexOf(e.filter)){t.logger.debug("filter check passed");var i=!(!e.singleuse||!e.singleuse);t.logger.debug("singleUse",{singleUse:i});var r={},n=function(i){t.logger.traceStart("popup"),t.logger.debug("textReplacements",i);var r=_MetricalAbandonCart.Config.offers.reduce(function(t,i){return i.id==e.confirmation_id?i:t},null);if(null===r)throw t.logger.error("Unable to find "+e.confirmation_id),new Error("Unable to find "+e.confirmation_id);var n=new _MetricalOfferViewV3({view:r.viewconfig,config:_MetricalAbandonCart.Config,textReplacements:i});n.subscribe("click/submit",function(o){t.logger.debug("click/submit was called"),t.logger.debug("offerView.data",{data:n.data}),console.log(o);o.target.innerHTML='<div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>';var a={data:n.data.form||{},coupon:i,type:"bounceback",params:e,engagement:r,surveyId:_MetricalAbandonCart.Config.surveyid,uuid:_MetricalIdentity.getDeviceId(),sessionId:_MetricalIdentity.getSessionId()};_MetricalFetch.post(_MetricalHosts.endpoints.message,a).then(function(e){t.logger.debug("message post response",{data:e}),n.navigate("thankyou"),_MetricalStorage.Cookie.removeItem("payload")}).catch(function(e){t.logger.error("message post error",{error:e}),n.navigate("error"),_MetricalStorage.Cookie.removeItem("payload")}),_MetricalOfferFlow.addTag({bounceBackPhone:!0})}),n.subscribe("click/close",function(){t.logger.debug("click/close was called"),_MetricalStorage.Cookie.removeItem("payload")}),n.subscribe("click/print",function(){t.logger.debug("click/print was called"),window.print(),_MetricalStorage.Cookie.removeItem("payload"),_MetricalOfferFlow.addTag({bounceBackPrint:!0})}),t.logger.debug("offerView is rendering index"),n.render("index"),_MetricalStorage.Storage.setItem("bb_view",{id:e.confirmation_id,ts:(new Date).toISOString()}),_MetricalOfferFlow.addTag({bounceBackCoupon:i.COUPON,bounceBackSerial:i.SERIAL}),t.logger.traceEnd("popup")};i?_MetricalCouponDataAccess.fetchSingleUseCouponCode(_MetricalAbandonCart.Config.surveyid,e.code,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),function(t){r.COUPON=e.code,r.SERIAL=t.coupon,n(r)}):(r.COUPON=e.code,n(r))}else t.logger.debug("filter check failed");t.logger.traceEnd("bbbv3")},jcpbbb:function(e){if(!("confirmation_id"in e))return console.log("confirmation_id needs to be provided"),null;"filter"in e&&-1!==window.location.href.indexOf(e.filter)?_MetricalCouponDataAccess.fetchSingleUseCouponCode(_MetricalAbandonCart.Config.surveyid,e.code,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),function(t){var i=_MetricalAbandonCart.Config.offers.reduce(function(t,i){return i.id==e.confirmation_id?i:t},null);if(null===i)throw new Error("Unable to find "+e.confirmation_id);i.couponconfig.textblocks[0].tagreplacements.COUPON=e.code,i.couponconfig.textblocks[0].tagreplacements.SERIAL=t.coupon,_MetricalOfferView.init(_MetricalAbandonCart.Config.staticendpointhost,i,function(){},function(e){},function(e){}),_MetricalOfferView.render(),_MetricalStorage.Cookie.removeItem("payload")}):console.log("filter prevented applier from running")},uso:function(e){"filter"in e&&-1!==window.location.href.indexOf(e.filter)&&(window.jQuery("input.saso-use-discount-code-cart-code").val(e.code),window.jQuery("button.saso-use-discount-code-cart-apply").click(),_MetricalStorage.Cookie.removeItem("payload"))},jcp:function(e){try{"filter"in e&&-1!==window.location.href.indexOf(e.filter)&&_MetricalCouponDataAccess.fetchSingleUseCouponCode(_MetricalAbandonCart.Config.surveyid,e.code,_MetricalIdentity.getDeviceId(),_MetricalIdentity.getSessionId(),function(t){var i,r,n=t.coupon;Array.isArray(n)&&Array.isArray(e.code)?(i=n[0],r=e.code[0]):(i=n,r=e.code);var o=_MetricalStorage.Cookie.getItemWithoutPrefix("ACCOUNT_ID")||JSON.parse(window.localStorage.__yoda).ACCOUNT_ID||void 0,a=_MetricalStorage.Cookie.getItemWithoutPrefix("Access_Token")||JSON.parse(window.localStorage.__yoda).Access_Token||void 0;if(0==!!o||0==!!a)throw new Error("Could not determine account ID or access token");var s="https://order-api.jcpenney.com/order-api/v1/accounts/"+o+"/draft-order/adjustment/discounts",c={code:r,serialNumber:i};_MetricalAppliers.logger.info(c),_MetricalAppliers.jq.ajax({type:"POST",contentType:"application/json",headers:{Authorization:"Bearer "+a},data:JSON.stringify(c),traditional:!1,async:!1,url:s,success:function(t){if(_MetricalAppliers.logger.info("JCP applier applied coupon",c),Array.isArray(n)&&2==n.length){var i={code:e.code[1],serialNumber:n[1]};_MetricalAppliers.logger.info(i),_MetricalAppliers.jq.ajax({type:"POST",contentType:"application/json",headers:{Authorization:"Bearer "+a},data:JSON.stringify(i),traditional:!1,async:!1,url:s,success:function(e){_MetricalAppliers.logger.info("JCP applier applied coupon",i),_MetricalStorage.Cookie.removeItem("payload"),window.location.reload()},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})}else _MetricalStorage.Cookie.removeItem("payload"),window.location.reload()},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})})}catch(e){console.error(e),_MetricalAppliers.logger.error(e)}}},_MetricalCallbacks={parseObserverConfig:function(e,t){for(var i=0;i<e.length;i++){var r=e[i];r.actions.includes(t.action)&&this[r.callback](t)}},jcp:function(e){var t=void 0;if("digitalData"in window){var i=_MetricalUtils.jsonPath(digitalData,"product[0].productInfo.productBrandName");Array.isArray(i)&&(t=i[0])}_MetricalStorage.Cookie.sessionQuickSet("lastbrand",t)}},_MetricalOfferView={el:null,elTab:null,container:null,postRenderAction:null,onOfferDismissAction:null,onOfferSubmitAction:null,staticendpointhost:null,init:function(e,t,i,r,n){try{this.staticendpointhost=e,this.postRenderAction=i,this.onOfferDismissAction=r,this.onOfferSubmitAction=n;this.properties=Object.assign({},{offerimage:!0,applyonpresentation:!1,avoidviewportformobile:!1},t||{}),this.clearOfferView(),this.setCSS()}catch(e){console.log(e)}},setCSS:function(){var e=this.staticendpointhost,t=document.querySelectorAll("head link[type='text/css']");if(0==t.length?(document.querySelector("head").innerHTML+="<link rel='stylesheet' href='//"+e+"/css/reset.css' type='text/css' >",t=document.querySelectorAll("head link[type='text/css']")):t[t.length-1].insertAdjacentHTML("afterend","<link rel='stylesheet' href='//"+e+"/css/reset.css' type='text/css' >"),t[t.length-1].insertAdjacentHTML("afterend","\x3c!--[if lt IE 9]><link href='//"+e+"/css/styles-ie8.css' type='text/css' ><![endif]--\x3e"),t[t.length-1].insertAdjacentHTML("afterend","\x3c!--[if gte IE 9]><link href='//"+e+"/css/styles-noie8.css' type='text/css' ><![endif]--\x3e"),t[t.length-1].insertAdjacentHTML("afterend","\x3c!--[if !IE]> --\x3e<link href='//"+e+"/css/styles-noie8.css' type='text/css' ><![endif]--\x3e"),void 0!==this.properties.css)if(Array.isArray(this.properties.css))for(let e=0;e<this.properties.css.length;e++){const t=this.properties.css[e];document.querySelectorAll("head link[rel='stylesheet']")[document.querySelectorAll("head link[rel='stylesheet']").length-1].insertAdjacentHTML("afterend","<link rel='stylesheet' href='"+t+"' type='text/css' >")}else document.querySelectorAll("head link[rel='stylesheet']")[document.querySelectorAll("head link[rel='stylesheet']").length-1].insertAdjacentHTML("afterend","<link rel='stylesheet' href='"+this.properties.css+"' type='text/css' >")},render:function(){var e=this;if(html="",void 0===this.properties.offerimage||void 0!==this.properties.offerimage&&1==this.properties.offerimage){this.configureDomMountPoint();var t=this.getImageOfferMarkup(),i=document.querySelector(".Metrical");t.imgObject.onload=function(){var r=document.documentElement.clientWidth,n=(document.documentElement.clientHeight-t.imgObject.height)/3,o=(r-t.imgObject.width)/2;document.querySelector("#metrical-widget-form img").setAttribute("style","z-index: 2001000; position: fixed; top: "+n+"px; left: "+o+"px;"),e.setupAdditionalInfoTextSection(n,o,t.imgObject.height,t.imgObject.width),i.innerHTML+=e.setupTextBlocks({top:n,left:o}),e.configureOfferEventHandlers(),setTimeout(function(){e.displayOffer()},100),e.setOfferPosition(),"function"==typeof e.postRenderAction&&e.postRenderAction()},i.innerHTML=t.htmlContent}},getImageOfferMarkup:function(){html="";var e=_MetricalUtils.determineDevice(),t=this.properties.couponconfig.closemap,i=void 0!==this.properties.couponconfig.submitmap?this.properties.couponconfig.submitmap:null,r=this.properties.couponconfig.imageurl;if("mobile"==e&&null!=r.mobile){r=r.mobile;var n=t.mobile.shape,o=t.mobile.coordinates;if(i)var a=i.mobile.shape,s=i.mobile.coordinates}else{r=r.desktop;n=t.desktop.shape,o=t.desktop.coordinates;if(i)a=i.desktop.shape,s=i.desktop.coordinates}var c=new Image;if(c.src=r,html+='<div style="background-color: transparent;" class="lb-wrapper">',html+='<div class="close-widget hidden"></div>',html+='<div id="form-container">',html+='<form id="metrical-widget-form" novalidate>',html+='<input id="metrical-surveyid" type = "hidden" value = "'+this.properties.survey+'" />',html+='<img usemap="#promomap" src="'+r+'">',void 0!==this.properties.couponconfig.additionalinfotextmap){var l=null!=this.properties.couponconfig.additionalinfotextmap.css?this.properties.couponconfig.additionalinfotextmap.css:"additionalTextBox",u=null!=this.properties.couponconfig.additionalinfotextmap.style?this.properties.couponconfig.additionalinfotextmap.style:"",d=this.properties.couponconfig.additionalinfotextmap;if("mobile"==e&&null!=d.mobile)var f=d.mobile.shape,p=d.mobile.coordinates;else f=d.desktop.shape,p=d.desktop.coordinates;html+='<div id="met_promo_additional_text" class="'+l+'" style="display: none; '+u+'" ><div><span class="metrical_chevron"></span></div>'+this.properties.couponconfig.additionalinfotextmap.text+"</div>"}return html+='<map name="promomap"><area shape="'+n+'" coords="'+o+'" id="close-widget" alt="Close" style="display: block; cursor: pointer;">',i&&(html+='<area id="submit-widget" shape="'+a+'" coords="'+s+'" alt="Submit" style="display: block; cursor: pointer;">'),html+=null!=f&&null!=p?'<area id="metrical-display-additional-text" shape="'+f+'" coords="'+p+'" alt="Show Additional Text" style="display: block; cursor: pointer;"></map>':"</map>",html+='<ul class="form-list">',html+='<li class="actions"><input type="submit" id="metrical-confirm-button" name ="" value="" class="enable hidden"></li>',html+="</ul>",html+="</form>",html+="</div>",html+="</div>",html+='<div id = "check-offset"><div>',{htmlContent:html,imgObject:c}},setupTextBlocks:function(e){var t="";if(this.properties.couponconfig.textblocks&&Array.isArray(this.properties.couponconfig.textblocks))for(var i=_MetricalUtils.determineDevice(),r=0;r<this.properties.couponconfig.textblocks.length;r++){var n=this.properties.couponconfig.textblocks[r],o=n.text,a=n.tagreplacements||null;if(a)for(var s in a)o=o.replace("{{"+s+"}}",a[s]);if("mobile"==i)var c=n.position.mobile.top||0,l=n.position.mobile.left||0;else c=n.position.desktop.top||0,l=n.position.desktop.left||0;var u=n.style||"";t+='<div style="'+("z-index: 2001100; position: fixed; top: "+(parseInt(e.top)+parseInt(c))+"px; left: "+(parseInt(e.left)+parseInt(l))+"px; "+u)+'">'+o+"</div>"}return t},setupAdditionalInfoTextSection:function(e,t,i,r){if(null!=this.properties.couponconfig&&null!=this.properties.couponconfig.additionalinfotextmap){var n=document.querySelector("#met_promo_additional_text");n.setAttribute("style",n.getAttribute("style")+"position: fixed; top: "+(parseInt(e)+parseInt(i))+"px; left: "+t+"px;"),-1===n.getAttribute("style").indexOf("width")&&(n.style.width=r+"px"),document.querySelector("#metrical-widget-form div>div").style.textAlign="center",document.querySelector("#metrical-widget-form div>div").style.width=r-20+"px"}},configureOfferEventHandlers:function(){var e=this,t="autocloseafterxseconds"in this.properties?this.properties.autocloseafterxseconds:void 0,i="autosubmitafterxseconds"in this.properties?this.properties.autosubmitafterxseconds:void 0;setTimeout(function(){var r=void 0,n=void 0;t&&(r=setTimeout(function(){e.clickOn(document.querySelector(".MetricalContainer #close-widget"))},1e3*t));i&&(n=setTimeout(function(){e.clickOn(document.querySelector(".MetricalContainer #submit-widget"))},1e3*i));null!=document.querySelector(".MetricalTab a.mobile-link")&&(document.querySelector(".MetricalTab a.mobile-link").onclick=function(t){"function"==typeof e.onOfferDismissAction&&e.onOfferDismissAction(t),void 0!==r&&clearTimeout(r)});for(var o=document.querySelectorAll(".MetricalTab.elTab-left, .MetricalTab.elTab-right, .MetricalTab.elTab-top"),a=0;a<o.length;a++)o[a].addEventListener("click",function(t){document.querySelector(this).parentNode.classList.contains("is-popped")&&void 0!==t.originalEvent&&("function"==typeof e.onOfferDismissAction&&e.onOfferDismissAction(t),void 0!==r&&clearTimeout(r))});null!=document.querySelector(".MetricalContainer #close-widget")&&(document.querySelector(".MetricalContainer #close-widget").onclick=function(t){document.querySelector(".MetricalTab").style.visibility="hidden",e.clickOn(document.querySelector(".close-widget")),document.querySelector("#metrical-widget-form img")&&(document.querySelector("#metrical-widget-form img").style.display="none"),document.querySelector("#metrical-widget-form div")&&(document.querySelector("#metrical-widget-form div").style.display="none"),"function"==typeof e.onOfferDismissAction&&e.onOfferDismissAction(t),void 0!==r&&clearTimeout(r),e.hideOffer()}),null!=document.querySelector(".MetricalContainer #submit-widget")&&(document.querySelector(".MetricalContainer #submit-widget").onclick=function(t){e.clickOn(document.querySelector("#metrical-confirm-button")),document.querySelector("#metrical-widget-form div")&&(document.querySelector("#metrical-widget-form div").style.display="none"),"function"==typeof e.onOfferSubmitAction&&e.onOfferSubmitAction(t),void 0!==n&&clearTimeout(n),e.hideOffer()}),null!=document.querySelector("#metrical-confirm-button")&&(document.querySelector("#metrical-confirm-button").onclick=function(e){e.stopImmediatePropagation(),e.preventDefault()}),null!=e.properties.couponconfig&&null!=e.properties.couponconfig.additionalinfotextmap&&(document.querySelector("#metrical-display-additional-text").onclick=function(){document.querySelector("#metrical-widget-form div").style.display="block"},document.querySelector("#met_promo_additional_text .metrical_chevron").onclick=function(){document.querySelector("#metrical-widget-form div").style.display="none"})},500)},configureDomMountPoint:function(){var e;document.querySelector("body").innerHTML+='<div class="Metrical_lightbox"><div class="Metrical_lightbox_center"><div class="Metrical_lightbox_content"></div></div></div>',(e=document.createElement("div")).classList.add("MetricalContainer"),e.style.visibility="hidden",document.querySelector("body").innerHTML+=e.outerHTML,this.container=e,(e=document.createElement("div")).classList.add("Metrical"),this.el=e,(e=document.createElement("div")).classList.add("MetricalTab"),e.classList.add("hidden"),this.elTab=e,document.querySelector(".MetricalContainer").appendChild(this.el),document.querySelector(".MetricalContainer").appendChild(this.elTab),"mobile"==_MetricalUtils.determineDevice()&&(this.properties.avoidviewportformobile||(document.querySelector("body").innerHTML+='<meta name="viewport" content="width=device-width, initial-scale=1">'))},setOfferPosition:function(){document.querySelector(".Metrical_lightbox_center").classList.remove("MetricalContainer");var e=window.innerHeight,t=document.querySelector(".MetricalContainer")?document.querySelector(".MetricalContainer").offsetTop:null,i=document.querySelector("#check-offset")?document.querySelector("#check-offset").offsetTop:null,r=null!=document.querySelector(".container-bottom");if("mobile"==_MetricalUtils.determineDevice())return document.querySelector("div.MetricalContainer").classList.contains("position-fixed")&&(document.querySelector(".MetricalContainer").style.height=window.innerHeight+"px"),document.querySelector(".Metrical_lightbox_center").classList.add("MetricalContainer"),document.querySelector(".Metrical_lightbox_center").classList.add("mobile"),1==_MetricalUtils.identifierIsIOS()&&document.querySelector(".Metrical_lightbox_center").classList.add("ios"),void document.querySelector(".Metrical_lightbox_center").classList.add("display-widget-page");i>e||r&&t<0?(document.querySelector("div.MetricalContainer").classList.contains("position-fixed")&&(document.querySelector("div.MetricalContainer").classList.remove("position-fixed"),document.querySelector("div.MetricalContainer").classList.add("position-absolute")),r&&t<0&&(document.querySelector("div.MetricalContainer").classList.remove("container-bottom"),document.querySelector("div.MetricalContainer").classList.add("container-top"))):document.querySelector("div.MetricalContainer").classList.contains("position-absolute")&&(document.querySelector("div.MetricalContainer").classList.remove("position-absolute"),document.querySelector("div.MetricalContainer").classList.add("position-fixed")),document.querySelector(".Metrical_lightbox_center").classList.add("MetricalContainer")},displayOffer:function(){var e=this,t=document.querySelector(".Metrical");document.querySelector(".MetricalTab").style.display="none",document.querySelector(".Metrical_lightbox_content").outerHTML=t.outerHTML,this.fadeIn(document.querySelector(".Metrical_lightbox")),document.querySelector(".Metrical_lightbox").style.display="block",document.querySelector("body").style.overflowY="hidden",document.querySelector(".close-widget").style.display="block","mobile"==_MetricalUtils.determineDevice()&&(document.querySelector("html, body").classList.add("ios-fix"),null!=document.querySelector("textarea")&&(document.querySelector("textarea").onblur=function(t){e.fixFocusLightboxMobile()}))},hideOffer:function(){document.querySelector(".MetricalTab").classList.contains("hidden")&&document.querySelector(".MetricalTab").classList.remove("hidden"),document.querySelector(".MetricalContainer").appendChild(document.querySelector(".Metrical_lightbox_center .Metrical")),document.querySelector(".Metrical_lightbox_center .Metrical").outerHTML='<div class="Metrical_lightbox_content">',this.fadeOut(document.querySelector(".Metrical_lightbox")),this.fadeIn(document.querySelector(".MetricalTab")),document.querySelector(".Metrical_lightbox").style.display="none",document.querySelector("body").style.overflowY="","mobile"==_MetricalUtils.determineDevice()&&document.querySelector("html, body").classList.remove("ios-fix")},clearOfferView:function(){var e=document.querySelector(".Metrical_lightbox"),t=document.querySelector(".MetricalContainer");null!=e&&null!=e.parentNode&&e.parentNode.removeChild(e),null!=t&&null!=t.parentNode&&t.parentNode.removeChild(t)},fixFocusLightboxMobile:function(){var e=this;setTimeout(function(){container=document.querySelector(".Metrical_lightbox"),oRect=document.querySelector(":focus").getBoundingClientRect(),o={top:oRect.top+document.body.scrollTop,left:oRect.left+document.body.scrollLeft},null!=o&&(cORect=container.getBoundingClientRect(),cO={top:cORect.top+document.body.scrollTop,left:cORect.left+document.body.scrollLeft},e.scrollTo(container,0,1e3)),e.clickOn(document.querySelector(":focus"))},.01)},clickOn:function(e){var t=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(t)},fadeIn:function(e){e.style.opacity=0;var t=+new Date,i=function(){e.style.opacity=+e.style.opacity+(new Date-t)/400,t=+new Date,+e.style.opacity<1&&(window.requestAnimationFrame&&requestAnimationFrame(i)||setTimeout(i,16))};i()},fadeOut:function(e){var t=setInterval(function(){e.style.opacity||(e.style.opacity=1),e.style.opacity>0?e.style.opacity-=.1:clearInterval(t)},50)},scrollTo:function(e,t,i){var r=e.scrollTop,n=t-r,o=0,a=function(){var t,s,c,l=(t=o+=20,s=r,c=n,(t/=i/2)<1?c/2*t*t+s:-c/2*(--t*(t-2)-1)+s);e.scrollTop=l,o<i&&setTimeout(a,20)};a()},slideUp:function(e,t){height=e.offsetHeight,counter=height;var i=height/10;!function(e){e.style.cssText="transition: height 500ms; -webkit-transition: height 500ms; -moz-transition: height 500ms; -o-transition: height 500ms"}(e),ease.disabled=1,e.style.overflow="hidden",interval=setInterval(function(){counter-=i,counter>0?e.style.height=counter+"px":(e.style.height=0,t.disabled=0,t.innerHTML="slideDown",clearInterval(interval))},duration)},slideDown:function(e,t){var i=height/10;interval=setInterval(function(){counter+=i,counter<height?e.style.height=counter+"px":(e.style.height=height+"px",t.disabled=0,t.innerHTML="slideUp",ease.disabled=0,clearInterval(interval))},duration)}},_MetricalOfferViewV2=function(e){if(0==!!e.config)throw new Error("OfferViewV2 requires a config parameter");if(0==!!e.view)throw new Error("OfferViewV2 requires a view parameter");var t=Object.create(new _MetricalUtils.PubSub);return t.defaultParams={staticEndpointHost:e.config.staticendpointhost,config:null,view:null,cssRelativePath:"/css/styles.lightbox.view.css"},t.params=Object.assign({},t.defaultParams,e||{}),t.viewConfig=function(){if("couponconfig"in this.params.view)return this.params.view.couponconfig;if("viewconfig"in this.params.view)return this.params.view.viewconfig;throw new Error("Either couponconfig or viewconfig needs to be specified in the current view to be shown")},t.viewPropertyValue=function(e,t){t=t||this.viewConfig();var i=_MetricalUtils.determineDevice();if(e in t){var r=Object.assign({},t[e]);return delete r.desktop,delete r.mobile,delete r.tablet,i in t[e]||(i="desktop"),i in t[e]&&(r="object"==typeof t[e][i]?Object.assign(r,t[e][i]):t[e][i]),r}return null},t.attachStylesheet=function(){var e="//"+this.params.staticEndpointHost+this.params.cssRelativePath,t=document.querySelector("head"),i=document.createElement("link");i.rel="stylesheet",i.href=e,i.type="text/css",t.appendChild(i)},t.isStylesheetLoaded=function(){var e=this.params.config.assets||[],t=this.params.cssRelativePath;return e.reduce(function(e,i){return!1===e&&i.url.includes(t)&&(e=!0),e},!1)},t.clearLightBox=function(){var e=document.querySelector(".Metrical_LightBox");e&&e.remove()},t.render=function(){var e=this;e.publish("render/pre");var t=document.createElement("div");t.classList.add("Metrical_LightBox");var i=document.createElement("div");i.classList.add("Metrical_LightBoxContent"),i.appendChild(e._makeMapEl()),i.appendChild(e._makeImgEl()),this.viewPropertyValue("additionalinfotextmap")&&i.appendChild(e._makeAdditionalInfoEl()),(e.viewConfig().textblocks||[]).forEach(function(t){i.appendChild(e._makeTextBlockEl(t))}),t.appendChild(i),document.querySelector("body").appendChild(t),e.publish("render/post")},t._makeTextBlockEl=function(e){var t=document.createElement("div");t.classList.add("MetricalTextLayer");var i,r=e.class||"";(i=r,Array.isArray(i)?i:"string"==typeof i&&i.length>0?i.split(" "):[]).forEach(function(e){t.classList.add(e)});var n=(e.style||"").split(";").filter(function(e){return e.length>0}).map(function(e){return e.trim()+";"}),o=this.viewPropertyValue("position",e);for(var a in o){var s=a+": "+o[a]+"px;";n.push(s)}t.style=n.join(" ");var c=e.tagreplacements||null,l=e.text||"";if(c)for(var u in c){var d=new RegExp("{{"+u+"}}","g");l=l.replace(d,c[u])}return t.innerHTML=l,t},t._makeAdditionalInfoEl=function(){var e=this,t=this.viewPropertyValue("additionalinfotextmap");return infoEl=document.createElement("div"),infoEl.classList.add("Metrical_AdditionalInfo"),"style"in t&&(infoEl.style=t.style),chevronSpanEl=document.createElement("span"),chevronSpanEl.classList.add("Metrical_Chevron"),chevronSpanEl.addEventListener("click",function(t){e.additionalInfoSlideIn()}),chevronEl=document.createElement("div"),chevronEl.appendChild(chevronSpanEl),textEl=document.createElement("span"),textEl.innerHTML=t.text||"",infoEl.appendChild(chevronEl),infoEl.appendChild(textEl),infoEl},t.additionalInfoSlideOut=function(){var e=document.querySelector(".Metrical_LightBox .Metrical_AdditionalInfo");e&&(e.classList.remove("MetricalSlideIn"),e.classList.add("MetricalSlideOut"))},t.additionalInfoSlideIn=function(){var e=document.querySelector(".Metrical_LightBox .Metrical_AdditionalInfo");e&&(e.classList.remove("MetricalSlideOut"),e.classList.add("MetricalSlideIn"))},t._makeImgEl=function(){var e=this.viewPropertyValue("imageurl"),t=document.createElement("img");return t.setAttribute("usemap","#MetricalOfferMap"),t.setAttribute("src",e),t},t._makeMapEl=function(){var e=this,t=document.createElement("map");t.setAttribute("name","MetricalOfferMap");var i=e.viewPropertyValue("closemap");if(i&&"shape"in i&&"coordinates"in i){var r=document.createElement("area");r.setAttribute("id","MetricalCloseArea"),r.setAttribute("shape",i.shape),r.setAttribute("coords",i.coordinates),r.setAttribute("alt","Close"),r.setAttribute("style","display: block; cursor: pointer;"),r.addEventListener("click",function(t){t.stopPropagation(),e.close()}),t.appendChild(r)}var n=e.viewPropertyValue("submitmap");if(n&&"shape"in n&&"coordinates"in n){var o=document.createElement("area");o.setAttribute("id","MetricalSubmitArea"),o.setAttribute("shape",n.shape),o.setAttribute("coords",n.coordinates),o.setAttribute("alt","Submit"),o.setAttribute("style","display: block; cursor: pointer;"),o.addEventListener("click",function(t){t.stopPropagation(),e.submit()}),t.appendChild(o)}var a=this.viewPropertyValue("additionalinfotextmap");if(a&&"shape"in a&&"coordinates"in a){var s=document.createElement("area");s.setAttribute("id","MetricalInfoArea"),s.setAttribute("shape",a.shape),s.setAttribute("coords",a.coordinates),s.setAttribute("alt","Info"),s.setAttribute("style","display: block; cursor: pointer;"),s.addEventListener("click",function(t){t.stopPropagation(),e.additionalInfoSlideOut()}),t.appendChild(s)}return t},t.close=function(){this.publish("close/pre"),this.clearLightBox(),this.publish("close/post")},t.submit=function(){this.publish("submit/pre"),this.clearLightBox(),this.publish("submit/post")},t.attachStylesheet(),t.clearLightBox(),t},_MetricalOfferViewV3=function(e){var t=Object.create(new _MetricalUtils.PubSub);if(t.defaultProperties={config:null,view:null,defaultStyles:[".Metrical_LightBox { position: fixed; z-index: 999; width: 100%; height: 100%; text-align: center; top: 0; left: 0; background: rgba(0, 0, 0, 0.8); overflow: auto; padding-top: 2%; } ",".Metrical_LightBox .Metrical_LightBoxContent { position: relative; margin: auto; padding: 0; }",".Metrical_LightBox .Metrical_LightBoxClose, .Metrical_additionalinfo_toggle { position: absolute; margin: 0px; padding: 0px; cursor: pointer; }"],document:document,textReplacements:{},currentViewKey:void 0,useCloseOverlay:!0},t.properties=Object.assign({},t.defaultProperties,e||{}),t.document=t.properties.document,t.formData={},t.data={},0==!!t.properties.config)throw new Error("OfferViewV3 requires a config parameter");if(0==!!t.properties.view)throw new Error("OfferViewV3 requires a view parameter");if(0==!!t.properties.view.views)throw new Error("OfferViewV3 requires a views parameter in the view property");return t.viewKeys=Object.keys(t.properties.view.views),t.viewKeys.forEach(function(e){t.data[e]={}}),t.additionalInfoShouldOpen=!1,t.render=function(e){if(0==this.viewKeys.includes(e))throw new Error("View "+e+" is not a valid view for this engagement");this.publish("render/pre");var t=this.document.createElement("div");this.properties.lightBoxEl=t,t.classList.add("Metrical_LightBox");var i=this.document.createElement("div");t.appendChild(i),i.classList.add("Metrical_LightBoxContent"),this.properties.contentEl=i,this.attachStyles("container",this.containerStyles()),this.navigate(e),this.document.querySelector("body").appendChild(t),this.attachEvents(),this.publish("render/post")},t.renderAdditionalInfo=function(){var e=this;e.additionalInfoShouldOpen=!1;var t=e.properties.view.additionalinfo||null;if(null!==t){var i=t.text||"",r=document.createElement("div");r.classList.add("Metrical_additionalinfo_container");var n=document.createElement("span");n.classList.add("Metrical_additionalinfo_text"),n.innerHTML=i,r.appendChild(n),this.properties.contentEl.appendChild(r);var o=this.document.createElement("div");o.id=this.makeId("additionalinfo_toggle"),o.classList.add("Metrical_additionalinfo_toggle"),this.properties.contentEl.appendChild(o),o.addEventListener("click",function(t){e.additionalInfoShouldOpen=!e.additionalInfoShouldOpen,1==e.additionalInfoShouldOpen?(r.classList.remove("Metrical_additionalinfo_slidein"),r.classList.add("Metrical_additionalinfo_slideout")):(r.classList.remove("Metrical_additionalinfo_slideout"),r.classList.add("Metrical_additionalinfo_slidein"))})}},t.renderCloseOverlay=function(){var e=this.document.createElement("div");e.id=this.makeId("view_close"),e.classList.add("Metrical_LightBoxClose"),this.properties.contentEl.appendChild(e),e.addEventListener("click",this.close.bind(this))},t.clearLightBox=function(){var e=this.properties.lightBoxEl;e&&e.remove()},t.navigate=function(e){if(0==this.viewKeys.includes(e))throw new Error("View "+e+" is not a valid view for this engagement");this.publish("navigate/pre");var t=this.properties.view.views[e],i=this.properties.currentViewKey;this.removeEvents(i),this.properties.contentEl.innerHTML="","style"in t&&t.style.length>0&&this.attachStyles(e,t.style);var r=this.document.createElement("div");r.classList.add(this.makeId("view")),r.classList.add(this.makeId("view_"+e));var n=(Array.isArray(t.html)?t.html:[t.html]).join("\n"),o=this.replaceText(n);r.innerHTML=o,this.properties.contentEl.appendChild(r),this.properties.currentViewKey=e,this.attachEvents(e),this.properties.useCloseOverlay&&this.renderCloseOverlay(),this.renderAdditionalInfo(),this.publish("navigate/post")},t.replaceText=function(e){var t=e,i=this.properties.textReplacements||{};for(var r in i){var n=new RegExp("{{"+r+"}}","g");t=t.replace(n,i[r])}return t},t.containerStyles=function(){var e=this.properties.defaultStyles,t=[],i=[];return"style"in this.properties.view&&this.properties.view.style.length>0&&(i=Array.isArray(this.properties.view.style)?this.properties.view.style:[this.properties.view.style]),"defaultstyle"in this.properties.view&&this.properties.view.defaultstyle.length>0&&(t=Array.isArray(this.properties.view.defaultstyle)?this.properties.view.defaultstyle:[this.properties.view.defaultstyle]),(t.length>0?t:e).concat(i)},t.attachStyles=function(e,t){var i=this.makeId(e+"_css");if(null===this.document.getElementById(i)){var r=this.document.createElement("style");r.id=i;var n=Array.isArray(t)?t:[t];r.appendChild(this.document.createTextNode(n.join("\n"))),this.document.getElementsByTagName("head")[0].appendChild(r)}},t.makeId=function(e){return"Metrical_"+e},t.removeEvents=function(e){var t=this;document.querySelectorAll(".Metrical_view form select").forEach(function(e){e.removeEventListener("change",t.controlHandleChange.bind(t))}),document.querySelectorAll(".Metrical_view form input").forEach(function(e){e.removeEventListener("input",t.controlHandleChange.bind(t))}),document.querySelectorAll(".Metrical_view form").forEach(function(e){e.removeEventListener("submit",t.formHandleSubmit.bind(t))})},t.attachEvents=function(e){var t=this;document.querySelectorAll(".Metrical_view form select").forEach(function(e){e.addEventListener("change",t.controlHandleChange.bind(t))}),document.querySelectorAll(".Metrical_view form input").forEach(function(e){e.addEventListener("input",t.controlHandleChange.bind(t))}),document.querySelectorAll(".Metrical_view form").forEach(function(e){e.addEventListener("submit",t.formHandleSubmit.bind(t))}),document.querySelectorAll(".Metrical_view *[data-nav]").forEach(function(e){e.addEventListener("click",t.elHandleNavigation.bind(t))}),document.querySelectorAll(".Metrical_view *[data-event]").forEach(function(e){var i=e.dataset.event.split("/"),r=2==i.length?i[0]:"click";e.addEventListener(r,t.elHandleEventPublish.bind(t))})},t.elHandleEventPublish=function(e){var t=e.target,i=t.dataset.event;"disableOnClick"in t.dataset&&(t.disabled=!0),this.publish(i,e)},t.elHandleNavigation=function(e){var t=e.target.dataset.nav;this.navigate(t)},t.controlHandleChange=function(e){var t=document.querySelectorAll(".Metrical_view form"),i={},r=[];(t.forEach(function(e,t){var n=e.id||e.name||t,o=e.checkValidity();r.push(o);var a=new FormData(e),s={};for(var c of a.entries())s[c[0]]=c[1];i[n]=s}),this.data[this.properties.currentViewKey]=i,0==r.includes(!1))?document.querySelectorAll(".Metrical_view form *[data-validation-toggle]").forEach(function(e){e.disabled=!1}):document.querySelectorAll(".Metrical_view form *[data-validation-toggle]").forEach(function(e){e.disabled=!0})},t.formHandleSubmit=function(e){return e.preventDefault(),!1},t.close=function(){this.clearLightBox(),this.publish("click/close")},t.submit=function(){this.publish("submit/pre");var e=this.document.querySelector(".Metrical_view form"),t=new FormData(e),i={};for(var r of t.entries())i[r[0]]=r[1];this.formData=i,this.publish("submit/post")},t},_MetricalCartDA={init:function(e){this.defaultConfig={namespace:"pc",useCookieOverLocal:!1},this.config=Object.assign({},this.defaultConfig,e||{}),this.namespace=this.config.namespace||"pc",this.cartKey="cart",this.itemKey="items",this.config.useCookieOverLocal?this.storageObject=_MetricalStorage.Cookie:this.storageObject=_MetricalStorage.Storage,this.cookieObject=_MetricalStorage.Cookie},getCart:function(){var e=this.namespace+"_"+this.cartKey;return this.storageObject.getItem(e)},setCart:function(e){var t=this.namespace+"_"+this.cartKey;return this.storageObject.setItem(t,e,0)},getItems:function(){var e=this.namespace+"_"+this.itemKey;return this.storageObject.getItem(e)},setItems:function(e){var t=this.namespace+"_"+this.itemKey;return this.storageObject.setItem(t,e,0)}},_MetricalCart={loaded:!1,init:function(e){this.defaultConfig={da:null,expandItemsFunc:null},this.config=Object.assign({},this.defaultConfig,e||{}),this.cart=[],this.loadCart(),this.items={},this.loadItems(),this.loaded=!0},loadCart:function(){var e=this.config.da.getCart();return Array.isArray(e)&&(this.cart=e),this.cart},loadItems:function(){var e=this.config.da.getItems();return this.items=e||{},this.items},syncWithUserMeta:function(e){if("usermeta"in e&&"cartidlist"in e.usermeta&&"cartskulist"in e.usermeta&&"cartqtylist"in e.usermeta&&"cartpricelist"in e.usermeta&&e.usermeta.cartidlist&&e.usermeta.cartskulist&&e.usermeta.cartqtylist&&e.usermeta.cartpricelist){var t=_MetricalUtils.plusDelimitedParts(e.usermeta.cartidlist),i=_MetricalUtils.plusDelimitedParts(e.usermeta.cartskulist),r=_MetricalUtils.plusDelimitedParts(e.usermeta.cartqtylist),n=_MetricalUtils.plusDelimitedParts(e.usermeta.cartpricelist);this.cart=[];for(var o=0;o<t.length;o++){var a=_MetricalUtils.round(_MetricalUtils.cleanMoney(n[o]),2);this.cart.push({id:t[o],sku:i[o],qty:parseInt(r[o]),price:a})}this.config.da.setCart(this.cart)}if("usermeta"in e&&"itemid"in e.usermeta){var s=e.usermeta.itemid,c=this.items[s]&&this.items[s].viewCount?this.items[s].viewCount:0;""==e.action&&c++;var l={ts:(new Date).getTime(),cat:e.usermeta.itemcategory||null,subcat:e.usermeta.itemsubcategory||null,price:_MetricalUtils.round(_MetricalUtils.cleanMoney(e.usermeta.itemprice||null),2),viewCount:c},u="function"==typeof this.config.expandItemsFunc?this.config.expandItemsFunc():{};this.items[s]=Object.assign({},l,u)}var d=(new Date).getTime()-1728e5;for(var s in this.items)this.items[s].ts&&this.items[s].ts<d&&delete this.items[s];this.config.da.setItems(this.items)},cartItemCount:function(){return this.loadCart(),this.cart.reduce(function(e,t){return e+t.qty},0)},cartValue:function(){this.loadCart();var e=this.cart.reduce(function(e,t){return e+t.qty*t.price},0);return _MetricalUtils.round(e,2)},cartHasItemInSubCategory:function(e){var t=this;return this.cart.map(function(e){return e.id}).reduce(function(i,r){!1===i&&t.items[r]&&(i=(t.items[r].subcat||"").includes(e));return i},!1)}};