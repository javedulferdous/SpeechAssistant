define(['jquery','Magento_Customer/js/customer-data','mage/utils/objects','underscore','cokeAddressUtils','mage/cookies','jquerySerializeJSON'],function($,customerData,mageObjectUtils,_,cokeAddressUtils){'use strict';if(typeof window.COKE==='undefined'){window.COKE={};}
$.widget('coke.geolocator',{map:null,geocoder:null,options:{cokeHqCoordinates:{lat:33.7710515,lng:-84.403845},findInStoreButtonLocationSelector:'div.customer-locator-control:visible form.form-find-in-store button.location, .page-main form.form-find-in-store button.location',findInStorePostcodeInputsSelector:'form.form-find-in-store input.find-in-store',customerLocatorControlSelector:'.customer-locator-control'},_create:function(){this.findInStorePostcodeInputs=$(this.options.findInStorePostcodeInputsSelector);this.findInStoreButtonLocations=$(this.options.findInStoreButtonLocationSelector);this.customerLocatorControl=$(this.options.customerLocatorControlSelector);},_init:function(){const self=this;if(this.findInStoreButtonLocations.length>0&&this.options.googleMapsApiUrl){if(!mageObjectUtils.isObject(window.google)){require([this.options.googleMapsApiUrl],function(){self.geocoder=new google.maps.Geocoder();COKE.geocoder=self.geocoder;if(document.getElementById('find-in-store-map')!==null){COKE.map=new google.maps.Map(document.getElementById('find-in-store-map'),{center:self.options.cokeHqCoordinates,zoom:11,mapTypeId:'roadmap'});}
self._bind();},function(error){console.log(error);});this.findInStorePostcodeInputs.val(cokeAddressUtils.currentAddressData().postcode);cokeAddressUtils.currentAddressData.subscribe(function(data){this.findInStorePostcodeInputs.val(data.postcode).keyup();},this);}}},_bind:function(){this.findInStoreButtonLocations.on({click:$.proxy(function(e){this._geoLocate();},this)});this.customerLocatorControl.on({submit:$.proxy(function(e){this._setPostcode(e);},this)});},clearLocations:function(){for(let i=0;i<this.markers.length;i++){this.markers[i].setMap(null);}
this.markers.length=0;},closeLocatorDropdown:function(){const self=this;setTimeout(function(){self.customerLocatorControl.find('> span > button').trigger('click.toggleDropdown');},777);},_geoLocate:function(){let lat,lng,latlng;const self=this;$('body').loader('show');if(navigator.geolocation){function success(position){$('body').loader('hide');lat=position.coords.latitude;lng=position.coords.longitude;latlng={lat:parseFloat(lat),lng:parseFloat(lng)};self._fetchAddressData(latlng);}
function error(){$('body').loader('hide');alert($.mage.__('Unable to retrieve your location'));}
navigator.geolocation.getCurrentPosition(success,error);}},_fetchAddressData:function(latlng){const self=this;this.geocoder.geocode({'location':latlng},function(results,status){if(mageObjectUtils.isObject(results[0])){let addressComponents=results[0].address_components,countryData=customerData.get('directory-data'),addressData={},countryRegions,regionResults;$.each(addressComponents,function(){if(this.types[0]==='locality'){addressData.city=this.long_name;}
if(this.types[0]==='administrative_area_level_1'){addressData.region_code=this.short_name;addressData.region=this.long_name;}
if(this.types[0]==='country'){addressData.country_id=this.short_name;}
if(this.types[0]==='postal_code'){addressData.postcode=this.short_name;}});if(_.size(countryData())>0){countryRegions=countryData()[addressData.country_id].regions||{};if(_.size(countryRegions)>0){regionResults=_.keys(_.pick(countryRegions,function(v){return v.code===addressData.region_code;}));if(regionResults[0]){addressData.region_id=regionResults[0];}}}
cokeAddressUtils.updateCurrentAddressData(addressData);self.closeLocatorDropdown();}});},_setPostcode:function(e){let formData=$(e.target).serializeJSON(),addressData=cokeAddressUtils.currentAddressData();addressData.postcode=formData['locator-postcode'];cokeAddressUtils.updateCurrentAddressData(addressData);this.closeLocatorDropdown();e.preventDefault();}});return $.coke.geolocator;});