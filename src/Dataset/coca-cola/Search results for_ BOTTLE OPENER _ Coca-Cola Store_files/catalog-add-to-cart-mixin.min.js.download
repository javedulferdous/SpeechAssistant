define(['jquery','underscore','mage/translate'],function($,_,$t){'use strict';return function(widget){const form=$('#product_addtocart_form'),previewButton=form.find('.action.preview'),submitButtons=form.find('.action.tocart,.action.preview'),previewInput=form.find('input[name="preview_only"]');widget.prototype.options.previewInput=previewInput;submitButtons.click(function(e){previewInput.val(($(this).hasClass('preview'))?1:0);});$('[data-block="minicart"]').on('contentLoading',function(){$('[data-block="minicart"]').on('contentUpdated',function(){$('[data-block="minicart"]').find('[data-role="dropdownDialog"]').dropdownDialog("open");});});$(document).on('ajax:addToCart',function(a,data){const gallery=$('.gallery-placeholder').data('gallery'),activeImage=$('div.fotorama__active img.fotorama__img'),activeImgHeight=activeImage.height(),lastPersonalizationInput=data.form.find('input.product-custom-option,textarea.bulk-personalization-phrases').last(),removeNameEl=data.form.find('.remove-name'),removeNamePosition=removeNameEl.position(),minicart=$('[data-block="minicart"]'),galleryPlaceholder=$('.gallery-placeholder')
let scrollTarget=0,openMinicart=true;if(data.response.error){lastPersonalizationInput.addClass('force-error');openMinicart=false;scrollTarget=data.form.offset().top;$.validator.addMethod('force-error',function(v){return false;},data.response.error);data.form.validation('isValid');lastPersonalizationInput.removeClass('force-error');if(removeNamePosition){removeNameEl.css({position:'absolute',top:removeNamePosition.top,left:removeNamePosition.left});}
$.each(data.response,function(i,v){let el;if($.isNumeric(i)&&v.isBulk&&v.deny.length){el=$('#options_'+i+'_text');if(el){el.val(v.deny.join("\n"));}}});}
if(data.response.preview_image){gallery.fotorama.resize({maxheight:activeImgHeight});gallery.updateData([{img:data.response.preview_image,full:data.response.preview_image,thumb:data.response.preview_image}]);if(data.response.preview_only){scrollTarget=galleryPlaceholder.offset().top;openMinicart=false;}}
if($('html').scrollTop()>scrollTarget){$('html, body').animate({scrollTop:scrollTarget},777);}
$('table#names').find('input.input-text').val('');submitButtons.removeClass(widget.prototype.options.addToCartButtonDisabledClass);});$.widget('mage.catalogAddToCart',widget,{options:{selectedSimpleProductInputSelector:'input[name="selected_simple_product"]'},submitForm:function(form){const selectedSimpleProductInput=form.find(this.options.selectedSimpleProductInputSelector),miniCartSelector=this.options.minicartSelector;let foundIds;if(this._isPreviewMode()){this.options.minicartSelector=null;previewButton.addClass(this.options.addToCartButtonDisabledClass);}
if(selectedSimpleProductInput.length>0){foundIds=this._findSelectedProductIds();if(foundIds.length===1){selectedSimpleProductInput.val(foundIds[0]);}}
this._super(form);this.options.minicartSelector=miniCartSelector;},disableAddToCartButton:function(form){if(this._isPreviewMode()){return;}
this._super(form);},enableAddToCartButton:function(form){if(this._isPreviewMode()){return;}
this._super(form);},_isPreviewMode:function(){return(this.options.previewInput&&this.options.previewInput.val()==='1');},_findSelectedProductIds:function(){const productIdIndex=$('[data-role=swatch-options]').data('mageSwatchRenderer').options.jsonConfig.index;let selectedOptions={},foundIds=[];$('div.swatch-attribute').each(function(k,v){const attributeId=$(v).attr('attribute-id'),optionSelected=$(v).attr('option-selected');if(!attributeId||!optionSelected){return;}
selectedOptions[attributeId]=optionSelected;});$.each(productIdIndex,function(productId,attributes){const productIsSelected=function(attributes,selectedOptions){return _.isEqual(attributes,selectedOptions);};if(productIsSelected(attributes,selectedOptions)){foundIds.push(productId);}});return foundIds;}});return $.mage.catalogAddToCart;};});