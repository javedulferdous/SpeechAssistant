function MapGeohash(){this.geohashPrecision=6,this.clusterRadius=50,this.geoHashMap=new GeoHashMap,this.mapBox=null,this.query={},this.timer=null,this.initialised=!1,this.geoHashes=[],this.propertyMarkers=[],this.propertiesOnMap=[],this.visibleGeoHashes=[],this.ajaxRequests=0,this.spiderifier=null,this.markers=[],this.markersOnScreen=[],this.spiderMarkers=[],this.inMapLoading=null,this.maxBoundingBox=new mapboxgl.LngLatBounds(new mapboxgl.LngLat(2.021484375,49.82380908513249),new mapboxgl.LngLat(-10.8544921875,59.478568831926395)),this.clickedId=null,this.clickedIdMarker=null,this.boundingBox=null}$.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,(function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""})),e},MapGeohash.prototype.updateMarkers=function(){for(var e={},t=this.mapBox.querySourceFeatures("geoHashes"),r=0;r<t.length;r++){var a=t[r].geometry.coordinates,i=t[r].properties;if(i.cluster){var s=i.cluster_id,o=this.markers[s];if(!o){var n=this.createClusterElement(i,a);o=this.markers[s]=new mapboxgl.Marker({element:n}).setLngLat(a)}e[s]=o,this.markersOnScreen[s]||o.addTo(this.mapBox)}}for(var s in this.markersOnScreen)e[s]||this.markersOnScreen[s].remove();this.markersOnScreen=e},MapGeohash.prototype.createClusterElement=function(e,t){var r=document.createElement("div");r.className="marker";var a="/images/"+$("body").attr("data-map")+"/markers/map-cluster.png";r.style.backgroundImage="url("+a+")",r.style.backgroundSize="100% 100%";var i=this;r.addEventListener("click",(function(){i.spiderifier&&i.spiderifier.unspiderfy(),eventTracker.fireEvent("SearchResults","Map12827","Cluster click"),i.mapBox.getSource("geoHashes").getClusterExpansionZoom(e.cluster_id,(function(e,r){e||(i.mapBox.easeTo({center:t,zoom:r+1}),i.updateMarkers())}))}));var s=44,o=44,n=e.sum/100;(s+=n)>90&&(s=90),(o+=n)>90&&(o=90),r.style.width=s+"px",r.style.height=o+"px",r.style.textAlign="center";var p="font-size: 15px; color: black; text-align: center; padding: 1px; vertical-align: middle; line-height: "+(o+2)+"px;";return r.innerHTML='<span style="'+p+'">'+e.sum+"</span>",r},MapGeohash.prototype.createPropertyMarker=function(e){var t=document.createElement("div");t.className="marker";var r="/images/"+$("body").attr("data-map")+"/markers/map-pin.png";t.style.backgroundImage="url("+r+")",t.style.width="25px",t.style.height="40px";var a=this;t.addEventListener("click",(function(){eventTracker.fireEvent("SearchResults","Map12827","Property marker click: "+e.id),a.spiderifier&&a.spiderifier.unspiderfy()}));var i=new mapboxgl.Marker(t).setLngLat([e.lon,e.lat]);return i.setPopup(this.createPropertyPopup(e)),i},MapGeohash.prototype.createPropertiesMarker=function(e,t,r){var a=document.createElement("div");a.className="marker";var i="/images/"+$("body").attr("data-map")+"/markers/map-cluster.png";a.style.backgroundImage="url("+i+")",a.style.width="44px",a.style.height="44px",a.style.backgroundSize="100% 100%",a.style.textAlign="center";a.innerHTML='<span style="font-size: 15px; color: black; text-align: center; padding: 1px; vertical-align: middle; line-height: 43px;">'+r.length+"</span>";var s=this;return a.addEventListener("click",(function(){s.spiderifier.spiderfy([t,e],r),eventTracker.fireEvent("SearchResults","Map12827","Spiderify (lat: "+e+", long: "+t+")")})),new mapboxgl.Marker(a).setLngLat([t,e])},MapGeohash.prototype.getPropertyPopupContent=function(e){var t=e.imageUrl+"/property/448x336/"+e.id+"/?access"+e.code;if("undefined"!=typeof accuratePrice14342&&accuratePrice14342&&e.startDate)var r="<img src='"+t+"'><a target='_blank' href='"+e.url+"'><h1>"+e.name+"</h1></a><div>"+e.accuratePrice.duration+" nights from "+e.startDate+"</div><div><b>"+e.symbol+(e.accuratePrice.rent+e.accuratePrice.booking_fee-e.accuratePrice.discount)+"</b></div>";else r="<img src='"+t+"'><a target='_blank' href='"+e.url+"'><h1>"+e.name+"</h1></a><div>from "+e.symbol+e.price+"</div>";return r},MapGeohash.prototype.createPropertyPopup=function(e){var t={top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-50],"bottom-left":[25,-65],"bottom-right":[-25,-65],left:[10,-40],right:[-10,-40]},r=this.getPropertyPopupContent(e);return new mapboxgl.Popup({offset:t}).setHTML(r).setMaxWidth("250px")},MapGeohash.prototype.onMoveEnd=function(){if(this.spiderifier&&this.spiderifier.unspiderfy(),this.timer&&clearTimeout(this.timer),this.visibleGeoHashes=[],this.displayProperties(),this.visibleGeoHashes.totalPropertiesCount>0){var e=this;this.timer=setTimeout((function(){e.getVisibleProperties(e.query,(function(t){for(var r=t.results,a=0;a<r.length;a++){for(var i=!1,s=0;s<e.propertyMarkers.length;s++)if(e.propertyMarkers[s].id==r[a].id){i=!0;break}if(!i){var o={id:r[a].id,name:r[a].name,price:parseInt(r[a].price),url:r[a].url,area:r[a].area,lat:r[a].lat,lon:r[a].long,code:t.code,symbol:t.symbol,imageUrl:t.imageUrl};"undefined"!=typeof accuratePrice14342&&accuratePrice14342&&(o.accuratePrice=r[a].accuratePrice,o.startDate=r[a].startDate);var n=e.createPropertyMarker(o);n.id=r[a].id,n.lat=o.lat,n.lon=o.lon,n.prop=o,n.geoHash=Geohash.encode(o.lat,o.lon,e.geohashPrecision),e.propertyMarkers.push(n)}}e.displayProperties(),e.updateMarkers(),e.ajaxRequests--,e.ajaxRequests=e.ajaxRequests<0?0:e.ajaxRequests,0===e.ajaxRequests&&e.inMapLoading.fadeOut()}))}),800)}this.updateMarkers()},MapGeohash.prototype.displayProperties=function(){var e=this.getRenderedGeoHashes();this.visibleGeoHashes=e;for(var t=0;t<this.propertyMarkers.length;t++)this.propertyMarkers[t].remove();for(t=0;t<this.spiderMarkers.length;t++)this.spiderMarkers[t].remove();this.spiderMarkers=[],this.propertiesOnMap=[];var r=[];for(t=0;t<e.geoHashes.length;t++)for(var a=e.geoHashes[t],i=0;i<this.propertyMarkers.length;i++){var s=this.propertyMarkers[i].geoHash===a,o=!1;if(void 0!==this.propertiesOnMap[this.propertyMarkers[i].id]&&(o=!0),s&&!o){var n=Geohash.encode(this.propertyMarkers[i].lat,this.propertyMarkers[i].lon,9);void 0===r[n]&&(r[n]=[]),r[n].push(this.propertyMarkers[i]),this.propertiesOnMap[this.propertyMarkers[i].id]=!0}}for(var p in r){if(r[p].length>1){var h=r[p][0],d=this.createPropertiesMarker(h.lat,h.lon,r[p]);d.addTo(this.mapBox),this.spiderMarkers.push(d)}else{r[p][0].addTo(this.mapBox)}}},MapGeohash.prototype.onLoad=function(){if(!this.initialised){var e=this;this.geoHashMap.getGeoHashesAsGeoJson(this.query,(function(t){for(var r=new mapboxgl.LngLatBounds,a=0;a<t.features.length;a++){var i=t.features[a].geometry.coordinates;e.maxBoundingBox.contains(i)&&r.extend(i)}e.boundingBox=r,r.isEmpty()||e.mapBox.fitBounds(r,{padding:{top:35,bottom:35,left:35,right:35}}),e.mapBox.addSource("geoHashes",{type:"geojson",data:t,cluster:!0,clusterRadius:e.clusterRadius,clusterProperties:{sum:["+",["get","count"]]}}),e.mapBox.addLayer({id:"clusters",type:"circle",source:"geoHashes",filter:["has","sum"],paint:{"circle-color":"rgba(0, 0, 0, 0.0)","circle-radius":0,"circle-stroke-width":0,"circle-stroke-color":"#fff"}}),e.mapBox.addLayer({id:"unclustered-point",type:"circle",source:"geoHashes",filter:["!",["has","sum"]],paint:{"circle-color":"#11b4da","circle-radius":1,"circle-stroke-width":1,"circle-stroke-color":"#fff"}}),$(".map11174-modal").find(".map11174-loading").eq(0).hide(),e.initialised=!0}))}},MapGeohash.prototype.getRenderedGeoHashes=function(){for(var e=this.mapBox.querySourceFeatures("geoHashes"),t=[],r=[],a=0,i=0;i<e.length;i++)void 0!==e[i].properties.geoHash&&(t.push(e[i].properties.geoHash),a+=e[i].properties.count,r.push({geoHash:e[i].properties.geoHash,count:e[i].properties.count}));return{geoHashes:t,totalPropertiesCount:a,geoHashesWithCount:r}},MapGeohash.prototype.getVisibleProperties=function(e,t){for(var r=this.visibleGeoHashes,a=[],i=0,s=0;s<r.geoHashesWithCount.length;s++){for(var o=r.geoHashesWithCount[s],n=!1,p=0;p<this.geoHashes.length;p++)if(this.geoHashes[p]===o.geoHash){n=!0;break}n||(a.push(o.geoHash),i+=o.count,this.geoHashes.push(o.geoHash))}var h=a.join(","),d=Object.assign({},e);d.size=i,d.geohashes=h,d.size>0&&(this.inMapLoading.fadeIn(),this.ajaxRequests++,$.ajax({type:"POST",url:"/map-properties",data:d,success:t}))},MapGeohash.prototype.openWithProperty=function(e){this.clickedIdMarker&&this.clickedIdMarker.remove();var t={fixed_property_id:e};this.inMapLoading.fadeIn();var r=this;$.ajax({type:"POST",url:"/map-properties",data:t,success:function(e){var t=e.results;if(void 0!==t[0]){var a=t[0],i={id:a.id,name:a.name,price:parseInt(a.price),url:a.url,area:a.area,lat:a.lat,lon:a.long,code:e.code,symbol:e.symbol,imageUrl:e.imageUrl},s=r.createPropertyMarker(i);s.id=i.id,s.lat=i.lat,s.lon=i.lon,s.prop=i,s.geoHash=Geohash.encode(i.lat,i.lon,r.geohashPrecision),r.inMapLoading.fadeOut(),s.addTo(r.mapBox),s.getPopup().addTo(r.mapBox),r.clickedIdMarker=s,r.boundingBox?r.mapBox.fitBounds(r.boundingBox):r.mapBox.fitBounds(r.maxBoundingBox)}}})},MapGeohash.prototype.init=function(){if(this.initialised)return $(".map11174-modal").fadeIn(),eventTracker.fireEvent("SearchResults","Map12827","Reopened"),void(this.clickedId&&this.openWithProperty(this.clickedId));eventTracker.fireEvent("SearchResults","Map12827","Opened");$("body").append("<div class='map11174-modal' style='background:rgb(240, 240, 240);'><div class='map11174-loading'><div class='loading'><img style='width: 20%;' src='/images/horizontal_loading.gif' alt='Loading...'></div></div><div id='map11174-inmap-loading'><img src='/images/spinner-logo.gif\n' alt='Loading...'></div><div id='map11174-close'></div><div id='map'></div></div>"),this.inMapLoading=$("#map11174-inmap-loading"),this.inMapLoading.hide(),mapboxgl.accessToken=mapboxSearchpageMainToken,this.mapBox=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v9?optimize=true",attributionControl:!1,bounds:this.maxBoundingBox}),this.mapBox.setRenderWorldCopies(!1),this.clickedId&&this.openWithProperty(this.clickedId);var e=this;this.spiderifier=new MapboxglSpiderifier(this.mapBox,{customPin:!0,initializeLeg:function(t){var r,a=t.elements.pin,i="/images/"+$("body").attr("data-map")+"/markers/map-pin.png";a.style.backgroundImage="url("+i+")",a.style.width="25px",a.style.height="40px",a.style.position="relative",a.style.marginLeft="-10px",a.style.marginTop="-10px",(r=new mapboxgl.Popup({closeButton:!0,closeOnClick:!0,offset:MapboxglSpiderifier.popupOffsetForSpiderLeg(t,25)})).setHTML(e.getPropertyPopupContent(t.feature.prop)).setMaxWidth("250px"),t.mapboxMarker.setPopup(r)}});var t=$("#search").find("form").eq(0);t.length||(t=$("#main-search-form")),$(".carousel-form").find("form").length&&(t=$(".carousel-form").find("form").eq(0));var r,a=t.serializeObject();a.precision=this.geohashPrecision,void 0!==a.start&&"object"==typeof a.start&&(a.start=a.start[0]),"undefined"!=typeof properties_for_map&&(a.npropertyids=properties_for_map),this.query=a,this.mapBox.on("moveend",this.onMoveEnd.bind(this)),this.mapBox.on("move",this.onMove.bind(this)),this.mapBox.on("load",this.onLoad.bind(this)),this.mapBox.on("data",this.onData.bind(this)),this.mapBox.on("render",(function(){r&&clearInterval(r),r=setTimeout((function(){e.onMoveEnd()}),500)})),$("#map11174-close").click((function(){eventTracker.fireEvent("SearchResults","Map12827","Closed"),$(".map11174-modal").fadeOut(),window.location.hash="#close-map"}))},MapGeohash.prototype.onData=function(e){"geoHashes"===e.sourceId&&e.isSourceLoaded&&(this.onMoveEnd(),this.updateMarkers())},MapGeohash.prototype.onMove=function(){this.updateMarkers()},$((function(){var e=new MapGeohash;"#view-map"===document.location.hash&&(eventTracker.fireEvent("SearchResults","Map12827","Opened with url view-map"),e.init()),$("[data-role=view-on-map]").click((function(){eventTracker.fireEvent("SearchResults","Map12827","Opened with click");var t=$(this).attr("data-id");void 0!==t&&(e.clickedId=t,eventTracker.fireEvent("SearchResults","Map12827","Opened with popup: "+t)),e.init()}))}));