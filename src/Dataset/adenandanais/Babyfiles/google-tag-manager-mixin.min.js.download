define(['mage/utils/wrapper','jquery','Magento_Customer/js/customer-data'],function(wrapper,$,customerData){'use strict';return function(googleTagManagerFunction){return wrapper.wrap(googleTagManagerFunction,function(originalGoogleTagManagerFunction,config){originalGoogleTagManagerFunction(config);let allowServices=false,allowedCookies,allowedWebsites;if(config.isCookieRestrictionModeEnabled){allowedCookies=$.mage.cookies.get(config.cookieName);if(allowedCookies!==null){allowedWebsites=JSON.parse(allowedCookies);if(allowedWebsites[config.currentWebsite]===1){allowServices=true;}}}else{allowServices=true;}
if(allowServices&&config.generalData){let customer=customerData.get('customer'),cart=customerData.get('cart');if($.isEmptyObject(cart())){cart.subscribe(function(updatedCart){pushGeneralData(customer(),updatedCart);this.dispose();});}else{pushGeneralData(customer(),cart());}}
function pushGeneralData(customer,cart){let skus={},productData=[];if(customer.customer_id){config.generalData.customerId=customer.customer_id;}
if(cart.subtotalAmount){config.generalData.ecommerce.cart.total=parseFloat(parseFloat(cart.subtotalAmount).toFixed(2));}
config.generalData.ecommerce.cart.quantity=cart.summary_count;if(cart.items.length){cart.items.forEach(function(product){skus[product.product_sku]={'qty':product.qty};});}
productsDataApi(Object.keys(skus).join(';'),function(){if(window.productsData){for(let productSku in skus){if(window.productsData.hasOwnProperty(productSku)){let product=window.productsData[productSku];productData.push({'name':product.sizeSelectable?product.parentName||product.name:product.name,'id':product.sizeSelectable?product.parentSku||product.sku:product.sku,'price':product.price,'brand':product.brand,'category':product.category,'variant':product.variant||'N/A','qty':skus[productSku].qty,'dimension2':product.dimension2,'dimension3':product.dimension3,'dimension11':product.dimension11||'N/A','dimension12':product.dimension12||'N/A'});}}
if(productData.length){config.generalData.ecommerce.products=productData;}}
dataLayer.push(config.generalData);});}});};});