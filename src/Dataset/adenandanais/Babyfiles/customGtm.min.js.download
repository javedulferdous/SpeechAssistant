const ADD_TO_CART='addToCart';const REMOVE_FROM_CART='removeFromCart';const SHIPMENT_STEP=2;const PAYMENT_STEP=3;function isGtmAvailable(){return!!window.dataLayer;}
function shipmentStepInit(){window.shipmentStep=false;}
function paymentStepInit(){window.paymentStep=false;}
function shipmentStepProcessed(){window.shipmentStep=true;}
function paymentStepProcessed(){window.paymentStep=true;}
function isShipmentStepProcessed(){return window.shipmentStep;}
function isPaymentStepProcessed(){return window.paymentStep;}
function getPageName(){let body=document.getElementsByTagName('body'),minicart=document.getElementsByClassName('minicart-modal'),classes=body[0].classList,page='';if(minicart[0]&&minicart[0].classList.contains('_show')){return'minicart';}
if(classes.contains('catalog-product-view')){page='pdp';}else if(classes.contains('catalog-category-view')){page='category';}else if(classes.contains('catalogsearch-result-index')){page='search';}else if(classes.contains('checkout-cart-index')){page='cart';}else if(classes.contains('wishlist-index-index')){page='wishlist';}else if(classes.contains('cms-index-index')){page='home';}else if(classes.contains('cms-page-view')){page='cms';}
return page;}
function getProductData(sku,callback){if(!callback){return;}
if(window.productsData&&window.productsData.hasOwnProperty(sku)){callback(window.productsData[sku]);}else{productsDataApi(sku,function(){if(window.productsData.hasOwnProperty(sku)){callback(window.productsData[sku]);}});}}
function shipmentGtmTrack(method,quote,event){if(!jQuery(event.target).hasClass('radio')&&quote){if(!isShipmentStepProcessed()){checkoutStepAction(quote.getItems(),'shipping',SHIPMENT_STEP,shipmentStepProcessed);}
onShipmentOption(method,quote.getBasePriceFormat().pattern);}}
function paymentGtmTrack(method,quote){if(!isPaymentStepProcessed()){checkoutStepAction(quote.getItems(),'payment',PAYMENT_STEP,paymentStepProcessed);}
onPaymentOption(method.title);}
function onShipmentOption(method,pricePattern){if(method&&pricePattern){let price=pricePattern.replace(/%s/g,method.amount),title=method.method_title;onCheckoutOption(`${title} ${price}`,SHIPMENT_STEP);}}
function onPaymentOption(title){onCheckoutOption(title,PAYMENT_STEP);}
function onCheckoutOption(option,step){gtmPush({'event':'checkoutOption','ecommerce':{'checkout_option':{'actionField':{'step':step,'option':option}}}});}
function gtmPush(dl){if(isGtmAvailable()){window.dataLayer.push(dl);}}
function getProductsData(skuString,callback){if(!callback){return;}
let missingItemList,skuArray=skuString.split(';');if(!window.productsData){missingItemList=skuArray;}else{missingItemList=skuArray.filter(function(sku){return!window.productsData.hasOwnProperty(sku);});}
if(window.productsData&&!missingItemList.length){callback(window.productsData);}else{productsDataApi(missingItemList.join(';'),function(){callback(window.productsData);});}}
function pushData(eventType,productsData,process='add'){let products=[],datalayerObj={'event':eventType,'ecommerce':{'currencyCode':window.storeCurrency,}};for(let index in productsData){if(productsData.hasOwnProperty(index)){products.push(productDataPrepare(productsData[index]));}}
datalayerObj['ecommerce'][process]={'products':products}
gtmPush(datalayerObj);}
function miniCartProcess(element){let input=jQuery(element).closest('.details-qty__wrapper').find('input.item-qty'),sku=input.data('cartItemId');cartDataSet(element,input,sku);}
function checkoutCartProcess(element){let input=jQuery(element).closest('.product-item-details').find('input.qty'),sku=input.data('itemSku');cartDataSet(element,input,sku);}
function pdpCartProcess(element,sku){let childSku=jQuery('input[name="productSku"]');if(childSku.length){sku=childSku.val();}
cartUpdate(element,sku);}
function checkoutStepAction(quoteItems=[],description,step,callback){if(!isGtmAvailable()){return;}
let skus=getSkuListFromQuote(quoteItems).join(';'),dl={'event':'checkout','ecommerce':{'currencyCode':window.storeCurrency,'checkout':{'actionField':{'step':step,'action':'checkout','description':description},'products':[]}}};getProductsData(skus,function(){let variant='N/A',quantity=1,skuArray=skus.split(';');for(let item in skuArray){if(skuArray.hasOwnProperty(item)){let sku=skuArray[item];if(window.productsData.hasOwnProperty(sku)){let product=window.productsData[sku];product.variant=product.variant||variant;let itemQty=quoteItems.find(function(quoteItem){return quoteItem.sku===sku;});product.quantity=parseInt(itemQty.qty)||quantity;dl.ecommerce.checkout.products.push(productDataPrepare(product));}}}
gtmPush(dl);callback();});}
function productDataPrepare(product){return{'id':product.sizeSelectable?product.parentSku||product.sku:product.sku,'name':product.sizeSelectable?product.parentName||product.name:product.name,'category':product.category,'brand':window.storeBrand,'price':parseFloat(product.price),'quantity':parseInt(product.quantity)||parseInt(product.qty),'variant':product.variant,'dimension2':product.dimension2,'dimension3':product.dimension3,'dimension11':product.dimension11||'N/A','dimension12':product.dimension12||'N/A'};}
function getSkuListFromQuote(items){return items.map(function(item){return item.sku;})}
function cartDataSet(element,input,sku){let cartStatusUpdate=cartQtyProcess(parseInt(input.data('itemQty')),parseInt(input.val()));if(cartStatusUpdate&&cartStatusUpdate.diff>0){cartUpdate(element,sku,cartStatusUpdate.diff,cartStatusUpdate.process);}}
function cartQtyProcess(initQty,newQty){if(isNaN(newQty)||isNaN(initQty)||newQty===initQty){return;}
let qtyDiff=newQty-initQty,process='add';if(qtyDiff<0){process='remove'}
return{diff:Math.abs(qtyDiff),process:process};}
function cartDLBulkUpdate(){if(!isGtmAvailable()||getPageName()!=='cart'||!jQuery('#form-validate').valid()){return;}
jQuery('#shopping-cart-table .input-text.qty').each(function(){let input=jQuery(this),sku=input.data('cartItemId');cartDataSet(null,input,sku);})}
function cartUpdate(element,sku,qty=null,process='add'){if(!isGtmAvailable()){return;}
let event=(process==='add')?ADD_TO_CART:REMOVE_FROM_CART,variant='N/A',quantity=!!qty?qty:jQuery(element).closest('.fieldset').find('input.qty').val(),sizeAttributes=jQuery('.swatch-attribute.size');if(!qty&&sizeAttributes.length){variant=sizeAttributes.find('.swatch-attribute-selected-option').html();}
getProductData(sku,function(product){if(!product.variant){product.variant=variant;}
product.quantity=quantity;pushData(event,[product],process);});}
function addWishListToCart(skuArrayString){if(!isGtmAvailable()||!skuArrayString){return;}
productsDataApi(skuArrayString,function(){let event=ADD_TO_CART,variant='N/A',quantity=1,products=[],skuArray=skuArrayString.split(';');for(let item in skuArray){if(skuArray.hasOwnProperty(item)){let sku=skuArray[item];if(window.productsData.hasOwnProperty(sku)){let product=window.productsData[sku];if(!product.variant){product.variant=variant;}
product.quantity=parseInt(jQuery(`input[data-sku="${sku}"]`).val())||quantity;products.push(product);}}}
pushData(event,products);});}