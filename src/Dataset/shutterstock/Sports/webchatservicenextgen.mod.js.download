/*!
 * widgets
 * @version: 9.0.017.11
 * @license: Genesys Telecom Labs
 */
widgetsJsonpFunction([24],{"./webapp/plugins/cx-webchat-service/controllers/transport-controller.js":function(e,t,n){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n("./node_modules/jquery/dist/jquery.js"),s=o(a),i=n("./webapp/plugins/cx-common/cx-common.js"),d=o(i);CXBus.registerModule("webchatservicenextgen",function(){function e(){y=!1,T=[],D=[]}function t(){d.default.deleteCookie(C)}function n(e,t){e().done(function(e){t.deferred.resolve(e)}).fail(function(e){t.deferred.reject(e)})}function o(e){for(var t=0;t<S.standard.length;t++)if((e+"").match(S.standard[t]))return!1;for(var n=0;n<S.custom.length;n++)if((e+"").match(S.custom[n]))return!1;return!0}function a(){for(var e,t={custom:[]},n=0;n<S.custom.length;n++)e=S.custom[n],t.custom.push({source:e.source,flags:e.flags});d.default.setCookie(C,JSON.stringify(t))}function i(){if(d.default.getCookie(C)){var e=JSON.parse(d.default.getCookie(C));return s.default.each(e.custom,function(){S.custom.push(new RegExp(this.source,this.flags))}),!0}return!1}function c(e){if(e instanceof RegExp){e.length||(e=[e]);for(var t=0;t<e.length;t++)S.custom.filter(function(n){return String(n)===String(e[t])}).length||S.custom.push(e[t]);a()}}function l(){S.custom=[],d.default.deleteCookie(C)}function u(e,t){"string"==typeof e&&t instanceof RegExp&&(c(t),m.command("sendMessage",{message:e}))}function f(e){return w.push(e),e}function p(e){var t=s.default.Deferred(),n=w.length;return n?w.forEach(function(o,r){e=o(e)||e,n===r+1&&t.resolve(e)}):t.resolve(e),t.promise()}function g(a){var d=s.default.Deferred(),g={async:!1,asyncClose:"hideChat",pagination:!1,fileUpload:!0};if(m.registerEvents(["ready","restored","restoreTimeout","restoreFailed","messageReceived","error","started","ended","agentTypingStarted","agentTypingStopped","agentTypingTimeout","pollingStarted","pollingStopped","clientConnected","clientDisconnected","agentConnected","agentDisconnected","supervisorConnected","supervisorDisconnected","clientTypingStarted","clientTypingStopped","ajaxResponse","disconnected","reconnected","chatServerWentOffline","chatServerBackOnline","capabilitiesChanged","sleeping","waking","sessionLost"]),b.sleepEnabled&&m.data("sleeping",!1),b&&v){var C="";"pureengage-v3-rest"==v?C="pure-engage-v3-rest-transport":"purecloud-v2-sockets"==v?C="pure-cloud-v2-sockets-transport":"pureconnect-v4-rest"==v?C="pure-connect-v4-rest-transport":"pureconnect-v4-chatbots"==v?C="pure-connect-v4-bots-transport":a.deferred.reject("Invalid transport configuration"),C&&CXBus.loadModule(C).done(function(a){h=new a(b),h.onChatStarted=function(e,t){m.publish("started",e),m.command("App.registerAutoLoad")},h.onPollingStarted=function(){m.publish("pollingStarted")},h.onPollingStopped=function(){m.publish("pollingStopped")},h.onTypingStarted=function(){m.publish("clientTypingStarted")},h.onTypingStopped=function(){m.publish("clientTypingStopped")},h.onAgentConnected=function(e){m.publish("agentConnected",e)},h.onAgentDisconnected=function(e){m.publish("agentDisconnected",e)},h.onAgentTypingStarted=function(e){m.publish("agentTypingStarted",e)},h.onAgentTypingTimeout=function(e){m.publish("agentTypingTimeout",e)},h.onAgentTypingStopped=function(e){m.publish("agentTypingStopped",e)},h.onBotConnected=function(e){m.publish("botConnected",e)},h.onBotDisconnected=function(e){m.publish("botDisconnected",e)},h.onSuperVisorConnected=function(e){m.publish("supervisorConnected",e)},h.onSuperVisorDisconnected=function(e){m.publish("supervisorDisconnected",e)},h.onClientConnected=function(e){m.publish("clientConnected",e)},h.onClientDisconnected=function(e){m.publish("clientDisconnected",e)},h.onSleep=function(){b.sleepEnabled&&m.publish("sleeping")},h.onWake=function(){m.publish("waking")},h.onMessageReceived=function(e){if(e.data){var t=e.data;t.messages instanceof Array&&(t.messages=t.messages.filter(function(e){return o(e.text||"")}).map(function(e){var t=null;return p(e).done(function(e){t=e}),t}),T=T.concat(t.messages)),t.originalMessages instanceof Array&&(t.originalMessages=t.originalMessages.filter(function(e){return o(e.body||e.text||"")}),D=D.concat(t.originalMessages)),t.messages&&t.messages.length>0&&m.publish("messageReceived",{originalMessages:t.originalMessages,messages:t.messages,restoring:t.restoring,sessionData:t.sessionData,oldMessages:t.oldMessages})}},h.onCapabilitiesChanged=function(e){e.async&&(g.async=e.async),e.asyncClose&&(g.asyncClose=e.asyncClose),"boolean"==typeof e.pagination&&(g.pagination=e.pagination),"boolean"==typeof e.fileUpload&&(g.fileUpload=e.fileUpload),m.data("capabilities",g),m.publish("capabilitiesChanged",g)},h.onRestore=function(e){m.publish("restored",e),e&&e.async&&m.data("WebChatService.mode",{async:!0})},h.onRestoreFailed=function(n){e(),t(),m.publish("restoreFailed",n)},h.onRestoreTimeout=function(){t(),m.publish("restoreTimeout")},h.onReconnected=function(){m.publish("reconnected")},h.onDisconnected=function(){m.publish("disconnected")},h.onChatServerWentOffline=function(){m.publish("chatServerWentOffline")},h.onChatServerBackOnline=function(){m.publish("chatServerBackOnline")},h.onChatEnded=function(){e(),t(),l(),m.publish("clientDisconnected"),m.publish("ended"),m.command("App.deregisterAutoLoad")},h.onSessionLost=function(n){e(),t(),m.publish("sessionLost",n)},h.onError=function(e){m.publish("error",{errors:[e]})},m.registerCommand("startChat",function(e){y?e.deferred.reject("There is already an active chat session"):(b.sleepEnabled&&m.command("wake"),e.data&&(e.data.userData&&m.data("userData",s.default.extend(!0,m.data("userData"),e.data.userData||{})),e.data.interactionData&&m.data("interactionData",s.default.extend(!0,m.data("interactionData"),e.data.interactionData||{}))),h.startChat(e.data).done(function(t){m.publishDirect("ajaxResponse",t),y=!0,e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)}))}),m.registerCommand("sendMessage",function(e){x.Interval&&h.onTypingStopped(),clearInterval(x.Interval),x.Interval=!1,x.Timer=0,x.text="",x.IdleCount=0,"string"!=typeof e.data.message||""==(e.data.message+"").trim()?e.deferred.reject("No message text provided"):(b.sleepEnabled&&m.command("wake"),h.sendMessage(e.data).done(function(t){e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)}))}),m.registerCommand("endChat",function(e){h.endChat().done(function(t){e.deferred.resolve(t||{})}).fail(function(t){e.deferred.reject(t)}),y=!1}),m.registerCommand("asyncRestore",function(e){h.asyncRestore().done(function(){y=!0,e.deferred.resolve()}).fail(function(){e.deferred.reject()})}),m.registerCommand("fetchHistory",function(e){h.fetchHistory().done(function(t){e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)})}),m.registerCommand("getSessionData",function(e){e.deferred.resolve(h.fetchSessionData())}),m.registerCommand("startPoll",function(e){if(!y)return e.deferred.reject("There is no active chat session"),!1;"function"==typeof h.startPoll?(h.startPoll(),e.deferred.resolve()):e.deferred.reject("This transport doesn't support polling.")}),m.registerCommand("pausePoll",function(e){if(!y)return e.deferred.reject("There is no active chat session"),!1;"function"==typeof h.pausePoll?(h.pausePoll(),e.deferred.resolve()):e.deferred.reject("This transport doesn't support polling.")}),m.registerCommand("stopPoll",function(e){"function"==typeof h.stopPoll?h.stopPoll().done(function(){e.deferred.resolve()}).fail(function(t){e.deferred.reject(t)}):e.deferred.reject("This transport doesn't support polling.")}),m.registerCommand("poll",function(e){e.commander!=m.namespace()&&e.deferred.reject("Access Denied to private command. Only WebChatService is allowed to invoke this command"),"function"==typeof h.poll?h.poll().done(function(){e.deferred.resolve()}).fail(function(t){e.deferred.reject(t)}):e.deferred.reject("This transport doesn't support polling.")}),m.registerCommand("resetPollExceptions",function(e){"function"==typeof h.resetPollExceptions?n(h.resetPollExceptions,e):e.deferred.reject("This transport doesn't support resetPollExceptions command.")}),m.registerCommand("getAgents",function(e){e.deferred.resolve({agents:h.getAgents()})}),m.registerCommand("getTranscript",function(e){e.deferred.resolve({messages:T,originalMessages:D})}),m.registerCommand("getStats",function(e){var t={agents:h.getAgents()||{},startTime:!1,endTime:!1,duration:!1};T.length>0&&(t.startTime=T[0].timestamp,t.endTime=T[T.length-1].timestamp,t.duration=new Date(t.endTime)-new Date(t.startTime)),e.deferred.resolve(t)}),m.registerCommand("registerPreProcessor",function(e){"function"==typeof e.data.preprocessor&&"function"==typeof f?e.deferred.resolve(f(e.data.preprocessor)):e.deferred.reject("No preprocessor function provided. Type provided was '"+r(e.data.preprocessor)+"'.")}),m.registerCommand("getFileLimits",function(e){"function"==typeof h.getFileLimits?n(h.getFileLimits,e):e.deferred.reject("This transport doesn't support getFileLimits command.")}),m.registerCommand("sendCustomNotice",function(e){"function"==typeof h.sendCustomNotice?n(h.sendCustomNotice,e):e.deferred.reject("This transport doesn't support sendCustomNotice command.")}),m.registerCommand("downloadFile",function(e){"function"==typeof h.downloadFile?n(h.downloadFile,e):e.deferred.reject("This transport doesn't support file download.")}),m.registerCommand("addPrefilter",function(e){if(e.data.filters&&e.data.filters instanceof RegExp)c(e.data.filters),e.deferred.resolve(s.default.extend({},S.custom));else if(e.data.filters&&e.data.filters.length>0&&e.data.filters[0]instanceof RegExp){for(var t=0;t<e.data.filters.length;t++)c(e.data.filters[t]);e.deferred.resolve(s.default.extend({},S.custom))}else e.deferred.reject("Missing or invalid filters provided. Please provide a regular expression or an array of regular expressions")}),m.registerCommand("sendFilteredMessage",function(e){y?(u(e.data.message,e.data.regex),e.deferred.resolve()):e.deferred.reject("No active chat session.")}),m.registerCommand("restore",function(e){var t=e.data&&e.data.sessionData||{};h.restore(t).done(function(t){y=!0,e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)})}),m.registerCommand("sendFile",function(e){h.sendFile(e).done(function(t){e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)})}),m.registerCommand("registerTypingPreviewInput",function(e){var t=(0,s.default)(e.data.input);!t||"text"!=t[0].type&&"textarea"!=t[0].type?e.deferred.reject("Invalid value provided for the 'input' property. An HTML element reference to a textarea or text input is required."):(j=(0,s.default)(t),e.deferred.resolve())}),m.registerCommand("updateUserData",function(e){var t=b,n=m.data("userData")||{};m.data("userData",s.default.extend(!0,n,e.data||{})),s.default.extend(!0,t.oUserData,m.data("userData")),y?h.updateUserData(e.data).done(function(t){e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)}):e.deferred.resolve(t.oUserData)}),m.registerCommand("updateInteractionData",function(e){var t=b,n=m.data("interactionData")||{};m.data("interactionData",s.default.extend(!0,n,e.data||{})),s.default.extend(!0,t.oInteractionData,m.data("interactionData")),y?h.updateInteractionData(e.data).done(function(t){e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)}):e.deferred.resolve(t.oInteractionData)}),m.registerCommand("sendTyping",function(e){var t=x;if(t.Interval)t.Timer=0,e.deferred.resolve();else{var n=e.data,o=!1;n.type="TypingStarted",n.message=n.message||j&&j.val()||"",o=h.sendTyping(n),h.onTypingStarted(),t.Interval=setInterval(function(){t.Timer+=t.TimeInterval,t.Timer>=t.Timeout&&(n.type="TypingStopped",n.message=n.message||j&&j.val()||"",clearInterval(t.Interval),t.Interval=!1,t.Timer=0,o=h.sendTyping(n),h.onTypingStopped())},t.TimeInterval),o.done(function(t){e.deferred.resolve(t)}).fail(function(t){e.deferred.reject(t)})}}),m.registerCommand("sleep",function(e){b.sleepEnabled&&!m.data("sleeping")&&y&&(m.publish("sleeping"),m.data("sleeping",!0),"function"==typeof h.pausePoll&&h.pausePoll()),e.deferred.resolve()}),m.registerCommand("wake",function(e){b.sleepEnabled&&m.data("sleeping")&&y&&(m.publish("waking"),m.data("sleeping",!1),"function"==typeof h.continuePoll&&h.continuePoll()),e.deferred.resolve()}),m.subscribe("App.data.pageFocus",function(e){b.sleepEnabled&&y&&(!1===e.data.value?m.command("sleep"):!0===e.data.value&&m.command("wake"))}),m.subscribe("App.data.pageHidden",function(e){b.sleepEnabled&&y&&(!1===e.data.value?m.command("wake"):!0===e.data.value&&m.command("sleep"))}),i(),m.ready(),m.republish("ready"),d.resolve()})}return d.promise()}var m="",v="",h={},y=!1,b={sCookie_Prefix:"_genesys.widgets.webchat.state",oUserData:{},oInteractionData:{},sleepEnabled:!1},C=b.sCookie_Prefix+".filters",T=[],D=[],S={standard:[/\{start\:[0-9]{9}\}/],custom:[]},j=!1,x={Timer:0,Timeout:2e3,TimeInterval:100,Interval:!1,IdleCount:0,IdleLimit:2,Text:""},w=[];return{init:function(e){(m=e)&&(m.registerCommand("configure",function(e){if(e.data&&Object.keys(e.data).length){var t=e.data,n="object",o=b;if(r(t.userData)==n&&s.default.extend(o.oUserData,t.userData),"number"==r(t.ajaxTimeout)&&(o.iAjaxTimeout=parseInt(t.ajaxTimeout)),r(t.transport)==n){var a=t.transport;"string"==r(a.type)&&(v=a.type),r(a.interactionData)==n&&(o.oInteractionData=a.interactionData),"boolean"==r(a.sleepEnabled)&&(o.sleepEnabled=a.sleepEnabled),o.transport=a}m.data("userData",o.oUserData),m.data("interactionData",o.oInteractionData),"boolean"==typeof t.enableCustomHeader&&(o.bEnableCustomHeader=t.enableCustomHeader),g(e).done(function(){m.command("asyncRestore")}).fail(function(t){e.deferred.reject(t)}),e.deferred.resolve()}else e.deferred.reject("Invalid configuration")}),m.command("configure",_genesys.widgets.webchat))}}})}},["./webapp/plugins/cx-webchat-service/controllers/transport-controller.js"]);