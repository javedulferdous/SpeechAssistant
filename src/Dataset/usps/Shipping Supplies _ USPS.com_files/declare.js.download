define(["./kernel","../has","./lang"],function(w,E,z){function u(d,c){throw Error("declare"+(c?" "+c:"")+": "+d);}function F(d,c,a){var b,f=this._inherited=this._inherited||{};if("string"==typeof d){var e=d;d=c;c=a}a=0;var k=d.callee;(e=e||k.nom)||u("can't deduce a name to call inherited()",this.declaredClass);var m=this.constructor._meta;var l=m.bases;var g=f.p;if("constructor"!=e){if(f.c!==k){g=0;var h=l[0];m=h._meta;if(m.hidden[e]!==k){(b=m.chains)&&"string"==typeof b[e]&&u("calling chained method with inherited: "+
e,this.declaredClass);do if(m=h._meta,b=h.prototype,m&&(b[e]===k&&b.hasOwnProperty(e)||m.hidden[e]===k))break;while(h=l[++g]);g=h?g:-1}}if(h=l[++g])if(b=h.prototype,h._meta&&b.hasOwnProperty(e))a=b[e];else{k=v[e];do if(b=h.prototype,(a=b[e])&&(h._meta?b.hasOwnProperty(e):a!==k))break;while(h=l[++g])}a=h&&a||v[e]}else{if(f.c!==k&&(g=0,(m=l[0]._meta)&&m.ctor!==k)){for((b=m.chains)&&"manual"===b.constructor||u("calling chained constructor with inherited",this.declaredClass);(h=l[++g])&&(!(m=h._meta)||
m.ctor!==k););g=h?g:-1}for(;(h=l[++g])&&!(a=(m=h._meta)?m.ctor:h););a=h&&a}f.c=a;f.p=g;if(a)return!0===c?a:a.apply(this,c||d)}function H(d,c){return"string"==typeof d?this.__inherited(d,c,!0):this.__inherited(d,!0)}function I(d,c,a){var b=this.getInherited(d,c);if(b)return b.apply(this,a||c||d)}function J(d){for(var c=this.constructor._meta.bases,a=0,b=c.length;a<b;++a)if(c[a]===d)return!0;return this instanceof d}function K(d,c){for(var a in c)"constructor"!=a&&c.hasOwnProperty(a)&&(d[a]=c[a]);if(E("bug-for-in-skips-shadowed"))for(var b=
z._extraNames,f=b.length;f;)a=b[--f],"constructor"!=a&&c.hasOwnProperty(a)&&(d[a]=c[a])}function L(d){x.safeMixin(this.prototype,d);return this}function M(d,c){return x([this].concat(d),c||{})}function N(d,c){return function(){var a=arguments,b=a,f=a[0],e;var k=d.length;if(!(this instanceof a.callee))return B(a);if(c&&(f&&f.preamble||this.preamble)){var m=Array(d.length);m[0]=a;for(e=0;;){(f=a[0])&&(f=f.preamble)&&(a=f.apply(this,a)||a);f=d[e].prototype;(f=f.hasOwnProperty("preamble")&&f.preamble)&&
(a=f.apply(this,a)||a);if(++e==k)break;m[e]=a}}for(e=k-1;0<=e;--e)f=d[e],(f=(k=f._meta)?k.ctor:f)&&f.apply(this,m?m[e]:a);(f=this.postscript)&&f.apply(this,b)}}function O(d,c){return function(){var a=arguments,b=a,f=a[0];if(!(this instanceof a.callee))return B(a);c&&(f&&(f=f.preamble)&&(b=f.apply(this,b)||b),(f=this.preamble)&&f.apply(this,b));d&&d.apply(this,a);(f=this.postscript)&&f.apply(this,a)}}function P(d){return function(){var c=arguments,a=0,b,f;if(!(this instanceof c.callee))return B(c);
for(;b=d[a];++a)if(b=(f=b._meta)?f.ctor:b){b.apply(this,c);break}(b=this.postscript)&&b.apply(this,c)}}function Q(d,c,a){return function(){var b,f=0,e=1;a&&(f=c.length-1,e=-1);for(;b=c[f];f+=e){var k=b._meta;(b=(k?k.hidden:b.prototype)[d])&&b.apply(this,arguments)}}}function G(d){C.prototype=d.prototype;d=new C;C.prototype=null;return d}function B(d){var c=d.callee,a=G(c);c.apply(a,d);return a}function x(d,c,a){"string"!=typeof d&&(a=c,c=d,d="");a=a||{};var b,f,e,k=1,m=c;if("[object Array]"==y.call(c)){k=
d;var l=[];var g=[{cls:0,refs:[]}];var h={};var p=1;for(var w=c.length,t=0,q,A,n,r;t<w;++t){(q=c[t])?"[object Function]"!=y.call(q)&&u("mixin #"+t+" is not a callable constructor.",k):u("mixin #"+t+" is unknown. Did you use dojo.require to pull it in?",k);A=q._meta?q._meta.bases:[q];n=0;for(q=A.length-1;0<=q;--q)r=A[q].prototype,r.hasOwnProperty("declaredClass")||(r.declaredClass="uniqName_"+R++),r=r.declaredClass,h.hasOwnProperty(r)||(h[r]={count:0,refs:[],cls:A[q]},++p),r=h[r],n&&n!==r&&(r.refs.push(n),
++n.count),n=r;++n.count;g[0].refs.push(n)}for(;g.length;){n=g.pop();l.push(n.cls);for(--p;b=n.refs,1==b.length;){n=b[0];if(!n||--n.count){n=0;break}l.push(n.cls);--p}if(n)for(t=0,w=b.length;t<w;++t)n=b[t],--n.count||g.push(n)}p&&u("can't build consistent linearization",k);q=c[0];l[0]=q?q._meta&&q===l[l.length-q._meta.bases.length]?q._meta.bases.length:1:0;p=l;g=p[0];k=p.length-g;c=p[k]}else p=[0],c?"[object Function]"==y.call(c)?(g=c._meta,p=p.concat(g?g.bases:c)):u("base class is not a callable constructor.",
d):null!==c&&u("unknown base class. Did you use dojo.require to pull it in?",d);if(c)for(l=k-1;;--l){b=G(c);if(!l)break;g=p[l];(g._meta?K:D)(b,g.prototype);h=new Function;h.superclass=c;h.prototype=b;c=b.constructor=h}else b={};x.safeMixin(b,a);g=a.constructor;g!==v.constructor&&(g.nom="constructor",b.constructor=g);for(l=k-1;l;--l)(g=p[l]._meta)&&g.chains&&(e=D(e||{},g.chains));b["-chains-"]&&(e=D(e||{},b["-chains-"]));g=!e||!e.hasOwnProperty("constructor");p[0]=h=e&&"manual"===e.constructor?P(p):
1==p.length?O(a.constructor,g):N(p,g);h._meta={bases:p,hidden:a,chains:e,parents:m,ctor:a.constructor};h.superclass=c&&c.prototype;h.extend=L;h.createSubclass=M;h.prototype=b;b.constructor=h;b.getInherited=H;b.isInstanceOf=J;b.inherited=S;b.__inherited=F;d&&(b.declaredClass=d,z.setObject(d,h));if(e)for(f in e)b[f]&&"string"==typeof e[f]&&"constructor"!=f&&(g=b[f]=Q(f,p,"after"===e[f]),g.nom=f);return h}var D=z.mixin,v=Object.prototype,y=v.toString,C=new Function,R=0,S=w.config.isDebug?I:F;w.safeMixin=
x.safeMixin=function(d,c){for(e in c){var a=c[e];a===v[e]&&e in v||"constructor"==e||("[object Function]"==y.call(a)&&(a.nom=e),d[e]=a)}if(E("bug-for-in-skips-shadowed"))for(var b=z._extraNames,f=b.length;f;){var e=b[--f];a=c[e];a===v[e]&&e in v||"constructor"==e||("[object Function]"==y.call(a)&&(a.nom=e),d[e]=a)}return d};return w.declare=x});
