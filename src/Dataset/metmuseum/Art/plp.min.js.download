define(['jquery','jquery/ui','corraui'],function($){"use strict";console.log("==PLP 1.2==");$.widget('corra.plp',{_init:function(){var self=this;self.initFilters();self.initLoading();self.initScroll();self.initBodyClick();self.initFilterDoneClick();self.ajaxFinish();self.initMobileToolbar();if(!$('#layered-filter-block').length){$('body').addClass('no-filter');}},initFilterDoneClick:function(){var self=this;$(".filter-options-content .close-filter-button").click(function(e){self.closeFilter();$('#layered-filter-block').removeClass('active');});},closeFilter:function(){var activeElem=jQuery(".filter-options-item.active");activeElem.find(".filter-options-title").attr("aria-selected",false).attr("aria-expanded",false);activeElem.find(".filter-options-content").attr("aria-hidden",true).hide();var mageCollapsibleData=activeElem.data("mageCollapsible");if(typeof mageCollapsibleData!="undefined"){mageCollapsibleData.options.active=false;activeElem.data("mageCollapsible",mageCollapsibleData);}
activeElem.removeClass("active");},initBodyClick:function(){var bodyClick=false;var self=this;$("body").click(function(e){var _this=$(e.target);if(!bodyClick){if(_this.parents("#narrow-by-list").length==0){bodyClick=true;jQuery("body").removeData("clicked-filter");if($(".filter-options-item.active").length&&$(e.target).parents("#layered-filter-block").length&&$('#layered-filter-block').hasClass('active')){$('#layered-filter-block').trigger('click');}
self.closeFilter();}
if(_this.parents(".toolbar-sorter").length==0){bodyClick=true;jQuery(".toolbar-sorter .active .sorter-label").trigger("click");}
if(_this.parents(".block.filter.active").length==0){bodyClick=true;jQuery(".active .filter-title .mobile-button-label").trigger("click");}}
bodyClick=false;});},initFilters:function(){$(".mob-plp-navs").click(function(){var dataClass=$(this).data("class");$("body").removeClass("filter-open sorter-open");$("body").addClass(dataClass+"-open");});$(".close-filter").click(function(){$("body").removeClass("filter-open sorter-open");});$(document).delegate(".filter-options-title","click",function(){var __this=$(this);setTimeout(function(){if(!CorraUI.isScrolledIntoView(__this)){$("body, html").animate({scrollTop:__this.offset().top-$(".sticky-header").outerHeight()-15});}},200);});},showhideLoadMore:function(){if(jQuery(".pages-item-next").length>0){$("#jq-load-more").show();}else{$("#jq-load-more").hide();}},updateProductCount:function(){$(".jq-product-count").text($('#ajax-product-grid ol.products li:not(.inline-promo):visible').length);},initLoading:function(){var self=this;$("#jq-load-more").remove();self.updateProductCount();self.showhideLoadMore();$('body').undelegate('#jq-load-more','click').delegate('#jq-load-more','click',function(e){var nextPage=$('div.pages li.item.current').next('li.item').find('a');if(nextPage.length){var link=self.checkUrl(nextPage.attr('href'));$(".toolbar-products").addClass("loading-more-products");link+='&isAjax=1';link+='&aw_layered_nav_process_output=1';$.ajax({url:link,type:'get',cache:false,dataType:'json',success:function(result){var res=result.mainColumn;$('#ajax-product-grid ol.products').append($(res).find('#ajax-product-grid ol.products').html());$("body").append($(res).filter(".jq-bv-init").html());$('.pages').html($(res).find('.pages:first').html());$('#corra-multiselect-product-list').trigger('contentUpdated');self.updateProductCount();self.showhideLoadMore();},complete:function(){$(".toolbar-products").removeClass("loading-more-products");}});}});},checkUrl:function(url){var regex=/(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?/;return regex.test(url)?url:null;},initScroll:function(){var self=this;$(window).on("scroll.plp",function(){if(CorraUI.isScrolledIntoView("#jq-load-more")){if(jQuery(".product-items .item.product-item:hidden:not(.inline-promo)").length>0){$(".toolbar-products").addClass("loading-more-products");setTimeout(function(){$(".toolbar-products").removeClass("loading-more-products");jQuery(".product-items .item.product-item:hidden:not(.inline-promo)").show();},2000);}}
self.updateProductCount();self.showhideLoadMore();});},ajaxFinish:function(){var self=this;$(document).ajaxComplete(function(){jQuery(".filter-content a, .toolbar-sorter.sorter a").each(function(){$(this).attr("href",self.removeParam("isAjax",$(this).attr("href")));});});},removeParam:function(key,sourceURL){var rtn=sourceURL.split("?")[0],param,params_arr=[],queryString=(sourceURL.indexOf("?")!==-1)?sourceURL.split("?")[1]:"";if(queryString!==""){params_arr=queryString.split("&");for(var i=params_arr.length-1;i>=0;i-=1){param=params_arr[i].split("=")[0];if(param===key){params_arr.splice(i,1);}}
rtn=rtn+"?"+params_arr.join("&");}
return rtn;},initMobileToolbar:function(){$('.products.wrapper ~ .toolbar .sorter').insertAfter('#layered-filter-block > .filter-title');$('#layered-filter-block a[data-role="sorter"]').click(function(evt){evt.stopPropagation();evt.preventDefault();let href=evt.target.href;if(href){$('.column.main .toolbar-sorter').find('[href="'+href+'"]').trigger('click');}});}});return $.corra.plp;});