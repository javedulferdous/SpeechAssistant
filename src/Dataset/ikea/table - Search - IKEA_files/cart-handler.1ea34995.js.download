(window.webpackJsonpPurchaseMiddleware=window.webpackJsonpPurchaseMiddleware||[]).push([[0],[,,,,,function(t,n){t.exports=function u(t,n,e){var a=0<arguments.length&&void 0!==t?t:2,s=1<arguments.length?n:void 0,c=2<arguments.length&&void 0!==e&&e;return function(o,i){return new Promise(function(e,r){return fetch(o,i).then(function(t){return t.ok?c?t.text().then(function(t){return t.length?JSON.parse(t):{}}).then(function(t){return e(t)}).catch(function(t){return r(t)}):t.json().then(function(t){return e(t)}).catch(function(t){return r(t)}):Promise.reject(t)}).catch(function(t){var n=t&&t.status;return a<=1||401===n||404===n?r("Failed to fetch from: ".concat(o,". Status code: ").concat(n,".")):e(new Promise(function(t){return setTimeout(function(){return t(u(a-1,s,c)(o,i))},s)}))})})}}},function(t,n,e){"use strict";var r={};n.a=function(t){var e=t.toUpperCase();return r[e]||(r[e]={namespace:e,publish:function(t,n){window.ikea&&window.ikea.pubsub&&window.ikea.pubsub.publish("".concat(e,"/").concat(t),n)},subscribe:function(t,n){window.ikea&&window.ikea.pubsub&&window.ikea.pubsub.subscribe("".concat(e,"/").concat(t),n)}}),r[e]}},function(t,n){t.exports=function(i){return function(){for(var t=i,n=0,e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];for(;n<r.length;){if(null==t)return t;t=Array.isArray(r[n])?t[r[n][0]]:t[r[n]],n+=1}return t}}},,,,,,function(t,n,e){var r=e(5),o=e(7);t.exports=function(n,t){var e={method:"POST",headers:{Accept:"application/json","X-Client-Id":"825a9a1d-bd81-41f4-83ad-fd576b613303","Content-Type":"application/json",Authorization:"Bearer ".concat(n)},body:JSON.stringify({query:function(t){var n=t.map(function(t){var n=t.productNumber,e=t.quantity;return'{itemNo: "'.concat(n,'", quantity: ').concat(e,"}")});return"\n    mutation {\n      addItems(items: [\n        ".concat(n.join(","),"\n      ]) {\n        quantity\n      }\n    }\n  ")}(t)})};return r(3,1e3)("https://cart.oneweb.ingka.com/graphql",e).then(function(t){return t.errors&&t.errors.length?Promise.reject(t.errors[0]):{status:"CART_ADD_SUCCESS",itemQty:o(t)("data","addItems","quantity")}}).catch(function(t){return{status:"CART_ADD_FAIL",error:t,token:n}})}},function(t,n,e){var i=e(7);t.exports=function(){return new Promise(function(r,o){if(!i(window)("ikea","authentication","getTokens"))return o(new Error("authentication.getTokens is not found"));window.ikea.authentication.getTokens(function(t,n){if(t)return o(t);var e=i(n)("auth","value")||i(n)("guest","value");return e?r(e):o(new Error("token is not found"))})})}},function(t,n,e){"use strict";e.r(n);function r(e){var t=h(e.items),n=l.put({bagId:e.bagId,userId:e.sessionContext.userId,payload:t});return o(3,1e3,!0)(n.url,n).then(function(t){var n=i(t)("ErrorList","Error","ErrorCode","$");return n?Promise.reject(new Error("error code: ".concat(n))):e.bagId})}var o=e(5),i=e(7),u=function(t,n){return t||d(2)().then(function(){return c(n)}).then(function(t){return t||Promise.reject(new Error("Was not able to get bag ID after several attempts!"))})},a="https://iows.ikea.com/retail/iows",s="us/en",c=function(t){if(!t)return Promise.reject("User ID is missing.");var n=l.getBags({userId:t});return o(3,1e3)(n.url,n).then(function(t){return i(t)("ShoppingBagRefList","ShoppingBagRef","BagId","$")})},p=function(e,r){if(!r)return Promise.reject("Bag ID is missing.");var t=l.getBag({userId:e,bagId:r});return o(3,1e3)(t.url,t).then(function(t){var n=i(t)("ShoppingBag","ShoppingBagSectionList","ShoppingBagSection","ShoppingBagItemList","ShoppingBagItem");return n?Array.isArray(n)?n.reduce(function(t,n){return t+n.ItemQty.$},0):n.ItemQty.$:Promise.reject({message:"No item in the shopping bag.",bagId:r,userId:e})})},d=function(e){return function(n){return new Promise(function(t){setTimeout(function(){return t(n)},1e3*e)})}},f=function(n){return n.bagId?r(n):function(t){var n=g({userId:t.userId,items:t.items}),r=l.post({userId:t.sessionContext.userId,payload:n});return o(3,1e3)(r.url,r).then(function(t){var n=i(t)("ErrorList","Error","ErrorCode","$"),e=i(t)("ShoppingBag","BagId","$");return 50101===n?Promise.reject({shouldHandleAsExistingCart:!0,response:t,request:r}):n?Promise.reject(new Error("error code: ".concat(n))):e})}(n).catch(function(t){return t.shouldHandleAsExistingCart?c(n.sessionContext.userId).then(function(t){return t?r(Object.assign({},n,{bagId:t})):Promise.reject("Could not get bag ID for user even after waiting and retrying!")}):Promise.reject(t)})},g=function(t){var n=t.userId,e=t.items;return{ShoppingBag:{BagType:{$:"onlineshoppingcart"},BagSource:{$:"M2"},BagName:{$:"CART"},CustomerSource:{$:"M2"},CustomerId:{$:n},CreatedDateTime:{$:(new Date).toUTCString()},ShoppingBagSectionList:[{ShoppingBagSection:{ShoppingBagItemList:{ShoppingBagItem:e.map(function(t){return{ItemType:{$:t.productType.toUpperCase()},ItemNo:{$:t.productNumber},ItemQty:{$:t.quantity},SectionId:{$:0}}})}}}],"@xmlns":{$:"ikea.com/cem/iows/ShoppingBagService/2.0/"}}}},h=function(t){return{ShoppingBagAdjustmentItemList:{ShoppingBagAdjustmentItem:t.map(function(t){return{ItemType:{$:t.productType.toUpperCase()},ItemNo:{$:t.productNumber},ItemQty:{$:t.quantity},SectionId:{$:0}}}),"@xmlns":{$:"ikea.com/cem/iows/ShoppingBagService/2.0/"}}}},m={headers:{Accept:"application/vnd.ikea.iows+json; version=2.0",Contract:"37249",Consumer:"MAMMUT"},mode:"cors",cache:"default",credentials:"include"},l={post:function(t){return Object.assign({},m,{method:"POST",url:"".concat(a,"/").concat(s,"/customer/irw/").concat(t.userId,"/shoppingbags/onlineshoppingcart"),body:"list=".concat(JSON.stringify(t.payload)),"Content-type":"application/x-www-form-urlencoded"})},put:function(t){return Object.assign({},m,{method:"PUT",url:"".concat(a,"/").concat(s,"/customer/irw/").concat(t.userId,"/shoppingbags/onlineshoppingcart/").concat(t.bagId,"/items"),body:"list=".concat(JSON.stringify(t.payload)),"Content-type":"application/x-www-form-urlencoded"})},getBags:function(t){return Object.assign({},m,{method:"GET",url:"".concat(a,"/").concat(s,"/customer/irw/").concat(t.userId,"/shoppingbags/onlineshoppingcart")})},getBag:function(t){return Object.assign({},m,{method:"GET",url:"".concat(a,"/").concat(s,"/customer/irw/").concat(t.userId,"/shoppingbags/onlineshoppingcart/").concat(t.bagId)})}};n.default=function(n,e){return c(n.userId).then(function(t){return f({bagId:t,sessionContext:n,items:e})}).then(function(t){return u(t,n.userId)}).then(function(t){return p(n.userId,t)}).then(function(t){return{itemQty:t,status:"CART_ADD_SUCCESS"}}).catch(function(t){return{status:"CART_ADD_FAIL",error:t,sessionContext:n}})}},function(t,n,e){"use strict";e.r(n);var r=e(17),o=e.n(r),i=e(18),u=e.n(i),a=function(){function e(t,n){o()(this,e),this.getSessionContext=t,this.purchase=n,this.handleSessionContextError=this.handleSessionContextError.bind(this)}return u()(e,[{key:"handleSessionContextError",value:function(t){return t.error?Promise.reject(t.error):Promise.resolve(t)}},{key:"addToCart",value:function(n){var e=this;return this.getSessionContext().then(this.handleSessionContextError).then(function(t){return e.purchase(t,n)})}}]),e}();n.default=a},function(t,n){t.exports=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}},function(t,n){function r(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}t.exports=function(t,n,e){return n&&r(t.prototype,n),e&&r(t,e),t}},,,,function(t,n,e){"use strict";e.r(n);var r=e(6),o="ADD_TO_CART",i="ADD_TO_CART_INITIATE",u="ADD_TO_CART_SUCCESS",a="ADD_TO_CART_FAIL",s=Object(r.a)("CART_CLIENT"),c="CART_ADD_SUCCESS";n.default=function(r){s.subscribe(o,function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(n.items&&n.items[0]&&n.items[0].productNumber&&n.items[0].productType){s.publish(i,n);var t=n.items;r.addToCart(t).then(function(t){t.status===c?s.publish(u,Object.assign({},n,t)):s.publish(a,Object.assign({},n,{errorMessage:t&&t.error}))}).catch(function(t){s.publish(a,Object.assign({errorMessage:t},n))})}else{var e=new Error("productNumber or productType is missing");s.publish(a,Object.assign({errorMessage:e},n))}})}},function(t,n,e){var r=e(13),o=e(14),i={addToCart:function(n){return o().then(function(t){return r(t,n)})}};t.exports={purchaseHandler:i}},function(t,n,e){"use strict";e.r(n),e.d(n,"purchaseFunc",function(){return r}),e.d(n,"purchaseHandler",function(){return o});var r=e(15).default,o=e(16).default}]]);
//# sourceMappingURL=cart-handler.1ea34995.js.map